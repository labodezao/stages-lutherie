<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸª— Clavier AccordÃ©on Diatonique</title>
<style>
:root{
  --vert:#1d6b23;--vert-c:#eaf5ea;--or:#b8860b;--or-c:#fffbf0;
  --gris:#888;--fond:#f5f5f3;--txt:#1a1a18;--rouge:#b8312a;--bleu:#1a6691;--brd:#e2e2da;
  --gold:#b8860b;--gold-d:#7a5c00;--dark:#1a1c1a;
  --card-bg:#ffffff;--card-head:#1a1c1a;--input-bg:#ffffff;--input-brd:#d4d4cc;
  --tooltip-bg:#1a1c1a;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,Arial,sans-serif;background:var(--fond);color:var(--txt);line-height:1.5;font-size:15px}

/* â”€â”€ Header â”€â”€ */
header{background:#fff;color:var(--txt);
  padding:10px 20px;display:flex;align-items:center;gap:10px;
  position:sticky;top:0;z-index:100;
  box-shadow:0 1px 8px rgba(0,0,0,.08);border-bottom:2px solid var(--gold)}
header .icon{font-size:1.7rem;flex-shrink:0}
header .hd-text{flex:1;min-width:0}
header h1{font-size:1.1rem;font-weight:700;white-space:nowrap;color:var(--dark);letter-spacing:.03em}
header p{font-size:.75rem;color:var(--gris);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#save-status{font-size:.75rem;padding:4px 10px;border-radius:20px;font-weight:700;white-space:nowrap;flex-shrink:0;transition:background .3s,color .3s}
#save-status.saved{background:rgba(184,134,11,.12);color:var(--gold);border:1px solid rgba(184,134,11,.3)}
#save-status.dirty{background:#f39c12;color:#fff}
#save-status.saving{background:rgba(184,134,11,.08);color:var(--gold)}
.lang-btn{padding:5px 11px;border:1.5px solid var(--brd);border-radius:5px;background:transparent;
  color:var(--gris);font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer;transition:background .15s,color .15s,border-color .15s}
.lang-btn:hover{border-color:var(--gold);color:var(--gold)}
.lang-btn.active{background:var(--dark);color:var(--or-c);border-color:var(--dark)}

/* â”€â”€ Library â”€â”€ */
#library-panel{background:#f0f0ee;border-bottom:1px solid var(--brd);padding:12px 20px}
.lib-toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.lib-toolbar h2{font-size:.86rem;color:var(--dark);font-weight:700;flex:1}
#lib-cards{display:flex;gap:9px;flex-wrap:wrap}
.instr-card{border:1.5px solid var(--brd);border-radius:8px;padding:9px 12px;min-width:190px;max-width:250px;
  cursor:pointer;transition:border-color .18s,box-shadow .18s;background:#fff;position:relative}
.instr-card:hover{border-color:var(--gold);box-shadow:0 2px 12px rgba(184,134,11,.14)}
.instr-card.active{border-color:var(--dark);background:#fffff8;box-shadow:0 0 0 2px rgba(26,28,26,.12)}
.card-name{font-weight:700;font-size:.88rem;color:var(--dark)}.card-sub,.card-meta{font-size:.72rem;color:var(--gris);margin-top:2px}
.card-btns{display:flex;gap:4px;margin-top:7px}
.ca{font-size:.68rem;padding:3px 7px;border:none;border-radius:4px;cursor:pointer;font-family:inherit;font-weight:700}
.ca-edit{background:var(--dark);color:var(--or-c);border:1px solid var(--dark)}
.ca-dup{background:#f0f0ee;color:#555;border:1px solid var(--brd)}
.ca-del{background:rgba(184,49,42,.1);color:#b8312a;border:1px solid rgba(184,49,42,.25)}
.lib-empty{font-size:.83rem;color:var(--gris);font-style:italic;padding:5px 0}

/* â”€â”€ Container â”€â”€ */
.container{max-width:1380px;margin:0 auto;padding:16px 14px}
.card{background:var(--card-bg);border-radius:10px;border:1px solid var(--brd);
  box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:16px;overflow:hidden}
.card-head{background:var(--card-head);color:#fff;
  padding:10px 16px;display:flex;align-items:center;gap:9px;border-bottom:2px solid var(--gold)}
.card-head h2{font-size:.9rem;font-weight:700;flex:1;color:var(--or-c)}
.step-badge{background:rgba(255,251,240,.15);border:1.5px solid var(--gold);border-radius:50%;width:24px;height:24px;
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;flex-shrink:0;color:var(--gold)}
.card-body{padding:16px}

/* â”€â”€ Forms â”€â”€ */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:11px}
.form-group{display:flex;flex-direction:column;gap:3px}
.form-group label{font-size:.7rem;font-weight:700;color:#777;text-transform:uppercase;letter-spacing:.05em}
input[type="text"],input[type="date"],input[type="number"],select{
  padding:7px 9px;border:1.5px solid var(--input-brd);border-radius:6px;font-size:.85rem;
  font-family:inherit;background:var(--input-bg);color:var(--txt);transition:border-color .18s}
input[type="text"]:focus,input[type="number"]:focus,select:focus,input[type="date"]:focus{
  border-color:var(--gold);outline:none;box-shadow:0 0 0 3px rgba(184,134,11,.12)}
select option{background:#fff;color:var(--txt)}
.hint{font-size:.68rem;color:var(--gris);margin-top:3px}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:7px 14px;border:none;border-radius:6px;font-family:inherit;font-size:.83rem;font-weight:700;
  cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:filter .15s,transform .1s}
.btn:hover{filter:brightness(.92)}.btn:active{transform:scale(.97)}
.btn-primary{background:var(--dark);color:var(--or-c);border:1px solid var(--dark)}
.btn-or{background:var(--gold);color:#fff;border:1px solid var(--gold-d)}
.btn-outline{background:#fff;color:var(--dark);border:1.5px solid var(--dark)}
.btn-outline:hover{background:var(--dark);color:var(--or-c);filter:none}
.btn-bleu{background:#1a6691;color:#fff;border:1px solid #1a6691}
.btn-rouge{background:#b8312a;color:#fff;border:1px solid #b8312a}
.btn-gris{background:#f0f0ee;color:#555;border:1px solid var(--brd)}
.btn-group{display:flex;gap:7px;flex-wrap:wrap}

/* â”€â”€ Row config â”€â”€ */
.rangees-grid{display:flex;gap:7px;flex-wrap:wrap;margin-top:9px}
.rangee-cfg{display:flex;flex-direction:column;gap:3px;background:#f8f8f6;border:1.5px solid var(--brd);
  border-radius:6px;padding:7px 9px;min-width:160px}
.rangee-cfg label{font-size:.7rem;font-weight:700;color:#666}
.rng-ctrl{display:flex;align-items:center;gap:5px}

/* â”€â”€ +/âˆ’ small buttons â”€â”€ */
.rng-btn{width:26px;height:26px;border:1.5px solid var(--brd);border-radius:4px;
  background:#fff;font-size:1rem;line-height:1;cursor:pointer;font-family:inherit;font-weight:700;
  color:var(--dark);display:inline-flex;align-items:center;justify-content:center;
  padding:0;flex-shrink:0;transition:background .12s,border-color .12s}
.rng-btn:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.rng-count{font-size:.78rem;font-weight:700;color:var(--gris);min-width:18px;text-align:center}

/* â”€â”€ Note grid â”€â”€ */
.note-section{margin-bottom:18px}
.note-section-title{font-size:.86rem;font-weight:700;color:var(--dark);
  border-bottom:2px solid var(--gold);padding-bottom:4px;margin-bottom:8px}
.sec-hd{display:flex;align-items:center;gap:7px;margin-bottom:5px}
.sec-label{font-size:.76rem;font-weight:700;color:var(--dark)}
.row-wrap{margin-bottom:11px}
.btn-grid{display:flex;flex-wrap:wrap;gap:4px}
.btn-cell{display:flex;flex-direction:column;align-items:center;gap:2px}
.btn-num{font-size:.63rem;color:var(--gris);font-weight:700}
.note-input{width:62px;padding:4px 3px;text-align:center;font-size:.76rem;border-radius:5px;
  border:1.5px solid var(--input-brd);cursor:pointer;background:var(--input-bg);color:var(--txt)}
.note-input.pousse{border-color:#4a9a3a;background:#eef8eb}
.note-input.tire{border-color:#c8a020;background:#fffbf0}
.note-input:focus{outline:none}
.note-input.pousse:focus{border-color:#2d8a20;box-shadow:0 0 0 2px rgba(45,138,32,.12)}
.note-input.tire:focus{border-color:var(--gold);box-shadow:0 0 0 2px rgba(184,134,11,.12)}
.note-input.picker-open{box-shadow:0 0 0 3px rgba(184,134,11,.2)!important;border-color:var(--gold)!important}
.legend{display:flex;gap:14px;margin-bottom:11px;flex-wrap:wrap;align-items:center}
.legend-item{display:flex;align-items:center;gap:5px;font-size:.8rem}
.legend-swatch{width:30px;height:14px;border-radius:3px;display:flex;align-items:center;justify-content:center;
  font-size:.64rem;font-weight:700}
.info-box{background:rgba(26,102,145,.08);border-left:3px solid var(--bleu);padding:9px 12px;
  border-radius:0 6px 6px 0;font-size:.8rem;margin-bottom:12px;color:#1a5580}
.mono{font-family:monospace;background:#f0f0ee;padding:1px 4px;border-radius:3px;color:var(--dark)}

/* â”€â”€ Note Picker â”€â”€ */
#note-picker{position:absolute;z-index:999;background:#fff;border:2px solid var(--dark);
  border-radius:10px;box-shadow:0 6px 28px rgba(0,0,0,.15);padding:11px 13px;min-width:305px;display:none}
.picker-tabs{display:flex;gap:0;margin-bottom:9px;border-bottom:1.5px solid var(--brd)}
.picker-tab-btn{padding:4px 12px;border:none;background:none;font-family:inherit;font-size:.78rem;
  font-weight:700;color:var(--gris);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px}
.picker-tab-btn.active{color:var(--dark);border-bottom-color:var(--gold)}
.picker-tab{display:none}
.picker-tab.active{display:block}
.picker-title{font-size:.72rem;font-weight:700;color:#777;text-transform:uppercase;
  letter-spacing:.05em;margin-bottom:7px}
.picker-notes-row{display:flex;gap:3px;margin-bottom:4px;flex-wrap:wrap}
.pn{min-width:34px;padding:4px 5px;border:1.5px solid var(--brd);border-radius:5px;
  background:#f8f8f6;font-family:inherit;font-size:.78rem;font-weight:700;cursor:pointer;text-align:center;
  color:var(--txt);transition:background .1s,border-color .1s}
.pn:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.pn.selected{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.pn.sharp{background:#f3f0fa;border-color:#c0b0e0;color:#5a3d8a}
.pn.sharp:hover,.pn.sharp.selected{background:#5a3d8a;color:#fff;border-color:#5a3d8a}
.pn.flat{background:#fdf0ee;border-color:#e0a898;color:#8a3020}
.pn.flat:hover,.pn.flat.selected{background:#b8312a;color:#fff;border-color:#b8312a}
.picker-octave-row{display:flex;gap:3px;margin-top:7px;align-items:center}
.picker-octave-label{font-size:.68rem;font-weight:700;color:var(--gris);margin-right:3px}
.po{width:30px;height:26px;border:1.5px solid var(--brd);border-radius:5px;
  background:#f8f8f6;font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer;color:var(--txt)}
.po:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.po.selected{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.picker-preview{margin-top:9px;padding:6px 9px;background:#f8f8f6;border:1px solid var(--brd);border-radius:5px;
  font-size:.83rem;font-weight:700;color:var(--dark);min-height:33px;display:flex;align-items:center;gap:7px}
.picker-preview span{flex:1}
.picker-clear{font-size:.7rem;color:var(--rouge);cursor:pointer;border:none;background:none;font-family:inherit}
.picker-insert{padding:5px 12px;background:var(--dark);color:var(--or-c);border:none;border-radius:5px;
  font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer}
.midi-preview{font-size:.65rem;color:#1a6691;font-weight:700;opacity:.9}
.chord-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
.pc{padding:4px 5px;border:1.5px solid var(--brd);border-radius:5px;background:#f8f8f6;
  font-family:inherit;font-size:.73rem;font-weight:700;cursor:pointer;text-align:center;color:var(--txt)}
.pc:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.pc.selected{background:var(--dark);color:var(--or-c)}

/* â”€â”€ Preview tabs â”€â”€ */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--brd);margin-bottom:13px}
.tab-btn{padding:7px 17px;border:none;background:none;font-family:inherit;font-size:.83rem;
  font-weight:700;color:var(--gris);cursor:pointer;border-bottom:2.5px solid transparent;margin-bottom:-2px}
.tab-btn.active{color:var(--dark);border-bottom-color:var(--gold)}
#visual-output{overflow-x:auto}
#visual-output svg{display:block;margin:0 auto;max-width:100%}



/* â”€â”€ Modal â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);
  z-index:500;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:#fff;border:2px solid var(--dark);border-radius:12px;padding:22px;max-width:600px;width:95%;
  max-height:80vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.15)}
.modal-box h3{font-size:.98rem;color:var(--dark);margin-bottom:11px}
.modal-box textarea{width:100%;height:200px;font-family:monospace;font-size:.76rem;
  border:1.5px solid var(--brd);border-radius:6px;padding:8px;resize:vertical;
  background:#fafaf8;color:var(--txt)}

.gauche-label{font-size:.74rem;font-weight:700;color:#555}
.preset-btn{width:auto!important;padding:2px 7px!important;font-size:.7rem!important}
hr.divider{border:none;border-top:1px solid var(--brd);margin:14px 0}

/* â”€â”€ Help tooltips â”€â”€ */
.tip{display:inline-flex;align-items:center;justify-content:center;
  width:15px;height:15px;border-radius:50%;background:rgba(184,134,11,.15);
  color:var(--gold);font-size:.7rem;font-weight:700;cursor:help;
  vertical-align:middle;margin-left:4px;position:relative;flex-shrink:0;
  border:1px solid rgba(184,134,11,.3)}
.tip::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 7px);left:50%;transform:translateX(-50%);
  background:var(--tooltip-bg);color:#fff;font-size:.72rem;font-weight:400;line-height:1.45;white-space:pre-wrap;
  max-width:280px;min-width:160px;padding:7px 10px;border-radius:6px;
  border:1px solid var(--gold);box-shadow:0 4px 16px rgba(0,0,0,.3);
  pointer-events:none;opacity:0;transition:opacity .15s;z-index:9999;text-align:left}
.tip:hover::after,.tip:focus::after{opacity:1}
/* keep visible even when at bottom of screen */
.tip.tip-up::after{bottom:auto;top:calc(100% + 7px)}

/* â”€â”€ Print â”€â”€ */
@media print{
  .no-print{display:none!important}
  body{background:#fff}
  .card{box-shadow:none;border:1px solid #ddd}
  .card-head{background:var(--dark)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .mfr-table th{background:var(--dark)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
@media(max-width:680px){
  header{flex-wrap:wrap}
  .form-grid{grid-template-columns:1fr}
  #note-picker{min-width:256px}
  .chord-grid{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="no-print">
  <div class="icon">ğŸª—</div>
  <div class="hd-text">
    <h1 data-i="title">Clavier AccordÃ©on Diatonique</h1>
    <p data-i="subtitle">Plan de clavier client &amp; bon de commande anches</p>
  </div>
  <button class="lang-btn active" id="lang-fr" onclick="setLang('fr')">ğŸ‡«ğŸ‡· FR</button>
  <button class="lang-btn"        id="lang-en" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ EN</button>
  <span id="save-status" class="saved">âœ“ SauvegardÃ©</span>
</header>

<!-- LIBRARY -->
<div id="library-panel" class="no-print">
  <div class="lib-toolbar">
    <h2 data-i="myInstruments">ğŸ“ Mes accordÃ©ons sauvegardÃ©s</h2>
    <button class="btn btn-primary" onclick="newInstrument()" style="font-size:.78rem;padding:5px 11px;" data-i-btn="newInstrument">ï¼‹ Nouvel instrument</button>
    <button class="btn btn-gris"    onclick="openImportExport()" style="font-size:.78rem;padding:5px 11px;" data-i-btn="importExport">â‡… Import / Export</button>
    <label class="btn btn-outline" style="font-size:.78rem;padding:5px 11px;cursor:pointer;" title="Charger un fichier .json" data-i-btn="openFile">ğŸ“‚ Ouvrir .json
      <input type="file" accept=".json,application/json" style="display:none;" onchange="loadFromFile(event)">
    </label>
  </div>
  <div id="lib-cards"><div class="lib-empty" data-i="noSaved">Aucun instrument sauvegardÃ©.</div></div>
</div>


<div class="container">

  <!-- STEP 1: Configuration -->
  <div class="card no-print">
    <div class="card-head"><div class="step-badge">1</div><h2 data-i="step1">Configuration de l'accordÃ©on</h2></div>
    <div class="card-body">
      <div class="form-grid">
        <div class="form-group"><label data-i="instrumentRef">RÃ©fÃ©rence instrument</label>
          <input type="text" id="nom-instrument" placeholder="Ex : Sol/Do #001" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="clientName">Nom du client</label>
          <input type="text" id="nom-joueur" placeholder="Ex : Jean Dupont" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="date">Date</label>
          <input type="date" id="date-creation" onchange="onAnyChange()"></div>
        <div class="form-group"><label data-i="luthier">Luthier</label>
          <input type="text" id="nom-luthier" value="Ewen d'Aviau" oninput="onAnyChange()"></div>
      </div>
      <hr class="divider">
      <div class="form-grid">
        <div class="form-group"><label data-i="preset">ModÃ¨le prÃ©dÃ©fini</label>
          <select id="preset-select" onchange="loadPreset(this.value)">
            <option value="" data-i-opt="presetPlaceholder">â€” Choisir un modÃ¨le â€”</option>
            <option value="custom" data-i-opt="custom">PersonnalisÃ©â€¦</option>
          </select></div>
        <div class="form-group"><label data-i="rowsRH">RangÃ©es main droite</label>
          <div class="rng-ctrl">
            <button type="button" class="rng-btn" onclick="changeNbRangees(-1)">âˆ’</button>
            <input type="number" id="nb-rangees" min="1" max="20" value="3"
              onchange="onRangeesChange()" style="width:54px;text-align:center">
            <button type="button" class="rng-btn" onclick="changeNbRangees(1)">ï¼‹</button>
          </div></div>
        <div class="form-group"><label data-i="leftHandConfig">Main gauche â€” basses libres</label>
          <div style="display:grid;grid-template-columns:auto 1fr;gap:3px 7px;align-items:center;margin-top:2px;">
            <div style="display:flex;align-items:center;gap:3px;">
              <span class="gauche-label" data-i="basses">Basses</span><span class="tip" tabindex="0" role="tooltip" aria-label="Info: Basses" data-tip="Bouton produisant une note basse unique (fondamentale). Ex: Do grave, Sol grave.&#10;â€” Single bass note button (root note). E.g. low C, low G.">â“˜</span>
            </div>
            <div class="rng-ctrl">
              <button type="button" class="rng-btn" onclick="changeGauche('basses',-1)">âˆ’</button>
              <input type="number" id="nb-basses" min="0" max="60" value="6" style="width:48px;text-align:center;" oninput="applyGaucheCount('basses')">
              <button type="button" class="rng-btn" onclick="changeGauche('basses',1)">ï¼‹</button>
            </div>
            <div style="display:flex;align-items:center;gap:3px;">
              <span class="gauche-label" data-i="accords">Accords</span><span class="tip" tabindex="0" role="tooltip" aria-label="Info: Accords" data-tip="Bouton d'accord : 2 voix (fondamentale + quinte). Ex: Do+Sol, Sol+RÃ©.&#10;â€” Chord button: 2 voices (root + fifth). E.g. C+G, G+D.">â“˜</span>
            </div>
            <div class="rng-ctrl">
              <button type="button" class="rng-btn" onclick="changeGauche('accords',-1)">âˆ’</button>
              <input type="number" id="nb-accords" min="0" max="60" value="6" style="width:48px;text-align:center;" oninput="applyGaucheCount('accords')">
              <button type="button" class="rng-btn" onclick="changeGauche('accords',1)">ï¼‹</button>
            </div>
            <label style="display:flex;align-items:center;gap:6px;grid-column:1/-1;cursor:pointer;margin-top:2px;">
              <input type="checkbox" id="terzetto-enabled" onchange="onTerzettoChange()">
              <span class="gauche-label" data-i="terzetto">Terzetto</span><span class="tip" tabindex="0" role="tooltip" aria-label="Info: Terzetto" data-tip="Terzetto (italien : &quot;trio&quot;) : plaque d'anche ajoutant la TIERCE Ã  l'accord.&#10;2 voix : Do+Sol Â· 3 voix terzetto : Do+Mi+Sol (accord complet).&#10;Optionnel sur accordÃ©on 2-voix ; inclus sur 3-voix.&#10;â€”&#10;Terzetto (Italian: &quot;trio&quot;): reed plate adding the 3RD to each chord.&#10;2-voice: C+G Â· 3-voice terzetto: C+E+G (full chord).&#10;Optional on 2-voice; standard on 3-voice instruments.">â“˜</span>
            </label>
          </div>
          <div style="margin-top:5px;display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
            <span style="font-size:.65rem;color:#888;" data-i="quickSet">Rapide :</span>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(2,2,false)">4b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(4,4,false)">8b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(6,6,false)">12b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(6,6,true)">18b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(8,8,true)">24b</button>
          </div></div>
        <div class="form-group"><label data-i="voices">Nombre de voix (anches) <span class="tip" tabindex="0" role="tooltip" aria-label="Info: Voix" data-tip="1 voix : une anche par note (son pur).&#10;2 voix : deux anches par note (ex: M+H ou L+M) â†’ son plus riche.&#10;3 voix : trois anches (L+M+H) â†’ son trÃ¨s plein, avec tremolo.&#10;â€”&#10;1 voice: one reed per note (pure tone).&#10;2 voices: two reeds per note (e.g. M+H or L+M) â†’ richer sound.&#10;3 voices: three reeds (L+M+H) â†’ full sound with tremolo.">â“˜</span></label>
          <select id="nb-voix" onchange="renderVoixPerRow();onAnyChange()">
            <option value="1">1 voix / 1 voice</option>
            <option value="2" selected>2 voix / voices</option>
            <option value="3">3 voix / voices</option>
          </select>
          <div id="voix-per-row-wrap" style="margin-top:4px;"></div></div>
        <div class="form-group"><label data-i="voicesLH">Voix main gauche (anches)</label>
          <div style="display:grid;grid-template-columns:auto 1fr;gap:3px 7px;align-items:center;margin-top:2px;">
            <span class="gauche-label" data-i="accords">Accords</span>
            <select id="nb-voix-accords" onchange="generateInputGrid();onAnyChange()" style="font-size:.82rem;">
              <option value="1">1 voix</option>
              <option value="2" selected>2 voix</option>
              <option value="3">3 voix</option>
            </select>
            <span class="gauche-label" data-i="basses">Basses</span>
            <select id="nb-voix-basses" onchange="generateInputGrid();onAnyChange()" style="font-size:.82rem;">
              <option value="1">1 voix</option>
              <option value="2" selected>2 voix</option>
              <option value="3">3 voix</option>
            </select>
          </div>
          <div style="margin-top:6px;display:flex;align-items:center;gap:7px">
            <input type="checkbox" id="show-midi" onchange="onAnyChange()">
            <label for="show-midi" style="font-size:.82rem;cursor:pointer;font-weight:normal;text-transform:none;letter-spacing:0" data-i="showMidi">NumÃ©ros MIDI <span class="tip tip-up" tabindex="0" role="tooltip" aria-label="Info: MIDI" data-tip="Affiche le numÃ©ro MIDI de chaque note sur le clavier et dans le tableau fabricant.&#10;Do central (Do4) = MIDI 60. Utile pour les logiciels et fabricants.&#10;â€”&#10;Shows MIDI note number on keyboard and manufacturer table.&#10;Middle C (C4) = MIDI 60. Useful for software and manufacturers.">â“˜</span></label>
          </div>
          <div style="margin-top:6px;">
            <div style="font-size:.75rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.04em;margin-bottom:3px;" data-i="lhDisplayMode">Affichage main gauche</div>
            <label style="font-size:.82rem;cursor:pointer;font-weight:normal;display:flex;align-items:center;gap:5px;">
              <input type="radio" name="lh-mode" id="lh-separated" value="separated" checked onchange="onLhModeChange()">
              <span data-i="lhSeparated">RangÃ©es sÃ©parÃ©es</span></label>
            <label style="font-size:.82rem;cursor:pointer;font-weight:normal;display:flex;align-items:center;gap:5px;margin-top:2px;">
              <input type="radio" name="lh-mode" id="lh-paired" value="paired" onchange="onLhModeChange()">
              <span data-i="lhPaired">AlternÃ©s (B-A-B-Aâ€¦)</span></label>
            <!-- LH rows + offsets config (shown for both modes) -->
            <div id="lh-rows-cfg" style="margin-top:6px;padding:6px 8px;background:#f5f5f0;border-radius:5px;border:1px solid #ddd;">
              <div style="font-size:.74rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px;" data-i="lhNbRows">Lignes</div>
              <div id="lh-rows-inner" style="display:flex;flex-direction:column;gap:4px;"></div>
            </div>
          </div></div>
      </div>
      <div id="rangees-cfg-wrap">
        <div style="font-size:.75rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.05em;margin-top:13px;margin-bottom:5px;" data-i="rowConfig">Configuration des rangÃ©es</div>
        <div class="rangees-grid" id="rangees-cfg"></div>
      </div>
      <hr class="divider">
      <div style="font-size:.75rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;" data-i="orderSpecTitle">ğŸ“‹ SpÃ©cifications commande fabricant (Voci Armoniche checklist)</div>
      <div class="form-grid">
        <div class="form-group"><label data-i="orderQty">QuantitÃ©</label>
          <input type="number" id="order-qty" min="1" value="1" oninput="onAnyChange()" style="width:80px;"></div>
        <div class="form-group"><label data-i="orderReedType">Type d'anches</label>
          <input type="text" id="order-reed-type" placeholder="Ex : Tipo a mano" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderTuning">Accord de base</label>
          <select id="order-tuning" onchange="onAnyChange()">
            <option value="440">440 Hz</option>
            <option value="441">441 Hz</option>
            <option value="442">442 Hz</option>
            <option value="443">443 Hz</option>
          </select></div>
        <div class="form-group"><label data-i="orderTremolo">Tremolo (Â± centiÃ¨mes de Hz) <span class="tip" tabindex="0" role="tooltip" aria-label="Info: Tremolo" data-tip="Ã‰cart de frÃ©quence entre le rang naturel et le rang tremolo (en centiÃ¨mes d'un demi-ton). Ex: Â±7 Cents = vibrato lent doux. Â±15 Cents = vibrato plus prononcÃ©.&#10;â€”&#10;Frequency offset between natural and tremolo reed rows (in cents = 1/100 of a semitone). E.g. Â±7 cents = gentle slow vibrato.">â“˜</span></label>
          <input type="text" id="order-tremolo" placeholder="Ex : Â± 7 Cents" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderHarmony">Harmonie / Harmony</label>
          <input type="text" id="order-harmony" placeholder="Ex : â€”" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderBassType">Type de basses</label>
          <input type="text" id="order-bass-type" placeholder="Ex : Basso Helikon, Balillaâ€¦" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderBassComp">Composition basses</label>
          <input type="text" id="order-bass-comp" placeholder="Ex : 6 Balilla / 4 BH4 + 4 BH2" oninput="onAnyChange()"></div>
      </div>
      <div class="hint" style="margin-top:5px;" data-i="orderSpecHelp">Ces informations apparaissent dans l'en-tÃªte du bon de commande fabricant.</div>
    </div>
  </div>

  <!-- STEP 2: Note entry -->
  <div class="card no-print">
    <div class="card-head"><div class="step-badge">2</div>
      <h2 data-i="step2">Saisie des notes â€” cliquez un champ pour ouvrir le sÃ©lecteur</h2></div>
    <div class="card-body">
      <div class="info-box" id="info-box-text" data-i="clickToOpen">
        <strong>Cliquez</strong> sur un champ vert (poussÃ©) ou ambrÃ© (tirÃ©) pour ouvrir le sÃ©lecteur de notes.
      </div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-swatch" style="background:#eef8eb;border:1.5px solid #4a9a3a;color:#1d6b23;">â†“</div>
          <strong data-i="push">PoussÃ©</strong>
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:#fffbf0;border:1.5px solid #c8a020;color:#7a5c00;">â†‘</div>
          <strong data-i="pull">TirÃ©</strong>
        </div>
        <button class="btn btn-rouge" style="margin-left:auto;font-size:.76rem;padding:5px 10px;" onclick="clearNotes()" data-i-btn="clearNotes">ğŸ—‘ï¸ Effacer toutes les notes</button>
      </div>
      <div id="note-grid"></div>
      <div class="btn-group" style="margin-top:13px;">
        <button class="btn btn-primary" onclick="saveCurrentInstrument()" data-i-btn="saveInstrument">ğŸ’¾ Sauvegarder cet accordÃ©on</button>
        <button class="btn btn-or"      onclick="saveAsJSON()" data-i-btn="saveAs">â¬‡ï¸ Enregistrer sous .json</button>
      </div>
    </div>
  </div>

  <!-- STEP 3: Preview -->
  <div class="card" id="preview-card">
    <div class="card-head no-print">
      <div class="step-badge">3</div>
      <h2 data-i="step3">AperÃ§u &amp; impression â€” mis Ã  jour automatiquement</h2>
      <button class="btn btn-bleu no-print" onclick="forcePreview()" style="margin-left:auto;font-size:.76rem;padding:4px 11px;" data-i-btn="refresh">ğŸ”„ Actualiser</button>
    </div>
    <div class="card-body">
      <div class="tabs no-print">
        <button class="tab-btn active" onclick="showTab('visual',this)" data-i-btn="clientVisual">ğŸ¹ Clavier client</button>
        <button class="tab-btn"        onclick="showTab('fabricant',this)" data-i-btn="manufacturerTable">ğŸ“‹ Fabricant anches</button>
      </div>
      <div class="btn-group no-print" style="margin-bottom:13px;">
        <button class="btn btn-bleu"    onclick="downloadPDF('visual')"    data-i-btn="pdfClientVisual">ğŸ“¥ PDF plan clavier</button>
        <button class="btn btn-primary" onclick="downloadPDF('fabricant')" data-i-btn="pdfManufacturer">ğŸ“¥ PDF fabricant</button>
      </div>
      <div id="tab-visual">
        <div id="visual-output"><p style="color:var(--gris);font-style:italic;font-size:.83rem;" data-i="previewPlaceholder">L'aperÃ§u apparaÃ®tra ici aprÃ¨s avoir saisi les notesâ€¦</p></div>
      </div>
      <div id="tab-fabricant" style="display:none">
        <div id="sommier-output"></div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<!-- NOTE PICKER -->
<div id="note-picker">
  <div class="picker-tabs">
    <button class="picker-tab-btn active" onclick="showPickerTab('notes',this)" data-i-btn="noteTab">ğŸµ Note</button>
    <button style="margin-left:auto;padding:4px 8px;border:none;background:none;font-size:.73rem;color:var(--gris);cursor:pointer;" onclick="hidePicker()" data-i-btn="close">âœ• Fermer</button>
  </div>
  <div class="picker-tab active" id="picker-tab-notes">
    <div class="picker-title" data-i="naturals">Touches naturelles</div>
    <div class="picker-notes-row" id="picker-naturals"></div>
    <div class="picker-title" style="margin-top:7px;" data-i="sharps">DiÃ¨ses</div>
    <div class="picker-notes-row" id="picker-sharps"></div>
    <div class="picker-title" style="margin-top:7px;" data-i="flats">BÃ©mols</div>
    <div class="picker-notes-row" id="picker-flats"></div>
    <div class="picker-octave-row">
      <span class="picker-octave-label" data-i="octave">Octave :</span>
      <div id="picker-octaves" style="display:flex;gap:3px;"></div>
    </div>
  </div>
  <div class="picker-preview" id="picker-preview">
    <span id="picker-preview-text" data-i="selectNoteOctave">â€” sÃ©lectionnez une note et une octave â€”</span>
    <span class="midi-preview" id="picker-midi-badge"></span>
    <button class="picker-clear" onclick="pickerClear()" data-i-btn="clear">Effacer</button>
    <button class="picker-insert" onclick="pickerInsert()" data-i-btn="insert">InsÃ©rer â†µ</button>
  </div>
</div>

<!-- IMPORT/EXPORT MODAL -->
<div class="modal-overlay no-print" id="import-modal">
  <div class="modal-box">
    <h3>â‡… Import / Export JSON</h3>
    <p style="font-size:.8rem;color:var(--gris);margin-bottom:9px;" data-i="importHelp">Copiez le JSON pour sauvegarder, ou collez un JSON exportÃ© pour importer.</p>
    <textarea id="modal-json" spellcheck="false"></textarea>
    <div class="btn-group" style="margin-top:11px;">
      <button class="btn btn-primary" onclick="doImport()" data-i-btn="importBtn">â¬‡ï¸ Importer</button>
      <button class="btn btn-or"      onclick="downloadAllJSON()" data-i-btn="downloadAll">â¬‡ï¸ TÃ©lÃ©charger tout (.json)</button>
      <button class="btn btn-gris"    onclick="copyJSON()" data-i-btn="copyBtn">ğŸ“‹ Copier</button>
      <button class="btn btn-outline" onclick="closeModal()" data-i-btn="closeBtn">Fermer</button>
    </div>
    <p id="modal-msg" style="font-size:.78rem;margin-top:7px;min-height:1.2em;"></p>
  </div>
</div>

<script>
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LANGUAGES                                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lang = 'fr';
const LANGS = {
fr:{
  title:'Clavier AccordÃ©on Diatonique',subtitle:'Plan de clavier client & bon de commande anches',
  myInstruments:'ğŸ“ Mes accordÃ©ons sauvegardÃ©s',newInstrument:'ï¼‹ Nouvel instrument',importExport:'â‡… Import / Export',
  step1:'Configuration de l\'accordÃ©on',step2:'Saisie des notes â€” cliquez un champ pour ouvrir le sÃ©lecteur',
  step3:'AperÃ§u & impression â€” mis Ã  jour automatiquement',
  instrumentRef:'RÃ©fÃ©rence instrument',clientName:'Nom du client',date:'Date',luthier:'Luthier',
  preset:'ModÃ¨le prÃ©dÃ©fini',rowsRH:'RangÃ©es main droite',leftHandTpl:'ModÃ¨le main gauche',
  voices:'Nombre de voix (anches)',options:'Options',showMidi:'NumÃ©ros MIDI',
  rowConfig:'Configuration des rangÃ©es (nom & boutons)',
  clickToOpen:'<strong>Cliquez</strong> sur un champ <span style="color:#1d6b23;font-weight:700;">vert</span> (poussÃ©) ou <span style="color:#b8860b;font-weight:700;">ambrÃ©</span> (tirÃ©) pour ouvrir le sÃ©lecteur de notes.',
  rightHand:'ğŸµ Main Droite',leftHand:'ğŸ¹ Main Gauche',push:'PoussÃ©',pull:'TirÃ©',
  clearNotes:'ğŸ—‘ï¸ Effacer toutes les notes',saveInstrument:'ğŸ’¾ Sauvegarder cet accordÃ©on',
  clientVisual:'ğŸ¹ Clavier client',manufacturerTable:'ğŸ“‹ Fabricant anches',
  pdfClientVisual:'ğŸ–¨ï¸ PDF plan clavier',pdfManufacturer:'ğŸ–¨ï¸ PDF fabricant',
  listView:'ğŸ“‹ Vue liste',sommierView:'ğŸª— Vue sommier',refresh:'ğŸ”„ Actualiser',
  rowOffset:'DÃ©calage',
  basses:'Basses',accords:'Accords',terzetto:'Terzetto',
  addTerzetto:'ï¼‹ Ajouter Terzetto',removeTerzetto:'ğŸ—‘ï¸ Supprimer Terzetto',
  noteTab:'ğŸµ Note',chordTab:'ğŸ¼ Accord',close:'âœ• Fermer',
  naturals:'Touches naturelles',sharps:'DiÃ¨ses',flats:'BÃ©mols',octave:'Octave :',
  selectNoteOctave:'â€” sÃ©lectionnez une note et une octave â€”',chordTitle:'Accords (cliquez pour insÃ©rer)',
  clear:'Effacer',insert:'InsÃ©rer â†µ',
  importHelp:'Copiez le JSON pour sauvegarder, ou collez un JSON exportÃ© pour importer.',
  importBtn:'â¬‡ï¸ Importer',copyBtn:'ğŸ“‹ Copier',closeBtn:'Fermer',
  previewPlaceholder:'L\'aperÃ§u apparaÃ®tra ici aprÃ¨s avoir saisi les notesâ€¦',
  noSaved:'Aucun instrument sauvegardÃ©. Configurez puis cliquez "ğŸ’¾ Sauvegarder".',
  saved:'âœ“ SauvegardÃ©',dirty:'â— Modificationsâ€¦',saving:'â€¦ Sauvegarde',
  rows:'rangÃ©es',voices_:'voix',edit:'âœï¸ Ã‰diter',copy:'â§‰ Copier',delete:'ğŸ—‘ï¸',
  leftHandConfig:'Main gauche â€” basses libres',quickSet:'Rapide :',
  presetPlaceholder:'â€” Choisir un modÃ¨le â€”',custom:'PersonnalisÃ©â€¦',
  // SVG strings
  svgClient:'Client',svgLuthier:'Luthier',svgPush:'â†“ PoussÃ©',svgPull:'â†‘ TirÃ©',
  svgHigh:'AIGU â–¶',svgLow:'â—€ GRAVE',svgBellowsPush:'POUSSÃ‰',svgBellowsPull:'TIRÃ‰',
  svgRH:'Main Droite',svgLH:'Main Gauche',svgSommierRH:'SOMMIER â€” Main Droite',svgSommierLH:'SOMMIER â€” Main Gauche',
  svgMidi:'MIDI',svgGeneratedBy:'GÃ©nÃ©rÃ© le',svgPlan:'Plan de clavier',svgBellows:'SOUFFLET',
  // Manufacturer table
  mfrRH:'MAIN DROITE â€” Plaque anches mÃ©lodie (bisonore)',
  mfrLH:'MAIN GAUCHE â€” Plaques basses, accords',
  mfrRow:'RangÃ©e',mfrNo:'NÂ°',mfrPushNote:'Note PoussÃ©e â†“',mfrPullNote:'Note TirÃ©e â†‘',
  mfrMidiPush:'MIDI â†“',mfrMidiPull:'MIDI â†‘',mfrPushSub:'(soufflet poussÃ©)',mfrPullSub:'(soufflet tirÃ©)',
  mfrType:'Type',mfrNoteChordPush:'Note/Accord PoussÃ© â†“',mfrNoteChordPull:'Note/Accord TirÃ© â†‘',
  specTitle:'SpÃ©cifications / Specifications',
  spec1:'AccordÃ©on bisonore â€” soufflet poussÃ© / tirÃ© (bisonoric â€” push / pull)',
  spec2:'Nombre de voix (reeds per note)',
  spec3:'Notation solfÃ¨ge : Do=C Â· RÃ©=D Â· Mi=E Â· Fa=F Â· Sol=G Â· La=A Â· Si=B',
  spec4:'DiÃ¨se=# Â· BÃ©mol=b  |  Octaves : 2=basse Â· 3=mÃ©d.grave Â· 4=mÃ©d Â· 5=aigu Â· 6=trÃ¨s aigu',
  specGenBy:'Document gÃ©nÃ©rÃ© le',pdfClientTitle:'Plan de clavier',pdfMfrTitle:'Bon de commande anches',
  deleteConfirm:(n)=>`Supprimer Â« ${n} Â» ?`,clearConfirm:'Effacer toutes les notes ?',
  popupAlert:'Veuillez autoriser les popups pour imprimer.',
  importSuccess:(n)=>`âœ“ ${n} instrument(s) importÃ©(s).`,importError:'âœ— Erreur : ',
  copied:'âœ“ CopiÃ© dans le presse-papiers.',invalidFormat:'Format invalide (doit Ãªtre un tableau)',
  saveAs:'â¬‡ï¸ Enregistrer sous .json',openFile:'ğŸ“‚ Ouvrir .json',
  downloadAll:'â¬‡ï¸ TÃ©lÃ©charger tout (.json)',loadedFrom:(n)=>`âœ“ ${n} instrument(s) chargÃ©(s).`,
  // Order spec section
  orderSpecTitle:'ğŸ“‹ SpÃ©cifications commande fabricant (checklist Voci Armoniche)',
  orderQty:'QuantitÃ©',orderReedType:'Type d\'anches',orderTuning:'Accord de base',
  orderTremolo:'Tremolo (Â± centiÃ¨mes Hz)',orderHarmony:'Harmonie',
  orderBassType:'Type de basses',orderBassComp:'Composition basses',
  orderSpecHelp:'Ces champs apparaissent dans l\'en-tÃªte du bon de commande fabricant.',
  // Manufacturer checklist labels
  orderChecklistTitle:'BON DE COMMANDE ANCHES',
  clQty:'QuantitÃ©',clReedType:'Type d\'anches',
  clDesc:'Description gÃ©nÃ©rale (touches/accords)',clDescHint:'touches mÃ©lodie / nb basses',
  clTonality:'TonalitÃ© (clÃ©)',clRowSpec:'SpÃ©cification rangÃ©es',
  clTuning:'Accord de base',clTremolo:'Tremolo',
  clHarmony:'Harmonie',clBassType:'Type de basses',
  clBassComp:'Composition basses',clVoices:'Nombre de voix (main droite)',clVoicesLH:'Nombre de voix (main gauche)',clLuthier:'Luthier / Date',
  voicesLH:'Voix main gauche (anches)',
  lhDisplayMode:'Affichage main gauche',lhSeparated:'RangÃ©es sÃ©parÃ©es',lhPaired:'AlternÃ©s (B-A-B-Aâ€¦)',
  lhNbRows:'Lignes',lhOffset:'DÃ©calage ligne',lhDuosPerRow:'Duos (B-A) par rangÃ©e',lhNbDuosTotal:'Nb duos total',
},
en:{
  title:'Diatonic Accordion Keyboard',subtitle:'Client keyboard plan & reed order form',
  myInstruments:'ğŸ“ My saved accordions',newInstrument:'ï¼‹ New instrument',importExport:'â‡… Import / Export',
  step1:'Accordion configuration',step2:'Note entry â€” click any field to open the note selector',
  step3:'Preview & print â€” updated automatically',
  instrumentRef:'Instrument reference',clientName:'Client name',date:'Date',luthier:'Luthier',
  preset:'Preset layout',rowsRH:'Right hand rows',leftHandTpl:'Left hand template',
  voices:'Number of voices (reeds)',options:'Options',showMidi:'MIDI note numbers',
  rowConfig:'Row configuration (name & button count)',
  clickToOpen:'<strong>Click</strong> a <span style="color:#1d6b23;font-weight:700;">green</span> (push) or <span style="color:#b8860b;font-weight:700;">amber</span> (pull) field to open the note picker.',
  rightHand:'ğŸµ Right Hand',leftHand:'ğŸ¹ Left Hand',push:'Push',pull:'Pull',
  clearNotes:'ğŸ—‘ï¸ Clear all notes',saveInstrument:'ğŸ’¾ Save this accordion',
  clientVisual:'ğŸ¹ Client keyboard',manufacturerTable:'ğŸ“‹ Reed manufacturer',
  pdfClientVisual:'ğŸ–¨ï¸ PDF keyboard plan',pdfManufacturer:'ğŸ–¨ï¸ PDF manufacturer',
  listView:'ğŸ“‹ List view',sommierView:'ğŸª— Reed plate view',refresh:'ğŸ”„ Refresh',
  rowOffset:'Offset',
  basses:'Basses',accords:'Chords',terzetto:'Terzetto',
  addTerzetto:'ï¼‹ Add Terzetto',removeTerzetto:'ğŸ—‘ï¸ Remove Terzetto',
  noteTab:'ğŸµ Note',chordTab:'ğŸ¼ Chord',close:'âœ• Close',
  naturals:'Natural notes',sharps:'Sharps',flats:'Flats',octave:'Octave:',
  selectNoteOctave:'â€” select a note and octave â€”',chordTitle:'Chords (click to insert)',
  clear:'Clear',insert:'Insert â†µ',
  importHelp:'Copy the JSON to save, or paste exported JSON to import.',
  importBtn:'â¬‡ï¸ Import',copyBtn:'ğŸ“‹ Copy',closeBtn:'Close',
  previewPlaceholder:'Preview will appear here after entering notesâ€¦',
  noSaved:'No saved instruments. Configure then click "ğŸ’¾ Save".',
  saved:'âœ“ Saved',dirty:'â— Unsaved changesâ€¦',saving:'â€¦ Saving',
  rows:'rows',voices_:'voices',edit:'âœï¸ Edit',copy:'â§‰ Copy',delete:'ğŸ—‘ï¸',
  leftHandConfig:'Left hand â€” free bass count',quickSet:'Quick:',
  presetPlaceholder:'â€” Choose a preset â€”',custom:'Customâ€¦',
  svgClient:'Client',svgLuthier:'Luthier',svgPush:'â†“ Push',svgPull:'â†‘ Pull',
  svgHigh:'TREBLE â–¶',svgLow:'â—€ BASS',svgBellowsPush:'PUSH',svgBellowsPull:'PULL',
  svgRH:'Right Hand',svgLH:'Left Hand',svgSommierRH:'REED PLATE â€” Right Hand',svgSommierLH:'REED PLATE â€” Left Hand',
  svgMidi:'MIDI',svgGeneratedBy:'Generated on',svgPlan:'Keyboard plan',svgBellows:'BELLOWS',
  mfrRH:'RIGHT HAND â€” Melody reed plate (bisonoric)',
  mfrLH:'LEFT HAND â€” Bass & chord plates',
  mfrRow:'Row',mfrNo:'No.',mfrPushNote:'Push Note â†“',mfrPullNote:'Pull Note â†‘',
  mfrMidiPush:'MIDI â†“',mfrMidiPull:'MIDI â†‘',mfrPushSub:'(bellows push)',mfrPullSub:'(bellows pull)',
  mfrType:'Type',mfrNoteChordPush:'Note/Chord Push â†“',mfrNoteChordPull:'Note/Chord Pull â†‘',
  specTitle:'SpÃ©cifications / Specifications',
  spec1:'Bisonoric accordion â€” bellows push / pull (accordÃ©on bisonore)',
  spec2:'Number of voices (reeds per note)',
  spec3:'French solfÃ¨ge: Do=C Â· RÃ©=D Â· Mi=E Â· Fa=F Â· Sol=G Â· La=A Â· Si=B',
  spec4:'Sharp=# Â· Flat=b  |  Octaves: 2=low bass Â· 3=low mid Â· 4=mid Â· 5=high Â· 6=very high',
  specGenBy:'Generated on',pdfClientTitle:'Keyboard plan',pdfMfrTitle:'Reed order form',
  deleteConfirm:(n)=>`Delete "${n}"?`,clearConfirm:'Clear all notes?',
  popupAlert:'Please allow popups to print.',
  importSuccess:(n)=>`âœ“ ${n} instrument(s) imported.`,importError:'âœ— Error: ',
  copied:'âœ“ Copied to clipboard.',invalidFormat:'Invalid format (must be an array)',
  saveAs:'â¬‡ï¸ Save As .json',openFile:'ğŸ“‚ Open .json',
  downloadAll:'â¬‡ï¸ Download all (.json)',loadedFrom:(n)=>`âœ“ ${n} instrument(s) loaded.`,
  // Order spec section
  orderSpecTitle:'ğŸ“‹ Manufacturer order specifications (Voci Armoniche checklist)',
  orderQty:'Quantity',orderReedType:'Reed type',orderTuning:'Base tuning',
  orderTremolo:'Tremolo (Â± cents)',orderHarmony:'Harmony',
  orderBassType:'Bass type',orderBassComp:'Bass composition',
  orderSpecHelp:'These fields appear in the manufacturer order form header.',
  // Manufacturer checklist labels
  orderChecklistTitle:'REED ORDER FORM',
  clQty:'Quantity',clReedType:'Reed type',
  clDesc:'General description (keys/chords)',clDescHint:'melody keys / nb basses',
  clTonality:'Key tonality',clRowSpec:'Row specification',
  clTuning:'Base tuning',clTremolo:'Tremolo',
  clHarmony:'Harmony',clBassType:'Bass type',
  clBassComp:'Bass composition',clVoices:'Number of voices (right hand)',clVoicesLH:'Number of voices (left hand)',clLuthier:'Luthier / Date',
  voicesLH:'Left hand voices (reeds)',
  lhDisplayMode:'Left hand display',lhSeparated:'Separate rows',lhPaired:'Paired (B-A-B-Aâ€¦)',
  lhNbRows:'Rows',lhOffset:'Row offset',lhDuosPerRow:'Duos (B-A) per row',lhNbDuosTotal:'Total duos',
}};
function t(k){ const v=LANGS[lang][k]; return v!==undefined?v:LANGS.fr[k]||k; }

/* â”€â”€â”€ Note name conversion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const FR2EN={
  'Do':'C','RÃ©':'D','Re':'D','Mi':'E','Fa':'F','Sol':'G','La':'A','Si':'B',
  'Do#':'C#','RÃ©#':'D#','Fa#':'F#','Sol#':'G#','La#':'A#',
  'RÃ©b':'Db','Mib':'Eb','Solb':'Gb','Lab':'Ab','Sib':'Bb','Dob':'Cb',
};
const EN2FR={
  'C':'Do','D':'RÃ©','E':'Mi','F':'Fa','G':'Sol','A':'La','B':'Si',
  'C#':'Do#','D#':'RÃ©#','F#':'Fa#','G#':'Sol#','A#':'La#',
  'Db':'RÃ©b','Eb':'Mib','Gb':'Solb','Ab':'Lab','Bb':'Sib','Cb':'Dob',
};
function displayNote(note){
  if(!note) return '';
  if(lang==='fr') return note;
  // Handle slash-separated individual notes (e.g. "La3/Do#4/Mi4")
  if(note.includes('/')){return note.split('/').map(n=>displayNote(n.trim())).join('/');}
  // Try full word match first for chords like "Sol Maj"
  const m=note.match(/^(.+?)(\s+(?:Maj|Min|7|V|dim|aug|m7|maj7))?(\d?)$/);
  if(!m) return note;
  const root=m[1].trim(), qual=(m[2]||'').trim(), oct=m[3]||'';
  const en=FR2EN[root];
  if(en) return en+oct+(qual?' '+qual:'');
  return note;
}
/* Returns array of constituent note-names (FR, no octave) for a chord string.
   e.g. "La Maj" â†’ ['La','Do#','Mi'],  "Fa Min" â†’ ['Fa','Lab','Do']
   Returns null for non-chord strings (bare notes). */
function chordNotes(chord){
  if(!chord)return null;
  // Already in note-list format ("La3/Do#4/Mi4") â€” return the individual notes
  if(chord.includes('/'))return chord.split('/').map(n=>n.trim());
  const m=chord.match(/^(.+?)\s+(Maj|Min|7|m7|maj7|dim|aug|V)$/);
  if(!m)return null;
  const root=m[1].trim(), quality=m[2];
  const FR_CHROMA={'Do':0,'Do#':1,'RÃ©b':1,'RÃ©':2,'Re':2,'RÃ©#':3,'Mib':3,'Mi':4,'Fa':5,
    'Fa#':6,'Solb':6,'Sol':7,'Sol#':8,'Lab':8,'La':9,'La#':10,'Sib':10,'Si':11,'Dob':11};
  const SHARP=['Do','Do#','RÃ©','RÃ©#','Mi','Fa','Fa#','Sol','Sol#','La','La#','Si'];
  const FLAT =['Do','RÃ©b','RÃ©','Mib','Mi','Fa','Solb','Sol','Lab','La','Sib','Si'];
  const IMAP ={'Maj':[0,4,7],'Min':[0,3,7],'7':[0,4,7,10],'m7':[0,3,7,10],
    'maj7':[0,4,7,11],'dim':[0,3,6],'aug':[0,4,8],'V':[0,7]};
  const idx=FR_CHROMA[root]; if(idx===undefined)return null;
  const ivs=IMAP[quality]; if(!ivs)return null;
  // Use flat spelling for "flat" roots and for minor-quality intervals (m3, m6, m7, dim5)
  const rootFlat=(root.length>2&&root.endsWith('b'))||root==='RÃ©b';
  return ivs.map(i=>{
    const preferFlat=rootFlat||[3,6,8,10].includes(i);
    return (preferFlat?FLAT:SHARP)[(idx+i)%12];
  });
}
function storageNote(note){
  // Convert ENâ†’FR for storage (picker uses current lang)
  if(lang==='fr') return note;
  const m=note.match(/^([A-G][#b]?)(\d?)(\s+.*)?$/);
  if(!m) return note;
  const fr=EN2FR[m[1]];
  if(fr) return fr+(m[2]||'')+(m[3]||'');
  return note;
}

/* â”€â”€â”€ Apply language to DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setLang(l){
  lang=l;
  document.getElementById('lang-fr').classList.toggle('active',l==='fr');
  document.getElementById('lang-en').classList.toggle('active',l==='en');
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k=el.dataset.i;
    const v=t(k);
    if(typeof v==='string') el.innerHTML=v;
  });
  document.querySelectorAll('[data-i-btn]').forEach(el=>{
    const k=el.dataset.iBtn;
    const v=t(k);
    if(typeof v==='string') el.textContent=v;
  });
  document.querySelectorAll('[data-i-opt]').forEach(el=>{
    const k=el.dataset.iOpt;
    const v=t(k);
    if(typeof v==='string') el.textContent=v;
  });
  // Update save status text
  const ss=document.getElementById('save-status');
  if(ss) ss.textContent=t(ss.className)||ss.textContent;
  // Reinit picker notes
  initPicker();
  // Regenerate grid (updates section labels)
  generateInputGrid();
  scheduleLivePreview();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Ã‰TAT GLOBAL                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let CFG={
  nbRangees:3,
  rangees:[
    {nom:'RangÃ©e Sol (intÃ©rieure)',nb:11},
    {nom:'RangÃ©e Do (mÃ©diane)',nb:11},
    {nom:'RangÃ©e RÃ© (extÃ©rieure)',nb:11},
  ],
  configGauche:12,
  lhRows:[{nb:6,offset:0}],
  lhPairsPerRow:2,
  notes:{droite:[],basses:[],basses2:[],basses3:[],accords:[],accords2:[],accords3:[],terzetto:[]}
};
let currentId=null,saveTimer=null,previewTimer=null;
let pickerInput=null,pickerNote='',pickerOctave='';

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  NOTE â†’ MIDI                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SEMI_FR={Do:0,RÃ©:2,Re:2,Mi:4,Fa:5,Sol:7,La:9,Si:11};
const SEMI_EN={C:0,D:2,E:4,F:5,G:7,A:9,B:11};
function noteToMidi(s){
  if(!s) return null;
  let m=s.trim().match(/^(Do|RÃ©|Re|Mi|Fa|Sol|La|Si)([#b]?)(\d+)$/);
  if(m){
    const base=SEMI_FR[m[1]]; if(base===undefined) return null;
    return (parseInt(m[3])+1)*12+base+(m[2]==='#'?1:m[2]==='b'?-1:0);
  }
  m=s.trim().match(/^([A-G])([#b]?)(\d+)$/);
  if(m){
    const base=SEMI_EN[m[1]]; if(base===undefined) return null;
    return (parseInt(m[3])+1)*12+base+(m[2]==='#'?1:m[2]==='b'?-1:0);
  }
  return null;
}
const MIDI_TO_FR=['Do','RÃ©b','RÃ©','Mib','Mi','Fa','Solb','Sol','Lab','La','Sib','Si'];
function midiToFr(midi){if(midi===null||midi===undefined)return'';const oct=Math.floor(midi/12)-1;return MIDI_TO_FR[((midi%12)+12)%12]+oct;}
function shiftNote(n,semi){const m=noteToMidi(n);return m!==null?midiToFr(m+semi):'';}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PRÃ‰RÃ‰GLAGES â€” chargÃ©s depuis presets/*.json         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _presetCache={};  // id â†’ preset data (lazy-loaded)
let   _presetIndex=[];  // [{id,label,category}]

async function loadPresetIndex(){
  const base=document.querySelector('base')?.href||location.href;
  const url=new URL('presets/index.json',base).href;
  const r=await fetch(url);
  _presetIndex=await r.json();
  renderPresetOptions();
}

function renderPresetOptions(){
  const sel=document.getElementById('preset-select');
  if(!sel)return;
  // Group by category
  const cats={};
  _presetIndex.forEach(p=>{(cats[p.category]||(cats[p.category]=[])).push(p);});
  const customOpt=sel.querySelector('option[value="custom"]');
  // Remove previously inserted options
  sel.querySelectorAll('option[data-preset]').forEach(o=>o.remove());
  Object.entries(cats).forEach(([cat,items])=>{
    const og=document.createElement('optgroup');og.label=cat;
    items.forEach(p=>{
      const o=document.createElement('option');
      o.value=p.id;o.textContent=p.label;o.dataset.preset='1';
      og.appendChild(o);
    });
    sel.insertBefore(og,customOpt);
  });
}

async function fetchPresetData(id){
  if(_presetCache[id])return _presetCache[id];
  const base=document.querySelector('base')?.href||location.href;
  const url=new URL(`presets/${id}.json`,base).href;
  const r=await fetch(url);
  if(!r.ok)throw new Error(`Preset not found: ${id}`);
  const data=await r.json();
  _presetCache[id]=data;
  return data;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LOCAL STORAGE DB                                    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB_KEY='acc_clavier_db';
const DB={
  load(){try{return JSON.parse(localStorage.getItem(DB_KEY)||'[]')}catch(e){return[]}},
  save(l){localStorage.setItem(DB_KEY,JSON.stringify(l))},
  all(){return DB.load()},
  get(id){return DB.load().find(r=>r.id===id)||null},
  add(r){const l=DB.load();l.unshift(r);DB.save(l);return r.id},
  update(id,d){const l=DB.load(),i=l.findIndex(r=>r.id===id);if(i>=0){l[i]={...l[i],...d,id,lastModified:new Date().toISOString()};DB.save(l)}},
  delete(id){DB.save(DB.load().filter(r=>r.id!==id))},
  duplicate(id){const s=DB.get(id);if(!s)return null;const n=JSON.parse(JSON.stringify(s));n.id=Date.now().toString();n.nom=s.nom+' (copie)';n.lastModified=new Date().toISOString();DB.add(n);return n.id}
};

function snapshotToDB(){
  readNoteInputsIntoCFG();
  // Read register values from selects
  for(let r=0;r<CFG.nbRangees;r++){
    const sel=document.getElementById(`rreg-${r}`);
    if(sel)CFG.rangees[r].register=sel.value;
  }
  return{id:currentId||Date.now().toString(),nom:val('nom-instrument')||'Sans titre',
    joueur:val('nom-joueur'),luthier:val('nom-luthier')||"Ewen d'Aviau",
    dateCreation:val('date-creation'),lastModified:new Date().toISOString(),
    nbRangees:CFG.nbRangees,rangees:JSON.parse(JSON.stringify(CFG.rangees)),
    nbVoix:parseInt(document.getElementById('nb-voix').value),
    voixPerRow:readVoixPerRow(),
    nbVoixAccords:parseInt(document.getElementById('nb-voix-accords')?.value||'2'),
    nbVoixBasses:parseInt(document.getElementById('nb-voix-basses')?.value||'2'),
    lhDisplayMode:document.querySelector('input[name="lh-mode"]:checked')?.value||'separated',
    lhRows:JSON.parse(JSON.stringify(CFG.lhRows)),
    lhPairsPerRow:CFG.lhPairsPerRow||2,
    notes:JSON.parse(JSON.stringify(CFG.notes)),
    orderSpecs:{
      qty:val('order-qty')||'1',
      reedType:val('order-reed-type'),
      tuning:document.getElementById('order-tuning')?.value||'440',
      tremolo:val('order-tremolo'),
      harmony:val('order-harmony'),
      bassType:val('order-bass-type'),
      bassComp:val('order-bass-comp'),
    }};
}
function loadFromDB(rec){
  currentId=rec.id;
  document.getElementById('nom-instrument').value=rec.nom||'';
  document.getElementById('nom-joueur').value=rec.joueur||'';
  document.getElementById('nom-luthier').value=rec.luthier||"Ewen d'Aviau";
  document.getElementById('date-creation').value=rec.dateCreation||'';
  document.getElementById('nb-voix').value=String(rec.nbVoix||2);
  renderVoixPerRow();
  (function(){const vpr=rec.voixPerRow||(rec.voixType?{N:['N'],BN:['B','N'],NH:['N','A'],BNH:['B','N','A']}[rec.voixType]:null)||['B','N'];for(let i=0;i<vpr.length;i++){const s=document.getElementById('voix-v'+i);if(s)s.value=vpr[i]||'N';}})();
  document.getElementById('nb-voix-accords').value=String(rec.nbVoixAccords||(rec.nbVoixGauche||2));
  document.getElementById('nb-voix-basses').value=String(rec.nbVoixBasses||(rec.nbVoixGauche||2));
  const lhm=rec.lhDisplayMode||'separated';
  const lhmEl=document.getElementById('lh-'+lhm);
  if(lhmEl)lhmEl.checked=true;
  CFG.nbRangees=rec.nbRangees||2;
  CFG.rangees=JSON.parse(JSON.stringify(rec.rangees));
  CFG.notes=JSON.parse(JSON.stringify(rec.notes));
  // Restore lhRows â€” backward compat: default to 1 row covering all basses
  CFG.lhRows=rec.lhRows?JSON.parse(JSON.stringify(rec.lhRows)):[{nb:(rec.notes&&rec.notes.basses?rec.notes.basses.length:6),offset:0}];
  CFG.lhPairsPerRow=rec.lhPairsPerRow||2;
  // ensure terzetto exists
  if(!CFG.notes.terzetto) CFG.notes.terzetto=[];
  // backward compat: if notes arrays are missing, init from configGauche
  if(!CFG.notes.basses||!CFG.notes.basses.length){
    const cgMap={4:2,8:4,18:6,24:8};
    const nb=cgMap[rec.configGauche]||6;
    CFG.notes.basses=Array.from({length:nb},()=>({p:'',t:''}));
    CFG.notes.accords=Array.from({length:nb},()=>({p:'',t:''}));
  }
  // ensure voice copies exist with correct length
  {const _nb=CFG.notes.basses.length,_na=CFG.notes.accords.length;
  const _ensureLen=(arr,n)=>{const r=(arr||[]).slice(0,n);while(r.length<n)r.push({p:'',t:''});return r;};
  CFG.notes.basses2=_ensureLen(CFG.notes.basses2,_nb);
  CFG.notes.basses3=_ensureLen(CFG.notes.basses3,_nb);
  CFG.notes.accords2=_ensureLen(CFG.notes.accords2,_na);
  CFG.notes.accords3=_ensureLen(CFG.notes.accords3,_na);}
  document.getElementById('nb-rangees').value=String(CFG.nbRangees);
  syncGaucheInputs();
  // Load order specs
  const os=rec.orderSpecs||{};
  const sv=(id,v)=>{const el=document.getElementById(id);if(el&&v!==undefined)el.value=v;};
  sv('order-qty',os.qty||'1');sv('order-reed-type',os.reedType||'');
  sv('order-tuning',os.tuning||'440');sv('order-tremolo',os.tremolo||'');
  sv('order-harmony',os.harmony||'');sv('order-bass-type',os.bassType||'');
  sv('order-bass-comp',os.bassComp||'');
  renderRangeesCfg();
  renderLhRowsCfg();
  generateInputGrid();
  setSaveStatus('saved');
}
function saveCurrentInstrument(){
  readNoteInputsIntoCFG();
  const rec=snapshotToDB();
  if(currentId&&DB.get(currentId)){DB.update(currentId,rec);}
  else{currentId=rec.id;DB.add(rec);}
  renderLibrary();setSaveStatus('saved');
}
function newInstrument(){
  currentId=null;
  document.getElementById('preset-select').value='';
  document.getElementById('nom-instrument').value='';
  document.getElementById('nom-joueur').value='';
  document.getElementById('date-creation').value=new Date().toISOString().slice(0,10);
  document.getElementById('nb-voix').value='2';
  renderVoixPerRow();
  (function(){const d=['B','N'];for(let i=0;i<2;i++){const s=document.getElementById('voix-v'+i);if(s)s.value=d[i];}})();
  document.getElementById('nb-voix-accords').value='2';
  document.getElementById('nb-voix-basses').value='2';
  document.getElementById('lh-separated').checked=true;
  CFG.lhRows=[{nb:6,offset:0}];
  loadPreset('GCD33');
  document.getElementById('preset-select').value='GCD33';
  renderLhRowsCfg();
  renderLibrary();setSaveStatus('dirty');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â”€â”€ Library â”€â”€ */
function renderLibrary(){
  const list=DB.all(),wrap=document.getElementById('lib-cards');
  if(!list.length){wrap.innerHTML=`<div class="lib-empty">${t('noSaved')}</div>`;return;}
  wrap.innerHTML=list.map(rec=>{
    const active=rec.id===currentId?' active':'';
    const d=rec.lastModified?new Date(rec.lastModified).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'2-digit'}):'â€”';
    const nb=rec.notes&&rec.notes.basses?rec.notes.basses.length:0;
    const info=`${rec.nbRangees} ${t('rows')} Â· ${nb} basses Â· ${rec.nbVoix||2} ${t('voices_')}`;
    return `<div class="instr-card${active}" id="card-${rec.id}">
      <div class="card-name">ï¿½ï¿½ ${escHTML(rec.nom)}</div>
      <div class="card-sub">${rec.joueur?'Client : '+escHTML(rec.joueur):'&nbsp;'}</div>
      <div class="card-meta">${info} Â· ${d}</div>
      <div class="card-btns">
        <button class="ca ca-edit" onclick="event.stopPropagation();editInstrument('${rec.id}')">${t('edit')}</button>
        <button class="ca ca-dup"  onclick="event.stopPropagation();duplicateInstrument('${rec.id}')">${t('copy')}</button>
        <button class="ca ca-del"  onclick="event.stopPropagation();deleteInstrument('${rec.id}')">${t('delete')}</button>
      </div></div>`;
  }).join('');
}
function editInstrument(id){const r=DB.get(id);if(!r)return;loadFromDB(r);renderLibrary();document.querySelector('.container').scrollIntoView({behavior:'smooth',block:'start'});scheduleLivePreview();}
function duplicateInstrument(id){const nid=DB.duplicate(id);renderLibrary();if(nid)editInstrument(nid);}
function deleteInstrument(id){const r=DB.get(id);if(!r)return;if(!confirm(t('deleteConfirm')(r.nom)))return;DB.delete(id);if(currentId===id){currentId=null;setSaveStatus('dirty');}renderLibrary();}

/* â”€â”€ Save status â”€â”€ */
function setSaveStatus(state){
  const el=document.getElementById('save-status');
  el.className=state;el.textContent=t(state)||t('saved');
}
function onAnyChange(){
  setSaveStatus('dirty');clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{if(currentId)saveCurrentInstrument();},1200);
  scheduleLivePreview();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  INIT                                                â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('date-creation').value=new Date().toISOString().slice(0,10);
  loadPresetIndex();
  renderVoixPerRow();
  initPicker();renderLibrary();
  const list=DB.all();
  if(list.length){loadFromDB(list[0]);}
  else{loadPreset('GCD33').then(()=>{document.getElementById('preset-select').value='GCD33';renderLhRowsCfg();});}
  scheduleLivePreview();
  // Event delegation: open picker when a note-input is clicked anywhere in #note-grid
  document.getElementById('note-grid').addEventListener('click',e=>{
    const inp=e.target.closest('.note-input');
    if(inp){e.stopPropagation();showPicker(inp);}
  });
  // Close picker when clicking outside it (use computed style so initial '' != 'none' doesn't trick us)
  document.addEventListener('click',e=>{
    const p=document.getElementById('note-picker');
    if(getComputedStyle(p).display!=='none'&&!p.contains(e.target)&&!e.target.closest('.note-input'))hidePicker();
  });
});

/* â”€â”€ Preset â”€â”€ */
async function loadPreset(key){
  if(!key||key==='custom'){renderRangeesCfg();generateInputGrid();onAnyChange();return;}
  let p;
  try{p=await fetchPresetData(key);}catch(e){console.warn('Preset not found:',key);return;}
  CFG.nbRangees=p.nbRangees;CFG.rangees=p.rangees.map(r=>({nom:r.nom,nb:r.nb,offset:r.offset||0}));
  CFG.notes=JSON.parse(JSON.stringify(p.notes));
  if(!CFG.notes.terzetto)CFG.notes.terzetto=[];
  // Reset lhRows to 1 row matching bass count
  CFG.lhRows=[{nb:Math.max(1,CFG.notes.basses.length),offset:0}];
  document.getElementById('nb-rangees').value=p.nbRangees;
  syncGaucheInputs();
  renderRangeesCfg();renderLhRowsCfg();generateInputGrid();onAnyChange();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  ROWS â€” RIGHT HAND                                   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function changeNbRangees(delta){
  const el=document.getElementById('nb-rangees');
  el.value=Math.max(1,Math.min(20,(parseInt(el.value)||3)+delta));
  onRangeesChange();
}
function onRangeesChange(){
  readNoteInputsIntoCFG();
  const nb=parseInt(document.getElementById('nb-rangees').value)||1;
  CFG.nbRangees=nb;
  while(CFG.rangees.length<nb)CFG.rangees.push({nom:`RangÃ©e ${CFG.rangees.length+1}`,nb:11});
  CFG.rangees=CFG.rangees.slice(0,nb);
  while(CFG.notes.droite.length<nb)CFG.notes.droite.push([]);
  CFG.notes.droite=CFG.notes.droite.slice(0,nb);
  renderRangeesCfg();generateInputGrid();onAnyChange();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  BASSES â€” LEFT HAND (free count)                     â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function changeGauche(key,delta){
  const el=document.getElementById('nb-'+key);
  el.value=Math.max(0,Math.min(60,(parseInt(el.value)||0)+delta));
  applyGaucheCount(key);
}
function applyGaucheCount(key){
  readNoteInputsIntoCFG();
  const el=document.getElementById('nb-'+key);
  const n=Math.max(0,Math.min(60,parseInt(el.value)||0));
  el.value=n;
  const resize=(arr,count)=>{const r=arr.slice(0,count);while(r.length<count)r.push({p:'',t:''});return r;};
  CFG.notes[key]=resize(CFG.notes[key]||[],n);
  if(key==='basses'){CFG.notes.basses2=resize(CFG.notes.basses2||[],n);CFG.notes.basses3=resize(CFG.notes.basses3||[],n);}
  if(key==='accords'){
    CFG.notes.accords2=resize(CFG.notes.accords2||[],n);CFG.notes.accords3=resize(CFG.notes.accords3||[],n);
    const terz=document.getElementById('terzetto-enabled');
    if(terz&&terz.checked) CFG.notes.terzetto=resize(CFG.notes.terzetto||[],n);
  }
  generateInputGrid();onAnyChange();
}
function setGauchePreset(nb,na,withTerzetto){
  readNoteInputsIntoCFG();
  const resize=(arr,n)=>{const r=arr.slice(0,n);while(r.length<n)r.push({p:'',t:''});return r;};
  document.getElementById('nb-basses').value=nb;
  document.getElementById('nb-accords').value=na;
  const terz=document.getElementById('terzetto-enabled');
  if(terz)terz.checked=!!withTerzetto;
  CFG.notes.basses=resize(CFG.notes.basses,nb);
  CFG.notes.basses2=resize(CFG.notes.basses2||[],nb);
  CFG.notes.basses3=resize(CFG.notes.basses3||[],nb);
  CFG.notes.accords=resize(CFG.notes.accords,na);
  CFG.notes.accords2=resize(CFG.notes.accords2||[],na);
  CFG.notes.accords3=resize(CFG.notes.accords3||[],na);
  CFG.notes.terzetto=resize(CFG.notes.terzetto,withTerzetto?na:0);
  generateInputGrid();onAnyChange();
}
function syncGaucheInputs(){
  const s=(k)=>{const el=document.getElementById('nb-'+k);if(el)el.value=(CFG.notes[k]||[]).length;};
  s('basses');s('accords');
  const terz=document.getElementById('terzetto-enabled');
  if(terz)terz.checked=(CFG.notes.terzetto||[]).length>0;
}
function onTerzettoChange(){
  readNoteInputsIntoCFG();
  const enabled=document.getElementById('terzetto-enabled').checked;
  const n=enabled?(CFG.notes.accords||[]).length:0;
  const resize=(arr,count)=>{const r=arr.slice(0,count);while(r.length<count)r.push({p:'',t:''});return r;};
  CFG.notes.terzetto=resize(CFG.notes.terzetto||[],n);
  generateInputGrid();onAnyChange();
}

function onLhModeChange(){renderLhRowsCfg();onAnyChange();}

function renderLhRowsCfg(){
  const wrap=document.getElementById('lh-rows-inner');
  if(!wrap)return;
  const isPaired=document.querySelector('input[name="lh-mode"]:checked')?.value==='paired';
  if(isPaired){
    const pprow=CFG.lhPairsPerRow||2;
    const totalDuos=Math.max(1,(CFG.notes&&CFG.notes.basses&&CFG.notes.basses.length)||6);
    wrap.innerHTML=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
      <span style="font-size:.78rem;min-width:80px;" data-i="lhNbDuosTotal">${t('lhNbDuosTotal')} :</span>
      <button type="button" class="rng-btn" onclick="lhSetTotalDuos(${totalDuos-1})">âˆ’</button>
      <span style="font-size:.82rem;font-weight:700;min-width:16px;text-align:center;">${totalDuos}</span>
      <button type="button" class="rng-btn" onclick="lhSetTotalDuos(${totalDuos+1})">ï¼‹</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <span style="font-size:.78rem;min-width:80px;" data-i="lhDuosPerRow">${t('lhDuosPerRow')} :</span>
      <button type="button" class="rng-btn" onclick="lhSetPairsPerRow(Math.max(1,${pprow}-1))">âˆ’</button>
      <span style="font-size:.82rem;font-weight:700;min-width:16px;text-align:center;">${pprow}</span>
      <button type="button" class="rng-btn" onclick="lhSetPairsPerRow(${pprow}+1)">ï¼‹</button>
    </div>`;
    return;
  }
  // Ensure lhRows is consistent: default to 1 row with all basses if missing
  if(!CFG.lhRows||!CFG.lhRows.length) CFG.lhRows=[{nb:Math.max(1,CFG.notes.basses.length),offset:0}];
  const nRows=CFG.lhRows.length;
  let html=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
    <span style="font-size:.78rem;">Nb lignes :</span>
    <button type="button" class="rng-btn" onclick="lhRowsSetN(Math.max(1,${nRows}-1))">âˆ’</button>
    <span style="font-size:.82rem;font-weight:700;min-width:16px;text-align:center;">${nRows}</span>
    <button type="button" class="rng-btn" onclick="lhRowsSetN(${nRows}+1)">ï¼‹</button>
  </div>`;
  CFG.lhRows.forEach((row,ri)=>{
    html+=`<div style="display:flex;align-items:center;gap:5px;font-size:.78rem;padding:2px 0;">
      <span style="min-width:42px;color:var(--gris);">L${ri+1} :</span>
      <button type="button" class="rng-btn" onclick="lhRowChange(${ri},'nb',Math.max(1,(CFG.lhRows[${ri}].nb||1)-1))">âˆ’</button>
      <input type="number" value="${row.nb}" min="1" max="30" style="width:46px;text-align:center;font-size:.78rem;padding:2px;" oninput="lhRowChange(${ri},'nb',Math.max(1,parseInt(this.value)||1))">
      <button type="button" class="rng-btn" onclick="lhRowChange(${ri},'nb',(CFG.lhRows[${ri}].nb||1)+1)">ï¼‹</button>
      <span style="color:var(--gris);margin-left:4px;">${t('rowOffset')} :</span>
      <button type="button" class="rng-btn" onclick="lhRowChange(${ri},'offset',(CFG.lhRows[${ri}].offset||0)-1)">âˆ’</button>
      <input type="number" value="${row.offset||0}" min="-30" max="30" style="width:46px;text-align:center;font-size:.78rem;padding:2px;" oninput="lhRowChange(${ri},'offset',parseInt(this.value)||0)">
      <button type="button" class="rng-btn" onclick="lhRowChange(${ri},'offset',(CFG.lhRows[${ri}].offset||0)+1)">ï¼‹</button>
    </div>`;
  });
  wrap.innerHTML=html;
  // Sync total basses count to sum of lhRows
  _syncBassesToLhRows();
}

function lhRowsSetN(n){
  n=Math.max(1,n);
  const cur=CFG.lhRows.length;
  if(n>cur){for(let i=cur;i<n;i++)CFG.lhRows.push({nb:1,offset:0});}
  else{CFG.lhRows=CFG.lhRows.slice(0,n);}
  _syncBassesToLhRows();
  renderLhRowsCfg();
  generateInputGrid();
  onAnyChange();
}

function lhRowChange(ri,field,val){
  CFG.lhRows[ri][field]=val;
  if(field==='nb'){
    readNoteInputsIntoCFG();
    _syncBassesToLhRows();
    generateInputGrid();
  }
  renderLhRowsCfg();
  onAnyChange();
}

function lhSetPairsPerRow(n){
  CFG.lhPairsPerRow=Math.max(1,Math.floor(n));
  renderLhRowsCfg();
  onAnyChange();
}

function lhSetTotalDuos(n){
  n=Math.max(1,Math.floor(n));
  readNoteInputsIntoCFG();
  const resize=(arr,count)=>{const r=arr.slice(0,count);while(r.length<count)r.push({p:'',t:''});return r;};
  CFG.notes.basses=resize(CFG.notes.basses||[],n);
  CFG.notes.basses2=resize(CFG.notes.basses2||[],n);
  CFG.notes.basses3=resize(CFG.notes.basses3||[],n);
  CFG.notes.accords=resize(CFG.notes.accords||[],n);
  CFG.notes.accords2=resize(CFG.notes.accords2||[],n);
  CFG.notes.accords3=resize(CFG.notes.accords3||[],n);
  const terz=document.getElementById('terzetto-enabled');
  if(terz&&terz.checked)CFG.notes.terzetto=resize(CFG.notes.terzetto||[],n);
  document.getElementById('nb-basses').value=n;
  document.getElementById('nb-accords').value=n;
  generateInputGrid();renderLhRowsCfg();onAnyChange();
}

function _syncBassesToLhRows(){
  // Total basses = sum of nb across all lhRows
  const total=CFG.lhRows.reduce((s,r)=>s+(r.nb||1),0);
  const resize=(arr,n)=>{const r=arr.slice(0,n);while(r.length<n)r.push({p:'',t:''});return r;};
  CFG.notes.basses=resize(CFG.notes.basses||[],total);
  CFG.notes.basses2=resize(CFG.notes.basses2||[],total);
  CFG.notes.basses3=resize(CFG.notes.basses3||[],total);
  // Also keep accords in sync (same count as basses by convention)
  CFG.notes.accords=resize(CFG.notes.accords||[],total);
  CFG.notes.accords2=resize(CFG.notes.accords2||[],total);
  CFG.notes.accords3=resize(CFG.notes.accords3||[],total);
  syncGaucheInputs();
}
function bassesOctaveShift(){
  readNoteInputsIntoCFG();
  const shiftUp=n=>{if(!n)return'';const m=n.match(/^(.+?)(\d+)$/);return m?m[1]+(parseInt(m[2])+1):n;};
  CFG.notes.basses2=CFG.notes.basses.map(b=>({p:shiftUp(b.p),t:shiftUp(b.t)}));
  CFG.notes.basses3=CFG.notes.basses2.map(b=>({p:shiftUp(b.p),t:shiftUp(b.t)}));
  generateInputGrid();onAnyChange();
}
function accordsFifthShift(){
  readNoteInputsIntoCFG();
  CFG.notes.accords2=(CFG.notes.accords||[]).map(a=>({p:shiftNote(a.p,7),t:shiftNote(a.t,7)}));
  generateInputGrid();onAnyChange();
}
function basseV2ToAccordV1Shift(){
  readNoteInputsIntoCFG();
  CFG.notes.accords=(CFG.notes.basses2||[]).map(b=>({p:shiftNote(b.p,12),t:shiftNote(b.t,12)}));
  generateInputGrid();onAnyChange();
}
function addGaucheBtn(key){
  readNoteInputsIntoCFG();CFG.notes[key].push({p:'',t:''});
  if(key==='basses'){CFG.notes.basses2.push({p:'',t:''});CFG.notes.basses3.push({p:'',t:''});}
  if(key==='accords'){CFG.notes.accords2.push({p:'',t:''});CFG.notes.accords3.push({p:'',t:''});}
  const el=document.getElementById('nb-'+key);if(el)el.value=CFG.notes[key].length;
  generateInputGrid();onAnyChange();
}
function removeGaucheBtn(key){
  readNoteInputsIntoCFG();
  if(CFG.notes[key].length>0){CFG.notes[key].pop();
    if(key==='basses'){if(CFG.notes.basses2.length>0)CFG.notes.basses2.pop();if(CFG.notes.basses3.length>0)CFG.notes.basses3.pop();}
    if(key==='accords'){if(CFG.notes.accords2.length>0)CFG.notes.accords2.pop();if(CFG.notes.accords3.length>0)CFG.notes.accords3.pop();}
    const el=document.getElementById('nb-'+key);if(el)el.value=CFG.notes[key].length;
    generateInputGrid();onAnyChange();}
}

/* â”€â”€ Read inputs back into CFG â”€â”€ */
function readNoteInputsIntoCFG(){
  const newD=[];
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nb:11};const row=[];
    for(let b=0;b<rc.nb;b++)row.push({p:val(`d-${r}-${b}-p`),t:val(`d-${r}-${b}-t`)});
    newD.push(row);
  }
  CFG.notes.droite=newD;
  const readRow=key=>{const n=(CFG.notes[key]||[]).length;const a=[];for(let b=0;b<n;b++)a.push({p:val(`g-${key}-${b}-p`),t:val(`g-${key}-${b}-t`)});return a;};
  CFG.notes.basses =readRow('basses');
  CFG.notes.basses2=readRow('basses2');
  CFG.notes.basses3=readRow('basses3');
  CFG.notes.accords =readRow('accords');
  CFG.notes.accords2=readRow('accords2');
  CFG.notes.accords3=readRow('accords3');
  CFG.notes.terzetto=readRow('terzetto');
}

/* â”€â”€ Render row configs â”€â”€ */
const REGISTERS=['B','N','N+','N-','A'];
const REGISTER_LABELS={'B':'B (16\' grave)','N':'N (8\' naturel 440)','N+':'N+ (8\'+ aigu)','N-':'N- (8\'- grave)','A':'A (4\' piccolo)'};
const REGISTER_LABELS_EN={'B':'B (16\' low)','N':'N (8\' natural 440)','N+':'N+ (8\'+ sharp)','N-':'N- (8\'- flat)','A':'A (4\' piccolo)'};
function renderRangeesCfg(){
  const wrap=document.getElementById('rangees-cfg');let html='';
  const rLabels=lang==='en'?REGISTER_LABELS_EN:REGISTER_LABELS;
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nom:`RangÃ©e ${r+1}`,nb:11,register:'N'};
    const reg=rc.register||'N';
    html+=`<div class="rangee-cfg">
      <label>R${r+1} â€” Nom</label>
      <input type="text" id="rnom-${r}" value="${esc(rc.nom)}" style="font-size:.76rem;padding:3px 6px;" onchange="CFG.rangees[${r}].nom=this.value;onAnyChange()">
      <label style="margin-top:3px;">Registre <span class="tip tip-up" tabindex="0" role="tooltip" aria-label="Info: Registre" data-tip="B (16') : une octave plus grave.&#10;N (8') : hauteur naturelle 440 Hz.&#10;N+ (8'+) : lÃ©gÃ¨rement plus haut (442 Hz).&#10;N- (8'-) : lÃ©gÃ¨rement plus bas (438 Hz).&#10;A (4') : une octave plus aigu (piccolo).&#10;â€”&#10;B(16')=low octave Â· N(8')=natural 440 Hz Â· N+(8'+)=+2Hz Â· N-(8'-)=-2Hz Â· A(4')=high octave">â“˜</span></label>
      <select id="rreg-${r}" style="font-size:.76rem;padding:3px 5px;" onchange="CFG.rangees[${r}].register=this.value;onAnyChange()">
        ${REGISTERS.map(rv=>`<option value="${rv}"${rv===reg?' selected':''}>${rLabels[rv]}</option>`).join('')}
      </select>
      <label style="margin-top:3px;">Boutons</label>
      <div class="rng-ctrl">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].nb=Math.max(1,(CFG.rangees[${r}].nb||11)-1);document.getElementById('rnb-${r}').value=CFG.rangees[${r}].nb;onRangeesChange()">âˆ’</button>
        <input type="number" id="rnb-${r}" value="${rc.nb}" min="1" max="30" style="width:54px;text-align:center;font-size:.82rem;padding:3px;font-weight:700;" oninput="CFG.rangees[${r}].nb=Math.max(1,parseInt(this.value)||1);onRangeesChange()">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].nb=Math.min(30,(CFG.rangees[${r}].nb||11)+1);document.getElementById('rnb-${r}').value=CFG.rangees[${r}].nb;onRangeesChange()">ï¼‹</button>
      </div>
      <label style="margin-top:3px;">${t('rowOffset')}</label>
      <div class="rng-ctrl">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].offset=Math.max(-30,(CFG.rangees[${r}].offset||0)-1);document.getElementById('roff-${r}').value=CFG.rangees[${r}].offset;scheduleLivePreview()">âˆ’</button>
        <input type="number" id="roff-${r}" value="${rc.offset||0}" min="-30" max="30" style="width:54px;text-align:center;font-size:.82rem;padding:3px;font-weight:700;" oninput="CFG.rangees[${r}].offset=Math.min(30,Math.max(-30,parseInt(this.value)||0));scheduleLivePreview()">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].offset=Math.min(30,(CFG.rangees[${r}].offset||0)+1);document.getElementById('roff-${r}').value=CFG.rangees[${r}].offset;scheduleLivePreview()">ï¼‹</button>
      </div></div>`;
  }
  wrap.innerHTML=html;
}

/* â”€â”€ Generate note input grid â”€â”€ */
function generateInputGrid(){
  let html='';
  // Right hand
  html+=`<div class="note-section"><div class="note-section-title">${t('rightHand')}</div>`;
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nom:`RangÃ©e ${r+1}`,nb:11};
    const nb=rc.nb;const notes=CFG.notes.droite[r]||[];
    const lbl=rc.nom.split(' ')[1]||`R${r+1}`;
    html+=`<div class="row-wrap"><div class="sec-label" style="margin-bottom:4px;">${esc(rc.nom)}</div><div class="btn-grid">`;
    for(let b=0;b<nb;b++){
      const n=notes[b]||{p:'',t:''};
      html+=`<div class="btn-cell">
        <div class="btn-num">${lbl} ${b+1}</div>
        <input class="note-input pousse" id="d-${r}-${b}-p" data-type="note" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" readonly>
        <input class="note-input tire"   id="d-${r}-${b}-t" data-type="note" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" readonly>
      </div>`;
    }
    html+=`</div></div>`;
  }
  html+=`</div>`;
  // Left hand â€” voice sections for basses and accords
  html+=`<div class="note-section"><div class="note-section-title">${t('leftHand')}</div>`;
  const nbVB=parseInt(document.getElementById('nb-voix-basses')?.value||'2');
  const nbVA=parseInt(document.getElementById('nb-voix-accords')?.value||'2');
  const _bCount=(CFG.notes.basses||[]).length;
  const _aCount=(CFG.notes.accords||[]).length;
  const _vkeys_b=['basses','basses2','basses3'];
  const _vkeys_a=['accords','accords2','accords3'];
  // Basses â€” one section per voice
  if(_bCount>0){
    for(let v=0;v<Math.min(nbVB,3);v++){
      const vkey=_vkeys_b[v];
      const arr=CFG.notes[vkey]||[];
      const label=t('basses')+(nbVB>1?` â€” V${v+1}`:'');
      html+=`<div class="row-wrap"><div class="sec-hd">
        <span class="sec-label">${label} <span style="color:var(--gris);font-weight:normal;">(${_bCount})</span></span>
        ${v===0?`<button type="button" class="rng-btn" onclick="removeGaucheBtn('basses')" title="âˆ’">âˆ’</button><button type="button" class="rng-btn" onclick="addGaucheBtn('basses')" title="ï¼‹">ï¼‹</button>${nbVB>1?`<button type="button" class="rng-btn" style="margin-left:6px;font-size:.7rem;padding:2px 6px;background:#e8f5e3;color:#1d6b23;" onclick="bassesOctaveShift()" title="Copier V1 â†’ V2 et V2 â†’ V3, chacune Ã  l'octave supÃ©rieure">â†‘8vaâ†’V2/V3</button>`:''}`:''}
      </div><div class="btn-grid">`;
      for(let b=0;b<_bCount;b++){
        const n=arr[b]||{p:'',t:''};
        html+=`<div class="btn-cell"><div class="btn-num">B${b+1}</div>
          <input class="note-input pousse" id="g-${vkey}-${b}-p" data-type="note" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" readonly>
          <input class="note-input tire"   id="g-${vkey}-${b}-t" data-type="note" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" readonly>
        </div>`;
      }
      html+=`</div></div>`;
    }
  }
  // Accords â€” one section per voice (individual notes, no chord notation)
  if(_aCount>0){
    for(let v=0;v<Math.min(nbVA,3);v++){
      const vkey=_vkeys_a[v];
      const arr=CFG.notes[vkey]||[];
      const label=t('accords')+(nbVA>1?` â€” V${v+1}`:'');
      html+=`<div class="row-wrap"><div class="sec-hd">
        <span class="sec-label">${label} <span style="color:var(--gris);font-weight:normal;">(${_aCount})</span></span>
        ${v===0?`<button type="button" class="rng-btn" onclick="removeGaucheBtn('accords')" title="âˆ’">âˆ’</button><button type="button" class="rng-btn" onclick="addGaucheBtn('accords')" title="ï¼‹">ï¼‹</button>${nbVA>1?`<button type="button" class="rng-btn" style="margin-left:6px;font-size:.7rem;padding:2px 6px;background:#e8f5e3;color:#1d6b23;" onclick="accordsFifthShift()" title="Copier Accords V1 â†’ V2 Ã  la quinte juste supÃ©rieure (+7 demi-tons)">â†‘5teâ†’V2</button>`:''}${nbVB>1?`<button type="button" class="rng-btn" style="margin-left:4px;font-size:.7rem;padding:2px 6px;background:#fff3cd;color:#856404;" onclick="basseV2ToAccordV1Shift()" title="Copier Basses V2 â†’ Accords V1 Ã  l'octave supÃ©rieure">B2+8vaâ†’A1</button>`:''}`:''}
      </div><div class="btn-grid">`;
      for(let b=0;b<_aCount;b++){
        const n=arr[b]||{p:'',t:''};
        html+=`<div class="btn-cell"><div class="btn-num">A${b+1}</div>
          <input class="note-input pousse" id="g-${vkey}-${b}-p" data-type="note" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" readonly>
          <input class="note-input tire"   id="g-${vkey}-${b}-t" data-type="note" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" readonly>
        </div>`;
      }
      html+=`</div></div>`;
    }
  }
  // Terzetto (kept as-is)
  if((CFG.notes.terzetto||[]).length>0){
    const arr=CFG.notes.terzetto||[];const count=arr.length;
    html+=`<div class="row-wrap"><div class="sec-hd">
      <span class="sec-label">${t('terzetto')} <span style="color:var(--gris);font-weight:normal;">(${count})</span></span>
      <button type="button" class="rng-btn" onclick="removeGaucheBtn('terzetto')" title="âˆ’">âˆ’</button>
      <button type="button" class="rng-btn" onclick="addGaucheBtn('terzetto')" title="ï¼‹">ï¼‹</button>
    </div><div class="btn-grid">`;
    for(let b=0;b<count;b++){
      const n=arr[b]||{p:'',t:''};
      html+=`<div class="btn-cell"><div class="btn-num">T${b+1}</div>
        <input class="note-input pousse" id="g-terzetto-${b}-p" data-type="note" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" readonly>
        <input class="note-input tire"   id="g-terzetto-${b}-t" data-type="note" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" readonly>
      </div>`;
    }
    html+=`</div></div>`;
  }
  html+=`</div>`;
  document.getElementById('note-grid').innerHTML=html;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  NOTE PICKER                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Notes shown in picker depend on current lang
const NOTES_FR={nat:['Do','RÃ©','Mi','Fa','Sol','La','Si'],sha:['Do#','RÃ©#',null,'Fa#','Sol#','La#',null],fla:['RÃ©b','Mib',null,'Solb','Lab','Sib',null]};
const NOTES_EN={nat:['C','D','E','F','G','A','B'],sha:['C#','D#',null,'F#','G#','A#',null],fla:['Db','Eb',null,'Gb','Ab','Bb',null]};
const OCTAVES=['2','3','4','5','6'];
const CHORDS_FR=()=>{const r=['Do','RÃ©','Mi','Fa','Sol','La','Si','Do#','RÃ©#','Fa#','Sol#','Sib','Mib','Lab'];const t=['Maj','Min','7','V'];const o=[];r.forEach(n=>t.forEach(q=>o.push(`${n} ${q}`)));return o;};
const CHORDS_EN=()=>{const r=['C','D','E','F','G','A','B','C#','D#','F#','G#','Bb','Eb','Ab'];const t=['Maj','Min','7','V'];const o=[];r.forEach(n=>t.forEach(q=>o.push(`${n} ${q}`)));return o;};

function initPicker(){
  const N=lang==='en'?NOTES_EN:NOTES_FR;
  document.getElementById('picker-naturals').innerHTML=N.nat.map(n=>`<button class="pn" onclick="pickerSetNote('${n}')">${n}</button>`).join('');
  document.getElementById('picker-sharps').innerHTML=N.sha.map(n=>n?`<button class="pn sharp" onclick="pickerSetNote('${n}')">${n}</button>`:`<span style="min-width:34px;"></span>`).join('');
  document.getElementById('picker-flats').innerHTML=N.fla.map(n=>n?`<button class="pn flat" onclick="pickerSetNote('${n}')">${n}</button>`:`<span style="min-width:34px;"></span>`).join('');
  const oWrap=document.getElementById('picker-octaves');
  oWrap.innerHTML=OCTAVES.map(o=>`<button class="po" onclick="pickerSetOctave('${o}')">${o}</button>`).join('');
}
function showPicker(input){
  pickerInput=input;pickerNote='';pickerOctave='';
  const v=input.value.trim();
  if(v){
    const m=v.match(/^(.+?)([2-6])$/);
    if(m){pickerNote=m[1];pickerOctave=m[2];}else pickerNote=v;
  }
  showPickerTab('notes',document.querySelector('.picker-tab-btn:first-child'));
  updatePickerHighlights();updatePickerPreview();
  const pk=document.getElementById('note-picker');pk.style.display='block';
  const rect=input.getBoundingClientRect(),sy=window.scrollY,sx=window.scrollX;
  let top=sy+rect.bottom+6,left=sx+rect.left;
  const pw=pk.offsetWidth||310,ph=pk.offsetHeight||300;
  if(left+pw>sx+window.innerWidth-10)left=sx+window.innerWidth-pw-10;
  if(left<8)left=8;
  if(top+ph>sy+window.innerHeight-10)top=sy+rect.top-ph-6;
  pk.style.top=top+'px';pk.style.left=left+'px';
  input.classList.add('picker-open');
}
function hidePicker(){
  document.getElementById('note-picker').style.display='none';
  if(pickerInput){pickerInput.classList.remove('picker-open');pickerInput=null;}
}
function showPickerTab(name,btn){
  document.querySelectorAll('.picker-tab-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById('picker-tab-notes').classList.toggle('active',name==='notes');
}
function pickerSetNote(n){pickerNote=n;updatePickerHighlights();updatePickerPreview();if(pickerNote&&pickerOctave)pickerInsert();}
function pickerSetOctave(o){pickerOctave=o;updatePickerHighlights();updatePickerPreview();if(pickerNote&&pickerOctave)pickerInsert();}
function pickerInsertDirect(text){
  if(!pickerInput)return;
  pickerInput.value=storageNote(text);
  pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  hidePicker();onAnyChange();
}
function pickerInsert(){
  if(!pickerInput)return;
  const v=pickerNote+pickerOctave;if(!v)return;
  pickerInput.value=storageNote(v);
  pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  hidePicker();onAnyChange();
}
function pickerClear(){
  if(!pickerInput)return;
  pickerInput.value='';pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  pickerNote='';pickerOctave='';updatePickerHighlights();updatePickerPreview();hidePicker();onAnyChange();
}
function updatePickerHighlights(){
  document.querySelectorAll('#picker-tab-notes .pn').forEach(b=>b.classList.toggle('selected',b.textContent===pickerNote));
  document.querySelectorAll('.po').forEach(b=>b.classList.toggle('selected',b.textContent===pickerOctave));
}
function updatePickerPreview(){
  const txt=pickerNote+pickerOctave;
  document.getElementById('picker-preview-text').textContent=txt||t('selectNoteOctave');
  const showMidi=document.getElementById('show-midi')?.checked;
  const badge=document.getElementById('picker-midi-badge');
  if(badge){
    const m=txt?noteToMidi(storageNote(txt)):null;
    badge.textContent=(showMidi&&m!==null)?`MIDI ${m}`:'';
  }
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  READ INPUTS â†’ data object                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function readInputs(){
  readNoteInputsIntoCFG();
  // capture register from selects
  for(let r=0;r<CFG.nbRangees;r++){
    const sel=document.getElementById(`rreg-${r}`);
    if(sel)CFG.rangees[r].register=sel.value;
  }
  const droite=CFG.notes.droite.map((row,ri)=>({
    nom:CFG.rangees[ri]?CFG.rangees[ri].nom:`RangÃ©e ${ri+1}`,
    register:(CFG.rangees[ri]||{}).register||'N',
    offset:(CFG.rangees[ri]||{}).offset||0,
    boutons:row
  }));
  return{
    nomInstrument:val('nom-instrument')||'AccordÃ©on Diatonique',
    nomJoueur:val('nom-joueur'),
    nomLuthier:val('nom-luthier')||"Ewen d'Aviau",
    date:val('date-creation'),
    nbVoix:parseInt(document.getElementById('nb-voix').value),
    voixPerRow:readVoixPerRow(),
    nbVoixAccords:parseInt(document.getElementById('nb-voix-accords')?.value||'2'),
    nbVoixBasses:parseInt(document.getElementById('nb-voix-basses')?.value||'2'),
    lhDisplayMode:document.querySelector('input[name="lh-mode"]:checked')?.value||'separated',
    lhRows:JSON.parse(JSON.stringify(CFG.lhRows)),
    lhPairsPerRow:CFG.lhPairsPerRow||2,
    showMidi:document.getElementById('show-midi')?.checked||false,
    droite,
    basses:CFG.notes.basses,
    basses2:CFG.notes.basses2||[],
    basses3:CFG.notes.basses3||[],
    accords:CFG.notes.accords,
    accords2:CFG.notes.accords2||[],
    accords3:CFG.notes.accords3||[],
    terzetto:CFG.notes.terzetto||[],
    orderSpecs:{
      qty:val('order-qty')||'1',
      reedType:val('order-reed-type'),
      tuning:document.getElementById('order-tuning')?.value||'440',
      tremolo:val('order-tremolo'),
      harmony:val('order-harmony'),
      bassType:val('order-bass-type'),
      bassComp:val('order-bass-comp'),
    },
  };
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG HELPERS                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function svg_open(w,h,bg){return`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" font-family="Arial,Helvetica,sans-serif"><rect width="${w}" height="${h}" fill="${bg||'white'}"/>`;}
function tx(x,y,text,size,fill,weight,anchor){return`<text x="${x}" y="${y}" font-size="${size}" fill="${fill}" font-weight="${weight||'normal'}" text-anchor="${anchor||'start'}">${text}</text>`;}
function esc(s){if(!s)return'';return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escSVG(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escHTML(s){if(!s)return'';const d=document.createElement('div');d.appendChild(document.createTextNode(String(s)));return d.innerHTML;}
function fmtDate(d){if(!d)return new Date().toLocaleDateString('fr-FR');try{return new Date(d).toLocaleDateString('fr-FR');}catch(e){return d;}}
function dn(note){return escSVG(displayNote(note));}  // display note in current lang
/* Render a button value (single note OR "N1/N2/N3") as SVG text centred at (cx,baseY).
   For multi-note values the notes are stacked vertically (tspan lines). */
function svgBtnVal(v,cx,baseY,color){
  if(!v)return'';
  const disp=displayNote(v);
  if(!disp.includes('/')){
    const fs=disp.length>8?5.5:disp.length>5?6.8:8;
    return tx(cx,baseY,escSVG(disp),fs,color,'bold','middle');
  }
  const parts=disp.split('/').map(p=>p.trim()).filter(Boolean);
  const lineH=6.5, fs=5.5;
  const startY=baseY-((parts.length-1)*lineH)/2;
  let out=`<text font-size="${fs}" fill="${color}" font-weight="bold" text-anchor="middle">`;
  parts.forEach((p,i)=>out+=`<tspan x="${cx}" y="${startY+i*lineH}">${escSVG(p)}</tspan>`);
  return out+'</text>';
}

/* â”€â”€â”€ Bellows SVG â”€â”€â”€ */
function bellowsSVG(x,y,w,h,folds,dark){
  const gold=dark?'#c9a227':'#8b6914',bg=dark?'#0a0800':'#fff8e6';
  let s=`<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${bg}" rx="2"/>`;
  const fh=h/folds;
  for(let i=0;i<folds;i++){
    const fy1=y+i*fh,fy2=fy1+fh,mid=fy1+fh/2;
    s+=`<line x1="${x}" y1="${fy1}" x2="${x+w}" y2="${fy1}" stroke="${gold}" stroke-width=".6" opacity=".7"/>`;
    s+=`<line x1="${x}" y1="${fy1}" x2="${x+w/2}" y2="${mid}" stroke="${gold}" stroke-width=".9"/>`;
    s+=`<line x1="${x+w/2}" y1="${mid}" x2="${x+w}" y2="${fy1}" stroke="${gold}" stroke-width=".9"/>`;
    if(i<folds-1){
      s+=`<line x1="${x}" y1="${fy2}" x2="${x+w/2}" y2="${mid}" stroke="${gold}" stroke-width=".6" opacity=".5"/>`;
      s+=`<line x1="${x+w/2}" y1="${mid}" x2="${x+w}" y2="${fy2}" stroke="${gold}" stroke-width=".6" opacity=".5"/>`;
    }
  }
  s+=`<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="none" stroke="${gold}" stroke-width="1.5" rx="2"/>`;
  return s;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG KEYBOARD â€” CLIENT (light preview + dark PDF)    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSVG_Droite(data,dark){
  const R=24,HGAP=60,VGAP=72,LPAD=186,MARG=14,HEAD=80,FOOT=34;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111111':'#ffffff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const subtl=dark?'#888866':'#888888',stroke=dark?'#c9a227':'#2d5a27';
  const band1=dark?'#1a1a1a':'#fafafa',band2=dark?'#161616':'#f3f7f3';
  const numTx=dark?'rgba(200,162,39,.3)':'rgba(0,0,0,.2)';

  const maxBtns=Math.max(...data.droite.map(r=>r.boutons.length),1);
  const allOffs=data.droite.map(r=>r.offset||0);
  const maxOff=Math.max(...allOffs,0);
  const minOff=Math.min(...allOffs,0);
  const leftShift=-minOff*(HGAP/2);
  const BASE=LPAD+leftShift;
  const W=BASE+maxBtns*HGAP+maxOff*(HGAP/2)+(data.droite.length>1?HGAP/2:0)+MARG;
  const H=MARG+HEAD+data.droite.length*VGAP+FOOT;

  let s=svg_open(W,H,bg);

  // Orientation arrows â€” horizontal across the top
  const arrowY=MARG+HEAD-10;
  const ax1=BASE,ax2=W-MARG-2;
  const arrowMid=(ax1+ax2)/2;
  s+=`<line x1="${ax1+2}" y1="${arrowY}" x2="${ax2-2}" y2="${arrowY}" stroke="${gold}" stroke-width="1" opacity=".5"/>`;
  s+=`<polygon points="${ax1+2},${arrowY} ${ax1+10},${arrowY-4} ${ax1+10},${arrowY+4}" fill="${gold}" opacity=".7"/>`;
  s+=`<polygon points="${ax2-2},${arrowY} ${ax2-10},${arrowY-4} ${ax2-10},${arrowY+4}" fill="${gold}" opacity=".7"/>`;
  s+=tx(ax1+14,arrowY+4,t('svgLow'),8,gold,'bold','start');
  s+=tx(ax2-14,arrowY+4,t('svgHigh'),8,gold,'bold','end');

  // Title
  s+=tx(BASE+(maxBtns*HGAP)/2,MARG+16,escSVG(data.nomInstrument),16,gold,'bold','middle');
  if(data.nomJoueur)s+=tx(BASE+(maxBtns*HGAP)/2,MARG+32,`${t('svgClient')} : ${escSVG(data.nomJoueur)}`,10,subtl,'normal','middle');
  s+=tx(BASE+(maxBtns*HGAP)/2,MARG+47,`${t('svgLuthier')} : ${escSVG(data.nomLuthier)}  Â·  ${fmtDate(data.date)}`,9,subtl,'normal','middle');

  // Legend â€“ split circle (push=top half, pull=bottom half)
  const lx=BASE,ly=MARG+62;
  const lr=10,lcx=lx+lr,lcy=ly-4;
  s+=`<circle cx="${lcx}" cy="${lcy}" r="${lr}" fill="${bg}" stroke="${stroke}" stroke-width="1.2"/>`;
  s+=`<path d="M${lcx-lr},${lcy} A${lr},${lr} 0 0,1 ${lcx+lr},${lcy}" fill="${pushBg}"/>`;
  s+=`<path d="M${lcx-lr},${lcy} A${lr},${lr} 0 0,0 ${lcx+lr},${lcy}" fill="${pullBg}"/>`;
  s+=`<circle cx="${lcx}" cy="${lcy}" r="${lr}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
  s+=`<line x1="${lcx-lr}" y1="${lcy}" x2="${lcx+lr}" y2="${lcy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
  s+=tx(lcx+lr+5,lcy-1,t('svgPush'),8,dark?'#ccc':'#333','normal','start');
  s+=tx(lcx+lr+5,lcy+9,t('svgPull'),8,dark?'#ccc':'#333','normal','start');

  // Rows
  data.droite.forEach((row,ri)=>{
    const cy=MARG+HEAD+ri*VGAP+VGAP/2;
    const stagger=(ri%2===1)?HGAP/2:0;
    const alignOff=(row.offset||0)*(HGAP/2);
    s+=`<rect x="${BASE+alignOff-4}" y="${cy-R-6}" width="${row.boutons.length*HGAP+stagger+8}" height="${(R+6)*2}" rx="4" fill="${ri%2===0?band1:band2}" opacity=".7"/>`;
    s+=tx(BASE+alignOff-8,cy+4,escSVG(row.nom),9.5,gold,'bold','end');
    row.boutons.forEach((btn,bi)=>{
      const cx=BASE+alignOff+stagger+bi*HGAP;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#ffffff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
      s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
      s+=tx(cx,cy+3.5,bi+1,7.5,numTx,'normal','middle');
      if(btn.p){const fs=btn.p.length>6?7:8.5;s+=tx(cx,cy-9,dn(btn.p),fs,pushTx,'bold','middle');}
      if(btn.t){const fs=btn.t.length>6?7:8.5;s+=tx(cx,cy+19,dn(btn.t),fs,pullTx,'bold','middle');}
      if(data.showMidi){
        const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);
        if(mp!==null)s+=tx(cx+R-2,cy-R+6,mp,5.5,'rgba(100,140,220,.8)','normal','end');
        if(mt!==null)s+=tx(cx+R-2,cy+R-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
      }
    });
  });

  const fy=MARG+HEAD+data.droite.length*VGAP+14;
  s+=`<line x1="${BASE}" y1="${fy}" x2="${W-MARG-44}" y2="${fy}" stroke="${dark?'#333':'#eee'}" stroke-width="1"/>`;
  s+=tx(BASE,fy+14,`${escSVG(data.nomLuthier)} â€” ewendaviau.com`,7.5,dark?'#444':'#bbb','normal','start');
  s+='</svg>';return s;
}

function buildSVG_Gauche(data,dark){
  const R=24,HGAP=62,VGAP=70,LPAD=140,MARG=12,HEAD=32,FOOT=20;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111':'#fff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const stroke=dark?'#c9a227':'#2d5a27';
  const band1=dark?'#1a1a1a':'#fafafa',band2=dark?'#161616':'#f3f7f3';
  const numTx=dark?'rgba(200,162,39,.3)':'rgba(0,0,0,.2)';

  // Paired mode: B1 A1 B2 A2 / B3 A3 B4 A4 / â€¦ (PPROW pairs per display row)
  if(data.lhDisplayMode==='paired'){
    const PPROW=Math.max(1,data.lhPairsPerRow||2); // pairs per display row
    const nPairs=Math.max(data.basses.length,data.accords.length);
    const nDispRows=Math.ceil(nPairs/PPROW);
    const nCols=PPROW*2;
    const bassLbl=dark?'#5aa0d0':'#1a4c9c';
    const accLbl=dark?'#d09040':'#8b6914';
    const gridCol=dark?'#3a3a3a':'#d0d0d0';
    const W=LPAD+nCols*HGAP+MARG;
    const H=MARG+HEAD+nDispRows*VGAP+FOOT;
    let s=svg_open(W,H,bg);
    s+=tx(W/2,MARG+16,`${t('svgLH')} â€” ${escSVG(data.nomInstrument)}`,12,gold,'bold','middle');
    for(let r=0;r<nDispRows;r++){
      const cy=MARG+HEAD+r*VGAP+VGAP/2;
      s+=`<rect x="${LPAD-4}" y="${cy-R-6}" width="${nCols*HGAP+8}" height="${(R+6)*2}" rx="4" fill="${r%2===0?band1:band2}" opacity=".7"/>`;
      if(r>0){const yh=MARG+HEAD+r*VGAP;s+=`<line x1="${LPAD-4}" y1="${yh}" x2="${W-MARG}" y2="${yh}" stroke="${gridCol}" stroke-width="1"/>`;}
      for(let q=0;q<PPROW;q++){
        const pi=r*PPROW+q;
        if(pi>=nPairs)break;
        [[data.basses[pi],'B',q*2,bassLbl],[data.accords[pi],'A',q*2+1,accLbl]].forEach(([btn,lbl,col,lblCol])=>{
          if(!btn)return;
          const cx=LPAD+col*HGAP;
          s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#fff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
          s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
          s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
          s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
          s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
          s+=tx(cx,cy+3.5,pi+1,7.5,numTx,'normal','middle');
          s+=tx(cx-R+5,cy-R+8,lbl,7,lblCol,'bold','start');
          if(btn.p)s+=svgBtnVal(btn.p,cx,cy-9,pushTx);
          if(btn.t)s+=svgBtnVal(btn.t,cx,cy+19,pullTx);          if(data.showMidi){
            const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);
            if(mp!==null)s+=tx(cx+R-2,cy-R+6,mp,5.5,'rgba(100,140,220,.8)','normal','end');
            if(mt!==null)s+=tx(cx+R-2,cy+R-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
          }
        });
      }
    }
    s+='</svg>';return s;
  }

  // Separated mode: multi-row basses/accords via lhRows
  const lhRows=(data.lhRows&&data.lhRows.length)?data.lhRows:[{nb:data.basses.length||1,offset:0}];
  const secRows=[];
  let bassIdx=0,accordIdx=0;
  const vA=data.nbVoixAccords||2,vB=data.nbVoixBasses||2;
  // Accords (outer rows, displayed first)
  lhRows.forEach((row,ri)=>{
    secRows.push({nom:lhRows.length===1?t('accords'):(ri===0?t('accords'):`  â†³ +${accordIdx}`),items:data.accords.slice(accordIdx,accordIdx+row.nb),offset:row.offset||0,type:'A',voix:vA});
    accordIdx+=row.nb;
  });
  // Basses (inner rows, displayed second)
  lhRows.forEach((row,ri)=>{
    secRows.push({nom:lhRows.length===1?t('basses'):(ri===0?t('basses'):`  â†³ +${bassIdx}`),items:data.basses.slice(bassIdx,bassIdx+row.nb),offset:row.offset||0,type:'B',voix:vB});
    bassIdx+=row.nb;
  });
  if(data.terzetto&&data.terzetto.length)secRows.push({nom:t('terzetto'),items:data.terzetto,offset:0,type:'T',voix:null});

  const maxItems=Math.max(...secRows.map(sc=>sc.items.length),1);
  const maxSecOff=Math.max(...secRows.map(sc=>sc.offset||0),0);
  const W=LPAD+maxItems*HGAP+maxSecOff*(HGAP/2)+MARG;
  const H=MARG+HEAD+secRows.length*VGAP+FOOT;

  let s=svg_open(W,H,bg);
  s+=tx(W/2,MARG+16,`${t('svgLH')} â€” ${escSVG(data.nomInstrument)}`,12,gold,'bold','middle');
  // Pass 1: alternating row bands + row labels
  secRows.forEach((sec,si)=>{
    const off=(sec.offset||0)*(HGAP/2);
    const cy=MARG+HEAD+si*VGAP+VGAP/2;
    if(sec.items.length)
      s+=`<rect x="${LPAD-4+off}" y="${cy-R-6}" width="${sec.items.length*HGAP+8}" height="${(R+6)*2}" rx="4" fill="${si%2===0?band1:band2}" opacity=".7"/>`;
    s+=tx(LPAD-R-10,cy,escSVG(sec.nom),10,gold,'bold','end');
    if(sec.voix!==null&&sec.voix!==undefined)s+=tx(LPAD-R-10,cy+11,`${sec.voix}v`,7.5,dark?'rgba(200,162,39,.6)':'rgba(45,90,39,.55)','normal','end');
  });
  // Pass 2: table grid (column + row separator lines, outer border, column numbers)
  if(secRows.length>0&&maxItems>0){
    const gTop=MARG+HEAD,gBot=MARG+HEAD+secRows.length*VGAP;
    const gLeft=LPAD-HGAP/2,gRight=LPAD+maxItems*HGAP-HGAP/2;
    const gridCol=dark?'#3a3a3a':'#d0d0d0';
    s+=`<rect x="${gLeft}" y="${gTop}" width="${gRight-gLeft}" height="${gBot-gTop}" fill="none" stroke="${dark?'#555':'#aaa'}" stroke-width="1.2" rx="2"/>`;
    for(let ci=1;ci<maxItems;ci++){const xv=LPAD+ci*HGAP-HGAP/2;s+=`<line x1="${xv}" y1="${gTop}" x2="${xv}" y2="${gBot}" stroke="${gridCol}" stroke-width="1"/>`;}
    for(let ri=1;ri<secRows.length;ri++){const yh=gTop+ri*VGAP;s+=`<line x1="${gLeft}" y1="${yh}" x2="${gRight}" y2="${yh}" stroke="${gridCol}" stroke-width="1"/>`;}
    for(let ci=0;ci<maxItems;ci++){s+=tx(LPAD+ci*HGAP,gTop-5,ci+1,7,dark?'rgba(200,162,39,.5)':'rgba(0,0,0,.3)','normal','middle');}
  }
  // Pass 3: buttons on top of grid
  secRows.forEach((sec,si)=>{
    const off=(sec.offset||0)*(HGAP/2);
    const cy=MARG+HEAD+si*VGAP+VGAP/2;
    sec.items.forEach((btn,bi)=>{
      const cx=LPAD+bi*HGAP+off;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#fff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
      s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
      s+=tx(cx,cy+3.5,bi+1,7.5,numTx,'normal','middle');
      if(btn.p)s+=svgBtnVal(btn.p,cx,cy-9,pushTx);
      if(btn.t)s+=svgBtnVal(btn.t,cx,cy+19,pullTx);      if(data.showMidi){
        const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);
        if(mp!==null)s+=tx(cx+R-2,cy-R+6,mp,5.5,'rgba(100,140,220,.8)','normal','end');
        if(mt!==null)s+=tx(cx+R-2,cy+R-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
      }
    });
  });
  s+='</svg>';return s;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG SOMMIER (reed plate view)                       â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  VOICE TYPE HELPERS                                  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VOICE_TYPE_DATA={
  'N' :{label:'N',  oct:0,  reg:"8'",   desc:"Naturel 8'"},
  'N+':{label:'N+', oct:0,  reg:"8'+",  desc:"Naturel 8' enrichi +"},
  'N-':{label:'N-', oct:0,  reg:"8'-",  desc:"Naturel 8' enrichi -"},
  'B' :{label:'B',  oct:-1, reg:"16'",  desc:"Basse 16'"},
  'A' :{label:'A',  oct:+1, reg:"4'",   desc:"Aigu 4'"},
};
function readVoixPerRow(){
  const nb=parseInt(document.getElementById('nb-voix')?.value)||2;
  const arr=[];
  for(let i=0;i<nb;i++){const s=document.getElementById('voix-v'+i);arr.push(s?s.value:null);}
  return arr;
}
function renderVoixPerRow(){
  const nb=parseInt(document.getElementById('nb-voix')?.value)||2;
  const wrap=document.getElementById('voix-per-row-wrap');if(!wrap)return;
  const prev=readVoixPerRow();
  const opts=['N','N+','N-','B','A'];
  const lbl={'N':"N â€” 8' naturel",'N+':"N+ â€” 8' +",'N-':"N- â€” 8' -",'B':"B â€” 16' basse",'A':"A â€” 4' aigu"};
  const dflt=['B','N','A'];
  wrap.innerHTML=Array.from({length:nb},(_,i)=>{
    const val=prev[i]||dflt[i]||'N';
    return `<div style="display:flex;align-items:center;gap:6px;margin-top:3px;">
      <span style="font-size:.78rem;color:#888;min-width:46px;">Voix ${i+1}</span>
      <select id="voix-v${i}" onchange="onAnyChange()" style="font-size:.82rem;flex:1;">
        ${opts.map(o=>`<option value="${o}"${o===val?' selected':''}>${lbl[o]}</option>`).join('')}
      </select></div>`;
  }).join('');
}
function shiftOctave(noteStr,octaves){
  if(!noteStr||!octaves)return noteStr;
  const m=noteStr.match(/^(.+?)(\d+)$/);
  if(!m)return noteStr;
  return m[1]+Math.max(0,parseInt(m[2])+octaves);
}
function expandVoicesForSommier(rows,voixPerRow){
  const legacyMap={N:['N'],BN:['B','N'],NH:['N','A'],BNH:['B','N','A']};
  const arr=Array.isArray(voixPerRow)?voixPerRow:(legacyMap[voixPerRow]||['N']);
  if(arr.length<=1)return rows;
  const result=[];
  for(const row of rows){
    for(const vtype of arr){
      const vd=VOICE_TYPE_DATA[vtype]||VOICE_TYPE_DATA['N'];
      result.push({
        nom:row.nom+' â€” '+vd.label+' ('+vd.reg+')',
        boutons:(row.boutons||[]).map(b=>({p:shiftOctave(b.p,vd.oct),t:shiftOctave(b.t,vd.oct)})),
        offset:row.offset||0
      });
    }
  }
  return result;
}
function buildSommierSection(title,rows,dark){
  const CW=58,CH=46,MARG=12,HEAD=52,VGAP=CH+6,FOOT=20;
  // Compute LPAD dynamically from the longest row label
  // Estimate: ~5.6px per char at font-size 9 bold + 14px padding
  const maxLabelLen=Math.max(...rows.map(r=>(r.nom||r.label||'').length),0);
  const LPAD=Math.max(120,Math.ceil(maxLabelLen*5.6)+14);
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111':'#fff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const numTx=dark?'rgba(200,162,39,.4)':'rgba(0,0,0,.3)';
  const sep=dark?'#3a3a1a':'#cccccc';
  const showMidi=document.getElementById('show-midi')?.checked;

  function cell(cx,cy,num,pNote,tNote){
    let o='';
    o+=`<rect x="${cx}" y="${cy}" width="${CW}" height="${CH/2}" fill="${pushBg}" stroke="${dark?'#2a4a2a':'#b0ccb0'}" stroke-width=".7"/>`;
    o+=`<rect x="${cx}" y="${cy+CH/2}" width="${CW}" height="${CH/2}" fill="${pullBg}" stroke="${dark?'#4a2a00':'#ccb080'}" stroke-width=".7"/>`;
    o+=`<line x1="${cx}" y1="${cy+CH/2}" x2="${cx+CW}" y2="${cy+CH/2}" stroke="${sep}" stroke-width=".8"/>`;
    o+=tx(cx+3,cy+9,num,6.5,numTx,'normal','start');
    if(pNote){const fs=pNote.length>6?7:8.5;o+=tx(cx+CW/2,cy+16,dn(pNote),fs,pushTx,'bold','middle');}
    if(tNote){const fs=tNote.length>6?7:8.5;o+=tx(cx+CW/2,cy+CH-7,dn(tNote),fs,pullTx,'bold','middle');}
    if(showMidi){
      const mp=noteToMidi(pNote),mt=noteToMidi(tNote);
      if(mp!==null)o+=tx(cx+CW-2,cy+9,mp,5.5,'rgba(100,140,220,.8)','normal','end');
      if(mt!==null)o+=tx(cx+CW-2,cy+CH-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
    }
    return o;
  }

  const maxBtns=Math.max(...rows.map(r=>r.boutons?r.boutons.length:(r.items?r.items.length:0)),1);
  const allOffs=rows.map(r=>r.offset||0);
  const maxOff=Math.max(...allOffs,0);
  const minOff=Math.min(...allOffs,0);
  const leftShift=-minOff*(CW/2);
  const RBASE=LPAD+leftShift;
  const W=RBASE+maxBtns*CW+maxOff*(CW/2)+MARG;
  const H=MARG+HEAD+rows.length*VGAP+FOOT;
  let s=svg_open(W,H,bg);

  // Header
  s+=tx(W/2,MARG+15,escSVG(title),12,gold,'bold','middle');
  s+=`<rect x="${RBASE}" y="${MARG+25}" width="13" height="8" rx="1" fill="${pushBg}" stroke="${dark?'#4a7a40':'#2d5a27'}" stroke-width=".8"/>`;
  s+=tx(RBASE+17,MARG+33,t('svgPush'),7.5,dark?'#ccc':'#333','normal','start');
  s+=`<rect x="${RBASE+68}" y="${MARG+25}" width="13" height="8" rx="1" fill="${pullBg}" stroke="${dark?'#c9a227':'#c8a96e'}" stroke-width=".8"/>`;
  s+=tx(RBASE+85,MARG+33,t('svgPull'),7.5,dark?'#ccc':'#333','normal','start');
  if(showMidi)s+=tx(RBASE+135,MARG+33,'MIDI = coin â†—',7,dark?'rgba(100,140,220,.8)':'rgba(21,101,192,.6)','normal','start');

  rows.forEach((row,ri)=>{
    const rowY=MARG+HEAD+ri*VGAP;
    const nom=row.nom||(row.label||`R${ri+1}`);
    const items=row.boutons||row.items||[];
    const alignOff=(row.offset||0)*(CW/2);
    s+=tx(RBASE+alignOff-5,rowY+CH/2+4,escSVG(nom),9,gold,'bold','end');
    items.forEach((btn,bi)=>{s+=cell(RBASE+alignOff+bi*CW,rowY,bi+1,btn.p||'',btn.t||'');});
  });
  s+='</svg>';return s;
}

function buildLhSommierSections(data){
  const lhRows=(data.lhRows&&data.lhRows.length)?data.lhRows:[{nb:Math.max(data.basses.length,data.accords.length)||1,offset:0}];
  const lhSections=[];
  let bIdx=0,aIdx=0;
  const vB=data.nbVoixBasses||2, vA=data.nbVoixAccords||2;
  lhRows.forEach((row,ri)=>{
    const rowLabel=lhRows.length===1?'':`${ri+1}`;
    const bSlice=data.basses?data.basses.slice(bIdx,bIdx+row.nb):[];
    const aSlice=data.accords?data.accords.slice(aIdx,aIdx+row.nb):[];
    if(bSlice.length){
      const basNom=lhRows.length===1?t('basses'):t('basses')+' '+rowLabel;
      const _bkeys=['basses','basses2','basses3'];
      for(let v=0;v<vB;v++){
        const vSlice=(data[_bkeys[v]]||data.basses||[]).slice(bIdx,bIdx+row.nb);
        lhSections.push({nom:basNom+(vB>1?` â€” V${v+1}`:''),items:vSlice,offset:row.offset||0});
      }
    }
    if(aSlice.length){
      const accNom=lhRows.length===1?t('accords'):t('accords')+' '+rowLabel;
      const _akeys=['accords','accords2','accords3'];
      for(let v=0;v<vA;v++){
        const vSlice=(data[_akeys[v]]||data.accords||[]).slice(aIdx,aIdx+row.nb);
        lhSections.push({nom:accNom+(vA>1?` â€” V${v+1}`:''),items:vSlice,offset:row.offset||0});
      }
    }
    bIdx+=row.nb;aIdx+=row.nb;
  });
  if(data.terzetto&&data.terzetto.length)lhSections.push({nom:t('terzetto'),items:data.terzetto,offset:0});
  return lhSections;
}
function buildSommierSVG(data,dark){
  const rhTitle=t('svgSommierRH')+' â€” '+escSVG(data.nomInstrument);
  const lhTitle=t('svgSommierLH')+' â€” '+escSVG(data.nomInstrument);
  const lhSections=buildLhSommierSections(data);
  const svgD=buildSommierSection(rhTitle,expandVoicesForSommier(data.droite,data.voixPerRow||['N']),dark);
  const svgG=lhSections.length?buildSommierSection(lhTitle,lhSections,dark):'';
  const h3style=`color:#1d6b23;font-size:.88rem;margin-bottom:10px;`;
  const h3dstyle=`color:#c9a227;font-size:.88rem;margin-bottom:10px;`;
  return `<h3 style="${dark?h3dstyle:h3style}">${t('svgRH')}</h3>${svgD}
    <h3 style="${dark?h3dstyle:h3style};margin-top:18px;">${t('svgLH')}</h3>${svgG}`;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LIVE PREVIEW                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Scale svgTgt to same natural width as svgRef (centers content via viewBox offset).
   This ensures CSS max-width:100% scales both SVGs identically â†’ same visual text size. */
function matchSvgWidth(svgRef,svgTgt){
  const wRef=+(svgRef.match(/\bwidth="(\d+(?:\.\d+)?)"/)||[,0])[1];
  const wTgt=+(svgTgt.match(/\bwidth="(\d+(?:\.\d+)?)"/)||[,0])[1];
  const hTgt=+(svgTgt.match(/\bheight="(\d+(?:\.\d+)?)"/)||[,0])[1];
  if(wRef<=wTgt||wTgt===0)return svgTgt;
  const xOff=(wRef-wTgt)/2;
  return svgTgt.replace(/<svg [^>]+>/,
    `<svg width="${wRef}" height="${hTgt}" viewBox="${-xOff} 0 ${wRef} ${hTgt}" xmlns="http://www.w3.org/2000/svg" font-family="Arial,Helvetica,sans-serif">`);
}

function scheduleLivePreview(){clearTimeout(previewTimer);previewTimer=setTimeout(runLivePreview,600);}
function forcePreview(){clearTimeout(previewTimer);runLivePreview();}
function runLivePreview(){
  try{
    readNoteInputsIntoCFG();
    const data=readInputs();
    const svgD=buildSVG_Droite(data,false);
    const svgG=matchSvgWidth(svgD,buildSVG_Gauche(data,false));
    document.getElementById('visual-output').innerHTML=
      `<h3 style="color:var(--vert);font-size:.88rem;margin-bottom:9px;">${t('svgRH')}</h3>${svgD}
       <div style="margin:8px 0 6px;display:flex;align-items:center;gap:10px;opacity:.8;"><div style="flex:1;border-top:1.5px dashed var(--vert);"></div><span style="font-size:8pt;font-weight:bold;letter-spacing:.1em;color:var(--vert);">â€” ${t('svgBellows')} â€”</span><div style="flex:1;border-top:1.5px dashed var(--vert);"></div></div>
       <h3 style="color:var(--vert);font-size:.88rem;margin:4px 0 9px;">${t('svgLH')}</h3>${svgG}`;
    document.getElementById('sommier-output').innerHTML=buildSommierSVG(data,false);
  }catch(e){console.error('runLivePreview:',e);}
}

/* â”€â”€ Tabs â”€â”€ */
function showTab(name,btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-visual').style.display   =name==='visual'   ?'':'none';
  document.getElementById('tab-fabricant').style.display=name==='fabricant'?'':'none';
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PDF PRINT â€” DARK/GOLD MIDICORE DESIGN               â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PDF DOWNLOAD â€” jsPDF (no print dialog)              â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadScript(url){
  return new Promise((res,rej)=>{
    if(document.querySelector(`script[src="${url}"]`)){res();return;}
    const s=document.createElement('script');
    s.src=url;s.onload=res;s.onerror=rej;
    document.head.appendChild(s);
  });
}
function svgToPngDataUrl(svgStr){
  return new Promise((res,rej)=>{
    const mw=svgStr.match(/\bwidth="(\d+(?:\.\d+)?)"/),mh=svgStr.match(/\bheight="(\d+(?:\.\d+)?)"/);
    const sw=mw?+mw[1]:800,sh=mh?+mh[1]:600;
    const SCALE=1;
    const c=document.createElement('canvas');c.width=sw*SCALE;c.height=sh*SCALE;
    const ctx=c.getContext('2d');ctx.scale(SCALE,SCALE);
    const img=new Image();
    const blob=new Blob([svgStr],{type:'image/svg+xml;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    img.onload=()=>{ctx.fillStyle='#fff';ctx.fillRect(0,0,sw,sh);ctx.drawImage(img,0,0,sw,sh);URL.revokeObjectURL(url);res({dataUrl:c.toDataURL('image/jpeg',0.82),w:sw,h:sh});};
    img.onerror=e=>{URL.revokeObjectURL(url);rej(e);};
    img.src=url;
  });
}
async function downloadPDF(which){
  const JSPDF_URL='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
  const AT_URL='https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
  try{ await loadScript(JSPDF_URL); await loadScript(AT_URL); }
  catch(e){ alert(t('popupAlert'));return; }

  const data=readInputs();
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const PW=pdf.internal.pageSize.getWidth(), PH=pdf.internal.pageSize.getHeight();

  // â”€â”€ Layout constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ML=15, MR=15, MT=15;
  const CW=PW-ML-MR;                 // 180 mm usable width
  const FOOTER_H=12;                  // mm reserved at bottom for footer area
  const FOOT_RULE=PH-10;             // Y of footer rule (2mm gap to content)
  const CB=PH-FOOTER_H;             // content bottom limit
  let yPos=MT;

  // â”€â”€ Professional palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const GRN=[30,68,30];              // deep forest green â€” headings
  const GRN2=[48,100,48];            // medium green â€” sub-headers
  const GRAY=[110,110,110];          // muted gray â€” meta / captions
  const LGRE=[240,248,240];          // pale green â€” key cells
  const ALT=[248,252,247];           // alternate row tint
  const RULE_C=[190,210,185];        // light sage â€” table borders / rules
  const PUSH_C=[20,85,20];           // push note â€” dark green
  const PULL_C=[140,100,10];         // pull note â€” warm amber

  // â”€â”€ Drawing helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function hRule(y,color=RULE_C,lw=0.2){
    pdf.setDrawColor(...color);pdf.setLineWidth(lw);
    pdf.line(ML,y,PW-MR,y);
  }
  function secLabel(txt,y){
    pdf.setFontSize(6.5);pdf.setFont('helvetica','bold');pdf.setTextColor(...GRAY);
    pdf.text(txt.toUpperCase(),ML,y);
  }

  // â”€â”€ SVG â†’ PDF with proper 2Ã— scale slicing â”€â”€â”€â”€â”€â”€â”€â”€
  async function addSvgImg(svgStr,label,mmPerPx){
    const {dataUrl,w,h}=await svgToPngDataUrl(svgStr);
    const imgW=mmPerPx?Math.min(w*mmPerPx,CW):CW;
    const scale=imgW/w;          // mm per natural pixel
    const imgH=h*scale;          // total height in mm
    if(label){
      if(yPos+8>CB){pdf.addPage();yPos=MT;}
      secLabel(label,yPos+4);yPos+=7;
    }
    if(imgH<=CB-yPos){
      pdf.addImage(dataUrl,'JPEG',ML,yPos,imgW,imgH);
      yPos+=imgH+5;return;
    }
    // Spans multiple pages â€” slice using actual canvas coords
    const srcImg=await new Promise((res,rej)=>{
      const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=dataUrl;
    });
    const pxW=srcImg.naturalWidth, pngToSvg=srcImg.naturalHeight/h; // e.g. 2 when rendered at 2Ã—
    const sc=document.createElement('canvas');sc.width=pxW;
    let srcY=0,first=true;
    while(srcY<h){
      if(!first){pdf.addPage();yPos=MT;}
      const maxH=Math.min(h-srcY,(CB-yPos)/scale);
      sc.height=Math.ceil(maxH*pngToSvg);
      const ctx=sc.getContext('2d');
      ctx.clearRect(0,0,pxW,sc.height);
      ctx.drawImage(srcImg,0,srcY*pngToSvg,pxW,maxH*pngToSvg,0,0,pxW,sc.height);
      pdf.addImage(sc.toDataURL('image/jpeg',0.82),'JPEG',ML,yPos,imgW,maxH*scale);
      yPos+=maxH*scale+1;srcY+=maxH;first=false;
    }
    yPos+=3;
  }

  // â”€â”€ AutoTable defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function tableDefaults(extra){
    return Object.assign({
      margin:{left:ML,right:MR},theme:'grid',
      rowPageBreak:'avoid',
      styles:{fontSize:7,cellPadding:[1.8,3],textColor:[30,30,30],
              lineColor:RULE_C,lineWidth:0.22},
      headStyles:{fillColor:GRN,textColor:[255,255,255],fontStyle:'bold',fontSize:7},
      alternateRowStyles:{fillColor:ALT},
    },extra);
  }
  // Returns MIDI note as string cell, or 'â€”'
  function midiCell(note){const m=noteToMidi(note);return m!==null?String(m):'â€”';}

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PAGE 1 â€” Cover header
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  hRule(yPos,GRN,0.6);yPos+=5;

  // Instrument name + document type
  pdf.setFontSize(20);pdf.setFont('helvetica','bold');pdf.setTextColor(...GRN);
  pdf.text(data.nomInstrument||'AccordÃ©on',ML,yPos+8);
  pdf.setFontSize(7);pdf.setFont('helvetica','normal');pdf.setTextColor(...GRAY);
  const badge=which==='visual'?t('pdfClientTitle'):t('pdfMfrTitle');
  pdf.text(badge.toUpperCase(),PW-MR,yPos+8,{align:'right'});
  yPos+=12;

  // Metadata row
  const meta=[
    `${t('svgLuthier').toUpperCase()}  ${data.nomLuthier||'â€”'}`,
    `${t('svgClient').toUpperCase()}  ${data.nomJoueur||'â€”'}`,
    fmtDate(data.date),
  ].join('    Â·    ');
  pdf.setFontSize(7);pdf.setTextColor(...GRAY);
  pdf.text(meta,ML,yPos);yPos+=5;
  hRule(yPos,GRN,0.4);yPos+=8;

  // â”€â”€ Keyboard SVGs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const svgDstr=buildSVG_Droite(data,false);
  const svgGstr=matchSvgWidth(svgDstr,buildSVG_Gauche(data,false));
  const wD=+(svgDstr.match(/\bwidth="(\d+(?:\.\d+)?)"/)||[,800])[1];
  const mmPerPxPlan=CW/wD;

  await addSvgImg(svgDstr,t('svgRH'),mmPerPxPlan);

  // Bellows separator
  if(yPos+7<CB){
    hRule(yPos,RULE_C,0.15);
    pdf.setFontSize(6.5);pdf.setFont('helvetica','bold');pdf.setTextColor(...GRAY);
    pdf.text(`â€” ${t('svgBellows')} â€”`,PW/2,yPos+4,{align:'center'});
    yPos+=7;
  }
  await addSvgImg(svgGstr,t('svgLH'),mmPerPxPlan);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FABRICANT PAGES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  if(which==='fabricant'){

    // â”€â”€ Page: Sommier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    pdf.addPage();yPos=MT;
    const rhSomTitle=t('svgSommierRH')+' â€” '+escSVG(data.nomInstrument);
    const lhSomTitle=t('svgSommierLH')+' â€” '+escSVG(data.nomInstrument);
    await addSvgImg(buildSommierSection(rhSomTitle,expandVoicesForSommier(data.droite,data.voixPerRow||['N']),false),t('svgRH'));
    const lhSecs=buildLhSommierSections(data);
    if(lhSecs.length)await addSvgImg(buildSommierSection(lhSomTitle,lhSecs,false),t('svgLH'));

    // â”€â”€ Page: Bon de commande â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    pdf.addPage();yPos=MT;
    const os=data.orderSpecs||{},date=fmtDate(data.date);
    const totalBtns=data.droite.reduce((s,r)=>s+r.boutons.length,0);
    const totalAnches=totalBtns*(data.nbVoix||2)
      +(data.basses?data.basses.length*2:0)*(data.nbVoixBasses||2)
      +(data.accords?data.accords.length*2:0)*(data.nbVoixAccords||2);
    const midi=data.showMidi;

    pdf.setFontSize(9);pdf.setFont('helvetica','bold');pdf.setTextColor(...GRN);
    pdf.text(t('pdfMfrTitle').toUpperCase(),ML,yPos+5);
    pdf.setFontSize(7);pdf.setFont('helvetica','normal');pdf.setTextColor(...GRAY);
    pdf.text(data.nomInstrument,PW-MR,yPos+5,{align:'right'});
    yPos+=8;hRule(yPos,RULE_C,0.2);yPos+=6;

    // Order checklist (4-col key/value)
    const kw=42,vw=CW/2-kw;
    pdf.autoTable(tableDefaults({
      startY:yPos,
      columnStyles:{0:{cellWidth:kw,fillColor:LGRE,textColor:GRN,fontStyle:'bold'},
                    1:{cellWidth:vw},
                    2:{cellWidth:kw,fillColor:LGRE,textColor:GRN,fontStyle:'bold'},
                    3:{cellWidth:vw}},
      body:[
        [t('clQty'),String(totalAnches),t('clReedType'),os.reedType||'â€”'],
        [t('clDesc'),`${totalBtns}/${data.basses.length}`,t('clTonality'),data.nomInstrument],
        [t('clRowSpec'),(data.voixPerRow||['N']).join('/'),t('clTuning'),(os.tuning||'440')+' Hz'],
        [t('clTremolo'),os.tremolo||'â€”',t('clHarmony'),os.harmony||'â€”'],
        [t('clBassType'),os.bassType||'â€”',t('clBassComp'),os.bassComp||'â€”'],
        [t('clVoices'),`${data.nbVoix}v Â· ${t('accords')} ${data.nbVoixAccords||2}v / ${t('basses')} ${data.nbVoixBasses||2}v`,t('clLuthier'),`${data.nomLuthier} â€” ${date}`],
      ],
    }));
    yPos=pdf.lastAutoTable.finalY+10;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FOOTER â€” stamped on every page
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const total=pdf.internal.getNumberOfPages();
  for(let pg=1;pg<=total;pg++){
    pdf.setPage(pg);
    hRule(FOOT_RULE,RULE_C,0.2);
    pdf.setFontSize(6);pdf.setFont('helvetica','normal');pdf.setTextColor(...GRAY);
    pdf.text(`${data.nomLuthier||''}  â€”  ewendaviau.com`,ML,PH-6.5);
    pdf.text(`${pg} / ${total}`,PW/2,PH-6.5,{align:'center'});
    pdf.text(fmtDate(data.date),PW-MR,PH-6.5,{align:'right'});
  }

  const fileName=`${(data.nomInstrument||'accordeon').replace(/[^a-zA-Z0-9_\-]/g,'_')}_${which==='visual'?'plan':'fabricant'}.pdf`;
  pdf.save(fileName);
}
function printSection(which){ downloadPDF(which); }

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  MISC ACTIONS                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearNotes(){
  if(!confirm(t('clearConfirm')))return;
  document.querySelectorAll('#note-grid input').forEach(el=>{el.value='';});
  readNoteInputsIntoCFG();onAnyChange();
}
function openImportExport(){
  document.getElementById('modal-json').value=JSON.stringify(DB.all(),null,2);
  document.getElementById('modal-msg').textContent='';
  document.getElementById('import-modal').classList.add('open');
}
function closeModal(){document.getElementById('import-modal').classList.remove('open');}
function copyJSON(){
  const text=document.getElementById('modal-json').value;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{document.getElementById('modal-msg').textContent=t('copied');}).catch(()=>{});
  } else {
    const ta=document.getElementById('modal-json');ta.select();document.execCommand('copy');
    document.getElementById('modal-msg').textContent=t('copied');
  }
}
function doImport(){
  try{
    const data=JSON.parse(document.getElementById('modal-json').value);
    if(!Array.isArray(data))throw new Error(t('invalidFormat'));
    DB.save(data);renderLibrary();
    if(data.length){loadFromDB(data[0]);scheduleLivePreview();}
    closeModal();
    document.getElementById('modal-msg').textContent=t('importSuccess')(data.length);
  }catch(e){document.getElementById('modal-msg').textContent=t('importError')+e.message;}
}

/* â”€â”€â”€ Save As / Open JSON file â”€â”€â”€ */
function saveAsJSON(){
  readNoteInputsIntoCFG();
  const rec=snapshotToDB();
  const name=(rec.nom||'accordeon').replace(/[^a-zA-Z0-9_\-]/g,'_');
  triggerDownload(JSON.stringify(rec,null,2),name+'.json','application/json');
}
function downloadAllJSON(){
  const list=DB.all();
  triggerDownload(JSON.stringify(list,null,2),'accordeons_export.json','application/json');
}
function loadFromFile(evt){
  const file=evt.target.files&&evt.target.files[0];
  if(!file)return;
  evt.target.value=''; // reset so same file can be re-loaded
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      let data=JSON.parse(e.target.result);
      // Accept both a single object and an array
      if(!Array.isArray(data))data=[data];
      data.forEach((rec,i)=>{if(!rec.id)rec.id=Date.now().toString(36)+'_'+i+'_'+Math.random().toString(36).slice(2);});
      const existing=DB.load();
      // Merge: skip duplicates by id, add new ones at top
      const ids=new Set(existing.map(r=>r.id));
      const fresh=data.filter(r=>!ids.has(r.id));
      DB.save([...fresh,...existing]);
      renderLibrary();
      if(data.length){loadFromDB(data[0]);scheduleLivePreview();}
      alert(t('loadedFrom')(data.length));
    }catch(err){alert(t('importError')+err.message);}
  };
  reader.readAsText(file);
}
function triggerDownload(content,filename,mime){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
}

/* â”€â”€â”€ utils â”€â”€â”€ */
function val(id){const el=document.getElementById(id);return el?el.value.trim():'';}
</script>
</body>
</html>
