<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸª— Clavier AccordÃ©on Diatonique</title>
<style>
:root{
  --vert:#2d5a27;--vert-c:#e8f5e3;--or:#c8a96e;--or-c:#fff8e6;
  --gris:#6c757d;--fond:#f2f5f2;--txt:#222;--rouge:#c0392b;--bleu:#1565c0;--brd:#d0d7d0;
  --gold:#c9a227;--gold-d:#8b6914;--dark:#111111;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,Arial,sans-serif;background:var(--fond);color:var(--txt);line-height:1.5;font-size:15px}

/* â”€â”€ Header â”€â”€ */
header{background:var(--vert);color:#fff;padding:10px 20px;display:flex;align-items:center;gap:10px;
  position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.28)}
header .icon{font-size:1.7rem;flex-shrink:0}
header .hd-text{flex:1;min-width:0}
header h1{font-size:1.1rem;font-weight:700;white-space:nowrap}
header p{font-size:.75rem;opacity:.8;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#save-status{font-size:.75rem;padding:4px 10px;border-radius:20px;font-weight:700;white-space:nowrap;flex-shrink:0;transition:background .3s,color .3s}
#save-status.saved{background:rgba(255,255,255,.18);color:#c8ffb8}
#save-status.dirty{background:#f39c12;color:#fff}
#save-status.saving{background:rgba(255,255,255,.1);color:#ffe}
.lang-btn{padding:5px 11px;border:1.5px solid rgba(255,255,255,.5);border-radius:5px;background:transparent;
  color:#fff;font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer;transition:background .15s}
.lang-btn:hover,.lang-btn.active{background:rgba(255,255,255,.2)}

/* â”€â”€ Library â”€â”€ */
#library-panel{background:#fff;border-bottom:2px solid var(--brd);padding:12px 20px}
.lib-toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.lib-toolbar h2{font-size:.86rem;color:var(--vert);font-weight:700;flex:1}
#lib-cards{display:flex;gap:9px;flex-wrap:wrap}
.instr-card{border:2px solid var(--brd);border-radius:8px;padding:9px 12px;min-width:190px;max-width:250px;
  cursor:pointer;transition:border-color .18s,box-shadow .18s;background:#fafafa;position:relative}
.instr-card:hover{border-color:var(--vert);box-shadow:0 2px 8px rgba(45,90,39,.12)}
.instr-card.active{border-color:var(--vert);background:var(--vert-c)}
.card-name{font-weight:700;font-size:.88rem}.card-sub,.card-meta{font-size:.72rem;color:var(--gris);margin-top:2px}
.card-btns{display:flex;gap:4px;margin-top:7px}
.ca{font-size:.68rem;padding:3px 7px;border:none;border-radius:4px;cursor:pointer;font-family:inherit;font-weight:700}
.ca-edit{background:var(--vert);color:#fff}.ca-dup{background:#e0e0e0;color:#444}.ca-del{background:#fde;color:var(--rouge)}
.lib-empty{font-size:.83rem;color:var(--gris);font-style:italic;padding:5px 0}

/* â”€â”€ Container â”€â”€ */
.container{max-width:1380px;margin:0 auto;padding:16px 14px}
.card{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:16px;overflow:hidden}
.card-head{background:var(--vert);color:#fff;padding:9px 16px;display:flex;align-items:center;gap:9px}
.card-head h2{font-size:.9rem;font-weight:700;flex:1}
.step-badge{background:rgba(255,255,255,.22);border-radius:50%;width:22px;height:22px;
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.75rem;flex-shrink:0}
.card-body{padding:16px}

/* â”€â”€ Forms â”€â”€ */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(175px,1fr));gap:11px}
.form-group{display:flex;flex-direction:column;gap:3px}
.form-group label{font-size:.72rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.05em}
input[type="text"],input[type="date"],input[type="number"],select{
  padding:7px 9px;border:1.5px solid var(--brd);border-radius:6px;font-size:.85rem;
  font-family:inherit;background:#fff;color:var(--txt);transition:border-color .18s}
input[type="text"]:focus,input[type="number"]:focus,select:focus,input[type="date"]:focus{
  border-color:var(--vert);outline:none;box-shadow:0 0 0 3px rgba(45,90,39,.1)}
.hint{font-size:.68rem;color:var(--gris);margin-top:3px}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:7px 14px;border:none;border-radius:6px;font-family:inherit;font-size:.83rem;font-weight:700;
  cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:filter .15s,transform .1s}
.btn:hover{filter:brightness(1.1)}.btn:active{transform:scale(.97)}
.btn-primary{background:var(--vert);color:#fff}
.btn-or{background:var(--or);color:#fff}
.btn-outline{background:transparent;color:var(--vert);border:2px solid var(--vert)}
.btn-outline:hover{background:var(--vert-c);filter:none}
.btn-bleu{background:var(--bleu);color:#fff}
.btn-rouge{background:var(--rouge);color:#fff}
.btn-gris{background:#e0e0e0;color:#444}
.btn-group{display:flex;gap:7px;flex-wrap:wrap}

/* â”€â”€ Row config â”€â”€ */
.rangees-grid{display:flex;gap:7px;flex-wrap:wrap;margin-top:9px}
.rangee-cfg{display:flex;flex-direction:column;gap:3px;background:var(--vert-c);border:1.5px solid var(--brd);
  border-radius:6px;padding:7px 9px;min-width:140px}
.rangee-cfg label{font-size:.7rem;font-weight:700;color:var(--vert)}
.rng-ctrl{display:flex;align-items:center;gap:5px}

/* â”€â”€ +/âˆ’ small buttons â”€â”€ */
.rng-btn{width:24px;height:24px;border:1.5px solid var(--brd);border-radius:4px;
  background:#fff;font-size:1rem;line-height:1;cursor:pointer;font-family:inherit;font-weight:700;
  color:var(--vert);display:inline-flex;align-items:center;justify-content:center;
  padding:0;flex-shrink:0;transition:background .12s,border-color .12s}
.rng-btn:hover{background:var(--vert-c);border-color:var(--vert)}
.rng-count{font-size:.78rem;font-weight:700;color:var(--gris);min-width:18px;text-align:center}

/* â”€â”€ Note grid â”€â”€ */
.note-section{margin-bottom:18px}
.note-section-title{font-size:.86rem;font-weight:700;color:var(--vert);
  border-bottom:2px solid var(--vert-c);padding-bottom:4px;margin-bottom:8px}
.sec-hd{display:flex;align-items:center;gap:7px;margin-bottom:5px}
.sec-label{font-size:.76rem;font-weight:700;color:var(--vert)}
.row-wrap{margin-bottom:11px}
.btn-grid{display:flex;flex-wrap:wrap;gap:4px}
.btn-cell{display:flex;flex-direction:column;align-items:center;gap:2px}
.btn-num{font-size:.63rem;color:var(--gris);font-weight:700}
.note-input{width:62px;padding:4px 3px;text-align:center;font-size:.76rem;border-radius:5px;
  border:1.5px solid var(--brd);cursor:pointer}
.note-input.pousse{border-color:var(--vert);background:var(--vert-c)}
.note-input.tire{border-color:var(--or);background:var(--or-c)}
.note-input:focus{outline:none}
.note-input.pousse:focus{border-color:#1a4417;box-shadow:0 0 0 2px rgba(45,90,39,.15)}
.note-input.tire:focus{border-color:#9a7030;box-shadow:0 0 0 2px rgba(200,169,110,.2)}
.note-input.picker-open{box-shadow:0 0 0 3px rgba(21,101,192,.3)!important;border-color:var(--bleu)!important}
.legend{display:flex;gap:14px;margin-bottom:11px;flex-wrap:wrap;align-items:center}
.legend-item{display:flex;align-items:center;gap:5px;font-size:.8rem}
.legend-swatch{width:30px;height:14px;border-radius:3px;display:flex;align-items:center;justify-content:center;
  font-size:.64rem;font-weight:700}
.info-box{background:#eaf2fb;border-left:4px solid var(--bleu);padding:9px 12px;
  border-radius:0 6px 6px 0;font-size:.8rem;margin-bottom:12px}
.mono{font-family:monospace;background:#f0f0f0;padding:1px 4px;border-radius:3px}

/* â”€â”€ Note Picker â”€â”€ */
#note-picker{position:absolute;z-index:999;background:#fff;border:2px solid var(--vert);
  border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.18);padding:11px 13px;min-width:305px;display:none}
.picker-tabs{display:flex;gap:0;margin-bottom:9px;border-bottom:2px solid var(--brd)}
.picker-tab-btn{padding:4px 12px;border:none;background:none;font-family:inherit;font-size:.78rem;
  font-weight:700;color:var(--gris);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px}
.picker-tab-btn.active{color:var(--vert);border-bottom-color:var(--vert)}
.picker-tab{display:none}
.picker-tab.active{display:block}
.picker-title{font-size:.72rem;font-weight:700;color:var(--vert);text-transform:uppercase;
  letter-spacing:.05em;margin-bottom:7px}
.picker-notes-row{display:flex;gap:3px;margin-bottom:4px;flex-wrap:wrap}
.pn{min-width:34px;padding:4px 5px;border:1.5px solid var(--brd);border-radius:5px;
  background:#f8f8f8;font-family:inherit;font-size:.78rem;font-weight:700;cursor:pointer;text-align:center;transition:background .1s,border-color .1s}
.pn:hover{background:var(--vert-c);border-color:var(--vert)}
.pn.selected{background:var(--vert);color:#fff;border-color:var(--vert)}
.pn.sharp{background:#e8e0f5}.pn.sharp:hover,.pn.sharp.selected{background:#6b4da0;color:#fff;border-color:#6b4da0}
.pn.flat{background:#fde8e0}.pn.flat:hover,.pn.flat.selected{background:#c0392b;color:#fff;border-color:#c0392b}
.picker-octave-row{display:flex;gap:3px;margin-top:7px;align-items:center}
.picker-octave-label{font-size:.68rem;font-weight:700;color:var(--gris);margin-right:3px}
.po{width:30px;height:26px;border:1.5px solid var(--brd);border-radius:5px;
  background:#f0f0f0;font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer}
.po:hover{background:var(--or-c);border-color:var(--or)}
.po.selected{background:var(--or);color:#fff;border-color:var(--or)}
.picker-preview{margin-top:9px;padding:6px 9px;background:#f4f6f4;border-radius:5px;
  font-size:.83rem;font-weight:700;color:var(--vert);min-height:33px;display:flex;align-items:center;gap:7px}
.picker-preview span{flex:1}
.picker-clear{font-size:.7rem;color:var(--rouge);cursor:pointer;border:none;background:none;font-family:inherit}
.picker-insert{padding:5px 12px;background:var(--vert);color:#fff;border:none;border-radius:5px;
  font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer}
.midi-preview{font-size:.65rem;color:var(--bleu);font-weight:700;opacity:.8}
.chord-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
.pc{padding:4px 5px;border:1.5px solid var(--brd);border-radius:5px;background:#f8f8f8;
  font-family:inherit;font-size:.73rem;font-weight:700;cursor:pointer;text-align:center}
.pc:hover{background:var(--vert-c);border-color:var(--vert)}
.pc.selected{background:var(--vert);color:#fff}

/* â”€â”€ Preview tabs â”€â”€ */
#preview-card .card-head{background:var(--bleu)}
.tabs{display:flex;gap:0;border-bottom:2px solid var(--brd);margin-bottom:13px}
.tab-btn{padding:7px 17px;border:none;background:none;font-family:inherit;font-size:.83rem;
  font-weight:700;color:var(--gris);cursor:pointer;border-bottom:2.5px solid transparent;margin-bottom:-2px}
.tab-btn.active{color:var(--bleu);border-bottom-color:var(--bleu)}
#visual-output{overflow-x:auto}
#visual-output svg{display:block;margin:0 auto;max-width:100%}

/* â”€â”€ Fab view toggle â”€â”€ */
.fab-view-wrap{display:flex;gap:0;margin-bottom:12px}
.fab-view-btn{padding:6px 15px;border:1.5px solid var(--vert);background:#fff;
  font-family:inherit;font-size:.78rem;font-weight:700;color:var(--vert);cursor:pointer;transition:background .15s}
.fab-view-btn:first-child{border-radius:6px 0 0 6px}
.fab-view-btn:last-child{border-radius:0 6px 6px 0;border-left:none}
.fab-view-btn.active{background:var(--vert);color:#fff}

/* â”€â”€ Tables â”€â”€ */
.mfr-table{width:100%;border-collapse:collapse;font-size:.8rem}
.mfr-table th,.mfr-table td{border:1px solid #ddd;padding:5px 9px;text-align:center}
.mfr-table th{background:var(--vert);color:#fff;font-size:.75rem;font-weight:700}
.mfr-table tr:nth-child(even) td{background:#f6f9f5}
.mfr-table td.note-p{color:#1a5c1a;font-weight:700}
.mfr-table td.note-t{color:#8b6914;font-weight:700}
.mfr-table td.row-hd{background:#edf4ec;font-weight:700;color:var(--vert)}
.mfr-table td.midi-c{color:var(--bleu);font-size:.72rem}
.mfr-sub{color:var(--gris);font-style:italic;font-size:.76rem;margin-bottom:12px}

/* â”€â”€ Modal â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
  z-index:500;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:#fff;border-radius:12px;padding:22px;max-width:600px;width:95%;
  max-height:80vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.25)}
.modal-box h3{font-size:.98rem;color:var(--vert);margin-bottom:11px}
.modal-box textarea{width:100%;height:200px;font-family:monospace;font-size:.76rem;
  border:1.5px solid var(--brd);border-radius:6px;padding:8px;resize:vertical}

/* â”€â”€ Misc â”€â”€ */
hr.divider{border:none;border-top:1.5px solid var(--vert-c);margin:14px 0}

/* â”€â”€ Print â”€â”€ */
@media print{
  .no-print{display:none!important}
  body{background:#fff}
  .card{box-shadow:none;border:1px solid #ddd}
  .card-head{background:#2d5a27!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .mfr-table th{background:#2d5a27!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
@media(max-width:680px){
  header{flex-wrap:wrap}
  .form-grid{grid-template-columns:1fr}
  #note-picker{min-width:256px}
  .chord-grid{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="no-print">
  <div class="icon">ğŸª—</div>
  <div class="hd-text">
    <h1 data-i="title">Clavier AccordÃ©on Diatonique</h1>
    <p data-i="subtitle">Plan de clavier client &amp; bon de commande anches</p>
  </div>
  <button class="lang-btn active" id="lang-fr" onclick="setLang('fr')">ğŸ‡«ğŸ‡· FR</button>
  <button class="lang-btn"        id="lang-en" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ EN</button>
  <span id="save-status" class="saved">âœ“ SauvegardÃ©</span>
</header>

<!-- LIBRARY -->
<div id="library-panel" class="no-print">
  <div class="lib-toolbar">
    <h2 data-i="myInstruments">ğŸ“ Mes accordÃ©ons sauvegardÃ©s</h2>
    <button class="btn btn-primary" onclick="newInstrument()" style="font-size:.78rem;padding:5px 11px;" data-i-btn="newInstrument">ï¼‹ Nouvel instrument</button>
    <button class="btn btn-gris"    onclick="openImportExport()" style="font-size:.78rem;padding:5px 11px;" data-i-btn="importExport">â‡… Import / Export</button>
  </div>
  <div id="lib-cards"><div class="lib-empty" data-i="noSaved">Aucun instrument sauvegardÃ©.</div></div>
</div>

<div class="container">

  <!-- STEP 1: Configuration -->
  <div class="card no-print">
    <div class="card-head"><div class="step-badge">1</div><h2 data-i="step1">Configuration de l'accordÃ©on</h2></div>
    <div class="card-body">
      <div class="form-grid">
        <div class="form-group"><label data-i="instrumentRef">RÃ©fÃ©rence instrument</label>
          <input type="text" id="nom-instrument" placeholder="Ex : Sol/Do #001" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="clientName">Nom du client</label>
          <input type="text" id="nom-joueur" placeholder="Ex : Jean Dupont" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="date">Date</label>
          <input type="date" id="date-creation" onchange="onAnyChange()"></div>
        <div class="form-group"><label data-i="luthier">Luthier</label>
          <input type="text" id="nom-luthier" value="Ewen d'Aviau" oninput="onAnyChange()"></div>
      </div>
      <hr class="divider">
      <div class="form-grid">
        <div class="form-group"><label data-i="preset">ModÃ¨le prÃ©dÃ©fini</label>
          <select id="preset-select" onchange="loadPreset(this.value)">
            <option value="" data-i-opt="presetPlaceholder">â€” Choisir un modÃ¨le â€”</option>
            <option value="GC21">Sol/Do â€” 21 boutons</option>
            <option value="DG21">RÃ©/Sol â€” 21 boutons</option>
            <option value="CF21">Do/Fa â€” 21 boutons</option>
            <option value="GCD33">Sol/Do/RÃ© â€” 33 boutons</option>
            <option value="BbFC33">Sib/Fa/Do â€” 33 boutons</option>
            <option value="custom" data-i-opt="custom">PersonnalisÃ©â€¦</option>
          </select></div>
        <div class="form-group"><label data-i="rowsRH">RangÃ©es main droite</label>
          <div class="rng-ctrl">
            <button type="button" class="rng-btn" onclick="changeNbRangees(-1)">âˆ’</button>
            <input type="number" id="nb-rangees" min="1" max="20" value="3"
              onchange="onRangeesChange()" style="width:54px;text-align:center">
            <button type="button" class="rng-btn" onclick="changeNbRangees(1)">ï¼‹</button>
          </div></div>
        <div class="form-group"><label data-i="leftHandTpl">ModÃ¨le main gauche</label>
          <select id="config-gauche" onchange="onGaucheChange()">
            <option value="" data-i-opt="cgLeft">â€” ModÃ¨le de dÃ©part â€”</option>
            <option value="4"  data-i-opt="cg4" >4 basses (2+2)</option>
            <option value="8"  data-i-opt="cg8" >8 basses (4+4)</option>
            <option value="12" data-i-opt="cg12" selected>12 basses (6+6)</option>
            <option value="18" data-i-opt="cg18">18 basses (6+6+6)</option>
            <option value="24" data-i-opt="cg24">24 basses (8+8+8)</option>
          </select>
          <span class="hint" data-i="cgHelp">Ajustez avec + / âˆ’ ci-dessous</span></div>
        <div class="form-group"><label data-i="voices">Nombre de voix (anches)</label>
          <select id="nb-voix" onchange="onAnyChange()">
            <option value="1">1 voix / 1 voice</option>
            <option value="2" selected>2 voix / voices (LM ou MH)</option>
            <option value="3">3 voix / voices (LMH)</option>
          </select>
          <div style="margin-top:6px;display:flex;align-items:center;gap:7px">
            <input type="checkbox" id="show-midi" onchange="onAnyChange()">
            <label for="show-midi" style="font-size:.82rem;cursor:pointer;font-weight:normal;text-transform:none;letter-spacing:0" data-i="showMidi">NumÃ©ros MIDI</label>
          </div></div>
      </div>
      <div id="rangees-cfg-wrap">
        <div style="font-size:.75rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.05em;margin-top:13px;margin-bottom:5px;" data-i="rowConfig">Configuration des rangÃ©es</div>
        <div class="rangees-grid" id="rangees-cfg"></div>
      </div>
    </div>
  </div>

  <!-- STEP 2: Note entry -->
  <div class="card no-print">
    <div class="card-head"><div class="step-badge">2</div>
      <h2 data-i="step2">Saisie des notes â€” cliquez un champ pour ouvrir le sÃ©lecteur</h2></div>
    <div class="card-body">
      <div class="info-box" id="info-box-text" data-i="clickToOpen">
        <strong>Cliquez</strong> sur un champ vert (poussÃ©) ou ambrÃ© (tirÃ©) pour ouvrir le sÃ©lecteur de notes.
      </div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-swatch" style="background:var(--vert-c);border:1.5px solid var(--vert);color:#1a5c1a;">â†“</div>
          <strong data-i="push">PoussÃ©</strong>
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:var(--or-c);border:1.5px solid var(--or);color:#8b6914;">â†‘</div>
          <strong data-i="pull">TirÃ©</strong>
        </div>
        <button class="btn btn-rouge" style="margin-left:auto;font-size:.76rem;padding:5px 10px;" onclick="clearNotes()" data-i-btn="clearNotes">ğŸ—‘ï¸ Effacer toutes les notes</button>
      </div>
      <div id="note-grid"></div>
      <div class="btn-group" style="margin-top:13px;">
        <button class="btn btn-primary" onclick="saveCurrentInstrument()" data-i-btn="saveInstrument">ğŸ’¾ Sauvegarder cet accordÃ©on</button>
      </div>
    </div>
  </div>

  <!-- STEP 3: Preview -->
  <div class="card" id="preview-card">
    <div class="card-head no-print">
      <div class="step-badge">3</div>
      <h2 data-i="step3">AperÃ§u &amp; impression â€” mis Ã  jour automatiquement</h2>
      <button class="btn btn-bleu no-print" onclick="forcePreview()" style="margin-left:auto;font-size:.76rem;padding:4px 11px;" data-i-btn="refresh">ğŸ”„ Actualiser</button>
    </div>
    <div class="card-body">
      <div class="tabs no-print">
        <button class="tab-btn active" onclick="showTab('visual',this)" data-i-btn="clientVisual">ğŸ¹ Clavier client</button>
        <button class="tab-btn"        onclick="showTab('fabricant',this)" data-i-btn="manufacturerTable">ğŸ“‹ Fabricant anches</button>
      </div>
      <div class="btn-group no-print" style="margin-bottom:13px;">
        <button class="btn btn-bleu"    onclick="printSection('visual')"    data-i-btn="pdfClientVisual">ğŸ–¨ï¸ PDF plan clavier</button>
        <button class="btn btn-primary" onclick="printSection('fabricant')" data-i-btn="pdfManufacturer">ğŸ–¨ï¸ PDF fabricant</button>
      </div>
      <div id="tab-visual">
        <div id="visual-output"><p style="color:var(--gris);font-style:italic;font-size:.83rem;" data-i="previewPlaceholder">L'aperÃ§u apparaÃ®tra ici aprÃ¨s avoir saisi les notesâ€¦</p></div>
      </div>
      <div id="tab-fabricant" style="display:none">
        <div class="fab-view-wrap no-print">
          <button class="fab-view-btn active" onclick="showFabricantView('liste',this)" data-i-btn="listView">ğŸ“‹ Vue liste</button>
          <button class="fab-view-btn"        onclick="showFabricantView('sommier',this)" data-i-btn="sommierView">ğŸª— Vue sommier</button>
        </div>
        <div id="fab-view-liste"><div id="table-output"></div></div>
        <div id="fab-view-sommier" style="display:none"><div id="sommier-output"></div></div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<!-- NOTE PICKER -->
<div id="note-picker">
  <div class="picker-tabs">
    <button class="picker-tab-btn active" onclick="showPickerTab('notes',this)" data-i-btn="noteTab">ğŸµ Note</button>
    <button class="picker-tab-btn"        onclick="showPickerTab('chords',this)" data-i-btn="chordTab">ğŸ¼ Accord</button>
    <button style="margin-left:auto;padding:4px 8px;border:none;background:none;font-size:.73rem;color:var(--gris);cursor:pointer;" onclick="hidePicker()" data-i-btn="close">âœ• Fermer</button>
  </div>
  <div class="picker-tab active" id="picker-tab-notes">
    <div class="picker-title" data-i="naturals">Touches naturelles</div>
    <div class="picker-notes-row" id="picker-naturals"></div>
    <div class="picker-title" style="margin-top:7px;" data-i="sharps">DiÃ¨ses</div>
    <div class="picker-notes-row" id="picker-sharps"></div>
    <div class="picker-title" style="margin-top:7px;" data-i="flats">BÃ©mols</div>
    <div class="picker-notes-row" id="picker-flats"></div>
    <div class="picker-octave-row">
      <span class="picker-octave-label" data-i="octave">Octave :</span>
      <div id="picker-octaves" style="display:flex;gap:3px;"></div>
    </div>
  </div>
  <div class="picker-tab" id="picker-tab-chords">
    <div class="picker-title" data-i="chordTitle">Accords (cliquez pour insÃ©rer)</div>
    <div class="chord-grid" id="picker-chords-grid"></div>
  </div>
  <div class="picker-preview" id="picker-preview">
    <span id="picker-preview-text" data-i="selectNoteOctave">â€” sÃ©lectionnez une note et une octave â€”</span>
    <span class="midi-preview" id="picker-midi-badge"></span>
    <button class="picker-clear" onclick="pickerClear()" data-i-btn="clear">Effacer</button>
    <button class="picker-insert" onclick="pickerInsert()" data-i-btn="insert">InsÃ©rer â†µ</button>
  </div>
</div>

<!-- IMPORT/EXPORT MODAL -->
<div class="modal-overlay no-print" id="import-modal">
  <div class="modal-box">
    <h3>â‡… Import / Export JSON</h3>
    <p style="font-size:.8rem;color:var(--gris);margin-bottom:9px;" data-i="importHelp">Copiez le JSON pour sauvegarder, ou collez un JSON exportÃ© pour importer.</p>
    <textarea id="modal-json" spellcheck="false"></textarea>
    <div class="btn-group" style="margin-top:11px;">
      <button class="btn btn-primary" onclick="doImport()" data-i-btn="importBtn">â¬‡ï¸ Importer</button>
      <button class="btn btn-gris"    onclick="copyJSON()" data-i-btn="copyBtn">ğŸ“‹ Copier</button>
      <button class="btn btn-outline" onclick="closeModal()" data-i-btn="closeBtn">Fermer</button>
    </div>
    <p id="modal-msg" style="font-size:.78rem;margin-top:7px;min-height:1.2em;"></p>
  </div>
</div>

<script>
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LANGUAGES                                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lang = 'fr';
const LANGS = {
fr:{
  title:'Clavier AccordÃ©on Diatonique',subtitle:'Plan de clavier client & bon de commande anches',
  myInstruments:'ğŸ“ Mes accordÃ©ons sauvegardÃ©s',newInstrument:'ï¼‹ Nouvel instrument',importExport:'â‡… Import / Export',
  step1:'Configuration de l\'accordÃ©on',step2:'Saisie des notes â€” cliquez un champ pour ouvrir le sÃ©lecteur',
  step3:'AperÃ§u & impression â€” mis Ã  jour automatiquement',
  instrumentRef:'RÃ©fÃ©rence instrument',clientName:'Nom du client',date:'Date',luthier:'Luthier',
  preset:'ModÃ¨le prÃ©dÃ©fini',rowsRH:'RangÃ©es main droite',leftHandTpl:'ModÃ¨le main gauche',
  voices:'Nombre de voix (anches)',options:'Options',showMidi:'NumÃ©ros MIDI',
  rowConfig:'Configuration des rangÃ©es (nom & boutons)',
  clickToOpen:'<strong>Cliquez</strong> sur un champ <span style="color:#1a5c1a;font-weight:700;">vert</span> (poussÃ©) ou <span style="color:#8b6914;font-weight:700;">ambrÃ©</span> (tirÃ©) pour ouvrir le sÃ©lecteur de notes.',
  rightHand:'ğŸµ Main Droite',leftHand:'ğŸ¹ Main Gauche',push:'PoussÃ©',pull:'TirÃ©',
  clearNotes:'ğŸ—‘ï¸ Effacer toutes les notes',saveInstrument:'ğŸ’¾ Sauvegarder cet accordÃ©on',
  clientVisual:'ğŸ¹ Clavier client',manufacturerTable:'ğŸ“‹ Fabricant anches',
  pdfClientVisual:'ğŸ–¨ï¸ PDF plan clavier',pdfManufacturer:'ğŸ–¨ï¸ PDF fabricant',
  listView:'ğŸ“‹ Vue liste',sommierView:'ğŸª— Vue sommier',refresh:'ğŸ”„ Actualiser',
  basses:'Basses',accords:'Accords',terzetto:'Terzetto',
  addTerzetto:'ï¼‹ Ajouter Terzetto',removeTerzetto:'ğŸ—‘ï¸ Supprimer Terzetto',
  noteTab:'ğŸµ Note',chordTab:'ğŸ¼ Accord',close:'âœ• Fermer',
  naturals:'Touches naturelles',sharps:'DiÃ¨ses',flats:'BÃ©mols',octave:'Octave :',
  selectNoteOctave:'â€” sÃ©lectionnez une note et une octave â€”',chordTitle:'Accords (cliquez pour insÃ©rer)',
  clear:'Effacer',insert:'InsÃ©rer â†µ',
  importHelp:'Copiez le JSON pour sauvegarder, ou collez un JSON exportÃ© pour importer.',
  importBtn:'â¬‡ï¸ Importer',copyBtn:'ğŸ“‹ Copier',closeBtn:'Fermer',
  previewPlaceholder:'L\'aperÃ§u apparaÃ®tra ici aprÃ¨s avoir saisi les notesâ€¦',
  noSaved:'Aucun instrument sauvegardÃ©. Configurez puis cliquez "ğŸ’¾ Sauvegarder".',
  saved:'âœ“ SauvegardÃ©',dirty:'â— Modificationsâ€¦',saving:'â€¦ Sauvegarde',
  rows:'rangÃ©es',voices_:'voix',edit:'âœï¸ Ã‰diter',copy:'â§‰ Copier',delete:'ğŸ—‘ï¸',
  cgLeft:'â€” ModÃ¨le de dÃ©part â€”',cg4:'4 basses (2+2)',cg8:'8 basses (4+4)',
  cg12:'12 basses (6+6)',cg18:'18 basses (6+6+6 terzetto)',cg24:'24 basses (8+8+8)',
  cgHelp:'Ajustez avec + / âˆ’ ci-dessous',
  presetPlaceholder:'â€” Choisir un modÃ¨le â€”',custom:'PersonnalisÃ©â€¦',
  // SVG strings
  svgClient:'Client',svgLuthier:'Luthier',svgPush:'â†“ PoussÃ©',svgPull:'â†‘ TirÃ©',
  svgHigh:'â–² AIGU',svgLow:'â–¼ GRAVE',svgBellowsPush:'POUSSÃ‰',svgBellowsPull:'TIRÃ‰',
  svgRH:'Main Droite',svgLH:'Main Gauche',svgSommierRH:'SOMMIER â€” Main Droite',svgSommierLH:'SOMMIER â€” Main Gauche',
  svgMidi:'MIDI',svgGeneratedBy:'GÃ©nÃ©rÃ© le',svgPlan:'Plan de clavier',
  // Manufacturer table
  mfrRH:'MAIN DROITE â€” Plaque anches mÃ©lodie (bisonore)',
  mfrLH:'MAIN GAUCHE â€” Plaques basses, accords',
  mfrRow:'RangÃ©e',mfrNo:'NÂ°',mfrPushNote:'Note PoussÃ©e â†“',mfrPullNote:'Note TirÃ©e â†‘',
  mfrMidiPush:'MIDI â†“',mfrMidiPull:'MIDI â†‘',mfrPushSub:'(soufflet poussÃ©)',mfrPullSub:'(soufflet tirÃ©)',
  mfrType:'Type',mfrNoteChordPush:'Note/Accord PoussÃ© â†“',mfrNoteChordPull:'Note/Accord TirÃ© â†‘',
  specTitle:'SpÃ©cifications / Specifications',
  spec1:'AccordÃ©on bisonore â€” soufflet poussÃ© / tirÃ© (bisonoric â€” push / pull)',
  spec2:'Nombre de voix (reeds per note)',
  spec3:'Notation solfÃ¨ge : Do=C Â· RÃ©=D Â· Mi=E Â· Fa=F Â· Sol=G Â· La=A Â· Si=B',
  spec4:'DiÃ¨se=# Â· BÃ©mol=b  |  Octaves : 2=basse Â· 3=mÃ©d.grave Â· 4=mÃ©d Â· 5=aigu Â· 6=trÃ¨s aigu',
  specGenBy:'Document gÃ©nÃ©rÃ© le',pdfClientTitle:'Plan de clavier',pdfMfrTitle:'Bon de commande anches',
  deleteConfirm:(n)=>`Supprimer Â« ${n} Â» ?`,clearConfirm:'Effacer toutes les notes ?',
  popupAlert:'Veuillez autoriser les popups pour imprimer.',
  importSuccess:(n)=>`âœ“ ${n} instrument(s) importÃ©(s).`,importError:'âœ— Erreur : ',
  copied:'âœ“ CopiÃ© dans le presse-papiers.',invalidFormat:'Format invalide (doit Ãªtre un tableau)',
},
en:{
  title:'Diatonic Accordion Keyboard',subtitle:'Client keyboard plan & reed order form',
  myInstruments:'ğŸ“ My saved accordions',newInstrument:'ï¼‹ New instrument',importExport:'â‡… Import / Export',
  step1:'Accordion configuration',step2:'Note entry â€” click any field to open the note selector',
  step3:'Preview & print â€” updated automatically',
  instrumentRef:'Instrument reference',clientName:'Client name',date:'Date',luthier:'Luthier',
  preset:'Preset layout',rowsRH:'Right hand rows',leftHandTpl:'Left hand template',
  voices:'Number of voices (reeds)',options:'Options',showMidi:'MIDI note numbers',
  rowConfig:'Row configuration (name & button count)',
  clickToOpen:'<strong>Click</strong> a <span style="color:#1a5c1a;font-weight:700;">green</span> (push) or <span style="color:#8b6914;font-weight:700;">amber</span> (pull) field to open the note picker.',
  rightHand:'ğŸµ Right Hand',leftHand:'ğŸ¹ Left Hand',push:'Push',pull:'Pull',
  clearNotes:'ğŸ—‘ï¸ Clear all notes',saveInstrument:'ğŸ’¾ Save this accordion',
  clientVisual:'ğŸ¹ Client keyboard',manufacturerTable:'ğŸ“‹ Reed manufacturer',
  pdfClientVisual:'ğŸ–¨ï¸ PDF keyboard plan',pdfManufacturer:'ğŸ–¨ï¸ PDF manufacturer',
  listView:'ğŸ“‹ List view',sommierView:'ğŸª— Reed plate view',refresh:'ğŸ”„ Refresh',
  basses:'Basses',accords:'Chords',terzetto:'Terzetto',
  addTerzetto:'ï¼‹ Add Terzetto',removeTerzetto:'ğŸ—‘ï¸ Remove Terzetto',
  noteTab:'ğŸµ Note',chordTab:'ğŸ¼ Chord',close:'âœ• Close',
  naturals:'Natural notes',sharps:'Sharps',flats:'Flats',octave:'Octave:',
  selectNoteOctave:'â€” select a note and octave â€”',chordTitle:'Chords (click to insert)',
  clear:'Clear',insert:'Insert â†µ',
  importHelp:'Copy the JSON to save, or paste exported JSON to import.',
  importBtn:'â¬‡ï¸ Import',copyBtn:'ğŸ“‹ Copy',closeBtn:'Close',
  previewPlaceholder:'Preview will appear here after entering notesâ€¦',
  noSaved:'No saved instruments. Configure then click "ğŸ’¾ Save".',
  saved:'âœ“ Saved',dirty:'â— Unsaved changesâ€¦',saving:'â€¦ Saving',
  rows:'rows',voices_:'voices',edit:'âœï¸ Edit',copy:'â§‰ Copy',delete:'ğŸ—‘ï¸',
  cgLeft:'â€” Starting template â€”',cg4:'4 basses (2+2)',cg8:'8 basses (4+4)',
  cg12:'12 basses (6+6)',cg18:'18 basses (6+6+6)',cg24:'24 basses (8+8+8)',
  cgHelp:'Fine-tune with + / âˆ’ below',
  presetPlaceholder:'â€” Choose a preset â€”',custom:'Customâ€¦',
  svgClient:'Client',svgLuthier:'Luthier',svgPush:'â†“ Push',svgPull:'â†‘ Pull',
  svgHigh:'â–² TREBLE',svgLow:'â–¼ BASS',svgBellowsPush:'PUSH',svgBellowsPull:'PULL',
  svgRH:'Right Hand',svgLH:'Left Hand',svgSommierRH:'REED PLATE â€” Right Hand',svgSommierLH:'REED PLATE â€” Left Hand',
  svgMidi:'MIDI',svgGeneratedBy:'Generated on',svgPlan:'Keyboard plan',
  mfrRH:'RIGHT HAND â€” Melody reed plate (bisonoric)',
  mfrLH:'LEFT HAND â€” Bass & chord plates',
  mfrRow:'Row',mfrNo:'No.',mfrPushNote:'Push Note â†“',mfrPullNote:'Pull Note â†‘',
  mfrMidiPush:'MIDI â†“',mfrMidiPull:'MIDI â†‘',mfrPushSub:'(bellows push)',mfrPullSub:'(bellows pull)',
  mfrType:'Type',mfrNoteChordPush:'Note/Chord Push â†“',mfrNoteChordPull:'Note/Chord Pull â†‘',
  specTitle:'SpÃ©cifications / Specifications',
  spec1:'Bisonoric accordion â€” bellows push / pull (accordÃ©on bisonore)',
  spec2:'Number of voices (reeds per note)',
  spec3:'French solfÃ¨ge: Do=C Â· RÃ©=D Â· Mi=E Â· Fa=F Â· Sol=G Â· La=A Â· Si=B',
  spec4:'Sharp=# Â· Flat=b  |  Octaves: 2=low bass Â· 3=low mid Â· 4=mid Â· 5=high Â· 6=very high',
  specGenBy:'Generated on',pdfClientTitle:'Keyboard plan',pdfMfrTitle:'Reed order form',
  deleteConfirm:(n)=>`Delete "${n}"?`,clearConfirm:'Clear all notes?',
  popupAlert:'Please allow popups to print.',
  importSuccess:(n)=>`âœ“ ${n} instrument(s) imported.`,importError:'âœ— Error: ',
  copied:'âœ“ Copied to clipboard.',invalidFormat:'Invalid format (must be an array)',
}};
function t(k){ const v=LANGS[lang][k]; return v!==undefined?v:LANGS.fr[k]||k; }

/* â”€â”€â”€ Note name conversion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const FR2EN={
  'Do':'C','RÃ©':'D','Re':'D','Mi':'E','Fa':'F','Sol':'G','La':'A','Si':'B',
  'Do#':'C#','RÃ©#':'D#','Fa#':'F#','Sol#':'G#','La#':'A#',
  'RÃ©b':'Db','Mib':'Eb','Solb':'Gb','Lab':'Ab','Sib':'Bb','Dob':'Cb','Sib':'Bb',
};
const EN2FR={
  'C':'Do','D':'RÃ©','E':'Mi','F':'Fa','G':'Sol','A':'La','B':'Si',
  'C#':'Do#','D#':'RÃ©#','F#':'Fa#','G#':'Sol#','A#':'La#',
  'Db':'RÃ©b','Eb':'Mib','Gb':'Solb','Ab':'Lab','Bb':'Sib','Cb':'Dob',
};
function displayNote(note){
  if(!note) return '';
  if(lang==='fr') return note;
  // Try full word match first for chords like "Sol Maj"
  const m=note.match(/^(.+?)(\s+(?:Maj|Min|7|dim|aug|m7|maj7))?(\d?)$/);
  if(!m) return note;
  const root=m[1].trim(), qual=(m[2]||'').trim(), oct=m[3]||'';
  const en=FR2EN[root];
  if(en) return en+oct+(qual?' '+qual:'');
  return note;
}
function storageNote(note){
  // Convert ENâ†’FR for storage (picker uses current lang)
  if(lang==='fr') return note;
  const m=note.match(/^([A-G][#b]?)(\d?)(\s+.*)?$/);
  if(!m) return note;
  const fr=EN2FR[m[1]];
  if(fr) return fr+(m[2]||'')+(m[3]||'');
  return note;
}

/* â”€â”€â”€ Apply language to DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setLang(l){
  lang=l;
  document.getElementById('lang-fr').classList.toggle('active',l==='fr');
  document.getElementById('lang-en').classList.toggle('active',l==='en');
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k=el.dataset.i;
    const v=t(k);
    if(typeof v==='string') el.innerHTML=v;
  });
  document.querySelectorAll('[data-i-btn]').forEach(el=>{
    const k=el.dataset.iBtn;
    const v=t(k);
    if(typeof v==='string') el.textContent=v;
  });
  document.querySelectorAll('[data-i-opt]').forEach(el=>{
    const k=el.dataset.iOpt;
    const v=t(k);
    if(typeof v==='string') el.textContent=v;
  });
  // Update save status text
  const ss=document.getElementById('save-status');
  if(ss) ss.textContent=t(ss.className)||ss.textContent;
  // Reinit picker notes
  initPicker();
  // Regenerate grid (updates section labels)
  generateInputGrid();
  scheduleLivePreview();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Ã‰TAT GLOBAL                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let CFG={
  nbRangees:3,
  rangees:[
    {nom:'RangÃ©e Sol (intÃ©rieure)',nb:11},
    {nom:'RangÃ©e Do (mÃ©diane)',nb:11},
    {nom:'RangÃ©e RÃ© (extÃ©rieure)',nb:11},
  ],
  configGauche:12,
  notes:{droite:[],basses:[],accords:[],terzetto:[]}
};
let currentId=null,saveTimer=null,previewTimer=null,fabricantView='liste';
let pickerInput=null,pickerNote='',pickerOctave='';

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  NOTE â†’ MIDI                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SEMI_FR={Do:0,RÃ©:2,Re:2,Mi:4,Fa:5,Sol:7,La:9,Si:11};
const SEMI_EN={C:0,D:2,E:4,F:5,G:7,A:9,B:11};
function noteToMidi(s){
  if(!s) return null;
  let m=s.trim().match(/^(Do|RÃ©|Re|Mi|Fa|Sol|La|Si)([#b]?)(\d+)$/);
  if(m){
    const base=SEMI_FR[m[1]]; if(base===undefined) return null;
    return (parseInt(m[3])+1)*12+base+(m[2]==='#'?1:m[2]==='b'?-1:0);
  }
  m=s.trim().match(/^([A-G])([#b]?)(\d+)$/);
  if(m){
    const base=SEMI_EN[m[1]]; if(base===undefined) return null;
    return (parseInt(m[3])+1)*12+base+(m[2]==='#'?1:m[2]==='b'?-1:0);
  }
  return null;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PRÃ‰RÃ‰GLAGES                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PRESETS={
  GC21:{nbRangees:2,rangees:[{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10},{nom:'RangÃ©e Do (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'}],
    [{p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},{p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},{p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}]],
    basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}],
    accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}],terzetto:[]}},
  DG21:{nbRangees:2,rangees:[{nom:'RangÃ©e RÃ© (intÃ©rieure)',nb:10},{nom:'RangÃ©e Sol (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'RÃ©3',t:'Mi3'},{p:'Fa#3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'RÃ©4',t:'Do#4'},{p:'Fa#4',t:'Mi4'},{p:'La4',t:'Sol4'},{p:'RÃ©5',t:'Si4'},{p:'Fa#5',t:'Do#5'},{p:'La5',t:'Mi5'},{p:'RÃ©6',t:'Sol5'}],
    [{p:'Sol2',t:'La2'},{p:'Si2',t:'Do3'},{p:'RÃ©3',t:'Mi3'},{p:'Sol3',t:'Fa#3'},{p:'Si3',t:'La3'},{p:'RÃ©4',t:'Do4'},{p:'Sol4',t:'Mi4'},{p:'Si4',t:'Fa#4'},{p:'RÃ©5',t:'La4'},{p:'Sol5',t:'Do5'},{p:'Si5',t:'Mi5'}]],
    basses:[{p:'RÃ©3',t:'La2'},{p:'Sol2',t:'RÃ©2'},{p:'La3',t:'Mi3'},{p:'Do3',t:'Sol2'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}],
    accords:[{p:'RÃ© Maj',t:'La Min'},{p:'Sol Maj',t:'RÃ© Min'},{p:'La Maj',t:'Mi Min'},{p:'Do Maj',t:'Sol Maj'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}],terzetto:[]}},
  CF21:{nbRangees:2,rangees:[{nom:'RangÃ©e Do (intÃ©rieure)',nb:10},{nom:'RangÃ©e Fa (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Do3',t:'RÃ©3'},{p:'Mi3',t:'Fa3'},{p:'Sol3',t:'La3'},{p:'Do4',t:'Si3'},{p:'Mi4',t:'RÃ©4'},{p:'Sol4',t:'Fa4'},{p:'Do5',t:'La4'},{p:'Mi5',t:'Si4'},{p:'Sol5',t:'RÃ©5'},{p:'Do6',t:'Fa5'}],
    [{p:'Fa3',t:'Mi3'},{p:'La3',t:'Sol3'},{p:'Do4',t:'Sib3'},{p:'Fa4',t:'RÃ©4'},{p:'La4',t:'Mib4'},{p:'Do5',t:'Sol4'},{p:'Fa5',t:'La4'},{p:'La5',t:'Sib4'},{p:'Do6',t:'RÃ©5'},{p:'Fa6',t:'Mi5'},{p:'La6',t:'Sol5'}]],
    basses:[{p:'Do3',t:'Sol2'},{p:'Fa3',t:'Do3'},{p:'Sol2',t:'RÃ©2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'}],
    accords:[{p:'Do Maj',t:'Sol Maj'},{p:'Fa Maj',t:'Do Maj'},{p:'Sol Maj',t:'RÃ© Min'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'}],terzetto:[]}},
  GCD33:{nbRangees:3,rangees:[{nom:'RangÃ©e Sol (intÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e RÃ© (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'},{p:'Si6',t:'Mi6'}],
    [{p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},{p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},{p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}],
    [{p:'RÃ©3',t:'Mi3'},{p:'Fa#3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'RÃ©4',t:'Do#4'},{p:'Fa#4',t:'Mi4'},{p:'La4',t:'Sol4'},{p:'RÃ©5',t:'Si4'},{p:'Fa#5',t:'Do#5'},{p:'La5',t:'Mi5'},{p:'RÃ©6',t:'Sol5'},{p:'Fa#6',t:'La5'}]],
    basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}],
    accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}],terzetto:[]}},
  BbFC33:{nbRangees:3,rangees:[{nom:'RangÃ©e Sib (intÃ©rieure)',nb:11},{nom:'RangÃ©e Fa (mÃ©diane)',nb:11},{nom:'RangÃ©e Do (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Sib3',t:'Do4'},{p:'RÃ©4',t:'Mib4'},{p:'Fa4',t:'Sol4'},{p:'Sib4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Fa5',t:'Mib5'},{p:'Sib5',t:'Sol5'},{p:'RÃ©6',t:'La5'},{p:'Fa6',t:'Do6'},{p:'Sib6',t:'Mib6'},{p:'RÃ©7',t:'Sol6'}],
    [{p:'Fa3',t:'Mib3'},{p:'La3',t:'Sol3'},{p:'Do4',t:'Sib3'},{p:'Fa4',t:'RÃ©4'},{p:'La4',t:'Mib4'},{p:'Do5',t:'Sol4'},{p:'Fa5',t:'La4'},{p:'La5',t:'Sib4'},{p:'Do6',t:'RÃ©5'},{p:'Fa6',t:'Mi5'},{p:'La6',t:'Sol5'}],
    [{p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},{p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},{p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}]],
    basses:[{p:'Sib2',t:'Fa2'},{p:'Mib3',t:'Sib2'},{p:'Fa3',t:'Do3'},{p:'Do3',t:'Sol2'},{p:'Sol3',t:'RÃ©3'},{p:'RÃ©3',t:'La2'}],
    accords:[{p:'Sib Maj',t:'Fa Min'},{p:'Mib Maj',t:'Sib Maj'},{p:'Fa Maj',t:'Do Min'},{p:'Do Maj',t:'Sol Maj'},{p:'Sol Maj',t:'RÃ© Min'},{p:'RÃ© Maj',t:'La Min'}],terzetto:[]}}
};


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LOCAL STORAGE DB                                    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB_KEY='acc_clavier_db';
const DB={
  load(){try{return JSON.parse(localStorage.getItem(DB_KEY)||'[]')}catch(e){return[]}},
  save(l){localStorage.setItem(DB_KEY,JSON.stringify(l))},
  all(){return DB.load()},
  get(id){return DB.load().find(r=>r.id===id)||null},
  add(r){const l=DB.load();l.unshift(r);DB.save(l);return r.id},
  update(id,d){const l=DB.load(),i=l.findIndex(r=>r.id===id);if(i>=0){l[i]={...l[i],...d,id,lastModified:new Date().toISOString()};DB.save(l)}},
  delete(id){DB.save(DB.load().filter(r=>r.id!==id))},
  duplicate(id){const s=DB.get(id);if(!s)return null;const n=JSON.parse(JSON.stringify(s));n.id=Date.now().toString();n.nom=s.nom+' (copie)';n.lastModified=new Date().toISOString();DB.add(n);return n.id}
};

function snapshotToDB(){
  readNoteInputsIntoCFG();
  return{id:currentId||Date.now().toString(),nom:val('nom-instrument')||'Sans titre',
    joueur:val('nom-joueur'),luthier:val('nom-luthier')||"Ewen d'Aviau",
    dateCreation:val('date-creation'),lastModified:new Date().toISOString(),
    nbRangees:CFG.nbRangees,rangees:JSON.parse(JSON.stringify(CFG.rangees)),
    configGauche:parseInt(document.getElementById('config-gauche').value)||12,
    nbVoix:parseInt(document.getElementById('nb-voix').value),
    notes:JSON.parse(JSON.stringify(CFG.notes))};
}
function loadFromDB(rec){
  currentId=rec.id;
  document.getElementById('nom-instrument').value=rec.nom||'';
  document.getElementById('nom-joueur').value=rec.joueur||'';
  document.getElementById('nom-luthier').value=rec.luthier||"Ewen d'Aviau";
  document.getElementById('date-creation').value=rec.dateCreation||'';
  document.getElementById('config-gauche').value=String(rec.configGauche||12);
  document.getElementById('nb-voix').value=String(rec.nbVoix||2);
  CFG.nbRangees=rec.nbRangees||2;
  CFG.rangees=JSON.parse(JSON.stringify(rec.rangees));
  CFG.configGauche=rec.configGauche||12;
  CFG.notes=JSON.parse(JSON.stringify(rec.notes));
  // ensure terzetto exists
  if(!CFG.notes.terzetto) CFG.notes.terzetto=[];
  document.getElementById('nb-rangees').value=String(CFG.nbRangees);
  renderRangeesCfg();
  generateInputGrid();
  setSaveStatus('saved');
}
function saveCurrentInstrument(){
  readNoteInputsIntoCFG();
  const rec=snapshotToDB();
  if(currentId&&DB.get(currentId)){DB.update(currentId,rec);}
  else{currentId=rec.id;DB.add(rec);}
  renderLibrary();setSaveStatus('saved');
}
function newInstrument(){
  currentId=null;
  document.getElementById('preset-select').value='';
  document.getElementById('nom-instrument').value='';
  document.getElementById('nom-joueur').value='';
  document.getElementById('date-creation').value=new Date().toISOString().slice(0,10);
  document.getElementById('nb-voix').value='2';
  loadPreset('GCD33');
  document.getElementById('preset-select').value='GCD33';
  renderLibrary();setSaveStatus('dirty');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â”€â”€ Library â”€â”€ */
function renderLibrary(){
  const list=DB.all(),wrap=document.getElementById('lib-cards');
  if(!list.length){wrap.innerHTML=`<div class="lib-empty">${t('noSaved')}</div>`;return;}
  wrap.innerHTML=list.map(rec=>{
    const active=rec.id===currentId?' active':'';
    const d=rec.lastModified?new Date(rec.lastModified).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'2-digit'}):'â€”';
    const nb=rec.notes&&rec.notes.basses?rec.notes.basses.length:0;
    const info=`${rec.nbRangees} ${t('rows')} Â· ${nb} basses Â· ${rec.nbVoix||2} ${t('voices_')}`;
    return `<div class="instr-card${active}" id="card-${rec.id}">
      <div class="card-name">ï¿½ï¿½ ${escHTML(rec.nom)}</div>
      <div class="card-sub">${rec.joueur?'Client : '+escHTML(rec.joueur):'&nbsp;'}</div>
      <div class="card-meta">${info} Â· ${d}</div>
      <div class="card-btns">
        <button class="ca ca-edit" onclick="event.stopPropagation();editInstrument('${rec.id}')">${t('edit')}</button>
        <button class="ca ca-dup"  onclick="event.stopPropagation();duplicateInstrument('${rec.id}')">${t('copy')}</button>
        <button class="ca ca-del"  onclick="event.stopPropagation();deleteInstrument('${rec.id}')">${t('delete')}</button>
      </div></div>`;
  }).join('');
}
function editInstrument(id){const r=DB.get(id);if(!r)return;loadFromDB(r);renderLibrary();document.querySelector('.container').scrollIntoView({behavior:'smooth',block:'start'});scheduleLivePreview();}
function duplicateInstrument(id){const nid=DB.duplicate(id);renderLibrary();if(nid)editInstrument(nid);}
function deleteInstrument(id){const r=DB.get(id);if(!r)return;if(!confirm(t('deleteConfirm')(r.nom)))return;DB.delete(id);if(currentId===id){currentId=null;setSaveStatus('dirty');}renderLibrary();}

/* â”€â”€ Save status â”€â”€ */
function setSaveStatus(state){
  const el=document.getElementById('save-status');
  el.className=state;el.textContent=t(state)||t('saved');
}
function onAnyChange(){
  setSaveStatus('dirty');clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{if(currentId)saveCurrentInstrument();},1200);
  scheduleLivePreview();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  INIT                                                â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('date-creation').value=new Date().toISOString().slice(0,10);
  initPicker();renderLibrary();
  const list=DB.all();
  if(list.length){loadFromDB(list[0]);}
  else{loadPreset('GCD33');document.getElementById('preset-select').value='GCD33';}
  scheduleLivePreview();
  document.addEventListener('click',e=>{
    const p=document.getElementById('note-picker');
    if(p.style.display!=='none'&&!p.contains(e.target)&&!e.target.classList.contains('note-input'))hidePicker();
  });
});

/* â”€â”€ Preset â”€â”€ */
function loadPreset(key){
  if(!key||key==='custom'){renderRangeesCfg();generateInputGrid();onAnyChange();return;}
  const p=PRESETS[key];if(!p)return;
  CFG.nbRangees=p.nbRangees;CFG.rangees=p.rangees.map(r=>({nom:r.nom,nb:r.nb}));
  CFG.notes=JSON.parse(JSON.stringify(p.notes));
  if(!CFG.notes.terzetto)CFG.notes.terzetto=[];
  document.getElementById('nb-rangees').value=p.nbRangees;
  renderRangeesCfg();generateInputGrid();onAnyChange();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  ROWS â€” RIGHT HAND                                   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function changeNbRangees(delta){
  const el=document.getElementById('nb-rangees');
  el.value=Math.max(1,Math.min(20,(parseInt(el.value)||3)+delta));
  onRangeesChange();
}
function onRangeesChange(){
  readNoteInputsIntoCFG();
  const nb=parseInt(document.getElementById('nb-rangees').value)||1;
  CFG.nbRangees=nb;
  while(CFG.rangees.length<nb)CFG.rangees.push({nom:`RangÃ©e ${CFG.rangees.length+1}`,nb:11});
  CFG.rangees=CFG.rangees.slice(0,nb);
  while(CFG.notes.droite.length<nb)CFG.notes.droite.push([]);
  CFG.notes.droite=CFG.notes.droite.slice(0,nb);
  renderRangeesCfg();generateInputGrid();onAnyChange();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  BASSES â€” LEFT HAND (flexible)                       â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onGaucheChange(){
  readNoteInputsIntoCFG();
  const v=parseInt(document.getElementById('config-gauche').value);
  if(!v)return; // placeholder selected
  const nb=v===4?2:v===8?4:v===24?8:v===18?6:6;
  const resize=(arr,n)=>{const r=arr.slice(0,n);while(r.length<n)r.push({p:'',t:''});return r;};
  CFG.notes.basses =resize(CFG.notes.basses,nb);
  CFG.notes.accords=resize(CFG.notes.accords,nb);
  CFG.notes.terzetto=v===18?resize(CFG.notes.terzetto,6):v===24?resize(CFG.notes.terzetto,8):[];
  generateInputGrid();onAnyChange();
}
function addGaucheBtn(key){readNoteInputsIntoCFG();CFG.notes[key].push({p:'',t:''});generateInputGrid();onAnyChange();}
function removeGaucheBtn(key){readNoteInputsIntoCFG();if(CFG.notes[key].length>1){CFG.notes[key].pop();generateInputGrid();onAnyChange();}}
function toggleTerzetto(){
  readNoteInputsIntoCFG();
  if((CFG.notes.terzetto||[]).length>0){CFG.notes.terzetto=[];}
  else{CFG.notes.terzetto=Array.from({length:6},()=>({p:'',t:''}));}
  generateInputGrid();onAnyChange();
}

/* â”€â”€ Read inputs back into CFG â”€â”€ */
function readNoteInputsIntoCFG(){
  const newD=[];
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nb:11};const row=[];
    for(let b=0;b<rc.nb;b++)row.push({p:val(`d-${r}-${b}-p`),t:val(`d-${r}-${b}-t`)});
    newD.push(row);
  }
  CFG.notes.droite=newD;
  const readRow=key=>{const n=(CFG.notes[key]||[]).length;const a=[];for(let b=0;b<n;b++)a.push({p:val(`g-${key}-${b}-p`),t:val(`g-${key}-${b}-t`)});return a;};
  CFG.notes.basses =readRow('basses');
  CFG.notes.accords=readRow('accords');
  CFG.notes.terzetto=readRow('terzetto');
}

/* â”€â”€ Render row configs â”€â”€ */
function renderRangeesCfg(){
  const wrap=document.getElementById('rangees-cfg');let html='';
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nom:`RangÃ©e ${r+1}`,nb:11};
    html+=`<div class="rangee-cfg">
      <label>R${r+1} â€” Nom</label>
      <input type="text" id="rnom-${r}" value="${esc(rc.nom)}" style="font-size:.76rem;padding:3px 6px;" onchange="CFG.rangees[${r}].nom=this.value;onAnyChange()">
      <label style="margin-top:3px;">Boutons</label>
      <div class="rng-ctrl">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].nb=Math.max(1,(CFG.rangees[${r}].nb||11)-1);document.getElementById('rnb-${r}').value=CFG.rangees[${r}].nb;onRangeesChange()">âˆ’</button>
        <input type="number" id="rnb-${r}" value="${rc.nb}" min="1" max="30" style="width:46px;text-align:center;font-size:.76rem;padding:3px;" onchange="CFG.rangees[${r}].nb=parseInt(this.value)||11;onRangeesChange()">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].nb=Math.min(30,(CFG.rangees[${r}].nb||11)+1);document.getElementById('rnb-${r}').value=CFG.rangees[${r}].nb;onRangeesChange()">ï¼‹</button>
      </div></div>`;
  }
  wrap.innerHTML=html;
}

/* â”€â”€ Generate note input grid â”€â”€ */
function generateInputGrid(){
  let html='';
  // Right hand
  html+=`<div class="note-section"><div class="note-section-title">${t('rightHand')}</div>`;
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nom:`RangÃ©e ${r+1}`,nb:11};
    const nb=rc.nb;const notes=CFG.notes.droite[r]||[];
    const lbl=rc.nom.split(' ')[1]||`R${r+1}`;
    html+=`<div class="row-wrap"><div class="sec-label" style="margin-bottom:4px;">${esc(rc.nom)}</div><div class="btn-grid">`;
    for(let b=0;b<nb;b++){
      const n=notes[b]||{p:'',t:''};
      html+=`<div class="btn-cell">
        <div class="btn-num">${lbl} ${b+1}</div>
        <input class="note-input pousse" id="d-${r}-${b}-p" data-type="note" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" onfocus="showPicker(this)" readonly>
        <input class="note-input tire"   id="d-${r}-${b}-t" data-type="note" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" onfocus="showPicker(this)" readonly>
      </div>`;
    }
    html+=`</div></div>`;
  }
  html+=`</div>`;
  // Left hand
  html+=`<div class="note-section"><div class="note-section-title">${t('leftHand')}</div>`;
  const gsec=[
    {key:'basses',label:t('basses'),type:'note'},
    {key:'accords',label:t('accords'),type:'chord'},
  ];
  if((CFG.notes.terzetto||[]).length>0)gsec.push({key:'terzetto',label:t('terzetto'),type:'chord'});
  gsec.forEach(({key,label,type})=>{
    const arr=CFG.notes[key]||[];const count=arr.length;
    html+=`<div class="row-wrap">
      <div class="sec-hd">
        <span class="sec-label">${label} <span style="color:var(--gris);font-weight:normal;">(${count})</span></span>
        <button type="button" class="rng-btn" onclick="removeGaucheBtn('${key}')" title="âˆ’">âˆ’</button>
        <button type="button" class="rng-btn" onclick="addGaucheBtn('${key}')" title="ï¼‹">ï¼‹</button>
      </div>
      <div class="btn-grid">`;
    for(let b=0;b<count;b++){
      const n=arr[b]||{p:'',t:''};
      html+=`<div class="btn-cell">
        <div class="btn-num">${label[0].toUpperCase()}${b+1}</div>
        <input class="note-input pousse" id="g-${key}-${b}-p" data-type="${type}" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" onfocus="showPicker(this)" readonly>
        <input class="note-input tire"   id="g-${key}-${b}-t" data-type="${type}" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" onfocus="showPicker(this)" readonly>
      </div>`;
    }
    html+=`</div></div>`;
  });
  const hasTerz=(CFG.notes.terzetto||[]).length>0;
  html+=`<div style="margin-top:9px;">
    <button class="btn btn-outline" style="font-size:.76rem;padding:4px 11px;" onclick="toggleTerzetto()">${hasTerz?t('removeTerzetto'):t('addTerzetto')}</button>
  </div>`;
  html+=`</div>`;
  document.getElementById('note-grid').innerHTML=html;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  NOTE PICKER                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Notes shown in picker depend on current lang
const NOTES_FR={nat:['Do','RÃ©','Mi','Fa','Sol','La','Si'],sha:['Do#','RÃ©#',null,'Fa#','Sol#','La#',null],fla:['RÃ©b','Mib',null,'Solb','Lab','Sib',null]};
const NOTES_EN={nat:['C','D','E','F','G','A','B'],sha:['C#','D#',null,'F#','G#','A#',null],fla:['Db','Eb',null,'Gb','Ab','Bb',null]};
const OCTAVES=['2','3','4','5','6'];
const CHORDS_FR=()=>{const r=['Do','RÃ©','Mi','Fa','Sol','La','Si','Do#','RÃ©#','Fa#','Sol#','Sib','Mib','Lab'];const t=['Maj','Min','7'];const o=[];r.forEach(n=>t.forEach(q=>o.push(`${n} ${q}`)));return o;};
const CHORDS_EN=()=>{const r=['C','D','E','F','G','A','B','C#','D#','F#','G#','Bb','Eb','Ab'];const t=['Maj','Min','7'];const o=[];r.forEach(n=>t.forEach(q=>o.push(`${n} ${q}`)));return o;};

function initPicker(){
  const N=lang==='en'?NOTES_EN:NOTES_FR;
  document.getElementById('picker-naturals').innerHTML=N.nat.map(n=>`<button class="pn" onclick="pickerSetNote('${n}')">${n}</button>`).join('');
  document.getElementById('picker-sharps').innerHTML=N.sha.map(n=>n?`<button class="pn sharp" onclick="pickerSetNote('${n}')">${n}</button>`:`<span style="min-width:34px;"></span>`).join('');
  document.getElementById('picker-flats').innerHTML=N.fla.map(n=>n?`<button class="pn flat" onclick="pickerSetNote('${n}')">${n}</button>`:`<span style="min-width:34px;"></span>`).join('');
  const oWrap=document.getElementById('picker-octaves');
  oWrap.innerHTML=OCTAVES.map(o=>`<button class="po" onclick="pickerSetOctave('${o}')">${o}</button>`).join('');
  const C=lang==='en'?CHORDS_EN():CHORDS_FR();
  document.getElementById('picker-chords-grid').innerHTML=C.map(c=>`<button class="pc" onclick="pickerInsertDirect('${c}')">${c}</button>`).join('');
}
function showPicker(input){
  pickerInput=input;pickerNote='';pickerOctave='';
  const v=input.value.trim();
  if(v){
    const m=v.match(/^(.+?)([2-6])$/);
    if(m){pickerNote=m[1];pickerOctave=m[2];}else pickerNote=v;
  }
  const isChord=input.dataset.type==='chord';
  showPickerTab(isChord?'chords':'notes',document.querySelector(isChord?'.picker-tab-btn:nth-child(2)':'.picker-tab-btn:first-child'));
  updatePickerHighlights();updatePickerPreview();
  const pk=document.getElementById('note-picker');pk.style.display='block';
  const rect=input.getBoundingClientRect(),sy=window.scrollY,sx=window.scrollX;
  let top=sy+rect.bottom+6,left=sx+rect.left;
  const pw=pk.offsetWidth||310,ph=pk.offsetHeight||300;
  if(left+pw>sx+window.innerWidth-10)left=sx+window.innerWidth-pw-10;
  if(left<8)left=8;
  if(top+ph>sy+window.innerHeight-10)top=sy+rect.top-ph-6;
  pk.style.top=top+'px';pk.style.left=left+'px';
  input.classList.add('picker-open');
}
function hidePicker(){
  document.getElementById('note-picker').style.display='none';
  if(pickerInput){pickerInput.classList.remove('picker-open');pickerInput=null;}
}
function showPickerTab(name,btn){
  document.querySelectorAll('.picker-tab-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById('picker-tab-notes').classList.toggle('active',name==='notes');
  document.getElementById('picker-tab-chords').classList.toggle('active',name==='chords');
}
function pickerSetNote(n){pickerNote=n;updatePickerHighlights();updatePickerPreview();if(pickerNote&&pickerOctave)pickerInsert();}
function pickerSetOctave(o){pickerOctave=o;updatePickerHighlights();updatePickerPreview();if(pickerNote&&pickerOctave)pickerInsert();}
function pickerInsertDirect(text){
  if(!pickerInput)return;
  pickerInput.value=storageNote(text);
  pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  hidePicker();onAnyChange();
}
function pickerInsert(){
  if(!pickerInput)return;
  const v=pickerNote+pickerOctave;if(!v)return;
  pickerInput.value=storageNote(v);
  pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  hidePicker();onAnyChange();
}
function pickerClear(){
  if(!pickerInput)return;
  pickerInput.value='';pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  pickerNote='';pickerOctave='';updatePickerHighlights();updatePickerPreview();hidePicker();onAnyChange();
}
function updatePickerHighlights(){
  document.querySelectorAll('#picker-tab-notes .pn').forEach(b=>b.classList.toggle('selected',b.textContent===pickerNote));
  document.querySelectorAll('.po').forEach(b=>b.classList.toggle('selected',b.textContent===pickerOctave));
}
function updatePickerPreview(){
  const txt=pickerNote+pickerOctave;
  document.getElementById('picker-preview-text').textContent=txt||t('selectNoteOctave');
  const showMidi=document.getElementById('show-midi')?.checked;
  const badge=document.getElementById('picker-midi-badge');
  if(badge){
    const m=txt?noteToMidi(storageNote(txt)):null;
    badge.textContent=(showMidi&&m!==null)?`MIDI ${m}`:'';
  }
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  READ INPUTS â†’ data object                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function readInputs(){
  readNoteInputsIntoCFG();
  const droite=CFG.notes.droite.map((row,ri)=>({
    nom:CFG.rangees[ri]?CFG.rangees[ri].nom:`RangÃ©e ${ri+1}`,boutons:row
  }));
  return{
    nomInstrument:val('nom-instrument')||'AccordÃ©on Diatonique',
    nomJoueur:val('nom-joueur'),
    nomLuthier:val('nom-luthier')||"Ewen d'Aviau",
    date:val('date-creation'),
    nbVoix:parseInt(document.getElementById('nb-voix').value),
    showMidi:document.getElementById('show-midi')?.checked||false,
    droite,
    basses:CFG.notes.basses,
    accords:CFG.notes.accords,
    terzetto:CFG.notes.terzetto||[],
  };
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG HELPERS                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function svg_open(w,h,bg){return`<svg width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg" font-family="Arial,Helvetica,sans-serif"><rect width="${w}" height="${h}" fill="${bg||'white'}"/>`;}
function tx(x,y,text,size,fill,weight,anchor){return`<text x="${x}" y="${y}" font-size="${size}" fill="${fill}" font-weight="${weight||'normal'}" text-anchor="${anchor||'start'}">${text}</text>`;}
function esc(s){if(!s)return'';return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escSVG(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escHTML(s){if(!s)return'';const d=document.createElement('div');d.appendChild(document.createTextNode(String(s)));return d.innerHTML;}
function fmtDate(d){if(!d)return new Date().toLocaleDateString('fr-FR');try{return new Date(d).toLocaleDateString('fr-FR');}catch(e){return d;}}
function dn(note){return escSVG(displayNote(note));}  // display note in current lang

/* â”€â”€â”€ Bellows SVG â”€â”€â”€ */
function bellowsSVG(x,y,w,h,folds,dark){
  const gold=dark?'#c9a227':'#8b6914',bg=dark?'#0a0800':'#fff8e6';
  let s=`<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${bg}" rx="2"/>`;
  const fh=h/folds;
  for(let i=0;i<folds;i++){
    const fy1=y+i*fh,fy2=fy1+fh,mid=fy1+fh/2;
    s+=`<line x1="${x}" y1="${fy1}" x2="${x+w}" y2="${fy1}" stroke="${gold}" stroke-width=".6" opacity=".7"/>`;
    s+=`<line x1="${x}" y1="${fy1}" x2="${x+w/2}" y2="${mid}" stroke="${gold}" stroke-width=".9"/>`;
    s+=`<line x1="${x+w/2}" y1="${mid}" x2="${x+w}" y2="${fy1}" stroke="${gold}" stroke-width=".9"/>`;
    if(i<folds-1){
      s+=`<line x1="${x}" y1="${fy2}" x2="${x+w/2}" y2="${mid}" stroke="${gold}" stroke-width=".6" opacity=".5"/>`;
      s+=`<line x1="${x+w/2}" y1="${mid}" x2="${x+w}" y2="${fy2}" stroke="${gold}" stroke-width=".6" opacity=".5"/>`;
    }
  }
  s+=`<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="none" stroke="${gold}" stroke-width="1.5" rx="2"/>`;
  return s;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG KEYBOARD â€” CLIENT (light preview + dark PDF)    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSVG_Droite(data,dark){
  const R=24,HGAP=60,VGAP=72,BW=26,LPAD=186,MARG=14,HEAD=80,FOOT=34;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111111':'#ffffff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const subtl=dark?'#888866':'#888888',stroke=dark?'#c9a227':'#2d5a27';
  const band1=dark?'#1a1a1a':'#fafafa',band2=dark?'#161616':'#f3f7f3';
  const numTx=dark?'rgba(200,162,39,.3)':'rgba(0,0,0,.2)';

  const maxBtns=Math.max(...data.droite.map(r=>r.boutons.length),1);
  const W=BW+LPAD+maxBtns*HGAP+MARG;
  const H=MARG+HEAD+data.droite.length*VGAP+FOOT;

  let s=svg_open(W,H,bg);

  // Bellows strip
  s+=bellowsSVG(MARG,MARG+HEAD,BW,data.droite.length*VGAP,Math.max(4,data.droite.length*2),dark);
  s+=tx(MARG+BW/2,MARG+HEAD-4,t('svgBellowsPush'),6,gold,'bold','middle');
  s+=tx(MARG+BW/2,MARG+HEAD+data.droite.length*VGAP+10,t('svgBellowsPull'),6,gold,'bold','middle');

  // Orientation arrows
  const ax=W-MARG-2;
  s+=tx(ax,MARG+HEAD-4,t('svgHigh'),8,gold,'bold','end');
  s+=tx(ax,MARG+HEAD+data.droite.length*VGAP+10,t('svgLow'),8,gold,'bold','end');
  s+=`<line x1="${ax-40}" y1="${MARG+HEAD-2}" x2="${ax-40}" y2="${MARG+HEAD+data.droite.length*VGAP}" stroke="${gold}" stroke-width=".8" opacity=".4"/>`;

  // Title
  s+=tx(BW+LPAD+(maxBtns*HGAP)/2,MARG+16,escSVG(data.nomInstrument),16,gold,'bold','middle');
  if(data.nomJoueur)s+=tx(BW+LPAD+(maxBtns*HGAP)/2,MARG+32,`${t('svgClient')} : ${escSVG(data.nomJoueur)}`,10,subtl,'normal','middle');
  s+=tx(BW+LPAD+(maxBtns*HGAP)/2,MARG+47,`${t('svgLuthier')} : ${escSVG(data.nomLuthier)}  Â·  ${fmtDate(data.date)}`,9,subtl,'normal','middle');

  // Legend
  const lx=BW+LPAD,ly=MARG+62;
  s+=`<rect x="${lx}" y="${ly-10}" width="13" height="10" rx="2" fill="${pushBg}" stroke="${stroke}" stroke-width="1.2"/>`;
  s+=tx(lx+17,ly,t('svgPush'),8,dark?'#ccc':'#333','normal','start');
  s+=`<rect x="${lx+70}" y="${ly-10}" width="13" height="10" rx="2" fill="${pullBg}" stroke="${dark?'#c9a227':'#c8a96e'}" stroke-width="1.2"/>`;
  s+=tx(lx+87,ly,t('svgPull'),8,dark?'#ccc':'#333','normal','start');

  // Rows
  data.droite.forEach((row,ri)=>{
    const cy=MARG+HEAD+ri*VGAP+VGAP/2;
    const stagger=(ri%2===1)?HGAP/2:0;
    s+=`<rect x="${BW+LPAD-4}" y="${cy-R-6}" width="${row.boutons.length*HGAP+stagger+8}" height="${(R+6)*2}" rx="4" fill="${ri%2===0?band1:band2}" opacity=".7"/>`;
    s+=tx(BW+LPAD-8,cy+4,escSVG(row.nom),9.5,gold,'bold','end');
    row.boutons.forEach((btn,bi)=>{
      const cx=BW+LPAD+stagger+bi*HGAP;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#ffffff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
      s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
      s+=tx(cx,cy+3.5,bi+1,7.5,numTx,'normal','middle');
      if(btn.p){const fs=btn.p.length>6?7:8.5;s+=tx(cx,cy-9,dn(btn.p),fs,pushTx,'bold','middle');}
      if(btn.t){const fs=btn.t.length>6?7:8.5;s+=tx(cx,cy+19,dn(btn.t),fs,pullTx,'bold','middle');}
      if(data.showMidi){
        const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);
        if(mp!==null)s+=tx(cx+R-2,cy-R+6,mp,5.5,'rgba(100,140,220,.8)','normal','end');
        if(mt!==null)s+=tx(cx+R-2,cy+R-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
      }
    });
  });

  const fy=MARG+HEAD+data.droite.length*VGAP+14;
  s+=`<line x1="${BW+LPAD}" y1="${fy}" x2="${W-MARG-44}" y2="${fy}" stroke="${dark?'#333':'#eee'}" stroke-width="1"/>`;
  s+=tx(BW+LPAD,fy+14,`${escSVG(data.nomLuthier)} â€” ewendaviau.com`,7.5,dark?'#444':'#bbb','normal','start');
  s+='</svg>';return s;
}

function buildSVG_Gauche(data,dark){
  const R=24,HGAP=62,VGAP=70,LPAD=110,MARG=12,HEAD=32,FOOT=20;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111':'#fff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const stroke=dark?'#c9a227':'#2d5a27';
  const band1=dark?'#1a1a1a':'#fafafa',band2=dark?'#161616':'#f3f7f3';
  const numTx=dark?'rgba(200,162,39,.3)':'rgba(0,0,0,.2)';

  const sections=[{nom:t('basses'),items:data.basses},{nom:t('accords'),items:data.accords}];
  if(data.terzetto&&data.terzetto.length)sections.push({nom:t('terzetto'),items:data.terzetto});
  const maxItems=Math.max(...sections.map(s=>s.items.length),1);
  const W=LPAD+maxItems*HGAP+MARG;
  const H=MARG+HEAD+sections.length*VGAP+FOOT;

  let s=svg_open(W,H,bg);
  s+=tx(W/2,MARG+16,`${t('svgLH')} â€” ${escSVG(data.nomInstrument)}`,12,gold,'bold','middle');
  sections.forEach((sec,si)=>{
    const cy=MARG+HEAD+si*VGAP+VGAP/2;
    const stagger=(si%2===1)?HGAP/2:0;
    s+=`<rect x="${LPAD-4}" y="${cy-R-6}" width="${sec.items.length*HGAP+stagger+8}" height="${(R+6)*2}" rx="4" fill="${si%2===0?band1:band2}" opacity=".7"/>`;
    s+=tx(LPAD-7,cy+4,escSVG(sec.nom),10,gold,'bold','end');
    sec.items.forEach((btn,bi)=>{
      const cx=LPAD+stagger+bi*HGAP;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#fff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
      s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
      s+=tx(cx,cy+3.5,bi+1,7.5,numTx,'normal','middle');
      if(btn.p){const fs=btn.p.length>7?7:(btn.p.length>4?7.5:8.5);s+=tx(cx,cy-9,dn(btn.p),fs,pushTx,'bold','middle');}
      if(btn.t){const fs=btn.t.length>7?7:(btn.t.length>4?7.5:8.5);s+=tx(cx,cy+19,dn(btn.t),fs,pullTx,'bold','middle');}
      if(data.showMidi){
        const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);
        if(mp!==null)s+=tx(cx+R-2,cy-R+6,mp,5.5,'rgba(100,140,220,.8)','normal','end');
        if(mt!==null)s+=tx(cx+R-2,cy+R-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
      }
    });
  });
  s+='</svg>';return s;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG SOMMIER (reed plate view)                       â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSommierSection(title,rows,dark){
  const CW=58,CH=46,LPAD=164,MARG=12,HEAD=52,VGAP=CH+6,FOOT=20;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111':'#fff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const numTx=dark?'rgba(200,162,39,.4)':'rgba(0,0,0,.3)';
  const sep=dark?'#3a3a1a':'#cccccc';
  const stagger=CW/2;
  const showMidi=document.getElementById('show-midi')?.checked;

  function cell(cx,cy,num,pNote,tNote){
    let o='';
    o+=`<rect x="${cx}" y="${cy}" width="${CW}" height="${CH/2}" fill="${pushBg}" stroke="${dark?'#2a4a2a':'#b0ccb0'}" stroke-width=".7"/>`;
    o+=`<rect x="${cx}" y="${cy+CH/2}" width="${CW}" height="${CH/2}" fill="${pullBg}" stroke="${dark?'#4a2a00':'#ccb080'}" stroke-width=".7"/>`;
    o+=`<line x1="${cx}" y1="${cy+CH/2}" x2="${cx+CW}" y2="${cy+CH/2}" stroke="${sep}" stroke-width=".8"/>`;
    o+=tx(cx+3,cy+9,num,6.5,numTx,'normal','start');
    if(pNote){const fs=pNote.length>6?7:8.5;o+=tx(cx+CW/2,cy+16,dn(pNote),fs,pushTx,'bold','middle');}
    if(tNote){const fs=tNote.length>6?7:8.5;o+=tx(cx+CW/2,cy+CH-7,dn(tNote),fs,pullTx,'bold','middle');}
    if(showMidi){
      const mp=noteToMidi(pNote),mt=noteToMidi(tNote);
      if(mp!==null)o+=tx(cx+CW-2,cy+9,mp,5.5,'rgba(100,140,220,.8)','normal','end');
      if(mt!==null)o+=tx(cx+CW-2,cy+CH-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
    }
    return o;
  }

  const maxBtns=Math.max(...rows.map(r=>r.boutons?r.boutons.length:(r.items?r.items.length:0)),1);
  const W=LPAD+maxBtns*CW+stagger+MARG;
  const H=MARG+HEAD+rows.length*VGAP+FOOT;
  let s=svg_open(W,H,bg);

  // Header
  s+=tx(W/2,MARG+15,escSVG(title),12,gold,'bold','middle');
  s+=`<rect x="${LPAD}" y="${MARG+25}" width="13" height="8" rx="1" fill="${pushBg}" stroke="${dark?'#4a7a40':'#2d5a27'}" stroke-width=".8"/>`;
  s+=tx(LPAD+17,MARG+33,t('svgPush'),7.5,dark?'#ccc':'#333','normal','start');
  s+=`<rect x="${LPAD+68}" y="${MARG+25}" width="13" height="8" rx="1" fill="${pullBg}" stroke="${dark?'#c9a227':'#c8a96e'}" stroke-width=".8"/>`;
  s+=tx(LPAD+85,MARG+33,t('svgPull'),7.5,dark?'#ccc':'#333','normal','start');
  if(showMidi)s+=tx(LPAD+135,MARG+33,'MIDI = coin â†—',7,dark?'rgba(100,140,220,.8)':'rgba(21,101,192,.6)','normal','start');

  rows.forEach((row,ri)=>{
    const rowY=MARG+HEAD+ri*VGAP;
    const rowStag=(ri%2===1)?stagger:0;
    const nom=row.nom||(row.label||`R${ri+1}`);
    const items=row.boutons||row.items||[];
    s+=tx(LPAD-5,rowY+CH/2+4,escSVG(nom),9,gold,'bold','end');
    items.forEach((btn,bi)=>{s+=cell(LPAD+rowStag+bi*CW,rowY,bi+1,btn.p||'',btn.t||'');});
  });
  s+='</svg>';return s;
}

function buildSommierSVG(data,dark){
  const rhTitle=t('svgSommierRH')+' â€” '+escSVG(data.nomInstrument);
  const lhTitle=t('svgSommierLH')+' â€” '+escSVG(data.nomInstrument);
  const lhSections=[];
  if(data.basses&&data.basses.length)lhSections.push({nom:t('basses'),items:data.basses});
  if(data.accords&&data.accords.length)lhSections.push({nom:t('accords'),items:data.accords});
  if(data.terzetto&&data.terzetto.length)lhSections.push({nom:t('terzetto'),items:data.terzetto});
  const svgD=buildSommierSection(rhTitle,data.droite,dark);
  const svgG=lhSections.length?buildSommierSection(lhTitle,lhSections,dark):'';
  const h3style=`color:var(--vert);font-size:.88rem;margin-bottom:10px;`;
  const h3dstyle=`color:#c9a227;font-size:.88rem;margin-bottom:10px;`;
  return `<h3 style="${dark?h3dstyle:h3style}">${t('svgRH')}</h3>${svgD}
    <h3 style="${dark?h3dstyle:h3style};margin-top:18px;">${t('svgLH')}</h3>${svgG}`;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  MANUFACTURER TABLE                                  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildManufacturerTable(data,dark){
  const date=fmtDate(data.date);
  const showMidi=data.showMidi;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111':'#fff';
  const subStyle=dark?'color:#aaa;':'color:#666;';

  let h=`<p class="mfr-sub" style="${subStyle}">
    ${t('instrumentRef')} : <strong>${escHTML(data.nomInstrument)}</strong> &nbsp;|&nbsp;
    ${t('clientName')} : <strong>${escHTML(data.nomJoueur)||'â€”'}</strong> &nbsp;|&nbsp;
    ${t('luthier')} : <strong>${escHTML(data.nomLuthier)}</strong> &nbsp;|&nbsp;
    ${t('date')} : <strong>${date}</strong> &nbsp;|&nbsp;
    ${t('voices')} : <strong>${data.nbVoix}</strong></p>`;

  const thStyle=dark?`style="background:#1a1500;color:#c9a227;border-color:#333;"`:'';
  const tdStyle=dark?`style="background:#1a1a1a;border-color:#333;color:#ddd;"`:'';
  const hdStyle=dark?`style="background:#111;color:#c9a227;border-color:#333;font-weight:700;"`:'class="row-hd"';

  const tableStart=(midi)=>`<table class="mfr-table" style="${dark?'color:#ddd;':''}"><thead><tr>
    <th ${thStyle}>${t('mfrRow')}</th><th ${thStyle}>${t('mfrNo')}</th>
    <th ${thStyle}>${t('mfrPushNote')}<br><small style="font-weight:400;opacity:.8">${t('mfrPushSub')}</small></th>
    <th ${thStyle}>${t('mfrPullNote')}<br><small style="font-weight:400;opacity:.8">${t('mfrPullSub')}</small></th>
    ${midi?`<th ${thStyle}>${t('mfrMidiPush')}</th><th ${thStyle}>${t('mfrMidiPull')}</th>`:''}
  </tr></thead><tbody>`;

  h+=`<h4 style="color:${gold};border-bottom:2px solid ${dark?'#333':'#c8e0c5'};padding-bottom:5px;margin:0 0 10px;font-size:.88rem;">${t('mfrRH')}</h4>`;
  h+=tableStart(showMidi);
  data.droite.forEach(row=>{
    row.boutons.forEach((btn,bi)=>{
      h+=`<tr>`;
      if(bi===0)h+=`<td ${hdStyle} rowspan="${row.boutons.length}">${escHTML(row.nom)}</td>`;
      h+=`<td ${tdStyle}>${bi+1}</td>`;
      h+=`<td class="note-p" ${tdStyle}>${escHTML(displayNote(btn.p))||'â€”'}</td>`;
      h+=`<td class="note-t" ${tdStyle}>${escHTML(displayNote(btn.t))||'â€”'}</td>`;
      if(showMidi){const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);h+=`<td class="midi-c" ${tdStyle}>${mp!==null?mp:'â€”'}</td><td class="midi-c" ${tdStyle}>${mt!==null?mt:'â€”'}</td>`;}
      h+=`</tr>`;
    });
  });
  h+=`</tbody></table>`;

  const lhExtra=data.terzetto.length?` &amp; ${t('terzetto')}`:'';
  h+=`<h4 style="color:${gold};border-bottom:2px solid ${dark?'#333':'#c8e0c5'};padding-bottom:5px;margin:18px 0 10px;font-size:.88rem;">${t('mfrLH')}${lhExtra}</h4>`;
  h+=`<table class="mfr-table" style="${dark?'color:#ddd;':''}"><thead><tr>
    <th ${thStyle}>${t('mfrType')}</th><th ${thStyle}>${t('mfrNo')}</th>
    <th ${thStyle}>${t('mfrNoteChordPush')}</th><th ${thStyle}>${t('mfrNoteChordPull')}</th>
    ${showMidi?`<th ${thStyle}>${t('mfrMidiPush')}</th><th ${thStyle}>${t('mfrMidiPull')}</th>`:''}
  </tr></thead><tbody>`;
  const gs=[{nom:t('basses'),arr:data.basses},{nom:t('accords'),arr:data.accords}];
  if(data.terzetto.length)gs.push({nom:t('terzetto'),arr:data.terzetto});
  gs.forEach(({nom,arr})=>{
    arr.forEach((btn,bi)=>{
      h+=`<tr>`;
      if(bi===0)h+=`<td ${hdStyle} rowspan="${arr.length}">${nom}</td>`;
      h+=`<td ${tdStyle}>${bi+1}</td>`;
      h+=`<td class="note-p" ${tdStyle}>${escHTML(displayNote(btn.p))||'â€”'}</td>`;
      h+=`<td class="note-t" ${tdStyle}>${escHTML(displayNote(btn.t))||'â€”'}</td>`;
      if(showMidi){const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);h+=`<td class="midi-c" ${tdStyle}>${mp!==null?mp:'â€”'}</td><td class="midi-c" ${tdStyle}>${mt!==null?mt:'â€”'}</td>`;}
      h+=`</tr>`;
    });
  });
  h+=`</tbody></table>`;
  h+=`<div style="margin-top:18px;background:${dark?'#1a1500':'#f6f9f5'};border:1.5px solid ${dark?'#333':'#c8e0c5'};border-radius:6px;padding:11px 14px;font-size:.78rem;${dark?'color:#ccc;':''}">
    <strong>${t('specTitle')}</strong><br>
    &bull; ${t('spec1')}<br>&bull; ${t('spec2')} : <strong>${data.nbVoix}</strong><br>
    &bull; ${t('spec3')}<br>&bull; ${t('spec4')}<br><br>
    <em>${t('specGenBy')} ${date} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</em></div>`;
  return h;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LIVE PREVIEW                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function scheduleLivePreview(){clearTimeout(previewTimer);previewTimer=setTimeout(runLivePreview,600);}
function forcePreview(){clearTimeout(previewTimer);runLivePreview();}
function runLivePreview(){
  try{
    const data=readInputs();
    const svgD=buildSVG_Droite(data,false);
    const svgG=buildSVG_Gauche(data,false);
    document.getElementById('visual-output').innerHTML=
      `<h3 style="color:var(--vert);font-size:.88rem;margin-bottom:9px;">${t('svgRH')}</h3>${svgD}
       <h3 style="color:var(--vert);font-size:.88rem;margin:16px 0 9px;">${t('svgLH')}</h3>${svgG}`;
    document.getElementById('table-output').innerHTML=buildManufacturerTable(data,false);
    document.getElementById('sommier-output').innerHTML=buildSommierSVG(data,false);
  }catch(e){}
}

/* â”€â”€ Tabs â”€â”€ */
function showTab(name,btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-visual').style.display   =name==='visual'   ?'':'none';
  document.getElementById('tab-fabricant').style.display=name==='fabricant'?'':'none';
}
function showFabricantView(mode,btn){
  fabricantView=mode;
  document.querySelectorAll('.fab-view-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('fab-view-liste').style.display  =mode==='liste'  ?'':'none';
  document.getElementById('fab-view-sommier').style.display=mode==='sommier'?'':'none';
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PDF PRINT â€” DARK/GOLD MIDICORE DESIGN               â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function printSection(which){
  const data=readInputs();
  const title=which==='visual'
    ?`${t('pdfClientTitle')} â€” ${data.nomInstrument}`
    :`${t('pdfMfrTitle')} â€” ${data.nomInstrument}`;
  const dark=true; // always dark/gold for PDF

  let body='';
  if(which==='visual'){
    const svgD=buildSVG_Droite(data,dark);
    const svgG=buildSVG_Gauche(data,dark);
    body=`
      <div style="background:#111;min-height:100vh;padding:12mm 14mm;color:#eee;">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #c9a227;padding-bottom:4mm;margin-bottom:6mm;">
          <div>
            <h2 style="color:#c9a227;font-size:15pt;font-family:'Georgia',serif;letter-spacing:.05em;margin:0;">${escHTML(data.nomInstrument)}</h2>
            <p style="font-size:9pt;color:#888;margin:1mm 0 0;">${t('svgClient')} : <b style="color:#ddd;">${escHTML(data.nomJoueur)||'â€”'}</b> &nbsp;Â·&nbsp; ${t('svgLuthier')} : <b style="color:#ddd;">${escHTML(data.nomLuthier)}</b> &nbsp;Â·&nbsp; ${fmtDate(data.date)}</p>
          </div>
          <div style="font-size:8pt;color:#c9a227;text-align:right;">ewendaviau.com</div>
        </div>
        <div style="display:flex;gap:10mm;margin-bottom:5mm;">
          <span style="font-size:8pt;color:#ccc;"><span style="display:inline-block;width:10mm;height:5mm;background:#0d1f0d;border:1px solid #c9a227;border-radius:2px;vertical-align:middle;margin-right:2mm;"></span>${t('svgPush')}</span>
          <span style="font-size:8pt;color:#ccc;"><span style="display:inline-block;width:10mm;height:5mm;background:#1f1000;border:1px solid #c9a227;border-radius:2px;vertical-align:middle;margin-right:2mm;"></span>${t('svgPull')}</span>
        </div>
        <h3 style="color:#c9a227;font-size:10pt;margin:3mm 0 2mm;">${t('svgRH')}</h3>
        ${svgD}
        <h3 style="color:#c9a227;font-size:10pt;margin:6mm 0 2mm;">${t('svgLH')}</h3>
        ${svgG}
        <p style="font-size:7pt;color:#555;text-align:center;margin-top:8mm;border-top:1px solid #333;padding-top:3mm;">${t('svgGeneratedBy')} ${fmtDate(data.date)} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</p>
      </div>`;
  } else if(fabricantView==='sommier'){
    body=`
      <div style="background:#111;min-height:100vh;padding:12mm 14mm;color:#eee;">
        <div style="border-bottom:2px solid #c9a227;padding-bottom:4mm;margin-bottom:6mm;">
          <h2 style="color:#c9a227;font-size:14pt;font-family:'Georgia',serif;">${escHTML(data.nomInstrument)} â€” ${t('sommierView').replace('ğŸª— ','')}</h2>
        </div>
        ${buildSommierSVG(data,true)}
        <p style="font-size:7pt;color:#555;text-align:center;margin-top:8mm;border-top:1px solid #333;padding-top:3mm;">${t('svgGeneratedBy')} ${fmtDate(data.date)} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</p>
      </div>`;
  } else {
    const tableHtml=buildManufacturerTable(data,true);
    body=`
      <div style="background:#111;min-height:100vh;padding:12mm 14mm;color:#eee;">
        <div style="border-bottom:2px solid #c9a227;padding-bottom:4mm;margin-bottom:6mm;">
          <h2 style="color:#c9a227;font-size:14pt;font-family:'Georgia',serif;">${escHTML(data.nomInstrument)} â€” ${t('pdfMfrTitle')}</h2>
        </div>
        ${tableHtml}
        <p style="font-size:7pt;color:#555;text-align:center;margin-top:8mm;border-top:1px solid #333;padding-top:3mm;">${t('svgGeneratedBy')} ${fmtDate(data.date)} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</p>
      </div>`;
  }

  const win=window.open('','_blank','width=960,height=740');
  if(!win){alert(t('popupAlert'));return;}
  win.document.write(`<!DOCTYPE html><html lang="${lang}"><head>
    <meta charset="UTF-8"><title>${escHTML(title)}</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Arial,Helvetica,sans-serif;background:#111}
      .mfr-table{width:100%;border-collapse:collapse;font-size:8.5pt;margin-bottom:4mm}
      .mfr-table th,.mfr-table td{border:1px solid #333;padding:4px 8px;text-align:center}
      .mfr-table th{background:#1a1500;color:#c9a227;font-size:7.5pt;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .mfr-table tr:nth-child(even) td{background:#1a1a1a}
      .mfr-table td{background:#111;color:#ddd}
      td.note-p{color:#6fcf5a;font-weight:700}
      td.note-t{color:#e8b840;font-weight:700}
      td.midi-c{color:#82b0ff;font-size:.72rem}
      .mfr-sub{font-size:8pt;color:#aaa;margin-bottom:4mm}
      svg{display:block;max-width:100%}
      @media print{body{background:#111!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}}
    </style>
  </head><body>${body}</body></html>`);
  win.document.close();win.focus();
  setTimeout(()=>win.print(),700);
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  MISC ACTIONS                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearNotes(){
  if(!confirm(t('clearConfirm')))return;
  document.querySelectorAll('#note-grid input').forEach(el=>{el.value='';});
  readNoteInputsIntoCFG();onAnyChange();
}
function openImportExport(){
  document.getElementById('modal-json').value=JSON.stringify(DB.all(),null,2);
  document.getElementById('modal-msg').textContent='';
  document.getElementById('import-modal').classList.add('open');
}
function closeModal(){document.getElementById('import-modal').classList.remove('open');}
function copyJSON(){
  const ta=document.getElementById('modal-json');ta.select();document.execCommand('copy');
  document.getElementById('modal-msg').textContent=t('copied');
}
function doImport(){
  try{
    const data=JSON.parse(document.getElementById('modal-json').value);
    if(!Array.isArray(data))throw new Error(t('invalidFormat'));
    DB.save(data);renderLibrary();
    if(data.length)loadFromDB(data[0]);
    closeModal();
    document.getElementById('modal-msg').textContent=t('importSuccess')(data.length);
  }catch(e){document.getElementById('modal-msg').textContent=t('importError')+e.message;}
}

/* â”€â”€â”€ utils â”€â”€â”€ */
function val(id){const el=document.getElementById(id);return el?el.value.trim():'';}
</script>
</body>
</html>
