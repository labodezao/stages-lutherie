<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ğŸª— Clavier AccordÃ©on Diatonique</title>
<style>
:root{
  --vert:#1d6b23;--vert-c:#eaf5ea;--or:#b8860b;--or-c:#fffbf0;
  --gris:#888;--fond:#f5f5f3;--txt:#1a1a18;--rouge:#b8312a;--bleu:#1a6691;--brd:#e2e2da;
  --gold:#b8860b;--gold-d:#7a5c00;--dark:#1a1c1a;
  --card-bg:#ffffff;--card-head:#1a1c1a;--input-bg:#ffffff;--input-brd:#d4d4cc;
  --tooltip-bg:#1a1c1a;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,Arial,sans-serif;background:var(--fond);color:var(--txt);line-height:1.5;font-size:15px}

/* â”€â”€ Header â”€â”€ */
header{background:#fff;color:var(--txt);
  padding:10px 20px;display:flex;align-items:center;gap:10px;
  position:sticky;top:0;z-index:100;
  box-shadow:0 1px 8px rgba(0,0,0,.08);border-bottom:2px solid var(--gold)}
header .icon{font-size:1.7rem;flex-shrink:0}
header .hd-text{flex:1;min-width:0}
header h1{font-size:1.1rem;font-weight:700;white-space:nowrap;color:var(--dark);letter-spacing:.03em}
header p{font-size:.75rem;color:var(--gris);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#save-status{font-size:.75rem;padding:4px 10px;border-radius:20px;font-weight:700;white-space:nowrap;flex-shrink:0;transition:background .3s,color .3s}
#save-status.saved{background:rgba(184,134,11,.12);color:var(--gold);border:1px solid rgba(184,134,11,.3)}
#save-status.dirty{background:#f39c12;color:#fff}
#save-status.saving{background:rgba(184,134,11,.08);color:var(--gold)}
.lang-btn{padding:5px 11px;border:1.5px solid var(--brd);border-radius:5px;background:transparent;
  color:var(--gris);font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer;transition:background .15s,color .15s,border-color .15s}
.lang-btn:hover{border-color:var(--gold);color:var(--gold)}
.lang-btn.active{background:var(--dark);color:var(--or-c);border-color:var(--dark)}

/* â”€â”€ Library â”€â”€ */
#library-panel{background:#f0f0ee;border-bottom:1px solid var(--brd);padding:12px 20px}
.lib-toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.lib-toolbar h2{font-size:.86rem;color:var(--dark);font-weight:700;flex:1}
#lib-cards{display:flex;gap:9px;flex-wrap:wrap}
.instr-card{border:1.5px solid var(--brd);border-radius:8px;padding:9px 12px;min-width:190px;max-width:250px;
  cursor:pointer;transition:border-color .18s,box-shadow .18s;background:#fff;position:relative}
.instr-card:hover{border-color:var(--gold);box-shadow:0 2px 12px rgba(184,134,11,.14)}
.instr-card.active{border-color:var(--dark);background:#fffff8;box-shadow:0 0 0 2px rgba(26,28,26,.12)}
.card-name{font-weight:700;font-size:.88rem;color:var(--dark)}.card-sub,.card-meta{font-size:.72rem;color:var(--gris);margin-top:2px}
.card-btns{display:flex;gap:4px;margin-top:7px}
.ca{font-size:.68rem;padding:3px 7px;border:none;border-radius:4px;cursor:pointer;font-family:inherit;font-weight:700}
.ca-edit{background:var(--dark);color:var(--or-c);border:1px solid var(--dark)}
.ca-dup{background:#f0f0ee;color:#555;border:1px solid var(--brd)}
.ca-del{background:rgba(184,49,42,.1);color:#b8312a;border:1px solid rgba(184,49,42,.25)}
.lib-empty{font-size:.83rem;color:var(--gris);font-style:italic;padding:5px 0}

/* â”€â”€ Container â”€â”€ */
.container{max-width:1380px;margin:0 auto;padding:16px 14px}
.card{background:var(--card-bg);border-radius:10px;border:1px solid var(--brd);
  box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:16px;overflow:hidden}
.card-head{background:var(--card-head);color:#fff;
  padding:10px 16px;display:flex;align-items:center;gap:9px;border-bottom:2px solid var(--gold)}
.card-head h2{font-size:.9rem;font-weight:700;flex:1;color:var(--or-c)}
.step-badge{background:rgba(255,251,240,.15);border:1.5px solid var(--gold);border-radius:50%;width:24px;height:24px;
  display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.78rem;flex-shrink:0;color:var(--gold)}
.card-body{padding:16px}

/* â”€â”€ Forms â”€â”€ */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:11px}
.form-group{display:flex;flex-direction:column;gap:3px}
.form-group label{font-size:.7rem;font-weight:700;color:#777;text-transform:uppercase;letter-spacing:.05em}
input[type="text"],input[type="date"],input[type="number"],select{
  padding:7px 9px;border:1.5px solid var(--input-brd);border-radius:6px;font-size:.85rem;
  font-family:inherit;background:var(--input-bg);color:var(--txt);transition:border-color .18s}
input[type="text"]:focus,input[type="number"]:focus,select:focus,input[type="date"]:focus{
  border-color:var(--gold);outline:none;box-shadow:0 0 0 3px rgba(184,134,11,.12)}
select option{background:#fff;color:var(--txt)}
.hint{font-size:.68rem;color:var(--gris);margin-top:3px}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:7px 14px;border:none;border-radius:6px;font-family:inherit;font-size:.83rem;font-weight:700;
  cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:filter .15s,transform .1s}
.btn:hover{filter:brightness(.92)}.btn:active{transform:scale(.97)}
.btn-primary{background:var(--dark);color:var(--or-c);border:1px solid var(--dark)}
.btn-or{background:var(--gold);color:#fff;border:1px solid var(--gold-d)}
.btn-outline{background:#fff;color:var(--dark);border:1.5px solid var(--dark)}
.btn-outline:hover{background:var(--dark);color:var(--or-c);filter:none}
.btn-bleu{background:#1a6691;color:#fff;border:1px solid #1a6691}
.btn-rouge{background:#b8312a;color:#fff;border:1px solid #b8312a}
.btn-gris{background:#f0f0ee;color:#555;border:1px solid var(--brd)}
.btn-group{display:flex;gap:7px;flex-wrap:wrap}

/* â”€â”€ Row config â”€â”€ */
.rangees-grid{display:flex;gap:7px;flex-wrap:wrap;margin-top:9px}
.rangee-cfg{display:flex;flex-direction:column;gap:3px;background:#f8f8f6;border:1.5px solid var(--brd);
  border-radius:6px;padding:7px 9px;min-width:160px}
.rangee-cfg label{font-size:.7rem;font-weight:700;color:#666}
.rng-ctrl{display:flex;align-items:center;gap:5px}

/* â”€â”€ +/âˆ’ small buttons â”€â”€ */
.rng-btn{width:26px;height:26px;border:1.5px solid var(--brd);border-radius:4px;
  background:#fff;font-size:1rem;line-height:1;cursor:pointer;font-family:inherit;font-weight:700;
  color:var(--dark);display:inline-flex;align-items:center;justify-content:center;
  padding:0;flex-shrink:0;transition:background .12s,border-color .12s}
.rng-btn:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.rng-count{font-size:.78rem;font-weight:700;color:var(--gris);min-width:18px;text-align:center}

/* â”€â”€ Note grid â”€â”€ */
.note-section{margin-bottom:18px}
.note-section-title{font-size:.86rem;font-weight:700;color:var(--dark);
  border-bottom:2px solid var(--gold);padding-bottom:4px;margin-bottom:8px}
.sec-hd{display:flex;align-items:center;gap:7px;margin-bottom:5px}
.sec-label{font-size:.76rem;font-weight:700;color:var(--dark)}
.row-wrap{margin-bottom:11px}
.btn-grid{display:flex;flex-wrap:wrap;gap:4px}
.btn-cell{display:flex;flex-direction:column;align-items:center;gap:2px}
.btn-num{font-size:.63rem;color:var(--gris);font-weight:700}
.note-input{width:62px;padding:4px 3px;text-align:center;font-size:.76rem;border-radius:5px;
  border:1.5px solid var(--input-brd);cursor:pointer;background:var(--input-bg);color:var(--txt)}
.note-input.pousse{border-color:#4a9a3a;background:#eef8eb}
.note-input.tire{border-color:#c8a020;background:#fffbf0}
.note-input:focus{outline:none}
.note-input.pousse:focus{border-color:#2d8a20;box-shadow:0 0 0 2px rgba(45,138,32,.12)}
.note-input.tire:focus{border-color:var(--gold);box-shadow:0 0 0 2px rgba(184,134,11,.12)}
.note-input.picker-open{box-shadow:0 0 0 3px rgba(184,134,11,.2)!important;border-color:var(--gold)!important}
.legend{display:flex;gap:14px;margin-bottom:11px;flex-wrap:wrap;align-items:center}
.legend-item{display:flex;align-items:center;gap:5px;font-size:.8rem}
.legend-swatch{width:30px;height:14px;border-radius:3px;display:flex;align-items:center;justify-content:center;
  font-size:.64rem;font-weight:700}
.info-box{background:rgba(26,102,145,.08);border-left:3px solid var(--bleu);padding:9px 12px;
  border-radius:0 6px 6px 0;font-size:.8rem;margin-bottom:12px;color:#1a5580}
.mono{font-family:monospace;background:#f0f0ee;padding:1px 4px;border-radius:3px;color:var(--dark)}

/* â”€â”€ Note Picker â”€â”€ */
#note-picker{position:absolute;z-index:999;background:#fff;border:2px solid var(--dark);
  border-radius:10px;box-shadow:0 6px 28px rgba(0,0,0,.15);padding:11px 13px;min-width:305px;display:none}
.picker-tabs{display:flex;gap:0;margin-bottom:9px;border-bottom:1.5px solid var(--brd)}
.picker-tab-btn{padding:4px 12px;border:none;background:none;font-family:inherit;font-size:.78rem;
  font-weight:700;color:var(--gris);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px}
.picker-tab-btn.active{color:var(--dark);border-bottom-color:var(--gold)}
.picker-tab{display:none}
.picker-tab.active{display:block}
.picker-title{font-size:.72rem;font-weight:700;color:#777;text-transform:uppercase;
  letter-spacing:.05em;margin-bottom:7px}
.picker-notes-row{display:flex;gap:3px;margin-bottom:4px;flex-wrap:wrap}
.pn{min-width:34px;padding:4px 5px;border:1.5px solid var(--brd);border-radius:5px;
  background:#f8f8f6;font-family:inherit;font-size:.78rem;font-weight:700;cursor:pointer;text-align:center;
  color:var(--txt);transition:background .1s,border-color .1s}
.pn:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.pn.selected{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.pn.sharp{background:#f3f0fa;border-color:#c0b0e0;color:#5a3d8a}
.pn.sharp:hover,.pn.sharp.selected{background:#5a3d8a;color:#fff;border-color:#5a3d8a}
.pn.flat{background:#fdf0ee;border-color:#e0a898;color:#8a3020}
.pn.flat:hover,.pn.flat.selected{background:#b8312a;color:#fff;border-color:#b8312a}
.picker-octave-row{display:flex;gap:3px;margin-top:7px;align-items:center}
.picker-octave-label{font-size:.68rem;font-weight:700;color:var(--gris);margin-right:3px}
.po{width:30px;height:26px;border:1.5px solid var(--brd);border-radius:5px;
  background:#f8f8f6;font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer;color:var(--txt)}
.po:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.po.selected{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.picker-preview{margin-top:9px;padding:6px 9px;background:#f8f8f6;border:1px solid var(--brd);border-radius:5px;
  font-size:.83rem;font-weight:700;color:var(--dark);min-height:33px;display:flex;align-items:center;gap:7px}
.picker-preview span{flex:1}
.picker-clear{font-size:.7rem;color:var(--rouge);cursor:pointer;border:none;background:none;font-family:inherit}
.picker-insert{padding:5px 12px;background:var(--dark);color:var(--or-c);border:none;border-radius:5px;
  font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer}
.midi-preview{font-size:.65rem;color:#1a6691;font-weight:700;opacity:.9}
.chord-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
.pc{padding:4px 5px;border:1.5px solid var(--brd);border-radius:5px;background:#f8f8f6;
  font-family:inherit;font-size:.73rem;font-weight:700;cursor:pointer;text-align:center;color:var(--txt)}
.pc:hover{background:var(--dark);color:var(--or-c);border-color:var(--dark)}
.pc.selected{background:var(--dark);color:var(--or-c)}

/* â”€â”€ Preview tabs â”€â”€ */
.tabs{display:flex;gap:0;border-bottom:2px solid var(--brd);margin-bottom:13px}
.tab-btn{padding:7px 17px;border:none;background:none;font-family:inherit;font-size:.83rem;
  font-weight:700;color:var(--gris);cursor:pointer;border-bottom:2.5px solid transparent;margin-bottom:-2px}
.tab-btn.active{color:var(--dark);border-bottom-color:var(--gold)}
#visual-output{overflow-x:auto}
#visual-output svg{display:block;margin:0 auto;max-width:100%}

/* â”€â”€ Fab view toggle â”€â”€ */
.fab-view-wrap{display:flex;gap:0;margin-bottom:12px}
.fab-view-btn{padding:6px 15px;border:1.5px solid var(--brd);background:#fff;
  font-family:inherit;font-size:.78rem;font-weight:700;color:#555;cursor:pointer;transition:background .15s,color .15s}
.fab-view-btn:first-child{border-radius:6px 0 0 6px}
.fab-view-btn:last-child{border-radius:0 6px 6px 0;border-left:none}
.fab-view-btn.active{background:var(--dark);color:var(--or-c);border-color:var(--dark)}

/* â”€â”€ Tables â”€â”€ */
.mfr-table{width:100%;border-collapse:collapse;font-size:.8rem}
.mfr-table th,.mfr-table td{border:1px solid #e0e0d8;padding:5px 9px;text-align:center}
.mfr-table th{background:var(--dark);color:var(--or-c);font-size:.75rem;font-weight:700}
.mfr-table tr:nth-child(even) td{background:#fafaf8}
.mfr-table td{background:#fff;color:var(--txt)}
.mfr-table td.note-p{color:#1d6b23;font-weight:700}
.mfr-table td.note-t{color:var(--gold-d);font-weight:700}
.mfr-table td.row-hd{background:#f0f0ee;font-weight:700;color:var(--dark)}
.mfr-table td.midi-c{color:#1a6691;font-size:.72rem}
.mfr-sub{color:var(--gris);font-style:italic;font-size:.76rem;margin-bottom:12px}

/* â”€â”€ Modal â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);
  z-index:500;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal-box{background:#fff;border:2px solid var(--dark);border-radius:12px;padding:22px;max-width:600px;width:95%;
  max-height:80vh;overflow:auto;box-shadow:0 10px 40px rgba(0,0,0,.15)}
.modal-box h3{font-size:.98rem;color:var(--dark);margin-bottom:11px}
.modal-box textarea{width:100%;height:200px;font-family:monospace;font-size:.76rem;
  border:1.5px solid var(--brd);border-radius:6px;padding:8px;resize:vertical;
  background:#fafaf8;color:var(--txt)}

.gauche-label{font-size:.74rem;font-weight:700;color:#555}
.preset-btn{width:auto!important;padding:2px 7px!important;font-size:.7rem!important}
hr.divider{border:none;border-top:1px solid var(--brd);margin:14px 0}

/* â”€â”€ Help tooltips â”€â”€ */
.tip{display:inline-flex;align-items:center;justify-content:center;
  width:15px;height:15px;border-radius:50%;background:rgba(184,134,11,.15);
  color:var(--gold);font-size:.7rem;font-weight:700;cursor:help;
  vertical-align:middle;margin-left:4px;position:relative;flex-shrink:0;
  border:1px solid rgba(184,134,11,.3)}
.tip::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 7px);left:50%;transform:translateX(-50%);
  background:var(--tooltip-bg);color:#fff;font-size:.72rem;font-weight:400;line-height:1.45;white-space:pre-wrap;
  max-width:280px;min-width:160px;padding:7px 10px;border-radius:6px;
  border:1px solid var(--gold);box-shadow:0 4px 16px rgba(0,0,0,.3);
  pointer-events:none;opacity:0;transition:opacity .15s;z-index:9999;text-align:left}
.tip:hover::after,.tip:focus::after{opacity:1}
/* keep visible even when at bottom of screen */
.tip.tip-up::after{bottom:auto;top:calc(100% + 7px)}

/* â”€â”€ Print â”€â”€ */
@media print{
  .no-print{display:none!important}
  body{background:#fff}
  .card{box-shadow:none;border:1px solid #ddd}
  .card-head{background:var(--dark)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
  .mfr-table th{background:var(--dark)!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
@media(max-width:680px){
  header{flex-wrap:wrap}
  .form-grid{grid-template-columns:1fr}
  #note-picker{min-width:256px}
  .chord-grid{grid-template-columns:repeat(3,1fr)}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="no-print">
  <div class="icon">ğŸª—</div>
  <div class="hd-text">
    <h1 data-i="title">Clavier AccordÃ©on Diatonique</h1>
    <p data-i="subtitle">Plan de clavier client &amp; bon de commande anches</p>
  </div>
  <button class="lang-btn active" id="lang-fr" onclick="setLang('fr')">ğŸ‡«ğŸ‡· FR</button>
  <button class="lang-btn"        id="lang-en" onclick="setLang('en')">ğŸ‡¬ğŸ‡§ EN</button>
  <span id="save-status" class="saved">âœ“ SauvegardÃ©</span>
</header>

<!-- LIBRARY -->
<div id="library-panel" class="no-print">
  <div class="lib-toolbar">
    <h2 data-i="myInstruments">ğŸ“ Mes accordÃ©ons sauvegardÃ©s</h2>
    <button class="btn btn-primary" onclick="newInstrument()" style="font-size:.78rem;padding:5px 11px;" data-i-btn="newInstrument">ï¼‹ Nouvel instrument</button>
    <button class="btn btn-gris"    onclick="openImportExport()" style="font-size:.78rem;padding:5px 11px;" data-i-btn="importExport">â‡… Import / Export</button>
    <label class="btn btn-outline" style="font-size:.78rem;padding:5px 11px;cursor:pointer;" title="Charger un fichier .json" data-i-btn="openFile">ğŸ“‚ Ouvrir .json
      <input type="file" accept=".json,application/json" style="display:none;" onchange="loadFromFile(event)">
    </label>
  </div>
  <div id="lib-cards"><div class="lib-empty" data-i="noSaved">Aucun instrument sauvegardÃ©.</div></div>
</div>


<div class="container">

  <!-- STEP 1: Configuration -->
  <div class="card no-print">
    <div class="card-head"><div class="step-badge">1</div><h2 data-i="step1">Configuration de l'accordÃ©on</h2></div>
    <div class="card-body">
      <div class="form-grid">
        <div class="form-group"><label data-i="instrumentRef">RÃ©fÃ©rence instrument</label>
          <input type="text" id="nom-instrument" placeholder="Ex : Sol/Do #001" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="clientName">Nom du client</label>
          <input type="text" id="nom-joueur" placeholder="Ex : Jean Dupont" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="date">Date</label>
          <input type="date" id="date-creation" onchange="onAnyChange()"></div>
        <div class="form-group"><label data-i="luthier">Luthier</label>
          <input type="text" id="nom-luthier" value="Ewen d'Aviau" oninput="onAnyChange()"></div>
      </div>
      <hr class="divider">
      <div class="form-grid">
        <div class="form-group"><label data-i="preset">ModÃ¨le prÃ©dÃ©fini</label>
          <select id="preset-select" onchange="loadPreset(this.value)">
            <option value="" data-i-opt="presetPlaceholder">â€” Choisir un modÃ¨le â€”</option>
            <option value="custom" data-i-opt="custom">PersonnalisÃ©â€¦</option>
          </select></div>
        <div class="form-group"><label data-i="rowsRH">RangÃ©es main droite</label>
          <div class="rng-ctrl">
            <button type="button" class="rng-btn" onclick="changeNbRangees(-1)">âˆ’</button>
            <input type="number" id="nb-rangees" min="1" max="20" value="3"
              onchange="onRangeesChange()" style="width:54px;text-align:center">
            <button type="button" class="rng-btn" onclick="changeNbRangees(1)">ï¼‹</button>
          </div></div>
        <div class="form-group"><label data-i="leftHandConfig">Main gauche â€” basses libres</label>
          <div style="display:grid;grid-template-columns:auto 1fr;gap:3px 7px;align-items:center;margin-top:2px;">
            <div style="display:flex;align-items:center;gap:3px;">
              <span class="gauche-label" data-i="basses">Basses</span><span class="tip" tabindex="0" role="tooltip" aria-label="Info: Basses" data-tip="Bouton produisant une note basse unique (fondamentale). Ex: Do grave, Sol grave.&#10;â€” Single bass note button (root note). E.g. low C, low G.">â“˜</span>
            </div>
            <div class="rng-ctrl">
              <button type="button" class="rng-btn" onclick="changeGauche('basses',-1)">âˆ’</button>
              <input type="number" id="nb-basses" min="0" max="60" value="6" style="width:48px;text-align:center;" oninput="applyGaucheCount('basses')">
              <button type="button" class="rng-btn" onclick="changeGauche('basses',1)">ï¼‹</button>
            </div>
            <div style="display:flex;align-items:center;gap:3px;">
              <span class="gauche-label" data-i="accords">Accords</span><span class="tip" tabindex="0" role="tooltip" aria-label="Info: Accords" data-tip="Bouton d'accord : 2 voix (fondamentale + quinte). Ex: Do+Sol, Sol+RÃ©.&#10;â€” Chord button: 2 voices (root + fifth). E.g. C+G, G+D.">â“˜</span>
            </div>
            <div class="rng-ctrl">
              <button type="button" class="rng-btn" onclick="changeGauche('accords',-1)">âˆ’</button>
              <input type="number" id="nb-accords" min="0" max="60" value="6" style="width:48px;text-align:center;" oninput="applyGaucheCount('accords')">
              <button type="button" class="rng-btn" onclick="changeGauche('accords',1)">ï¼‹</button>
            </div>
            <div style="display:flex;align-items:center;gap:3px;">
              <span class="gauche-label" data-i="terzetto">Terzetto</span><span class="tip" tabindex="0" role="tooltip" aria-label="Info: Terzetto" data-tip="Terzetto (italien : &quot;trio&quot;) : plaque d'anche ajoutant la TIERCE Ã  l'accord.&#10;2 voix : Do+Sol Â· 3 voix terzetto : Do+Mi+Sol (accord complet).&#10;Optionnel sur accordÃ©on 2-voix ; inclus sur 3-voix.&#10;â€”&#10;Terzetto (Italian: &quot;trio&quot;): reed plate adding the 3RD to each chord.&#10;2-voice: C+G Â· 3-voice terzetto: C+E+G (full chord).&#10;Optional on 2-voice; standard on 3-voice instruments.">â“˜</span>
            </div>
            <div class="rng-ctrl">
              <button type="button" class="rng-btn" onclick="changeGauche('terzetto',-1)">âˆ’</button>
              <input type="number" id="nb-terzetto" min="0" max="60" value="0" style="width:48px;text-align:center;" oninput="applyGaucheCount('terzetto')">
              <button type="button" class="rng-btn" onclick="changeGauche('terzetto',1)">ï¼‹</button>
            </div>
          </div>
          <div style="margin-top:5px;display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
            <span style="font-size:.65rem;color:#888;" data-i="quickSet">Rapide :</span>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(2,2,0)">4b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(4,4,0)">8b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(6,6,0)">12b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(6,6,6)">18b</button>
            <button type="button" class="rng-btn preset-btn" onclick="setGauchePreset(8,8,8)">24b</button>
          </div></div>
        <div class="form-group"><label data-i="voices">Nombre de voix (anches) <span class="tip" tabindex="0" role="tooltip" aria-label="Info: Voix" data-tip="1 voix : une anche par note (son pur).&#10;2 voix : deux anches par note (ex: M+H ou L+M) â†’ son plus riche.&#10;3 voix : trois anches (L+M+H) â†’ son trÃ¨s plein, avec tremolo.&#10;â€”&#10;1 voice: one reed per note (pure tone).&#10;2 voices: two reeds per note (e.g. M+H or L+M) â†’ richer sound.&#10;3 voices: three reeds (L+M+H) â†’ full sound with tremolo.">â“˜</span></label>
          <select id="nb-voix" onchange="onAnyChange()">
            <option value="1">1 voix / 1 voice</option>
            <option value="2" selected>2 voix / voices (LM ou MH)</option>
            <option value="3">3 voix / voices (LMH)</option>
          </select></div>
        <div class="form-group"><label data-i="voicesLH">Voix main gauche (anches)</label>
          <select id="nb-voix-gauche" onchange="onAnyChange()">
            <option value="1">1 voix / 1 voice</option>
            <option value="2" selected>2 voix / voices</option>
            <option value="3">3 voix / voices</option>
          </select>
          <div style="margin-top:6px;display:flex;align-items:center;gap:7px">
            <input type="checkbox" id="show-midi" onchange="onAnyChange()">
            <label for="show-midi" style="font-size:.82rem;cursor:pointer;font-weight:normal;text-transform:none;letter-spacing:0" data-i="showMidi">NumÃ©ros MIDI <span class="tip tip-up" tabindex="0" role="tooltip" aria-label="Info: MIDI" data-tip="Affiche le numÃ©ro MIDI de chaque note sur le clavier et dans le tableau fabricant.&#10;Do central (Do4) = MIDI 60. Utile pour les logiciels et fabricants.&#10;â€”&#10;Shows MIDI note number on keyboard and manufacturer table.&#10;Middle C (C4) = MIDI 60. Useful for software and manufacturers.">â“˜</span></label>
          </div>
          <div style="margin-top:6px;">
            <div style="font-size:.75rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.04em;margin-bottom:3px;" data-i="lhDisplayMode">Affichage main gauche</div>
            <label style="font-size:.82rem;cursor:pointer;font-weight:normal;display:flex;align-items:center;gap:5px;">
              <input type="radio" name="lh-mode" id="lh-separated" value="separated" checked onchange="onAnyChange()">
              <span data-i="lhSeparated">RangÃ©es sÃ©parÃ©es</span></label>
            <label style="font-size:.82rem;cursor:pointer;font-weight:normal;display:flex;align-items:center;gap:5px;margin-top:2px;">
              <input type="radio" name="lh-mode" id="lh-paired" value="paired" onchange="onAnyChange()">
              <span data-i="lhPaired">AlternÃ©s (B-A-B-Aâ€¦)</span></label>
          </div></div>
      </div>
      <div id="rangees-cfg-wrap">
        <div style="font-size:.75rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.05em;margin-top:13px;margin-bottom:5px;" data-i="rowConfig">Configuration des rangÃ©es</div>
        <div class="rangees-grid" id="rangees-cfg"></div>
      </div>
      <hr class="divider">
      <div style="font-size:.75rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;" data-i="orderSpecTitle">ğŸ“‹ SpÃ©cifications commande fabricant (Voci Armoniche checklist)</div>
      <div class="form-grid">
        <div class="form-group"><label data-i="orderQty">QuantitÃ©</label>
          <input type="number" id="order-qty" min="1" value="1" oninput="onAnyChange()" style="width:80px;"></div>
        <div class="form-group"><label data-i="orderReedType">Type d'anches</label>
          <input type="text" id="order-reed-type" placeholder="Ex : Tipo a mano" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderTuning">Accord de base</label>
          <select id="order-tuning" onchange="onAnyChange()">
            <option value="440">440 Hz</option>
            <option value="441">441 Hz</option>
            <option value="442">442 Hz</option>
            <option value="443">443 Hz</option>
          </select></div>
        <div class="form-group"><label data-i="orderTremolo">Tremolo (Â± centiÃ¨mes de Hz) <span class="tip" tabindex="0" role="tooltip" aria-label="Info: Tremolo" data-tip="Ã‰cart de frÃ©quence entre le rang naturel et le rang tremolo (en centiÃ¨mes d'un demi-ton). Ex: Â±7 Cents = vibrato lent doux. Â±15 Cents = vibrato plus prononcÃ©.&#10;â€”&#10;Frequency offset between natural and tremolo reed rows (in cents = 1/100 of a semitone). E.g. Â±7 cents = gentle slow vibrato.">â“˜</span></label>
          <input type="text" id="order-tremolo" placeholder="Ex : Â± 7 Cents" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderHarmony">Harmonie / Harmony</label>
          <input type="text" id="order-harmony" placeholder="Ex : â€”" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderBassType">Type de basses</label>
          <input type="text" id="order-bass-type" placeholder="Ex : Basso Helikon, Balillaâ€¦" oninput="onAnyChange()"></div>
        <div class="form-group"><label data-i="orderBassComp">Composition basses</label>
          <input type="text" id="order-bass-comp" placeholder="Ex : 6 Balilla / 4 BH4 + 4 BH2" oninput="onAnyChange()"></div>
      </div>
      <div class="hint" style="margin-top:5px;" data-i="orderSpecHelp">Ces informations apparaissent dans l'en-tÃªte du bon de commande fabricant.</div>
    </div>
  </div>

  <!-- STEP 2: Note entry -->
  <div class="card no-print">
    <div class="card-head"><div class="step-badge">2</div>
      <h2 data-i="step2">Saisie des notes â€” cliquez un champ pour ouvrir le sÃ©lecteur</h2></div>
    <div class="card-body">
      <div class="info-box" id="info-box-text" data-i="clickToOpen">
        <strong>Cliquez</strong> sur un champ vert (poussÃ©) ou ambrÃ© (tirÃ©) pour ouvrir le sÃ©lecteur de notes.
      </div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-swatch" style="background:#eef8eb;border:1.5px solid #4a9a3a;color:#1d6b23;">â†“</div>
          <strong data-i="push">PoussÃ©</strong>
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:#fffbf0;border:1.5px solid #c8a020;color:#7a5c00;">â†‘</div>
          <strong data-i="pull">TirÃ©</strong>
        </div>
        <button class="btn btn-rouge" style="margin-left:auto;font-size:.76rem;padding:5px 10px;" onclick="clearNotes()" data-i-btn="clearNotes">ğŸ—‘ï¸ Effacer toutes les notes</button>
      </div>
      <div id="note-grid"></div>
      <div class="btn-group" style="margin-top:13px;">
        <button class="btn btn-primary" onclick="saveCurrentInstrument()" data-i-btn="saveInstrument">ğŸ’¾ Sauvegarder cet accordÃ©on</button>
        <button class="btn btn-or"      onclick="saveAsJSON()" data-i-btn="saveAs">â¬‡ï¸ Enregistrer sous .json</button>
      </div>
    </div>
  </div>

  <!-- STEP 3: Preview -->
  <div class="card" id="preview-card">
    <div class="card-head no-print">
      <div class="step-badge">3</div>
      <h2 data-i="step3">AperÃ§u &amp; impression â€” mis Ã  jour automatiquement</h2>
      <button class="btn btn-bleu no-print" onclick="forcePreview()" style="margin-left:auto;font-size:.76rem;padding:4px 11px;" data-i-btn="refresh">ğŸ”„ Actualiser</button>
    </div>
    <div class="card-body">
      <div class="tabs no-print">
        <button class="tab-btn active" onclick="showTab('visual',this)" data-i-btn="clientVisual">ğŸ¹ Clavier client</button>
        <button class="tab-btn"        onclick="showTab('fabricant',this)" data-i-btn="manufacturerTable">ğŸ“‹ Fabricant anches</button>
      </div>
      <div class="btn-group no-print" style="margin-bottom:13px;">
        <button class="btn btn-bleu"    onclick="printSection('visual')"    data-i-btn="pdfClientVisual">ğŸ–¨ï¸ PDF plan clavier</button>
        <button class="btn btn-primary" onclick="printSection('fabricant')" data-i-btn="pdfManufacturer">ğŸ–¨ï¸ PDF fabricant</button>
      </div>
      <div id="tab-visual">
        <div id="visual-output"><p style="color:var(--gris);font-style:italic;font-size:.83rem;" data-i="previewPlaceholder">L'aperÃ§u apparaÃ®tra ici aprÃ¨s avoir saisi les notesâ€¦</p></div>
      </div>
      <div id="tab-fabricant" style="display:none">
        <div class="fab-view-wrap no-print">
          <button class="fab-view-btn active" onclick="showFabricantView('liste',this)" data-i-btn="listView">ğŸ“‹ Vue liste</button>
          <button class="fab-view-btn"        onclick="showFabricantView('sommier',this)" data-i-btn="sommierView">ğŸª— Vue sommier</button>
        </div>
        <div id="fab-view-liste"><div id="table-output"></div></div>
        <div id="fab-view-sommier" style="display:none"><div id="sommier-output"></div></div>
      </div>
    </div>
  </div>

</div><!-- /container -->

<!-- NOTE PICKER -->
<div id="note-picker">
  <div class="picker-tabs">
    <button class="picker-tab-btn active" onclick="showPickerTab('notes',this)" data-i-btn="noteTab">ğŸµ Note</button>
    <button class="picker-tab-btn"        onclick="showPickerTab('chords',this)" data-i-btn="chordTab">ğŸ¼ Accord</button>
    <button style="margin-left:auto;padding:4px 8px;border:none;background:none;font-size:.73rem;color:var(--gris);cursor:pointer;" onclick="hidePicker()" data-i-btn="close">âœ• Fermer</button>
  </div>
  <div class="picker-tab active" id="picker-tab-notes">
    <div class="picker-title" data-i="naturals">Touches naturelles</div>
    <div class="picker-notes-row" id="picker-naturals"></div>
    <div class="picker-title" style="margin-top:7px;" data-i="sharps">DiÃ¨ses</div>
    <div class="picker-notes-row" id="picker-sharps"></div>
    <div class="picker-title" style="margin-top:7px;" data-i="flats">BÃ©mols</div>
    <div class="picker-notes-row" id="picker-flats"></div>
    <div class="picker-octave-row">
      <span class="picker-octave-label" data-i="octave">Octave :</span>
      <div id="picker-octaves" style="display:flex;gap:3px;"></div>
    </div>
  </div>
  <div class="picker-tab" id="picker-tab-chords">
    <div class="picker-title" data-i="chordTitle">Accords (cliquez pour insÃ©rer)</div>
    <div class="chord-grid" id="picker-chords-grid"></div>
  </div>
  <div class="picker-preview" id="picker-preview">
    <span id="picker-preview-text" data-i="selectNoteOctave">â€” sÃ©lectionnez une note et une octave â€”</span>
    <span class="midi-preview" id="picker-midi-badge"></span>
    <button class="picker-clear" onclick="pickerClear()" data-i-btn="clear">Effacer</button>
    <button class="picker-insert" onclick="pickerInsert()" data-i-btn="insert">InsÃ©rer â†µ</button>
  </div>
</div>

<!-- IMPORT/EXPORT MODAL -->
<div class="modal-overlay no-print" id="import-modal">
  <div class="modal-box">
    <h3>â‡… Import / Export JSON</h3>
    <p style="font-size:.8rem;color:var(--gris);margin-bottom:9px;" data-i="importHelp">Copiez le JSON pour sauvegarder, ou collez un JSON exportÃ© pour importer.</p>
    <textarea id="modal-json" spellcheck="false"></textarea>
    <div class="btn-group" style="margin-top:11px;">
      <button class="btn btn-primary" onclick="doImport()" data-i-btn="importBtn">â¬‡ï¸ Importer</button>
      <button class="btn btn-or"      onclick="downloadAllJSON()" data-i-btn="downloadAll">â¬‡ï¸ TÃ©lÃ©charger tout (.json)</button>
      <button class="btn btn-gris"    onclick="copyJSON()" data-i-btn="copyBtn">ğŸ“‹ Copier</button>
      <button class="btn btn-outline" onclick="closeModal()" data-i-btn="closeBtn">Fermer</button>
    </div>
    <p id="modal-msg" style="font-size:.78rem;margin-top:7px;min-height:1.2em;"></p>
  </div>
</div>

<script>
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LANGUAGES                                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lang = 'fr';
const LANGS = {
fr:{
  title:'Clavier AccordÃ©on Diatonique',subtitle:'Plan de clavier client & bon de commande anches',
  myInstruments:'ğŸ“ Mes accordÃ©ons sauvegardÃ©s',newInstrument:'ï¼‹ Nouvel instrument',importExport:'â‡… Import / Export',
  step1:'Configuration de l\'accordÃ©on',step2:'Saisie des notes â€” cliquez un champ pour ouvrir le sÃ©lecteur',
  step3:'AperÃ§u & impression â€” mis Ã  jour automatiquement',
  instrumentRef:'RÃ©fÃ©rence instrument',clientName:'Nom du client',date:'Date',luthier:'Luthier',
  preset:'ModÃ¨le prÃ©dÃ©fini',rowsRH:'RangÃ©es main droite',leftHandTpl:'ModÃ¨le main gauche',
  voices:'Nombre de voix (anches)',options:'Options',showMidi:'NumÃ©ros MIDI',
  rowConfig:'Configuration des rangÃ©es (nom & boutons)',
  clickToOpen:'<strong>Cliquez</strong> sur un champ <span style="color:#1d6b23;font-weight:700;">vert</span> (poussÃ©) ou <span style="color:#b8860b;font-weight:700;">ambrÃ©</span> (tirÃ©) pour ouvrir le sÃ©lecteur de notes.',
  rightHand:'ğŸµ Main Droite',leftHand:'ğŸ¹ Main Gauche',push:'PoussÃ©',pull:'TirÃ©',
  clearNotes:'ğŸ—‘ï¸ Effacer toutes les notes',saveInstrument:'ğŸ’¾ Sauvegarder cet accordÃ©on',
  clientVisual:'ğŸ¹ Clavier client',manufacturerTable:'ğŸ“‹ Fabricant anches',
  pdfClientVisual:'ğŸ–¨ï¸ PDF plan clavier',pdfManufacturer:'ğŸ–¨ï¸ PDF fabricant',
  listView:'ğŸ“‹ Vue liste',sommierView:'ğŸª— Vue sommier',refresh:'ğŸ”„ Actualiser',
  rowOffset:'DÃ©calage',
  basses:'Basses',accords:'Accords',terzetto:'Terzetto',
  addTerzetto:'ï¼‹ Ajouter Terzetto',removeTerzetto:'ğŸ—‘ï¸ Supprimer Terzetto',
  noteTab:'ğŸµ Note',chordTab:'ğŸ¼ Accord',close:'âœ• Fermer',
  naturals:'Touches naturelles',sharps:'DiÃ¨ses',flats:'BÃ©mols',octave:'Octave :',
  selectNoteOctave:'â€” sÃ©lectionnez une note et une octave â€”',chordTitle:'Accords (cliquez pour insÃ©rer)',
  clear:'Effacer',insert:'InsÃ©rer â†µ',
  importHelp:'Copiez le JSON pour sauvegarder, ou collez un JSON exportÃ© pour importer.',
  importBtn:'â¬‡ï¸ Importer',copyBtn:'ğŸ“‹ Copier',closeBtn:'Fermer',
  previewPlaceholder:'L\'aperÃ§u apparaÃ®tra ici aprÃ¨s avoir saisi les notesâ€¦',
  noSaved:'Aucun instrument sauvegardÃ©. Configurez puis cliquez "ğŸ’¾ Sauvegarder".',
  saved:'âœ“ SauvegardÃ©',dirty:'â— Modificationsâ€¦',saving:'â€¦ Sauvegarde',
  rows:'rangÃ©es',voices_:'voix',edit:'âœï¸ Ã‰diter',copy:'â§‰ Copier',delete:'ğŸ—‘ï¸',
  leftHandConfig:'Main gauche â€” basses libres',quickSet:'Rapide :',
  presetPlaceholder:'â€” Choisir un modÃ¨le â€”',custom:'PersonnalisÃ©â€¦',
  // SVG strings
  svgClient:'Client',svgLuthier:'Luthier',svgPush:'â†“ PoussÃ©',svgPull:'â†‘ TirÃ©',
  svgHigh:'AIGU â–¶',svgLow:'â—€ GRAVE',svgBellowsPush:'POUSSÃ‰',svgBellowsPull:'TIRÃ‰',
  svgRH:'Main Droite',svgLH:'Main Gauche',svgSommierRH:'SOMMIER â€” Main Droite',svgSommierLH:'SOMMIER â€” Main Gauche',
  svgMidi:'MIDI',svgGeneratedBy:'GÃ©nÃ©rÃ© le',svgPlan:'Plan de clavier',
  // Manufacturer table
  mfrRH:'MAIN DROITE â€” Plaque anches mÃ©lodie (bisonore)',
  mfrLH:'MAIN GAUCHE â€” Plaques basses, accords',
  mfrRow:'RangÃ©e',mfrNo:'NÂ°',mfrPushNote:'Note PoussÃ©e â†“',mfrPullNote:'Note TirÃ©e â†‘',
  mfrMidiPush:'MIDI â†“',mfrMidiPull:'MIDI â†‘',mfrPushSub:'(soufflet poussÃ©)',mfrPullSub:'(soufflet tirÃ©)',
  mfrType:'Type',mfrNoteChordPush:'Note/Accord PoussÃ© â†“',mfrNoteChordPull:'Note/Accord TirÃ© â†‘',
  specTitle:'SpÃ©cifications / Specifications',
  spec1:'AccordÃ©on bisonore â€” soufflet poussÃ© / tirÃ© (bisonoric â€” push / pull)',
  spec2:'Nombre de voix (reeds per note)',
  spec3:'Notation solfÃ¨ge : Do=C Â· RÃ©=D Â· Mi=E Â· Fa=F Â· Sol=G Â· La=A Â· Si=B',
  spec4:'DiÃ¨se=# Â· BÃ©mol=b  |  Octaves : 2=basse Â· 3=mÃ©d.grave Â· 4=mÃ©d Â· 5=aigu Â· 6=trÃ¨s aigu',
  specGenBy:'Document gÃ©nÃ©rÃ© le',pdfClientTitle:'Plan de clavier',pdfMfrTitle:'Bon de commande anches',
  deleteConfirm:(n)=>`Supprimer Â« ${n} Â» ?`,clearConfirm:'Effacer toutes les notes ?',
  popupAlert:'Veuillez autoriser les popups pour imprimer.',
  importSuccess:(n)=>`âœ“ ${n} instrument(s) importÃ©(s).`,importError:'âœ— Erreur : ',
  copied:'âœ“ CopiÃ© dans le presse-papiers.',invalidFormat:'Format invalide (doit Ãªtre un tableau)',
  saveAs:'â¬‡ï¸ Enregistrer sous .json',openFile:'ğŸ“‚ Ouvrir .json',
  downloadAll:'â¬‡ï¸ TÃ©lÃ©charger tout (.json)',loadedFrom:(n)=>`âœ“ ${n} instrument(s) chargÃ©(s).`,
  // Order spec section
  orderSpecTitle:'ğŸ“‹ SpÃ©cifications commande fabricant (checklist Voci Armoniche)',
  orderQty:'QuantitÃ©',orderReedType:'Type d\'anches',orderTuning:'Accord de base',
  orderTremolo:'Tremolo (Â± centiÃ¨mes Hz)',orderHarmony:'Harmonie',
  orderBassType:'Type de basses',orderBassComp:'Composition basses',
  orderSpecHelp:'Ces champs apparaissent dans l\'en-tÃªte du bon de commande fabricant.',
  // Manufacturer checklist labels
  orderChecklistTitle:'BON DE COMMANDE ANCHES',
  clQty:'QuantitÃ©',clReedType:'Type d\'anches',
  clDesc:'Description gÃ©nÃ©rale (touches/accords)',clDescHint:'touches mÃ©lodie / nb basses',
  clTonality:'TonalitÃ© (clÃ©)',clRowSpec:'SpÃ©cification rangÃ©es',
  clTuning:'Accord de base',clTremolo:'Tremolo',
  clHarmony:'Harmonie',clBassType:'Type de basses',
  clBassComp:'Composition basses',clVoices:'Nombre de voix (main droite)',clVoicesLH:'Nombre de voix (main gauche)',clLuthier:'Luthier / Date',
  voicesLH:'Voix main gauche (anches)',
  lhDisplayMode:'Affichage main gauche',lhSeparated:'RangÃ©es sÃ©parÃ©es',lhPaired:'AlternÃ©s (B-A-B-Aâ€¦)',
},
en:{
  title:'Diatonic Accordion Keyboard',subtitle:'Client keyboard plan & reed order form',
  myInstruments:'ğŸ“ My saved accordions',newInstrument:'ï¼‹ New instrument',importExport:'â‡… Import / Export',
  step1:'Accordion configuration',step2:'Note entry â€” click any field to open the note selector',
  step3:'Preview & print â€” updated automatically',
  instrumentRef:'Instrument reference',clientName:'Client name',date:'Date',luthier:'Luthier',
  preset:'Preset layout',rowsRH:'Right hand rows',leftHandTpl:'Left hand template',
  voices:'Number of voices (reeds)',options:'Options',showMidi:'MIDI note numbers',
  rowConfig:'Row configuration (name & button count)',
  clickToOpen:'<strong>Click</strong> a <span style="color:#1d6b23;font-weight:700;">green</span> (push) or <span style="color:#b8860b;font-weight:700;">amber</span> (pull) field to open the note picker.',
  rightHand:'ğŸµ Right Hand',leftHand:'ğŸ¹ Left Hand',push:'Push',pull:'Pull',
  clearNotes:'ğŸ—‘ï¸ Clear all notes',saveInstrument:'ğŸ’¾ Save this accordion',
  clientVisual:'ğŸ¹ Client keyboard',manufacturerTable:'ğŸ“‹ Reed manufacturer',
  pdfClientVisual:'ğŸ–¨ï¸ PDF keyboard plan',pdfManufacturer:'ğŸ–¨ï¸ PDF manufacturer',
  listView:'ğŸ“‹ List view',sommierView:'ğŸª— Reed plate view',refresh:'ğŸ”„ Refresh',
  rowOffset:'Offset',
  basses:'Basses',accords:'Chords',terzetto:'Terzetto',
  addTerzetto:'ï¼‹ Add Terzetto',removeTerzetto:'ğŸ—‘ï¸ Remove Terzetto',
  noteTab:'ğŸµ Note',chordTab:'ğŸ¼ Chord',close:'âœ• Close',
  naturals:'Natural notes',sharps:'Sharps',flats:'Flats',octave:'Octave:',
  selectNoteOctave:'â€” select a note and octave â€”',chordTitle:'Chords (click to insert)',
  clear:'Clear',insert:'Insert â†µ',
  importHelp:'Copy the JSON to save, or paste exported JSON to import.',
  importBtn:'â¬‡ï¸ Import',copyBtn:'ğŸ“‹ Copy',closeBtn:'Close',
  previewPlaceholder:'Preview will appear here after entering notesâ€¦',
  noSaved:'No saved instruments. Configure then click "ğŸ’¾ Save".',
  saved:'âœ“ Saved',dirty:'â— Unsaved changesâ€¦',saving:'â€¦ Saving',
  rows:'rows',voices_:'voices',edit:'âœï¸ Edit',copy:'â§‰ Copy',delete:'ğŸ—‘ï¸',
  leftHandConfig:'Left hand â€” free bass count',quickSet:'Quick:',
  presetPlaceholder:'â€” Choose a preset â€”',custom:'Customâ€¦',
  svgClient:'Client',svgLuthier:'Luthier',svgPush:'â†“ Push',svgPull:'â†‘ Pull',
  svgHigh:'TREBLE â–¶',svgLow:'â—€ BASS',svgBellowsPush:'PUSH',svgBellowsPull:'PULL',
  svgRH:'Right Hand',svgLH:'Left Hand',svgSommierRH:'REED PLATE â€” Right Hand',svgSommierLH:'REED PLATE â€” Left Hand',
  svgMidi:'MIDI',svgGeneratedBy:'Generated on',svgPlan:'Keyboard plan',
  mfrRH:'RIGHT HAND â€” Melody reed plate (bisonoric)',
  mfrLH:'LEFT HAND â€” Bass & chord plates',
  mfrRow:'Row',mfrNo:'No.',mfrPushNote:'Push Note â†“',mfrPullNote:'Pull Note â†‘',
  mfrMidiPush:'MIDI â†“',mfrMidiPull:'MIDI â†‘',mfrPushSub:'(bellows push)',mfrPullSub:'(bellows pull)',
  mfrType:'Type',mfrNoteChordPush:'Note/Chord Push â†“',mfrNoteChordPull:'Note/Chord Pull â†‘',
  specTitle:'SpÃ©cifications / Specifications',
  spec1:'Bisonoric accordion â€” bellows push / pull (accordÃ©on bisonore)',
  spec2:'Number of voices (reeds per note)',
  spec3:'French solfÃ¨ge: Do=C Â· RÃ©=D Â· Mi=E Â· Fa=F Â· Sol=G Â· La=A Â· Si=B',
  spec4:'Sharp=# Â· Flat=b  |  Octaves: 2=low bass Â· 3=low mid Â· 4=mid Â· 5=high Â· 6=very high',
  specGenBy:'Generated on',pdfClientTitle:'Keyboard plan',pdfMfrTitle:'Reed order form',
  deleteConfirm:(n)=>`Delete "${n}"?`,clearConfirm:'Clear all notes?',
  popupAlert:'Please allow popups to print.',
  importSuccess:(n)=>`âœ“ ${n} instrument(s) imported.`,importError:'âœ— Error: ',
  copied:'âœ“ Copied to clipboard.',invalidFormat:'Invalid format (must be an array)',
  saveAs:'â¬‡ï¸ Save As .json',openFile:'ğŸ“‚ Open .json',
  downloadAll:'â¬‡ï¸ Download all (.json)',loadedFrom:(n)=>`âœ“ ${n} instrument(s) loaded.`,
  // Order spec section
  orderSpecTitle:'ğŸ“‹ Manufacturer order specifications (Voci Armoniche checklist)',
  orderQty:'Quantity',orderReedType:'Reed type',orderTuning:'Base tuning',
  orderTremolo:'Tremolo (Â± cents)',orderHarmony:'Harmony',
  orderBassType:'Bass type',orderBassComp:'Bass composition',
  orderSpecHelp:'These fields appear in the manufacturer order form header.',
  // Manufacturer checklist labels
  orderChecklistTitle:'REED ORDER FORM',
  clQty:'Quantity',clReedType:'Reed type',
  clDesc:'General description (keys/chords)',clDescHint:'melody keys / nb basses',
  clTonality:'Key tonality',clRowSpec:'Row specification',
  clTuning:'Base tuning',clTremolo:'Tremolo',
  clHarmony:'Harmony',clBassType:'Bass type',
  clBassComp:'Bass composition',clVoices:'Number of voices (right hand)',clVoicesLH:'Number of voices (left hand)',clLuthier:'Luthier / Date',
  voicesLH:'Left hand voices (reeds)',
  lhDisplayMode:'Left hand display',lhSeparated:'Separate rows',lhPaired:'Paired (B-A-B-Aâ€¦)',
}};
function t(k){ const v=LANGS[lang][k]; return v!==undefined?v:LANGS.fr[k]||k; }

/* â”€â”€â”€ Note name conversion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const FR2EN={
  'Do':'C','RÃ©':'D','Re':'D','Mi':'E','Fa':'F','Sol':'G','La':'A','Si':'B',
  'Do#':'C#','RÃ©#':'D#','Fa#':'F#','Sol#':'G#','La#':'A#',
  'RÃ©b':'Db','Mib':'Eb','Solb':'Gb','Lab':'Ab','Sib':'Bb','Dob':'Cb',
};
const EN2FR={
  'C':'Do','D':'RÃ©','E':'Mi','F':'Fa','G':'Sol','A':'La','B':'Si',
  'C#':'Do#','D#':'RÃ©#','F#':'Fa#','G#':'Sol#','A#':'La#',
  'Db':'RÃ©b','Eb':'Mib','Gb':'Solb','Ab':'Lab','Bb':'Sib','Cb':'Dob',
};
function displayNote(note){
  if(!note) return '';
  if(lang==='fr') return note;
  // Try full word match first for chords like "Sol Maj"
  const m=note.match(/^(.+?)(\s+(?:Maj|Min|7|dim|aug|m7|maj7))?(\d?)$/);
  if(!m) return note;
  const root=m[1].trim(), qual=(m[2]||'').trim(), oct=m[3]||'';
  const en=FR2EN[root];
  if(en) return en+oct+(qual?' '+qual:'');
  return note;
}
function storageNote(note){
  // Convert ENâ†’FR for storage (picker uses current lang)
  if(lang==='fr') return note;
  const m=note.match(/^([A-G][#b]?)(\d?)(\s+.*)?$/);
  if(!m) return note;
  const fr=EN2FR[m[1]];
  if(fr) return fr+(m[2]||'')+(m[3]||'');
  return note;
}

/* â”€â”€â”€ Apply language to DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setLang(l){
  lang=l;
  document.getElementById('lang-fr').classList.toggle('active',l==='fr');
  document.getElementById('lang-en').classList.toggle('active',l==='en');
  document.querySelectorAll('[data-i]').forEach(el=>{
    const k=el.dataset.i;
    const v=t(k);
    if(typeof v==='string') el.innerHTML=v;
  });
  document.querySelectorAll('[data-i-btn]').forEach(el=>{
    const k=el.dataset.iBtn;
    const v=t(k);
    if(typeof v==='string') el.textContent=v;
  });
  document.querySelectorAll('[data-i-opt]').forEach(el=>{
    const k=el.dataset.iOpt;
    const v=t(k);
    if(typeof v==='string') el.textContent=v;
  });
  // Update save status text
  const ss=document.getElementById('save-status');
  if(ss) ss.textContent=t(ss.className)||ss.textContent;
  // Reinit picker notes
  initPicker();
  // Regenerate grid (updates section labels)
  generateInputGrid();
  scheduleLivePreview();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Ã‰TAT GLOBAL                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let CFG={
  nbRangees:3,
  rangees:[
    {nom:'RangÃ©e Sol (intÃ©rieure)',nb:11},
    {nom:'RangÃ©e Do (mÃ©diane)',nb:11},
    {nom:'RangÃ©e RÃ© (extÃ©rieure)',nb:11},
  ],
  configGauche:12,
  notes:{droite:[],basses:[],accords:[],terzetto:[]}
};
let currentId=null,saveTimer=null,previewTimer=null,fabricantView='liste';
let pickerInput=null,pickerNote='',pickerOctave='';

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  NOTE â†’ MIDI                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SEMI_FR={Do:0,RÃ©:2,Re:2,Mi:4,Fa:5,Sol:7,La:9,Si:11};
const SEMI_EN={C:0,D:2,E:4,F:5,G:7,A:9,B:11};
function noteToMidi(s){
  if(!s) return null;
  let m=s.trim().match(/^(Do|RÃ©|Re|Mi|Fa|Sol|La|Si)([#b]?)(\d+)$/);
  if(m){
    const base=SEMI_FR[m[1]]; if(base===undefined) return null;
    return (parseInt(m[3])+1)*12+base+(m[2]==='#'?1:m[2]==='b'?-1:0);
  }
  m=s.trim().match(/^([A-G])([#b]?)(\d+)$/);
  if(m){
    const base=SEMI_EN[m[1]]; if(base===undefined) return null;
    return (parseInt(m[3])+1)*12+base+(m[2]==='#'?1:m[2]==='b'?-1:0);
  }
  return null;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PRÃ‰RÃ‰GLAGES                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PRESETS={
  GC21:{nbRangees:2,rangees:[{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10},{nom:'RangÃ©e Do (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'}],
    [{p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},{p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},{p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}]],
    basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}],
    accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}],terzetto:[]}},
  DG21:{nbRangees:2,rangees:[{nom:'RangÃ©e RÃ© (intÃ©rieure)',nb:10},{nom:'RangÃ©e Sol (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'RÃ©3',t:'Mi3'},{p:'Fa#3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'RÃ©4',t:'Do#4'},{p:'Fa#4',t:'Mi4'},{p:'La4',t:'Sol4'},{p:'RÃ©5',t:'Si4'},{p:'Fa#5',t:'Do#5'},{p:'La5',t:'Mi5'},{p:'RÃ©6',t:'Sol5'}],
    [{p:'Sol2',t:'La2'},{p:'Si2',t:'Do3'},{p:'RÃ©3',t:'Mi3'},{p:'Sol3',t:'Fa#3'},{p:'Si3',t:'La3'},{p:'RÃ©4',t:'Do4'},{p:'Sol4',t:'Mi4'},{p:'Si4',t:'Fa#4'},{p:'RÃ©5',t:'La4'},{p:'Sol5',t:'Do5'},{p:'Si5',t:'Mi5'}]],
    basses:[{p:'RÃ©3',t:'La2'},{p:'Sol2',t:'RÃ©2'},{p:'La3',t:'Mi3'},{p:'Do3',t:'Sol2'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}],
    accords:[{p:'RÃ© Maj',t:'La Min'},{p:'Sol Maj',t:'RÃ© Min'},{p:'La Maj',t:'Mi Min'},{p:'Do Maj',t:'Sol Maj'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}],terzetto:[]}},
  CF21:{nbRangees:2,rangees:[{nom:'RangÃ©e Do (intÃ©rieure)',nb:10},{nom:'RangÃ©e Fa (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Do3',t:'RÃ©3'},{p:'Mi3',t:'Fa3'},{p:'Sol3',t:'La3'},{p:'Do4',t:'Si3'},{p:'Mi4',t:'RÃ©4'},{p:'Sol4',t:'Fa4'},{p:'Do5',t:'La4'},{p:'Mi5',t:'Si4'},{p:'Sol5',t:'RÃ©5'},{p:'Do6',t:'Fa5'}],
    [{p:'Fa3',t:'Mi3'},{p:'La3',t:'Sol3'},{p:'Do4',t:'Sib3'},{p:'Fa4',t:'RÃ©4'},{p:'La4',t:'Mib4'},{p:'Do5',t:'Sol4'},{p:'Fa5',t:'La4'},{p:'La5',t:'Sib4'},{p:'Do6',t:'RÃ©5'},{p:'Fa6',t:'Mi5'},{p:'La6',t:'Sol5'}]],
    basses:[{p:'Do3',t:'Sol2'},{p:'Fa3',t:'Do3'},{p:'Sol2',t:'RÃ©2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'}],
    accords:[{p:'Do Maj',t:'Sol Maj'},{p:'Fa Maj',t:'Do Maj'},{p:'Sol Maj',t:'RÃ© Min'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'}],terzetto:[]}},
  GCD33:{nbRangees:3,rangees:[{nom:'RangÃ©e Sol (intÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e RÃ© (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'},{p:'Si6',t:'Mi6'}],
    [{p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},{p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},{p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}],
    [{p:'RÃ©3',t:'Mi3'},{p:'Fa#3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'RÃ©4',t:'Do#4'},{p:'Fa#4',t:'Mi4'},{p:'La4',t:'Sol4'},{p:'RÃ©5',t:'Si4'},{p:'Fa#5',t:'Do#5'},{p:'La5',t:'Mi5'},{p:'RÃ©6',t:'Sol5'},{p:'Fa#6',t:'La5'}]],
    basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}],
    accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}],terzetto:[]}},
  BbFC33:{nbRangees:3,rangees:[{nom:'RangÃ©e Sib (intÃ©rieure)',nb:11},{nom:'RangÃ©e Fa (mÃ©diane)',nb:11},{nom:'RangÃ©e Do (extÃ©rieure)',nb:11}],
    notes:{droite:[[{p:'Sib3',t:'Do4'},{p:'RÃ©4',t:'Mib4'},{p:'Fa4',t:'Sol4'},{p:'Sib4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Fa5',t:'Mib5'},{p:'Sib5',t:'Sol5'},{p:'RÃ©6',t:'La5'},{p:'Fa6',t:'Do6'},{p:'Sib6',t:'Mib6'},{p:'RÃ©7',t:'Sol6'}],
    [{p:'Fa3',t:'Mib3'},{p:'La3',t:'Sol3'},{p:'Do4',t:'Sib3'},{p:'Fa4',t:'RÃ©4'},{p:'La4',t:'Mib4'},{p:'Do5',t:'Sol4'},{p:'Fa5',t:'La4'},{p:'La5',t:'Sib4'},{p:'Do6',t:'RÃ©5'},{p:'Fa6',t:'Mi5'},{p:'La6',t:'Sol5'}],
    [{p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},{p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},{p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}]],
    basses:[{p:'Sib2',t:'Fa2'},{p:'Mib3',t:'Sib2'},{p:'Fa3',t:'Do3'},{p:'Do3',t:'Sol2'},{p:'Sol3',t:'RÃ©3'},{p:'RÃ©3',t:'La2'}],
    accords:[{p:'Sib Maj',t:'Fa Min'},{p:'Mib Maj',t:'Sib Maj'},{p:'Fa Maj',t:'Do Min'},{p:'Do Maj',t:'Sol Maj'},{p:'Sol Maj',t:'RÃ© Min'},{p:'RÃ© Maj',t:'La Min'}],terzetto:[]}}
};

const PRESET_LABELS={
  GC21:'Sol/Do â€” 21 boutons',DG21:'RÃ©/Sol â€” 21 boutons',CF21:'Do/Fa â€” 21 boutons',
  AD21:'La/RÃ© â€” 21 boutons',BE21:'Si/Mi â€” 21 boutons',EA21:'Mi/La â€” 21 boutons',
  FBb21:'Fa/Sib â€” 21 boutons',EbBb21:'Mib/Sib â€” 21 boutons',ABb21:'La/Sib â€” 21 boutons',
  GDA21:'Sol/RÃ©/La (layout 2 rangs en La ext.) â€” 21 boutons',
  FD21:'Fa/RÃ© â€” 21 boutons',
  CA21:'Do/La â€” 21 boutons',
  BC21:'Si/Do (systÃ¨me irlandais) â€” 21 boutons',
  CSharpD21:'Do#/RÃ© (systÃ¨me irlandais) â€” 21 boutons',
  DbEb21:'RÃ©b/Mib (systÃ¨me irlandais) â€” 21 boutons',
  EbF21:'Mib/Fa (systÃ¨me irlandais) â€” 21 boutons',
  FGb21:'Fa/Solb (systÃ¨me irlandais) â€” 21 boutons',
  GAb21:'Sol/Lab (systÃ¨me irlandais) â€” 21 boutons',
  ADb21:'La/RÃ©b (systÃ¨me irlandais) â€” 21 boutons',
  GCD33:'Sol/Do/RÃ© â€” 33 boutons',BbFC33:'Sib/Fa/Do â€” 33 boutons',
  ADG33:'La/RÃ©/Sol â€” 33 boutons',DGC33:'RÃ©/Sol/Do â€” 33 boutons',
  CFBb33:'Do/Fa/Sib â€” 33 boutons',EAD33:'Mi/La/RÃ© â€” 33 boutons',
  BbEbAb33:'Sib/Mib/Lab â€” 33 boutons',FCG33:'Fa/Do/Sol â€” 33 boutons',
  // â”€â”€ Presets from PDF source analysis â”€â”€
  SolDoFa33_12:'Sol/Do/Fa â€” 33/12 (Continental)',
  LaReSol33_12:'La/RÃ©/Sol â€” 33/12',
  SibMibLab33_12:'Sib/Mib/Lab â€” 33/12',
  SolDo_Corgeron:'Sol/Do Corgeron â€” 33/8',
  SolDo_Heim:'Sol/Do Heim â€” 33/8',
  SolDoAlts_Bottasso:'Sol/Do/Alts Bottasso â€” 33/18',
  SolDoAlts_JPL:'Sol/Do/Alts JPL â€” 33/18',
  SolDoAlts_LTL:'Sol/Do/Alts LTL â€” 33/18',
  SolDoAlts_Gaillard:'Sol/Do/Alts Gaillard â€” 33/18',
  // â”€â”€ Plans personnalisÃ©s â”€â”€
  Evelyne:'Evelyne â€” Sol/Mi/Fa 33/12 (plan perso)',
  Thorsen:'Thorsen â€” Sol/Mi/Fa 33/12 (plan perso)'
};

const NOTE_TO_SEMITONE={Do:0,'Do#':1,RÃ©b:1,Re:2,'RÃ©':2,'RÃ©#':3,Mib:3,Mi:4,Fa:5,'Fa#':6,Solb:6,Sol:7,'Sol#':8,Lab:8,La:9,'La#':10,Sib:10,Si:11};
const SHARP_NOTES=['Do','Do#','RÃ©','RÃ©#','Mi','Fa','Fa#','Sol','Sol#','La','La#','Si'];
const FLAT_NOTES=['Do','RÃ©b','RÃ©','Mib','Mi','Fa','Solb','Sol','Lab','La','Sib','Si'];
function transposeSingleNoteFr(note,semi,preferFlats=true){
  const m=(note||'').trim().match(/^(Do|RÃ©|Re|Mi|Fa|Sol|La|Si)([#b]?)(\d+)$/);
  if(!m)return note;
  const base=(m[1]==='Re'?'RÃ©':m[1])+(m[2]||'');
  const idx=NOTE_TO_SEMITONE[base];
  if(idx===undefined)return note;
  const midi=(parseInt(m[3],10)+1)*12+idx+semi;
  const oct=Math.floor(midi/12)-1;
  const arr=preferFlats?FLAT_NOTES:SHARP_NOTES;
  return `${arr[((midi%12)+12)%12]}${oct}`;
}
function transposeChordFr(chord,semi,preferFlats=true){
  const m=(chord||'').trim().match(/^(Do|RÃ©|Re|Mi|Fa|Sol|La|Si)([#b]?)(.*)$/);
  if(!m)return chord;
  const base=(m[1]==='Re'?'RÃ©':m[1])+(m[2]||'');
  const idx=NOTE_TO_SEMITONE[base];
  if(idx===undefined)return chord;
  const arr=preferFlats?FLAT_NOTES:SHARP_NOTES;
  return `${arr[((idx+semi)%12+12)%12]}${m[3]||''}`;
}
function transposePreset(base,semi,rowNames,preferFlats=true){
  const p=JSON.parse(JSON.stringify(PRESETS[base]));
  p.rangees=p.rangees.map((r,i)=>({nom:rowNames[i]||r.nom,nb:r.nb}));
  p.notes.droite=p.notes.droite.map(row=>row.map(n=>({
    p:transposeSingleNoteFr(n.p,semi,preferFlats),t:transposeSingleNoteFr(n.t,semi,preferFlats)
  })));
  p.notes.basses=(p.notes.basses||[]).map(n=>({
    p:transposeSingleNoteFr(n.p,semi,preferFlats),t:transposeSingleNoteFr(n.t,semi,preferFlats)
  }));
  p.notes.accords=(p.notes.accords||[]).map(n=>({
    p:transposeChordFr(n.p,semi,preferFlats),t:transposeChordFr(n.t,semi,preferFlats)
  }));
  return p;
}
function addTransposedPresets(){
  // 2 rangs 21 boutons
  PRESETS.AD21=transposePreset('GC21',2,['RangÃ©e La (intÃ©rieure)','RangÃ©e RÃ© (extÃ©rieure)'],false);
  PRESETS.BE21=transposePreset('GC21',4,['RangÃ©e Si (intÃ©rieure)','RangÃ©e Mi (extÃ©rieure)'],false);
  PRESETS.EA21=transposePreset('DG21',2,['RangÃ©e Mi (intÃ©rieure)','RangÃ©e La (extÃ©rieure)'],false);
  PRESETS.FBb21=transposePreset('CF21',5,['RangÃ©e Fa (intÃ©rieure)','RangÃ©e Sib (extÃ©rieure)'],true);
  PRESETS.EbBb21=transposePreset('CF21',3,['RangÃ©e Mib (intÃ©rieure)','RangÃ©e Sib (extÃ©rieure)'],true);
  PRESETS.ABb21=transposePreset('CF21',9,['RangÃ©e La (intÃ©rieure)','RangÃ©e Sib (extÃ©rieure)'],true);
  PRESETS.GDA21=transposePreset('DG21',5,['RangÃ©e Sol (intÃ©rieure)','RangÃ©e La (extÃ©rieure)'],false);
  PRESETS.FD21=transposePreset('DG21',3,['RangÃ©e Fa (intÃ©rieure)','RangÃ©e RÃ© (extÃ©rieure)'],true);
  PRESETS.CA21=transposePreset('DG21',-2,['RangÃ©e Do (intÃ©rieure)','RangÃ©e La (extÃ©rieure)'],false);

  // 2 rangs "systÃ¨mes demi-ton"
  PRESETS.BC21=transposePreset('GC21',4,['RangÃ©e Si (intÃ©rieure)','RangÃ©e Do (extÃ©rieure)'],false);
  PRESETS.CSharpD21=transposePreset('GC21',6,['RangÃ©e Do# (intÃ©rieure)','RangÃ©e RÃ© (extÃ©rieure)'],false);
  PRESETS.DbEb21=transposePreset('GC21',7,['RangÃ©e RÃ©b (intÃ©rieure)','RangÃ©e Mib (extÃ©rieure)'],true);
  PRESETS.EbF21=transposePreset('GC21',9,['RangÃ©e Mib (intÃ©rieure)','RangÃ©e Fa (extÃ©rieure)'],true);
  PRESETS.FGb21=transposePreset('GC21',10,['RangÃ©e Fa (intÃ©rieure)','RangÃ©e Solb (extÃ©rieure)'],true);
  PRESETS.GAb21=transposePreset('GC21',0,['RangÃ©e Sol (intÃ©rieure)','RangÃ©e Lab (extÃ©rieure)'],true);
  PRESETS.ADb21=transposePreset('GC21',2,['RangÃ©e La (intÃ©rieure)','RangÃ©e RÃ©b (extÃ©rieure)'],true);

  // 3 rangs 33 boutons
  PRESETS.ADG33=transposePreset('GCD33',2,['RangÃ©e La (intÃ©rieure)','RangÃ©e RÃ© (mÃ©diane)','RangÃ©e Sol (extÃ©rieure)'],false);
  PRESETS.DGC33=transposePreset('GCD33',-5,['RangÃ©e RÃ© (intÃ©rieure)','RangÃ©e Sol (mÃ©diane)','RangÃ©e Do (extÃ©rieure)'],false);
  PRESETS.CFBb33=transposePreset('BbFC33',2,['RangÃ©e Do (intÃ©rieure)','RangÃ©e Fa (mÃ©diane)','RangÃ©e Sib (extÃ©rieure)'],true);
  PRESETS.EAD33=transposePreset('GCD33',4,['RangÃ©e Mi (intÃ©rieure)','RangÃ©e La (mÃ©diane)','RangÃ©e RÃ© (extÃ©rieure)'],false);
  PRESETS.BbEbAb33=transposePreset('GCD33',3,['RangÃ©e Sib (intÃ©rieure)','RangÃ©e Mib (mÃ©diane)','RangÃ©e Lab (extÃ©rieure)'],true);
  PRESETS.FCG33=transposePreset('GCD33',10,['RangÃ©e Fa (intÃ©rieure)','RangÃ©e Do (mÃ©diane)','RangÃ©e Sol (extÃ©rieure)'],true);
}
addTransposedPresets();

/* â”€â”€ Presets from PDF source analysis (Loffet/Comprendre-et-Choisir PDFs) â”€â”€ */
// Sol/Do/Fa 33/12 Continental
PRESETS.SolDoFa33_12={nbRangees:3,rangees:[{nom:'RangÃ©e Fa (extÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Do3',t:'Si2'},{p:'Mib3',t:'Do#3'},{p:'Do4',t:'Sol3'},{p:'Fa4',t:'Si3'},{p:'La4',t:'RÃ©4'},{p:'Do5',t:'Sol4'},{p:'Fa5',t:'Si4'},{p:'La5',t:'RÃ©5'},{p:'Do6',t:'Sol5'},{p:'Fa6',t:'Si5'},{p:'La6',t:'RÃ©6'}],
  [{p:'Do3',t:'Si2'},{p:'Mib3',t:'Do#3'},{p:'La3',t:'Mi3'},{p:'Do4',t:'Sol3'},{p:'Mi4',t:'Sib3'},{p:'Fa#4',t:'RÃ©4'},{p:'La4',t:'Mi4'},{p:'Do5',t:'Sol4'},{p:'Mi5',t:'Sib4'},{p:'Fa#5',t:'RÃ©5'},{p:'La5',t:'Mi5'}],
  [{p:'Sol#3',t:'Do#3'},{p:'Si3',t:'Mi3'},{p:'RÃ©4',t:'Sol3'},{p:'Fa4',t:'Sib3'},{p:'La4',t:'RÃ©4'},{p:'Si4',t:'Mi4'},{p:'RÃ©5',t:'Sol4'},{p:'Fa5',t:'Sib4'},{p:'La5',t:'RÃ©5'},{p:'Si5',t:'Mi5'}]
],basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'Fa3',t:'Do3'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'}],accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'Fa Maj',t:'Do Min'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'}],terzetto:[]}};

// La/RÃ©/Sol 33/12
PRESETS.LaReSol33_12={nbRangees:3,rangees:[{nom:'RangÃ©e Sol (extÃ©rieure)',nb:10},{nom:'RangÃ©e RÃ© (mÃ©diane)',nb:11},{nom:'RangÃ©e La (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Fa3',t:'Mib3'},{p:'RÃ©4',t:'La3'},{p:'Sol4',t:'Do#4'},{p:'Si4',t:'Mi4'},{p:'RÃ©5',t:'La4'},{p:'Sol5',t:'Do#5'},{p:'Si5',t:'Mi5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do#6'},{p:'Si6',t:'Mi6'}],
  [{p:'La2',t:'Sol#2'},{p:'Fa3',t:'Mib3'},{p:'Si3',t:'Fa#3'},{p:'RÃ©4',t:'La3'},{p:'Fa#4',t:'Do4'},{p:'Sol#4',t:'Mi4'},{p:'Si4',t:'Fa#4'},{p:'RÃ©5',t:'La4'},{p:'Fa#5',t:'Do5'},{p:'Sol#5',t:'Mi5'},{p:'Si5',t:'Fa#5'}],
  [{p:'Sib3',t:'Do#3'},{p:'Do#4',t:'Mi3'},{p:'Mi4',t:'Sol3'},{p:'Sol4',t:'Sib3'},{p:'Si4',t:'RÃ©4'},{p:'Do#5',t:'Mi4'},{p:'Mi5',t:'Sol4'},{p:'Sol5',t:'Sib4'},{p:'Si5',t:'RÃ©5'},{p:'Do#6',t:'Mi5'}]
],basses:[{p:'La2',t:'Mi2'},{p:'RÃ©3',t:'La2'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'},{p:'Fa#3',t:'Do#3'},{p:'Do#3',t:'Sol#2'}],accords:[{p:'La Maj',t:'Mi Min'},{p:'RÃ© Maj',t:'La Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'},{p:'Fa# Maj',t:'Do# Min'},{p:'Do# Maj',t:'Sol# Min'}],terzetto:[]}};

// Sib/Mib/Lab 33/12
PRESETS.SibMibLab33_12={nbRangees:3,rangees:[{nom:'RangÃ©e Lab (extÃ©rieure)',nb:10},{nom:'RangÃ©e Mib (mÃ©diane)',nb:11},{nom:'RangÃ©e Sib (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Fa#3',t:'Mi3'},{p:'Mib4',t:'Sib3'},{p:'Sib4',t:'RÃ©4'},{p:'Do5',t:'Fa4'},{p:'Mib5',t:'Sib4'},{p:'Sol5',t:'RÃ©5'},{p:'Do6',t:'Fa5'},{p:'Mib6',t:'Sib5'},{p:'Fa6',t:'RÃ©6'},{p:'Do7',t:'Fa6'}],
  [{p:'Sib2',t:'La2'},{p:'Fa#3',t:'Mi3'},{p:'Do4',t:'Sol3'},{p:'Mib4',t:'Sib3'},{p:'Sol4',t:'RÃ©b4'},{p:'La4',t:'Fa4'},{p:'Do5',t:'Sol4'},{p:'Mib5',t:'RÃ©b5'},{p:'Sol5',t:'Fa5'},{p:'La5',t:'Sol5'},{p:'Do6',t:'Fa6'}],
  [{p:'Si3',t:'RÃ©3'},{p:'RÃ©4',t:'Fa3'},{p:'Fa4',t:'Lab3'},{p:'Do5',t:'RÃ©b4'},{p:'RÃ©5',t:'Fa4'},{p:'Fa5',t:'Lab4'},{p:'Do6',t:'RÃ©b5'},{p:'RÃ©6',t:'Fa5'},{p:'Fa6',t:'Lab5'},{p:'Do7',t:'RÃ©b6'}]
],basses:[{p:'Sib2',t:'Fa2'},{p:'Mib3',t:'Sib2'},{p:'Lab3',t:'Mib3'},{p:'Fa3',t:'Do3'},{p:'Do3',t:'Sol2'},{p:'Sol3',t:'RÃ©3'}],accords:[{p:'Sib Maj',t:'Fa Min'},{p:'Mib Maj',t:'Sib Min'},{p:'Lab Maj',t:'Mib Min'},{p:'Fa Maj',t:'Do Min'},{p:'Do Maj',t:'Sol Min'},{p:'Sol Maj',t:'RÃ© Min'}],terzetto:[]}};

// Sol/Do Corgeron 33/8
PRESETS.SolDo_Corgeron={nbRangees:3,rangees:[{nom:'RangÃ©e Alts (extÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Sol#3',t:'Si3'},{p:'Sib3',t:'RÃ©4'},{p:'Mib4',t:'Sol4'},{p:'Sol#4',t:'Si4'},{p:'Sib4',t:'RÃ©5'},{p:'Mib5',t:'Sol5'},{p:'Sol#5',t:'Si5'},{p:'Sib5',t:'RÃ©6'},{p:'Mib6',t:'Sol6'},{p:'Sol#6',t:'Si6'},{p:'Sib6',t:'RÃ©7'}],
  [{p:'Mi3',t:'Sol#3'},{p:'Fa#3',t:'Sib3'},{p:'La3',t:'Do#4'},{p:'Do4',t:'Sol4'},{p:'Mi4',t:'Sol#4'},{p:'Fa#4',t:'Sib4'},{p:'La4',t:'Do#5'},{p:'Do5',t:'Sol5'},{p:'Mi5',t:'Sol#5'},{p:'Fa#5',t:'Sib5'},{p:'La5',t:'Do#6'}],
  [{p:'Sol3',t:'La3'},{p:'Do4',t:'Si3'},{p:'Mi4',t:'RÃ©4'},{p:'Sol4',t:'Fa#4'},{p:'Do5',t:'La4'},{p:'Mi5',t:'Do5'},{p:'Sol5',t:'RÃ©5'},{p:'Do6',t:'Mi5'},{p:'Mi6',t:'La5'},{p:'Sol6',t:'Do6'}]
],basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'}],accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'}],terzetto:[]}};

// Sol/Do Heim 33/8
PRESETS.SolDo_Heim={nbRangees:3,rangees:[{nom:'RangÃ©e Alts (extÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Sol#3',t:'Si3'},{p:'La3',t:'RÃ©4'},{p:'Mib4',t:'Sol4'},{p:'Sol#4',t:'Si4'},{p:'La4',t:'RÃ©5'},{p:'Mib5',t:'Sol5'},{p:'Sol#5',t:'Si5'},{p:'La5',t:'RÃ©6'},{p:'Mib6',t:'Sol6'},{p:'Sol#6',t:'Si6'},{p:'La6',t:'RÃ©7'}],
  [{p:'Mi3',t:'Sol#3'},{p:'Fa#3',t:'Sib3'},{p:'La3',t:'Do#4'},{p:'Do4',t:'Sol4'},{p:'Mi4',t:'Sol#4'},{p:'Fa#4',t:'Sib4'},{p:'La4',t:'Do#5'},{p:'Do5',t:'Sol5'},{p:'Mi5',t:'Sol#5'},{p:'Fa#5',t:'Sib5'},{p:'La5',t:'Do#6'}],
  [{p:'Sol3',t:'La3'},{p:'Do4',t:'Si3'},{p:'Mi4',t:'RÃ©4'},{p:'Sol4',t:'Fa#4'},{p:'Do5',t:'La4'},{p:'Mi5',t:'Do5'},{p:'Sol5',t:'RÃ©5'},{p:'Do6',t:'Mi5'},{p:'Mi6',t:'La5'},{p:'Sol6',t:'Do6'}]
],basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'}],accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'}],terzetto:[]}};

// Sol/Do/Alts Bottasso 33/18
PRESETS.SolDoAlts_Bottasso={nbRangees:3,rangees:[{nom:'RangÃ©e Alts (extÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Do#3',t:'Si2'},{p:'Sol#3',t:'RÃ©3'},{p:'Mib4',t:'Sol3'},{p:'Fa4',t:'Si3'},{p:'Fa#4',t:'RÃ©4'},{p:'Mib5',t:'Sol4'},{p:'Fa5',t:'Si4'},{p:'Fa#5',t:'RÃ©5'},{p:'Mib6',t:'Sol5'},{p:'Fa6',t:'Si5'},{p:'Fa#6',t:'RÃ©6'}],
  [{p:'Mi3',t:'Si2'},{p:'Fa#3',t:'Do#3'},{p:'La3',t:'Mib3'},{p:'Do4',t:'Sol3'},{p:'Mi4',t:'Sib3'},{p:'Fa#4',t:'Do#4'},{p:'La4',t:'Mib4'},{p:'Do5',t:'Sol4'},{p:'Mi5',t:'Sib4'},{p:'Fa#5',t:'Do#5'},{p:'La5',t:'Mib5'}],
  [{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'}]
],basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'},{p:'Do#3',t:'Sol#2'},{p:'Sol#3',t:'Mib3'},{p:'Fa3',t:'Do3'}],accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'},{p:'Do# Maj',t:'Sol# Min'},{p:'Sol# Maj',t:'Mib Min'},{p:'Fa Maj',t:'Do Min'}],terzetto:[]}};

// Sol/Do/Alts JPL 33/18
PRESETS.SolDoAlts_JPL={nbRangees:3,rangees:[{nom:'RangÃ©e Alts (extÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Si2',t:'Si3'},{p:'Sol#3',t:'RÃ©4'},{p:'La3',t:'Sol4'},{p:'Mib4',t:'Si4'},{p:'Sol#4',t:'RÃ©5'},{p:'La4',t:'Sol5'},{p:'Mib5',t:'Si5'},{p:'Sol#5',t:'RÃ©6'},{p:'La5',t:'Sol6'},{p:'Mib6',t:'Si6'},{p:'La6',t:'RÃ©7'}],
  [{p:'Mi3',t:'Si2'},{p:'Fa#3',t:'Sol3'},{p:'La3',t:'Sib3'},{p:'Do4',t:'Do#4'},{p:'Mi4',t:'Sol4'},{p:'Fa#4',t:'Sib4'},{p:'La4',t:'Do#5'},{p:'Do5',t:'Sol5'},{p:'Mi5',t:'Sib5'},{p:'Fa#5',t:'Do6'},{p:'La5',t:'Mi6'}],
  [{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'}]
],basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'},{p:'Do#3',t:'Sol#2'},{p:'Sol#3',t:'Mib3'},{p:'Fa3',t:'Do3'}],accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'},{p:'Do# Maj',t:'Sol# Min'},{p:'Sol# Maj',t:'Mib Min'},{p:'Fa Maj',t:'Do Min'}],terzetto:[]}};

// Sol/Do/Alts LTL 33/18
PRESETS.SolDoAlts_LTL={nbRangees:3,rangees:[{nom:'RangÃ©e Alts (extÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Do#3',t:'Si2'},{p:'Sol#3',t:'RÃ©3'},{p:'Sib3',t:'Sol3'},{p:'Mib4',t:'Si3'},{p:'Sol#4',t:'RÃ©4'},{p:'Sib4',t:'Sol4'},{p:'Mib5',t:'Si4'},{p:'Sol#5',t:'RÃ©5'},{p:'Sib5',t:'Sol5'},{p:'Mib6',t:'Si5'},{p:'Sol#6',t:'RÃ©6'}],
  [{p:'Mi3',t:'Si2'},{p:'Fa#3',t:'Sib3'},{p:'La3',t:'Do#4'},{p:'Do4',t:'Sol4'},{p:'Mi4',t:'Sol#4'},{p:'Fa#4',t:'Sib4'},{p:'La4',t:'Do#5'},{p:'Do5',t:'Sol5'},{p:'Mi5',t:'Sol#5'},{p:'Fa#5',t:'Sib5'},{p:'La5',t:'Do#6'}],
  [{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'}]
],basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'},{p:'Do#3',t:'Sol#2'},{p:'Sol#3',t:'Mib3'},{p:'Fa3',t:'Do3'}],accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'},{p:'Do# Maj',t:'Sol# Min'},{p:'Sol# Maj',t:'Mib Min'},{p:'Fa Maj',t:'Do Min'}],terzetto:[]}};

// Sol/Do/Alts Gaillard 33/18
PRESETS.SolDoAlts_Gaillard={nbRangees:3,rangees:[{nom:'RangÃ©e Alts (extÃ©rieure)',nb:11},{nom:'RangÃ©e Do (mÃ©diane)',nb:11},{nom:'RangÃ©e Sol (intÃ©rieure)',nb:10}],notes:{droite:[
  [{p:'Mib3',t:'Si3'},{p:'Sol#3',t:'RÃ©4'},{p:'La3',t:'Sol4'},{p:'Mib4',t:'Si4'},{p:'Sol#4',t:'RÃ©5'},{p:'La4',t:'Sol5'},{p:'Mib5',t:'Si5'},{p:'Sol#5',t:'RÃ©6'},{p:'La5',t:'Sol6'},{p:'Mib6',t:'Si6'},{p:'Sol#6',t:'RÃ©7'}],
  [{p:'Mi3',t:'Sol#3'},{p:'Fa#3',t:'Sib3'},{p:'La3',t:'Do#4'},{p:'Do4',t:'Sol4'},{p:'Mi4',t:'Sol#4'},{p:'Fa#4',t:'Sib4'},{p:'La4',t:'Do#5'},{p:'Do5',t:'Sol5'},{p:'Mi5',t:'Sol#5'},{p:'Fa#5',t:'Sib5'},{p:'La5',t:'Do#6'}],
  [{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'}]
],basses:[{p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'},{p:'Do#3',t:'Sol#2'},{p:'Sol#3',t:'Mib3'},{p:'Fa3',t:'Do3'}],accords:[{p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'},{p:'Do# Maj',t:'Sol# Min'},{p:'Sol# Maj',t:'Mib Min'},{p:'Fa Maj',t:'Do Min'}],terzetto:[]}};

// Evelyne â€” plan personnalisÃ© 3 rangÃ©es (Sol/Mi/Fa)
PRESETS.Evelyne={nbRangees:3,rangees:[
  {nom:'RangÃ©e Sol (intÃ©rieure)',nb:12},
  {nom:'RangÃ©e Mi (mÃ©diane)',nb:11},
  {nom:'RangÃ©e Fa (extÃ©rieure)',nb:10,offset:2}
],notes:{droite:[
  [{p:'Do3',t:'Mi3'},{p:'RÃ©3',t:'Fa#3'},{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La6'},{p:'Sol6',t:'Do6'}],
  [{p:'Mi3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'Do4',t:'RÃ©4'},{p:'Mi4',t:'Fa4'},{p:'La4',t:'Sol4'},{p:'Do5',t:'Si4'},{p:'Mi5',t:'RÃ©5'},{p:'La5',t:'Fa5'},{p:'Do6',t:'Sol5'},{p:'Mi6',t:'Si5'},{p:'La6',t:'RÃ©6'}],
  [{p:'Fa3',t:'Sib3'},{p:'Mib4',t:'RÃ©b4'},{p:'Fa4',t:'Mib4'},{p:'Lab4',t:'Sib4'},{p:'Mib5',t:'RÃ©b5'},{p:'Fa5',t:'Mib5'},{p:'Lab5',t:'Lab5'},{p:'Mib6',t:'Sib5'},{p:'Fa6',t:'RÃ©b6'},{p:'Lab6',t:'Mib6'}]
],basses:[{p:'Do2',t:'Sol2'},{p:'Do3',t:'Sol3'},{p:'Sol2',t:'RÃ©2'},{p:'Sol3',t:'RÃ©3'},{p:'Si2',t:'Fa#2'},{p:'Si3',t:'Fa#3'}],accords:[{p:'La Maj',t:'Fa Maj'},{p:'La Min',t:'Fa Min'},{p:'Mi Maj',t:'La Maj'},{p:'Mi Min',t:'La Min'},{p:'Mib Maj',t:'Sib Maj'},{p:'Mib Min',t:'Sib Min'}],terzetto:[]}};

// Thorsen â€” plan 3 rangÃ©es Sol/Mi/Fa (mÃªme layout Evelyne, notation Anglo-Saxonne)
PRESETS.Thorsen={nbRangees:3,rangees:[
  {nom:'RangÃ©e Sol (intÃ©rieure)',nb:12},
  {nom:'RangÃ©e Mi (mÃ©diane)',nb:11},
  {nom:'RangÃ©e Fa (extÃ©rieure)',nb:10,offset:2}
],notes:{droite:[
  [{p:'Do3',t:'Mi3'},{p:'RÃ©3',t:'Fa#3'},{p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},{p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},{p:'RÃ©6',t:'La6'},{p:'Sol6',t:'Do6'}],
  [{p:'Mi3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'Do4',t:'RÃ©4'},{p:'Mi4',t:'Fa4'},{p:'La4',t:'Sol4'},{p:'Do5',t:'Si4'},{p:'Mi5',t:'RÃ©5'},{p:'La5',t:'Fa5'},{p:'Do6',t:'Sol5'},{p:'Mi6',t:'Si5'},{p:'La6',t:'RÃ©6'}],
  [{p:'Fa3',t:'Sib3'},{p:'Mib4',t:'RÃ©b4'},{p:'Fa4',t:'Mib4'},{p:'Lab4',t:'Sib4'},{p:'Mib5',t:'RÃ©b5'},{p:'Fa5',t:'Mib5'},{p:'Lab5',t:'Lab5'},{p:'Mib6',t:'Sib5'},{p:'Fa6',t:'RÃ©b6'},{p:'Lab6',t:'Mib6'}]
],basses:[{p:'Do2',t:'Sol2'},{p:'Do3',t:'Sol3'},{p:'Sol2',t:'RÃ©2'},{p:'Sol3',t:'RÃ©3'},{p:'Si2',t:'Fa#2'},{p:'Si3',t:'Fa#3'}],accords:[{p:'La Maj',t:'Fa Maj'},{p:'La Min',t:'Fa Min'},{p:'Mi Maj',t:'La Maj'},{p:'Mi Min',t:'La Min'},{p:'Mib Maj',t:'Sib Maj'},{p:'Mib Min',t:'Sib Min'}],terzetto:[]}};

function renderPresetOptions(){
  const sel=document.getElementById('preset-select');
  if(!sel)return;
  const customOpt=sel.querySelector('option[value="custom"]');
  Object.keys(PRESET_LABELS).forEach(key=>{
    const opt=document.createElement('option');
    opt.value=key;opt.textContent=PRESET_LABELS[key];
    sel.insertBefore(opt,customOpt);
  });
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LOCAL STORAGE DB                                    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DB_KEY='acc_clavier_db';
const DB={
  load(){try{return JSON.parse(localStorage.getItem(DB_KEY)||'[]')}catch(e){return[]}},
  save(l){localStorage.setItem(DB_KEY,JSON.stringify(l))},
  all(){return DB.load()},
  get(id){return DB.load().find(r=>r.id===id)||null},
  add(r){const l=DB.load();l.unshift(r);DB.save(l);return r.id},
  update(id,d){const l=DB.load(),i=l.findIndex(r=>r.id===id);if(i>=0){l[i]={...l[i],...d,id,lastModified:new Date().toISOString()};DB.save(l)}},
  delete(id){DB.save(DB.load().filter(r=>r.id!==id))},
  duplicate(id){const s=DB.get(id);if(!s)return null;const n=JSON.parse(JSON.stringify(s));n.id=Date.now().toString();n.nom=s.nom+' (copie)';n.lastModified=new Date().toISOString();DB.add(n);return n.id}
};

function snapshotToDB(){
  readNoteInputsIntoCFG();
  // Read register values from selects
  for(let r=0;r<CFG.nbRangees;r++){
    const sel=document.getElementById(`rreg-${r}`);
    if(sel)CFG.rangees[r].register=sel.value;
  }
  return{id:currentId||Date.now().toString(),nom:val('nom-instrument')||'Sans titre',
    joueur:val('nom-joueur'),luthier:val('nom-luthier')||"Ewen d'Aviau",
    dateCreation:val('date-creation'),lastModified:new Date().toISOString(),
    nbRangees:CFG.nbRangees,rangees:JSON.parse(JSON.stringify(CFG.rangees)),
    nbVoix:parseInt(document.getElementById('nb-voix').value),
    nbVoixGauche:parseInt(document.getElementById('nb-voix-gauche')?.value||'2'),
    lhDisplayMode:document.querySelector('input[name="lh-mode"]:checked')?.value||'separated',
    notes:JSON.parse(JSON.stringify(CFG.notes)),
    orderSpecs:{
      qty:val('order-qty')||'1',
      reedType:val('order-reed-type'),
      tuning:document.getElementById('order-tuning')?.value||'440',
      tremolo:val('order-tremolo'),
      harmony:val('order-harmony'),
      bassType:val('order-bass-type'),
      bassComp:val('order-bass-comp'),
    }};
}
function loadFromDB(rec){
  currentId=rec.id;
  document.getElementById('nom-instrument').value=rec.nom||'';
  document.getElementById('nom-joueur').value=rec.joueur||'';
  document.getElementById('nom-luthier').value=rec.luthier||"Ewen d'Aviau";
  document.getElementById('date-creation').value=rec.dateCreation||'';
  document.getElementById('nb-voix').value=String(rec.nbVoix||2);
  document.getElementById('nb-voix-gauche').value=String(rec.nbVoixGauche||2);
  const lhm=rec.lhDisplayMode||'separated';
  const lhmEl=document.getElementById('lh-'+lhm);
  if(lhmEl)lhmEl.checked=true;
  CFG.nbRangees=rec.nbRangees||2;
  CFG.rangees=JSON.parse(JSON.stringify(rec.rangees));
  CFG.notes=JSON.parse(JSON.stringify(rec.notes));
  // ensure terzetto exists
  if(!CFG.notes.terzetto) CFG.notes.terzetto=[];
  // backward compat: if notes arrays are missing, init from configGauche
  if(!CFG.notes.basses||!CFG.notes.basses.length){
    const cgMap={4:2,8:4,18:6,24:8};
    const nb=cgMap[rec.configGauche]||6;
    CFG.notes.basses=Array.from({length:nb},()=>({p:'',t:''}));
    CFG.notes.accords=Array.from({length:nb},()=>({p:'',t:''}));
  }
  document.getElementById('nb-rangees').value=String(CFG.nbRangees);
  syncGaucheInputs();
  // Load order specs
  const os=rec.orderSpecs||{};
  const sv=(id,v)=>{const el=document.getElementById(id);if(el&&v!==undefined)el.value=v;};
  sv('order-qty',os.qty||'1');sv('order-reed-type',os.reedType||'');
  sv('order-tuning',os.tuning||'440');sv('order-tremolo',os.tremolo||'');
  sv('order-harmony',os.harmony||'');sv('order-bass-type',os.bassType||'');
  sv('order-bass-comp',os.bassComp||'');
  renderRangeesCfg();
  generateInputGrid();
  setSaveStatus('saved');
}
function saveCurrentInstrument(){
  readNoteInputsIntoCFG();
  const rec=snapshotToDB();
  if(currentId&&DB.get(currentId)){DB.update(currentId,rec);}
  else{currentId=rec.id;DB.add(rec);}
  renderLibrary();setSaveStatus('saved');
}
function newInstrument(){
  currentId=null;
  document.getElementById('preset-select').value='';
  document.getElementById('nom-instrument').value='';
  document.getElementById('nom-joueur').value='';
  document.getElementById('date-creation').value=new Date().toISOString().slice(0,10);
  document.getElementById('nb-voix').value='2';
  document.getElementById('nb-voix-gauche').value='2';
  document.getElementById('lh-separated').checked=true;
  loadPreset('GCD33');
  document.getElementById('preset-select').value='GCD33';
  renderLibrary();setSaveStatus('dirty');
  window.scrollTo({top:0,behavior:'smooth'});
}

/* â”€â”€ Library â”€â”€ */
function renderLibrary(){
  const list=DB.all(),wrap=document.getElementById('lib-cards');
  if(!list.length){wrap.innerHTML=`<div class="lib-empty">${t('noSaved')}</div>`;return;}
  wrap.innerHTML=list.map(rec=>{
    const active=rec.id===currentId?' active':'';
    const d=rec.lastModified?new Date(rec.lastModified).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'2-digit'}):'â€”';
    const nb=rec.notes&&rec.notes.basses?rec.notes.basses.length:0;
    const info=`${rec.nbRangees} ${t('rows')} Â· ${nb} basses Â· ${rec.nbVoix||2} ${t('voices_')}`;
    return `<div class="instr-card${active}" id="card-${rec.id}">
      <div class="card-name">ï¿½ï¿½ ${escHTML(rec.nom)}</div>
      <div class="card-sub">${rec.joueur?'Client : '+escHTML(rec.joueur):'&nbsp;'}</div>
      <div class="card-meta">${info} Â· ${d}</div>
      <div class="card-btns">
        <button class="ca ca-edit" onclick="event.stopPropagation();editInstrument('${rec.id}')">${t('edit')}</button>
        <button class="ca ca-dup"  onclick="event.stopPropagation();duplicateInstrument('${rec.id}')">${t('copy')}</button>
        <button class="ca ca-del"  onclick="event.stopPropagation();deleteInstrument('${rec.id}')">${t('delete')}</button>
      </div></div>`;
  }).join('');
}
function editInstrument(id){const r=DB.get(id);if(!r)return;loadFromDB(r);renderLibrary();document.querySelector('.container').scrollIntoView({behavior:'smooth',block:'start'});scheduleLivePreview();}
function duplicateInstrument(id){const nid=DB.duplicate(id);renderLibrary();if(nid)editInstrument(nid);}
function deleteInstrument(id){const r=DB.get(id);if(!r)return;if(!confirm(t('deleteConfirm')(r.nom)))return;DB.delete(id);if(currentId===id){currentId=null;setSaveStatus('dirty');}renderLibrary();}

/* â”€â”€ Save status â”€â”€ */
function setSaveStatus(state){
  const el=document.getElementById('save-status');
  el.className=state;el.textContent=t(state)||t('saved');
}
function onAnyChange(){
  setSaveStatus('dirty');clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{if(currentId)saveCurrentInstrument();},1200);
  scheduleLivePreview();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  INIT                                                â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('date-creation').value=new Date().toISOString().slice(0,10);
  renderPresetOptions();
  initPicker();renderLibrary();
  const list=DB.all();
  if(list.length){loadFromDB(list[0]);}
  else{loadPreset('GCD33');document.getElementById('preset-select').value='GCD33';}
  scheduleLivePreview();
  // Event delegation: open picker when a note-input is clicked anywhere in #note-grid
  document.getElementById('note-grid').addEventListener('click',e=>{
    const inp=e.target.closest('.note-input');
    if(inp){e.stopPropagation();showPicker(inp);}
  });
  // Close picker when clicking outside it (use computed style so initial '' != 'none' doesn't trick us)
  document.addEventListener('click',e=>{
    const p=document.getElementById('note-picker');
    if(getComputedStyle(p).display!=='none'&&!p.contains(e.target)&&!e.target.closest('.note-input'))hidePicker();
  });
});

/* â”€â”€ Preset â”€â”€ */
function loadPreset(key){
  if(!key||key==='custom'){renderRangeesCfg();generateInputGrid();onAnyChange();return;}
  const p=PRESETS[key];if(!p)return;
  CFG.nbRangees=p.nbRangees;CFG.rangees=p.rangees.map(r=>({nom:r.nom,nb:r.nb,offset:r.offset||0}));
  CFG.notes=JSON.parse(JSON.stringify(p.notes));
  if(!CFG.notes.terzetto)CFG.notes.terzetto=[];
  document.getElementById('nb-rangees').value=p.nbRangees;
  syncGaucheInputs();
  renderRangeesCfg();generateInputGrid();onAnyChange();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  ROWS â€” RIGHT HAND                                   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function changeNbRangees(delta){
  const el=document.getElementById('nb-rangees');
  el.value=Math.max(1,Math.min(20,(parseInt(el.value)||3)+delta));
  onRangeesChange();
}
function onRangeesChange(){
  readNoteInputsIntoCFG();
  const nb=parseInt(document.getElementById('nb-rangees').value)||1;
  CFG.nbRangees=nb;
  while(CFG.rangees.length<nb)CFG.rangees.push({nom:`RangÃ©e ${CFG.rangees.length+1}`,nb:11});
  CFG.rangees=CFG.rangees.slice(0,nb);
  while(CFG.notes.droite.length<nb)CFG.notes.droite.push([]);
  CFG.notes.droite=CFG.notes.droite.slice(0,nb);
  renderRangeesCfg();generateInputGrid();onAnyChange();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  BASSES â€” LEFT HAND (free count)                     â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function changeGauche(key,delta){
  const el=document.getElementById('nb-'+key);
  el.value=Math.max(0,Math.min(60,(parseInt(el.value)||0)+delta));
  applyGaucheCount(key);
}
function applyGaucheCount(key){
  readNoteInputsIntoCFG();
  const el=document.getElementById('nb-'+key);
  const n=Math.max(0,Math.min(60,parseInt(el.value)||0));
  el.value=n;
  const resize=(arr,count)=>{const r=arr.slice(0,count);while(r.length<count)r.push({p:'',t:''});return r;};
  CFG.notes[key]=resize(CFG.notes[key]||[],n);
  generateInputGrid();onAnyChange();
}
function setGauchePreset(nb,na,nt){
  readNoteInputsIntoCFG();
  const resize=(arr,n)=>{const r=arr.slice(0,n);while(r.length<n)r.push({p:'',t:''});return r;};
  document.getElementById('nb-basses').value=nb;
  document.getElementById('nb-accords').value=na;
  document.getElementById('nb-terzetto').value=nt;
  CFG.notes.basses=resize(CFG.notes.basses,nb);
  CFG.notes.accords=resize(CFG.notes.accords,na);
  CFG.notes.terzetto=resize(CFG.notes.terzetto,nt);
  generateInputGrid();onAnyChange();
}
function syncGaucheInputs(){
  const s=(k)=>{const el=document.getElementById('nb-'+k);if(el)el.value=(CFG.notes[k]||[]).length;};
  s('basses');s('accords');s('terzetto');
}
function addGaucheBtn(key){
  readNoteInputsIntoCFG();CFG.notes[key].push({p:'',t:''});
  const el=document.getElementById('nb-'+key);if(el)el.value=CFG.notes[key].length;
  generateInputGrid();onAnyChange();
}
function removeGaucheBtn(key){
  readNoteInputsIntoCFG();
  if(CFG.notes[key].length>0){CFG.notes[key].pop();
    const el=document.getElementById('nb-'+key);if(el)el.value=CFG.notes[key].length;
    generateInputGrid();onAnyChange();}
}

/* â”€â”€ Read inputs back into CFG â”€â”€ */
function readNoteInputsIntoCFG(){
  const newD=[];
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nb:11};const row=[];
    for(let b=0;b<rc.nb;b++)row.push({p:val(`d-${r}-${b}-p`),t:val(`d-${r}-${b}-t`)});
    newD.push(row);
  }
  CFG.notes.droite=newD;
  const readRow=key=>{const n=(CFG.notes[key]||[]).length;const a=[];for(let b=0;b<n;b++)a.push({p:val(`g-${key}-${b}-p`),t:val(`g-${key}-${b}-t`)});return a;};
  CFG.notes.basses =readRow('basses');
  CFG.notes.accords=readRow('accords');
  CFG.notes.terzetto=readRow('terzetto');
}

/* â”€â”€ Render row configs â”€â”€ */
const REGISTERS=['B','N','N+','N-','A'];
const REGISTER_LABELS={'B':'B (16\' grave)','N':'N (8\' naturel 440)','N+':'N+ (8\'+ aigu)','N-':'N- (8\'- grave)','A':'A (4\' piccolo)'};
const REGISTER_LABELS_EN={'B':'B (16\' low)','N':'N (8\' natural 440)','N+':'N+ (8\'+ sharp)','N-':'N- (8\'- flat)','A':'A (4\' piccolo)'};
function renderRangeesCfg(){
  const wrap=document.getElementById('rangees-cfg');let html='';
  const rLabels=lang==='en'?REGISTER_LABELS_EN:REGISTER_LABELS;
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nom:`RangÃ©e ${r+1}`,nb:11,register:'N'};
    const reg=rc.register||'N';
    html+=`<div class="rangee-cfg">
      <label>R${r+1} â€” Nom</label>
      <input type="text" id="rnom-${r}" value="${esc(rc.nom)}" style="font-size:.76rem;padding:3px 6px;" onchange="CFG.rangees[${r}].nom=this.value;onAnyChange()">
      <label style="margin-top:3px;">Registre <span class="tip tip-up" tabindex="0" role="tooltip" aria-label="Info: Registre" data-tip="B (16') : une octave plus grave.&#10;N (8') : hauteur naturelle 440 Hz.&#10;N+ (8'+) : lÃ©gÃ¨rement plus haut (442 Hz).&#10;N- (8'-) : lÃ©gÃ¨rement plus bas (438 Hz).&#10;A (4') : une octave plus aigu (piccolo).&#10;â€”&#10;B(16')=low octave Â· N(8')=natural 440 Hz Â· N+(8'+)=+2Hz Â· N-(8'-)=-2Hz Â· A(4')=high octave">â“˜</span></label>
      <select id="rreg-${r}" style="font-size:.76rem;padding:3px 5px;" onchange="CFG.rangees[${r}].register=this.value;onAnyChange()">
        ${REGISTERS.map(rv=>`<option value="${rv}"${rv===reg?' selected':''}>${rLabels[rv]}</option>`).join('')}
      </select>
      <label style="margin-top:3px;">Boutons</label>
      <div class="rng-ctrl">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].nb=Math.max(1,(CFG.rangees[${r}].nb||11)-1);document.getElementById('rnb-${r}').value=CFG.rangees[${r}].nb;onRangeesChange()">âˆ’</button>
        <input type="number" id="rnb-${r}" value="${rc.nb}" min="1" max="30" style="width:54px;text-align:center;font-size:.82rem;padding:3px;font-weight:700;" oninput="CFG.rangees[${r}].nb=Math.max(1,parseInt(this.value)||1);onRangeesChange()">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].nb=Math.min(30,(CFG.rangees[${r}].nb||11)+1);document.getElementById('rnb-${r}').value=CFG.rangees[${r}].nb;onRangeesChange()">ï¼‹</button>
      </div>
      <label style="margin-top:3px;">${t('rowOffset')}</label>
      <div class="rng-ctrl">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].offset=Math.max(-30,(CFG.rangees[${r}].offset||0)-1);document.getElementById('roff-${r}').value=CFG.rangees[${r}].offset;scheduleLivePreview()">âˆ’</button>
        <input type="number" id="roff-${r}" value="${rc.offset||0}" min="-30" max="30" style="width:54px;text-align:center;font-size:.82rem;padding:3px;font-weight:700;" oninput="CFG.rangees[${r}].offset=Math.min(30,Math.max(-30,parseInt(this.value)||0));scheduleLivePreview()">
        <button type="button" class="rng-btn" onclick="CFG.rangees[${r}].offset=Math.min(30,(CFG.rangees[${r}].offset||0)+1);document.getElementById('roff-${r}').value=CFG.rangees[${r}].offset;scheduleLivePreview()">ï¼‹</button>
      </div></div>`;
  }
  wrap.innerHTML=html;
}

/* â”€â”€ Generate note input grid â”€â”€ */
function generateInputGrid(){
  let html='';
  // Right hand
  html+=`<div class="note-section"><div class="note-section-title">${t('rightHand')}</div>`;
  for(let r=0;r<CFG.nbRangees;r++){
    const rc=CFG.rangees[r]||{nom:`RangÃ©e ${r+1}`,nb:11};
    const nb=rc.nb;const notes=CFG.notes.droite[r]||[];
    const lbl=rc.nom.split(' ')[1]||`R${r+1}`;
    html+=`<div class="row-wrap"><div class="sec-label" style="margin-bottom:4px;">${esc(rc.nom)}</div><div class="btn-grid">`;
    for(let b=0;b<nb;b++){
      const n=notes[b]||{p:'',t:''};
      html+=`<div class="btn-cell">
        <div class="btn-num">${lbl} ${b+1}</div>
        <input class="note-input pousse" id="d-${r}-${b}-p" data-type="note" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" readonly>
        <input class="note-input tire"   id="d-${r}-${b}-t" data-type="note" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" readonly>
      </div>`;
    }
    html+=`</div></div>`;
  }
  html+=`</div>`;
  // Left hand â€” all sections including terzetto if count > 0
  html+=`<div class="note-section"><div class="note-section-title">${t('leftHand')}</div>`;
  const gsec=[{key:'basses',label:t('basses'),type:'note'},{key:'accords',label:t('accords'),type:'chord'}];
  if((CFG.notes.terzetto||[]).length>0)gsec.push({key:'terzetto',label:t('terzetto'),type:'chord'});
  gsec.forEach(({key,label,type})=>{
    const arr=CFG.notes[key]||[];const count=arr.length;
    if(count===0)return;
    html+=`<div class="row-wrap">
      <div class="sec-hd">
        <span class="sec-label">${label} <span style="color:var(--gris);font-weight:normal;">(${count})</span></span>
        <button type="button" class="rng-btn" onclick="removeGaucheBtn('${key}')" title="âˆ’">âˆ’</button>
        <button type="button" class="rng-btn" onclick="addGaucheBtn('${key}')" title="ï¼‹">ï¼‹</button>
      </div>
      <div class="btn-grid">`;
    for(let b=0;b<count;b++){
      const n=arr[b]||{p:'',t:''};
      html+=`<div class="btn-cell">
        <div class="btn-num">${label[0].toUpperCase()}${b+1}</div>
        <input class="note-input pousse" id="g-${key}-${b}-p" data-type="${type}" value="${esc(n.p)}" placeholder="â†“" oninput="onAnyChange()" readonly>
        <input class="note-input tire"   id="g-${key}-${b}-t" data-type="${type}" value="${esc(n.t)}" placeholder="â†‘" oninput="onAnyChange()" readonly>
      </div>`;
    }
    html+=`</div></div>`;
  });
  html+=`</div>`;
  document.getElementById('note-grid').innerHTML=html;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  NOTE PICKER                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Notes shown in picker depend on current lang
const NOTES_FR={nat:['Do','RÃ©','Mi','Fa','Sol','La','Si'],sha:['Do#','RÃ©#',null,'Fa#','Sol#','La#',null],fla:['RÃ©b','Mib',null,'Solb','Lab','Sib',null]};
const NOTES_EN={nat:['C','D','E','F','G','A','B'],sha:['C#','D#',null,'F#','G#','A#',null],fla:['Db','Eb',null,'Gb','Ab','Bb',null]};
const OCTAVES=['2','3','4','5','6'];
const CHORDS_FR=()=>{const r=['Do','RÃ©','Mi','Fa','Sol','La','Si','Do#','RÃ©#','Fa#','Sol#','Sib','Mib','Lab'];const t=['Maj','Min','7'];const o=[];r.forEach(n=>t.forEach(q=>o.push(`${n} ${q}`)));return o;};
const CHORDS_EN=()=>{const r=['C','D','E','F','G','A','B','C#','D#','F#','G#','Bb','Eb','Ab'];const t=['Maj','Min','7'];const o=[];r.forEach(n=>t.forEach(q=>o.push(`${n} ${q}`)));return o;};

function initPicker(){
  const N=lang==='en'?NOTES_EN:NOTES_FR;
  document.getElementById('picker-naturals').innerHTML=N.nat.map(n=>`<button class="pn" onclick="pickerSetNote('${n}')">${n}</button>`).join('');
  document.getElementById('picker-sharps').innerHTML=N.sha.map(n=>n?`<button class="pn sharp" onclick="pickerSetNote('${n}')">${n}</button>`:`<span style="min-width:34px;"></span>`).join('');
  document.getElementById('picker-flats').innerHTML=N.fla.map(n=>n?`<button class="pn flat" onclick="pickerSetNote('${n}')">${n}</button>`:`<span style="min-width:34px;"></span>`).join('');
  const oWrap=document.getElementById('picker-octaves');
  oWrap.innerHTML=OCTAVES.map(o=>`<button class="po" onclick="pickerSetOctave('${o}')">${o}</button>`).join('');
  const C=lang==='en'?CHORDS_EN():CHORDS_FR();
  document.getElementById('picker-chords-grid').innerHTML=C.map(c=>`<button class="pc" onclick="pickerInsertDirect('${c}')">${c}</button>`).join('');
}
function showPicker(input){
  pickerInput=input;pickerNote='';pickerOctave='';
  const v=input.value.trim();
  if(v){
    const m=v.match(/^(.+?)([2-6])$/);
    if(m){pickerNote=m[1];pickerOctave=m[2];}else pickerNote=v;
  }
  const isChord=input.dataset.type==='chord';
  showPickerTab(isChord?'chords':'notes',document.querySelector(isChord?'.picker-tab-btn:nth-child(2)':'.picker-tab-btn:first-child'));
  updatePickerHighlights();updatePickerPreview();
  const pk=document.getElementById('note-picker');pk.style.display='block';
  const rect=input.getBoundingClientRect(),sy=window.scrollY,sx=window.scrollX;
  let top=sy+rect.bottom+6,left=sx+rect.left;
  const pw=pk.offsetWidth||310,ph=pk.offsetHeight||300;
  if(left+pw>sx+window.innerWidth-10)left=sx+window.innerWidth-pw-10;
  if(left<8)left=8;
  if(top+ph>sy+window.innerHeight-10)top=sy+rect.top-ph-6;
  pk.style.top=top+'px';pk.style.left=left+'px';
  input.classList.add('picker-open');
}
function hidePicker(){
  document.getElementById('note-picker').style.display='none';
  if(pickerInput){pickerInput.classList.remove('picker-open');pickerInput=null;}
}
function showPickerTab(name,btn){
  document.querySelectorAll('.picker-tab-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById('picker-tab-notes').classList.toggle('active',name==='notes');
  document.getElementById('picker-tab-chords').classList.toggle('active',name==='chords');
}
function pickerSetNote(n){pickerNote=n;updatePickerHighlights();updatePickerPreview();if(pickerNote&&pickerOctave)pickerInsert();}
function pickerSetOctave(o){pickerOctave=o;updatePickerHighlights();updatePickerPreview();if(pickerNote&&pickerOctave)pickerInsert();}
function pickerInsertDirect(text){
  if(!pickerInput)return;
  pickerInput.value=storageNote(text);
  pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  hidePicker();onAnyChange();
}
function pickerInsert(){
  if(!pickerInput)return;
  const v=pickerNote+pickerOctave;if(!v)return;
  pickerInput.value=storageNote(v);
  pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  hidePicker();onAnyChange();
}
function pickerClear(){
  if(!pickerInput)return;
  pickerInput.value='';pickerInput.dispatchEvent(new Event('input',{bubbles:true}));
  pickerNote='';pickerOctave='';updatePickerHighlights();updatePickerPreview();hidePicker();onAnyChange();
}
function updatePickerHighlights(){
  document.querySelectorAll('#picker-tab-notes .pn').forEach(b=>b.classList.toggle('selected',b.textContent===pickerNote));
  document.querySelectorAll('.po').forEach(b=>b.classList.toggle('selected',b.textContent===pickerOctave));
}
function updatePickerPreview(){
  const txt=pickerNote+pickerOctave;
  document.getElementById('picker-preview-text').textContent=txt||t('selectNoteOctave');
  const showMidi=document.getElementById('show-midi')?.checked;
  const badge=document.getElementById('picker-midi-badge');
  if(badge){
    const m=txt?noteToMidi(storageNote(txt)):null;
    badge.textContent=(showMidi&&m!==null)?`MIDI ${m}`:'';
  }
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  READ INPUTS â†’ data object                           â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function readInputs(){
  readNoteInputsIntoCFG();
  // capture register from selects
  for(let r=0;r<CFG.nbRangees;r++){
    const sel=document.getElementById(`rreg-${r}`);
    if(sel)CFG.rangees[r].register=sel.value;
  }
  const droite=CFG.notes.droite.map((row,ri)=>({
    nom:CFG.rangees[ri]?CFG.rangees[ri].nom:`RangÃ©e ${ri+1}`,
    register:(CFG.rangees[ri]||{}).register||'N',
    offset:(CFG.rangees[ri]||{}).offset||0,
    boutons:row
  }));
  return{
    nomInstrument:val('nom-instrument')||'AccordÃ©on Diatonique',
    nomJoueur:val('nom-joueur'),
    nomLuthier:val('nom-luthier')||"Ewen d'Aviau",
    date:val('date-creation'),
    nbVoix:parseInt(document.getElementById('nb-voix').value),
    nbVoixGauche:parseInt(document.getElementById('nb-voix-gauche')?.value||'2'),
    lhDisplayMode:document.querySelector('input[name="lh-mode"]:checked')?.value||'separated',
    showMidi:document.getElementById('show-midi')?.checked||false,
    droite,
    basses:CFG.notes.basses,
    accords:CFG.notes.accords,
    terzetto:CFG.notes.terzetto||[],
    orderSpecs:{
      qty:val('order-qty')||'1',
      reedType:val('order-reed-type'),
      tuning:document.getElementById('order-tuning')?.value||'440',
      tremolo:val('order-tremolo'),
      harmony:val('order-harmony'),
      bassType:val('order-bass-type'),
      bassComp:val('order-bass-comp'),
    },
  };
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG HELPERS                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function svg_open(w,h,bg){return`<svg width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg" font-family="Arial,Helvetica,sans-serif"><rect width="${w}" height="${h}" fill="${bg||'white'}"/>`;}
function tx(x,y,text,size,fill,weight,anchor){return`<text x="${x}" y="${y}" font-size="${size}" fill="${fill}" font-weight="${weight||'normal'}" text-anchor="${anchor||'start'}">${text}</text>`;}
function esc(s){if(!s)return'';return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function escSVG(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escHTML(s){if(!s)return'';const d=document.createElement('div');d.appendChild(document.createTextNode(String(s)));return d.innerHTML;}
function fmtDate(d){if(!d)return new Date().toLocaleDateString('fr-FR');try{return new Date(d).toLocaleDateString('fr-FR');}catch(e){return d;}}
function dn(note){return escSVG(displayNote(note));}  // display note in current lang

/* â”€â”€â”€ Bellows SVG â”€â”€â”€ */
function bellowsSVG(x,y,w,h,folds,dark){
  const gold=dark?'#c9a227':'#8b6914',bg=dark?'#0a0800':'#fff8e6';
  let s=`<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="${bg}" rx="2"/>`;
  const fh=h/folds;
  for(let i=0;i<folds;i++){
    const fy1=y+i*fh,fy2=fy1+fh,mid=fy1+fh/2;
    s+=`<line x1="${x}" y1="${fy1}" x2="${x+w}" y2="${fy1}" stroke="${gold}" stroke-width=".6" opacity=".7"/>`;
    s+=`<line x1="${x}" y1="${fy1}" x2="${x+w/2}" y2="${mid}" stroke="${gold}" stroke-width=".9"/>`;
    s+=`<line x1="${x+w/2}" y1="${mid}" x2="${x+w}" y2="${fy1}" stroke="${gold}" stroke-width=".9"/>`;
    if(i<folds-1){
      s+=`<line x1="${x}" y1="${fy2}" x2="${x+w/2}" y2="${mid}" stroke="${gold}" stroke-width=".6" opacity=".5"/>`;
      s+=`<line x1="${x+w/2}" y1="${mid}" x2="${x+w}" y2="${fy2}" stroke="${gold}" stroke-width=".6" opacity=".5"/>`;
    }
  }
  s+=`<rect x="${x}" y="${y}" width="${w}" height="${h}" fill="none" stroke="${gold}" stroke-width="1.5" rx="2"/>`;
  return s;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG KEYBOARD â€” CLIENT (light preview + dark PDF)    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSVG_Droite(data,dark){
  const R=24,HGAP=60,VGAP=72,LPAD=186,MARG=14,HEAD=80,FOOT=34;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111111':'#ffffff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const subtl=dark?'#888866':'#888888',stroke=dark?'#c9a227':'#2d5a27';
  const band1=dark?'#1a1a1a':'#fafafa',band2=dark?'#161616':'#f3f7f3';
  const numTx=dark?'rgba(200,162,39,.3)':'rgba(0,0,0,.2)';

  const maxBtns=Math.max(...data.droite.map(r=>r.boutons.length),1);
  const allOffs=data.droite.map(r=>r.offset||0);
  const maxOff=Math.max(...allOffs,0);
  const minOff=Math.min(...allOffs,0);
  const leftShift=-minOff*(HGAP/2);
  const BASE=LPAD+leftShift;
  const W=BASE+maxBtns*HGAP+maxOff*(HGAP/2)+MARG;
  const H=MARG+HEAD+data.droite.length*VGAP+FOOT;

  let s=svg_open(W,H,bg);

  // Orientation arrows â€” horizontal across the top
  const arrowY=MARG+HEAD-10;
  const ax1=BASE,ax2=W-MARG-2;
  const arrowMid=(ax1+ax2)/2;
  s+=`<line x1="${ax1+2}" y1="${arrowY}" x2="${ax2-2}" y2="${arrowY}" stroke="${gold}" stroke-width="1" opacity=".5"/>`;
  s+=`<polygon points="${ax1+2},${arrowY} ${ax1+10},${arrowY-4} ${ax1+10},${arrowY+4}" fill="${gold}" opacity=".7"/>`;
  s+=`<polygon points="${ax2-2},${arrowY} ${ax2-10},${arrowY-4} ${ax2-10},${arrowY+4}" fill="${gold}" opacity=".7"/>`;
  s+=tx(ax1+14,arrowY+4,t('svgLow'),8,gold,'bold','start');
  s+=tx(ax2-14,arrowY+4,t('svgHigh'),8,gold,'bold','end');

  // Title
  s+=tx(BASE+(maxBtns*HGAP)/2,MARG+16,escSVG(data.nomInstrument),16,gold,'bold','middle');
  if(data.nomJoueur)s+=tx(BASE+(maxBtns*HGAP)/2,MARG+32,`${t('svgClient')} : ${escSVG(data.nomJoueur)}`,10,subtl,'normal','middle');
  s+=tx(BASE+(maxBtns*HGAP)/2,MARG+47,`${t('svgLuthier')} : ${escSVG(data.nomLuthier)}  Â·  ${fmtDate(data.date)}`,9,subtl,'normal','middle');

  // Legend â€“ split circle (push=top half, pull=bottom half)
  const lx=BASE,ly=MARG+62;
  const lr=10,lcx=lx+lr,lcy=ly-4;
  s+=`<circle cx="${lcx}" cy="${lcy}" r="${lr}" fill="${bg}" stroke="${stroke}" stroke-width="1.2"/>`;
  s+=`<path d="M${lcx-lr},${lcy} A${lr},${lr} 0 0,1 ${lcx+lr},${lcy}" fill="${pushBg}"/>`;
  s+=`<path d="M${lcx-lr},${lcy} A${lr},${lr} 0 0,0 ${lcx+lr},${lcy}" fill="${pullBg}"/>`;
  s+=`<circle cx="${lcx}" cy="${lcy}" r="${lr}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
  s+=`<line x1="${lcx-lr}" y1="${lcy}" x2="${lcx+lr}" y2="${lcy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
  s+=tx(lcx+lr+5,lcy-1,t('svgPush'),8,dark?'#ccc':'#333','normal','start');
  s+=tx(lcx+lr+5,lcy+9,t('svgPull'),8,dark?'#ccc':'#333','normal','start');

  // Rows
  data.droite.forEach((row,ri)=>{
    const cy=MARG+HEAD+ri*VGAP+VGAP/2;
    const stagger=(ri%2===1)?HGAP/2:0;
    const alignOff=(row.offset||0)*(HGAP/2);
    s+=`<rect x="${BASE+alignOff-4}" y="${cy-R-6}" width="${row.boutons.length*HGAP+stagger+8}" height="${(R+6)*2}" rx="4" fill="${ri%2===0?band1:band2}" opacity=".7"/>`;
    s+=tx(BASE+alignOff-8,cy+4,escSVG(row.nom),9.5,gold,'bold','end');
    row.boutons.forEach((btn,bi)=>{
      const cx=BASE+alignOff+stagger+bi*HGAP;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#ffffff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
      s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
      s+=tx(cx,cy+3.5,bi+1,7.5,numTx,'normal','middle');
      if(btn.p){const fs=btn.p.length>6?7:8.5;s+=tx(cx,cy-9,dn(btn.p),fs,pushTx,'bold','middle');}
      if(btn.t){const fs=btn.t.length>6?7:8.5;s+=tx(cx,cy+19,dn(btn.t),fs,pullTx,'bold','middle');}
      if(data.showMidi){
        const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);
        if(mp!==null)s+=tx(cx+R-2,cy-R+6,mp,5.5,'rgba(100,140,220,.8)','normal','end');
        if(mt!==null)s+=tx(cx+R-2,cy+R-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
      }
    });
  });

  const fy=MARG+HEAD+data.droite.length*VGAP+14;
  s+=`<line x1="${BASE}" y1="${fy}" x2="${W-MARG-44}" y2="${fy}" stroke="${dark?'#333':'#eee'}" stroke-width="1"/>`;
  s+=tx(BASE,fy+14,`${escSVG(data.nomLuthier)} â€” ewendaviau.com`,7.5,dark?'#444':'#bbb','normal','start');
  s+='</svg>';return s;
}

function buildSVG_Gauche(data,dark){
  const R=24,HGAP=62,VGAP=70,LPAD=110,MARG=12,HEAD=32,FOOT=20;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111':'#fff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const stroke=dark?'#c9a227':'#2d5a27';
  const band1=dark?'#1a1a1a':'#fafafa',band2=dark?'#161616':'#f3f7f3';
  const numTx=dark?'rgba(200,162,39,.3)':'rgba(0,0,0,.2)';

  // Paired mode: interleave bass and chord buttons on a single row
  if(data.lhDisplayMode==='paired'){
    const n=Math.max(data.basses.length,data.accords.length);
    const items=[];
    for(let i=0;i<n;i++){
      if(i<data.basses.length)items.push({btn:data.basses[i],type:'B'});
      if(i<data.accords.length)items.push({btn:data.accords[i],type:'A'});
    }
    if(data.terzetto&&data.terzetto.length)data.terzetto.forEach(btn=>items.push({btn,type:'T'}));
    const PLPAD=20,PW=PLPAD+items.length*HGAP+MARG;
    const PH=MARG+HEAD+VGAP+FOOT;
    let s=svg_open(PW,PH,bg);
    s+=tx(PW/2,MARG+16,`${t('svgLH')} â€” ${escSVG(data.nomInstrument)}`,12,gold,'bold','middle');
    const cy=MARG+HEAD+VGAP/2;
    items.forEach((item,bi)=>{
      const cx=PLPAD+bi*HGAP;
      const isB=item.type==='B',isT=item.type==='T';
      const btnStroke=isB?stroke:(isT?'#888':dark?'#888':'#aaa');
      const sw=isB?1.8:1.0;
      s+=tx(cx,cy-R-8,isB?'B':isT?'T':'A',7,btnStroke,'bold','middle');
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#fff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${btnStroke}" stroke-width="${sw}"/>`;
      s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${btnStroke}" stroke-width=".5" opacity=".4"/>`;
      const pairNum=Math.floor(bi/2)+1;
      s+=tx(cx,cy+3.5,pairNum,7.5,numTx,'normal','middle');
      if(item.btn.p){const fs=item.btn.p.length>7?6.5:(item.btn.p.length>4?7.5:8.5);s+=tx(cx,cy-9,dn(item.btn.p),fs,pushTx,'bold','middle');}
      if(item.btn.t){const fs=item.btn.t.length>7?6.5:(item.btn.t.length>4?7.5:8.5);s+=tx(cx,cy+19,dn(item.btn.t),fs,pullTx,'bold','middle');}
    });
    s+='</svg>';return s;
  }

  // Separated mode: accords on top (outer), basses below (inner) â€” conventional accordion layout
  const sections=[{nom:t('accords'),items:data.accords},{nom:t('basses'),items:data.basses}];
  if(data.terzetto&&data.terzetto.length)sections.push({nom:t('terzetto'),items:data.terzetto});
  const maxItems=Math.max(...sections.map(s=>s.items.length),1);
  const W=LPAD+maxItems*HGAP+MARG;
  const H=MARG+HEAD+sections.length*VGAP+FOOT;

  let s=svg_open(W,H,bg);
  s+=tx(W/2,MARG+16,`${t('svgLH')} â€” ${escSVG(data.nomInstrument)}`,12,gold,'bold','middle');
  sections.forEach((sec,si)=>{
    const cy=MARG+HEAD+si*VGAP+VGAP/2;
    s+=`<rect x="${LPAD-4}" y="${cy-R-6}" width="${sec.items.length*HGAP+8}" height="${(R+6)*2}" rx="4" fill="${si%2===0?band1:band2}" opacity=".7"/>`;
    s+=tx(LPAD-7,cy+4,escSVG(sec.nom),10,gold,'bold','end');
    sec.items.forEach((btn,bi)=>{
      const cx=LPAD+bi*HGAP;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${bg}" stroke="${bg==='#fff'?'#bbb':'#333'}" stroke-width="1.2"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="${pushBg}"/>`;
      s+=`<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="${pullBg}"/>`;
      s+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="${stroke}" stroke-width="1.4"/>`;
      s+=`<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="${stroke}" stroke-width=".5" opacity=".4"/>`;
      s+=tx(cx,cy+3.5,bi+1,7.5,numTx,'normal','middle');
      if(btn.p){const fs=btn.p.length>7?6.5:(btn.p.length>4?7.5:8.5);s+=tx(cx,cy-9,dn(btn.p),fs,pushTx,'bold','middle');}
      if(btn.t){const fs=btn.t.length>7?6.5:(btn.t.length>4?7.5:8.5);s+=tx(cx,cy+19,dn(btn.t),fs,pullTx,'bold','middle');}
      if(data.showMidi){
        const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);
        if(mp!==null)s+=tx(cx+R-2,cy-R+6,mp,5.5,'rgba(100,140,220,.8)','normal','end');
        if(mt!==null)s+=tx(cx+R-2,cy+R-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
      }
    });
  });
  s+='</svg>';return s;
}


/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG SOMMIER (reed plate view)                       â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSommierSection(title,rows,dark){
  const CW=58,CH=46,LPAD=164,MARG=12,HEAD=52,VGAP=CH+6,FOOT=20;
  const gold=dark?'#c9a227':'#2d5a27';
  const bg=dark?'#111':'#fff';
  const pushBg=dark?'#0d1f0d':'#e8f5e3',pullBg=dark?'#1f1000':'#fff8e6';
  const pushTx=dark?'#6fcf5a':'#1a5c1a',pullTx=dark?'#e8b840':'#8b6914';
  const numTx=dark?'rgba(200,162,39,.4)':'rgba(0,0,0,.3)';
  const sep=dark?'#3a3a1a':'#cccccc';
  const stagger=CW/2;
  const showMidi=document.getElementById('show-midi')?.checked;

  function cell(cx,cy,num,pNote,tNote){
    let o='';
    o+=`<rect x="${cx}" y="${cy}" width="${CW}" height="${CH/2}" fill="${pushBg}" stroke="${dark?'#2a4a2a':'#b0ccb0'}" stroke-width=".7"/>`;
    o+=`<rect x="${cx}" y="${cy+CH/2}" width="${CW}" height="${CH/2}" fill="${pullBg}" stroke="${dark?'#4a2a00':'#ccb080'}" stroke-width=".7"/>`;
    o+=`<line x1="${cx}" y1="${cy+CH/2}" x2="${cx+CW}" y2="${cy+CH/2}" stroke="${sep}" stroke-width=".8"/>`;
    o+=tx(cx+3,cy+9,num,6.5,numTx,'normal','start');
    if(pNote){const fs=pNote.length>6?7:8.5;o+=tx(cx+CW/2,cy+16,dn(pNote),fs,pushTx,'bold','middle');}
    if(tNote){const fs=tNote.length>6?7:8.5;o+=tx(cx+CW/2,cy+CH-7,dn(tNote),fs,pullTx,'bold','middle');}
    if(showMidi){
      const mp=noteToMidi(pNote),mt=noteToMidi(tNote);
      if(mp!==null)o+=tx(cx+CW-2,cy+9,mp,5.5,'rgba(100,140,220,.8)','normal','end');
      if(mt!==null)o+=tx(cx+CW-2,cy+CH-2,mt,5.5,'rgba(100,140,220,.8)','normal','end');
    }
    return o;
  }

  const maxBtns=Math.max(...rows.map(r=>r.boutons?r.boutons.length:(r.items?r.items.length:0)),1);
  const allOffs=rows.map(r=>r.offset||0);
  const maxOff=Math.max(...allOffs,0);
  const minOff=Math.min(...allOffs,0);
  const leftShift=-minOff*(CW/2);
  const RBASE=LPAD+leftShift;
  const W=RBASE+maxBtns*CW+stagger+maxOff*(CW/2)+MARG;
  const H=MARG+HEAD+rows.length*VGAP+FOOT;
  let s=svg_open(W,H,bg);

  // Header
  s+=tx(W/2,MARG+15,escSVG(title),12,gold,'bold','middle');
  s+=`<rect x="${RBASE}" y="${MARG+25}" width="13" height="8" rx="1" fill="${pushBg}" stroke="${dark?'#4a7a40':'#2d5a27'}" stroke-width=".8"/>`;
  s+=tx(RBASE+17,MARG+33,t('svgPush'),7.5,dark?'#ccc':'#333','normal','start');
  s+=`<rect x="${RBASE+68}" y="${MARG+25}" width="13" height="8" rx="1" fill="${pullBg}" stroke="${dark?'#c9a227':'#c8a96e'}" stroke-width=".8"/>`;
  s+=tx(RBASE+85,MARG+33,t('svgPull'),7.5,dark?'#ccc':'#333','normal','start');
  if(showMidi)s+=tx(RBASE+135,MARG+33,'MIDI = coin â†—',7,dark?'rgba(100,140,220,.8)':'rgba(21,101,192,.6)','normal','start');

  rows.forEach((row,ri)=>{
    const rowY=MARG+HEAD+ri*VGAP;
    const rowStag=(ri%2===1)?stagger:0;
    const nom=row.nom||(row.label||`R${ri+1}`);
    const items=row.boutons||row.items||[];
    const alignOff=(row.offset||0)*(CW/2);
    s+=tx(RBASE+alignOff-5,rowY+CH/2+4,escSVG(nom),9,gold,'bold','end');
    items.forEach((btn,bi)=>{s+=cell(RBASE+alignOff+rowStag+bi*CW,rowY,bi+1,btn.p||'',btn.t||'');});
  });
  s+='</svg>';return s;
}

function buildSommierSVG(data,dark){
  const rhTitle=t('svgSommierRH')+' â€” '+escSVG(data.nomInstrument);
  const lhTitle=t('svgSommierLH')+' â€” '+escSVG(data.nomInstrument);
  const lhSections=[];
  if(data.basses&&data.basses.length)lhSections.push({nom:t('basses'),items:data.basses});
  if(data.accords&&data.accords.length)lhSections.push({nom:t('accords'),items:data.accords});
  if(data.terzetto&&data.terzetto.length)lhSections.push({nom:t('terzetto'),items:data.terzetto});
  const svgD=buildSommierSection(rhTitle,data.droite,dark);
  const svgG=lhSections.length?buildSommierSection(lhTitle,lhSections,dark):'';
  const h3style=`color:var(--vert);font-size:.88rem;margin-bottom:10px;`;
  const h3dstyle=`color:#c9a227;font-size:.88rem;margin-bottom:10px;`;
  return `<h3 style="${dark?h3dstyle:h3style}">${t('svgRH')}</h3>${svgD}
    <h3 style="${dark?h3dstyle:h3style};margin-top:18px;">${t('svgLH')}</h3>${svgG}`;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  MANUFACTURER TABLE                                  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildManufacturerTable(data,dark){
  const date=fmtDate(data.date);
  const showMidi=data.showMidi;
  const gold=dark?'#c9a227':'#2d5a27';
  const subStyle=dark?'color:#aaa;':'color:#666;';
  const os=data.orderSpecs||{};

  // â”€â”€ Description gÃ©nÃ©rale (nb touches / nb accords)
  const totalBtns=data.droite.reduce((s,r)=>s+r.boutons.length,0);
  const nbBasses=data.basses.length;
  const genDesc=`${totalBtns}/${nbBasses}`;
  // â”€â”€ Row spec string  e.g.  "1B / 2N"  or  "3N"
  const rowSpecStr=data.droite.map(r=>r.register||'N').join(' / ');

  const thStyle=dark?`style="background:#1a1500;color:#c9a227;border-color:#333;"`:'';
  const tdStyle=dark?`style="background:#1a1a1a;border-color:#333;color:#ddd;"`:'';
  const hdStyle=dark?`style="background:#111;color:#c9a227;border-color:#333;font-weight:700;"`:'class="row-hd"';
  const clStyle=dark?`style="background:#0d0d00;border-color:#333;color:#ddd;"`:`style="background:#fafdf8;"`;
  const clHdStyle=dark?`style="background:#0d0d00;color:#c9a227;border-color:#333;font-weight:700;"`:`style="background:#e8f5e3;color:#2d5a27;font-weight:700;"`;
  const clValStyle=dark?`style="background:#1a1a1a;border-color:#333;color:#e8e8c8;font-weight:700;"`:`style="background:#fff;font-weight:700;"`;

  let h='';

  // â•â• VOCI ARMONICHE CHECKLIST HEADER â•â•
  h+=`<div style="border:2px solid ${dark?'#c9a227':'#2d5a27'};border-radius:8px;overflow:hidden;margin-bottom:18px;">
    <div style="background:${dark?'#1a1500':'#2d5a27'};color:${dark?'#c9a227':'#fff'};padding:8px 14px;font-size:.86rem;font-weight:700;letter-spacing:.04em;">
      ğŸ“‹ ${t('orderChecklistTitle')} &nbsp;â€”&nbsp; ${escHTML(data.nomInstrument)}
    </div>
    <table style="width:100%;border-collapse:collapse;font-size:.82rem;">
      <tbody>
        <tr>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;width:36%">${t('clQty')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(os.qty||'1')}</td>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;width:36%">${t('clReedType')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(os.reedType||'â€”')}</td>
        </tr>
        <tr>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clDesc')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${genDesc} <span style="opacity:.6;font-weight:normal;font-size:.76rem;">(${t('clDescHint')})</span></td>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clTonality')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(data.nomInstrument)}</td>
        </tr>
        <tr>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clRowSpec')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(rowSpecStr)}
            <span style="opacity:.6;font-weight:normal;font-size:.72rem;">&nbsp;(B=16' Â· N=8' Â· N+=8'+ Â· N-=8'- Â· A=4')</span></td>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clTuning')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(os.tuning||'440')} Hz</td>
        </tr>
        <tr>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clTremolo')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(os.tremolo||'â€”')}</td>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clHarmony')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(os.harmony||'â€”')}</td>
        </tr>
        <tr>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clBassType')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(os.bassType||'â€”')}</td>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clBassComp')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(os.bassComp||'â€”')}</td>
        </tr>
        <tr>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clVoices')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${data.nbVoix} / ${data.nbVoixGauche||2}</td>
          <td ${clHdStyle} style="${dark?'background:#0d0d00;color:#c9a227;':'background:#e8f5e3;color:#2d5a27;'}font-weight:700;border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${t('clLuthier')}</td>
          <td ${clValStyle} style="border:1px solid ${dark?'#333':'#c8e0c5'};padding:5px 10px;">${escHTML(data.nomLuthier)} â€” ${date}</td>
        </tr>
      </tbody>
    </table>
  </div>`;

  // â•â• NOTE TABLES â•â•
  const tableStart=(midi)=>`<table class="mfr-table" style="${dark?'color:#ddd;':''}"><thead><tr>
    <th ${thStyle}>${t('mfrRow')}</th>
    <th ${thStyle}>${t('clRowSpec')}</th>
    <th ${thStyle}>${t('mfrNo')}</th>
    <th ${thStyle}>${t('mfrPushNote')}<br><small style="font-weight:400;opacity:.8">${t('mfrPushSub')}</small></th>
    <th ${thStyle}>${t('mfrPullNote')}<br><small style="font-weight:400;opacity:.8">${t('mfrPullSub')}</small></th>
    ${midi?`<th ${thStyle}>${t('mfrMidiPush')}</th><th ${thStyle}>${t('mfrMidiPull')}</th>`:''}
  </tr></thead><tbody>`;

  h+=`<h4 style="color:${gold};border-bottom:2px solid ${dark?'#333':'#c8e0c5'};padding-bottom:5px;margin:0 0 10px;font-size:.88rem;">${t('mfrRH')}</h4>`;
  h+=tableStart(showMidi);
  data.droite.forEach(row=>{
    const reg=row.register||'N';
    row.boutons.forEach((btn,bi)=>{
      h+=`<tr>`;
      if(bi===0){
        h+=`<td ${hdStyle} rowspan="${row.boutons.length}">${escHTML(row.nom)}</td>`;
        h+=`<td ${hdStyle} rowspan="${row.boutons.length}" style="font-size:.8rem;text-align:center;">${reg}<br><span style="font-weight:normal;opacity:.7;font-size:.7rem;">${(lang==='en'?REGISTER_LABELS_EN:REGISTER_LABELS)[reg]||reg}</span></td>`;
      }
      h+=`<td ${tdStyle}>${bi+1}</td>`;
      h+=`<td class="note-p" ${tdStyle}>${escHTML(displayNote(btn.p))||'â€”'}</td>`;
      h+=`<td class="note-t" ${tdStyle}>${escHTML(displayNote(btn.t))||'â€”'}</td>`;
      if(showMidi){const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);h+=`<td class="midi-c" ${tdStyle}>${mp!==null?mp:'â€”'}</td><td class="midi-c" ${tdStyle}>${mt!==null?mt:'â€”'}</td>`;}
      h+=`</tr>`;
    });
  });
  h+=`</tbody></table>`;

  const lhExtra=data.terzetto.length?` &amp; ${t('terzetto')}`:'';
  h+=`<h4 style="color:${gold};border-bottom:2px solid ${dark?'#333':'#c8e0c5'};padding-bottom:5px;margin:18px 0 10px;font-size:.88rem;">${t('mfrLH')}${lhExtra}</h4>`;
  h+=`<table class="mfr-table" style="${dark?'color:#ddd;':''}"><thead><tr>
    <th ${thStyle}>${t('mfrType')}</th><th ${thStyle}>${t('mfrNo')}</th>
    <th ${thStyle}>${t('mfrNoteChordPush')}</th><th ${thStyle}>${t('mfrNoteChordPull')}</th>
    ${showMidi?`<th ${thStyle}>${t('mfrMidiPush')}</th><th ${thStyle}>${t('mfrMidiPull')}</th>`:''}
  </tr></thead><tbody>`;
  const gs=[{nom:t('basses'),arr:data.basses},{nom:t('accords'),arr:data.accords}];
  if(data.terzetto.length)gs.push({nom:t('terzetto'),arr:data.terzetto});
  gs.forEach(({nom,arr})=>{
    arr.forEach((btn,bi)=>{
      h+=`<tr>`;
      if(bi===0)h+=`<td ${hdStyle} rowspan="${arr.length}">${nom}</td>`;
      h+=`<td ${tdStyle}>${bi+1}</td>`;
      h+=`<td class="note-p" ${tdStyle}>${escHTML(displayNote(btn.p))||'â€”'}</td>`;
      h+=`<td class="note-t" ${tdStyle}>${escHTML(displayNote(btn.t))||'â€”'}</td>`;
      if(showMidi){const mp=noteToMidi(btn.p),mt=noteToMidi(btn.t);h+=`<td class="midi-c" ${tdStyle}>${mp!==null?mp:'â€”'}</td><td class="midi-c" ${tdStyle}>${mt!==null?mt:'â€”'}</td>`;}
      h+=`</tr>`;
    });
  });
  h+=`</tbody></table>`;

  h+=`<div style="margin-top:18px;background:${dark?'#1a1500':'#f6f9f5'};border:1.5px solid ${dark?'#333':'#c8e0c5'};border-radius:6px;padding:11px 14px;font-size:.78rem;${dark?'color:#ccc;':''}">
    <strong>${t('specTitle')}</strong><br>
    &bull; ${t('spec1')}<br>&bull; ${t('spec2')} : <strong>${data.nbVoix}</strong><br>
    &bull; ${t('spec3')}<br>&bull; ${t('spec4')}<br><br>
    <em>${t('specGenBy')} ${date} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</em></div>`;
  return h;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LIVE PREVIEW                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function scheduleLivePreview(){clearTimeout(previewTimer);previewTimer=setTimeout(runLivePreview,600);}
function forcePreview(){clearTimeout(previewTimer);runLivePreview();}
function runLivePreview(){
  try{
    readNoteInputsIntoCFG();
    const data=readInputs();
    const svgD=buildSVG_Droite(data,false);
    const svgG=buildSVG_Gauche(data,false);
    document.getElementById('visual-output').innerHTML=
      `<h3 style="color:var(--vert);font-size:.88rem;margin-bottom:9px;">${t('svgRH')}</h3>${svgD}
       <h3 style="color:var(--vert);font-size:.88rem;margin:16px 0 9px;">${t('svgLH')}</h3>${svgG}`;
    document.getElementById('table-output').innerHTML=buildManufacturerTable(data,false);
    document.getElementById('sommier-output').innerHTML=buildSommierSVG(data,false);
  }catch(e){}
}

/* â”€â”€ Tabs â”€â”€ */
function showTab(name,btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-visual').style.display   =name==='visual'   ?'':'none';
  document.getElementById('tab-fabricant').style.display=name==='fabricant'?'':'none';
}
function showFabricantView(mode,btn){
  fabricantView=mode;
  document.querySelectorAll('.fab-view-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('fab-view-liste').style.display  =mode==='liste'  ?'':'none';
  document.getElementById('fab-view-sommier').style.display=mode==='sommier'?'':'none';
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PDF PRINT â€” DARK/GOLD MIDICORE DESIGN               â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function printSection(which){
  const data=readInputs();
  const title=which==='visual'
    ?`${t('pdfClientTitle')} â€” ${data.nomInstrument}`
    :`${t('pdfMfrTitle')} â€” ${data.nomInstrument}`;
  const dark=true; // always dark/gold for PDF

  let body='';
  if(which==='visual'){
    const svgD=buildSVG_Droite(data,dark);
    const svgG=buildSVG_Gauche(data,dark);
    body=`
      <div style="background:#111;min-height:100vh;padding:12mm 14mm;color:#eee;">
        <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #c9a227;padding-bottom:4mm;margin-bottom:6mm;">
          <div>
            <h2 style="color:#c9a227;font-size:15pt;font-family:'Georgia',serif;letter-spacing:.05em;margin:0;">${escHTML(data.nomInstrument)}</h2>
            <p style="font-size:9pt;color:#888;margin:1mm 0 0;">${t('svgClient')} : <b style="color:#ddd;">${escHTML(data.nomJoueur)||'â€”'}</b> &nbsp;Â·&nbsp; ${t('svgLuthier')} : <b style="color:#ddd;">${escHTML(data.nomLuthier)}</b> &nbsp;Â·&nbsp; ${fmtDate(data.date)}</p>
          </div>
          <div style="font-size:8pt;color:#c9a227;text-align:right;">ewendaviau.com</div>
        </div>
        <h3 style="color:#c9a227;font-size:10pt;margin:3mm 0 2mm;">${t('svgRH')}</h3>
        ${svgD}
        <h3 style="color:#c9a227;font-size:10pt;margin:6mm 0 2mm;">${t('svgLH')}</h3>
        ${svgG}
        <p style="font-size:7pt;color:#555;text-align:center;margin-top:8mm;border-top:1px solid #333;padding-top:3mm;">${t('svgGeneratedBy')} ${fmtDate(data.date)} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</p>
      </div>`;
  } else if(fabricantView==='sommier'){
    body=`
      <div style="background:#111;min-height:100vh;padding:12mm 14mm;color:#eee;">
        <div style="border-bottom:2px solid #c9a227;padding-bottom:4mm;margin-bottom:6mm;">
          <h2 style="color:#c9a227;font-size:14pt;font-family:'Georgia',serif;">${escHTML(data.nomInstrument)} â€” ${t('sommierView').replace('ğŸª— ','')}</h2>
        </div>
        ${buildSommierSVG(data,true)}
        <p style="font-size:7pt;color:#555;text-align:center;margin-top:8mm;border-top:1px solid #333;padding-top:3mm;">${t('svgGeneratedBy')} ${fmtDate(data.date)} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</p>
      </div>`;
  } else {
    const tableHtml=buildManufacturerTable(data,true);
    body=`
      <div style="background:#111;min-height:100vh;padding:12mm 14mm;color:#eee;">
        <div style="border-bottom:2px solid #c9a227;padding-bottom:4mm;margin-bottom:6mm;">
          <h2 style="color:#c9a227;font-size:14pt;font-family:'Georgia',serif;">${escHTML(data.nomInstrument)} â€” ${t('pdfMfrTitle')}</h2>
        </div>
        ${tableHtml}
        <p style="font-size:7pt;color:#555;text-align:center;margin-top:8mm;border-top:1px solid #333;padding-top:3mm;">${t('svgGeneratedBy')} ${fmtDate(data.date)} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</p>
      </div>`;
  }

  const win=window.open('','_blank','width=960,height=740');
  if(!win){alert(t('popupAlert'));return;}
  win.document.write(`<!DOCTYPE html><html lang="${lang}"><head>
    <meta charset="UTF-8"><title>${escHTML(title)}</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:Arial,Helvetica,sans-serif;background:#111}
      .mfr-table{width:100%;border-collapse:collapse;font-size:8.5pt;margin-bottom:4mm}
      .mfr-table th,.mfr-table td{border:1px solid #333;padding:4px 8px;text-align:center}
      .mfr-table th{background:#1a1500;color:#c9a227;font-size:7.5pt;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .mfr-table tr:nth-child(even) td{background:#1a1a1a}
      .mfr-table td{background:#111;color:#ddd}
      td.note-p{color:#6fcf5a;font-weight:700}
      td.note-t{color:#e8b840;font-weight:700}
      td.midi-c{color:#82b0ff;font-size:.72rem}
      .mfr-sub{font-size:8pt;color:#aaa;margin-bottom:4mm}
      svg{display:block;max-width:100%}
      @media print{body{background:#111!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}}
    </style>
  </head><body>${body}</body></html>`);
  win.document.close();win.focus();
  setTimeout(()=>win.print(),700);
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  MISC ACTIONS                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearNotes(){
  if(!confirm(t('clearConfirm')))return;
  document.querySelectorAll('#note-grid input').forEach(el=>{el.value='';});
  readNoteInputsIntoCFG();onAnyChange();
}
function openImportExport(){
  document.getElementById('modal-json').value=JSON.stringify(DB.all(),null,2);
  document.getElementById('modal-msg').textContent='';
  document.getElementById('import-modal').classList.add('open');
}
function closeModal(){document.getElementById('import-modal').classList.remove('open');}
function copyJSON(){
  const text=document.getElementById('modal-json').value;
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{document.getElementById('modal-msg').textContent=t('copied');}).catch(()=>{});
  } else {
    const ta=document.getElementById('modal-json');ta.select();document.execCommand('copy');
    document.getElementById('modal-msg').textContent=t('copied');
  }
}
function doImport(){
  try{
    const data=JSON.parse(document.getElementById('modal-json').value);
    if(!Array.isArray(data))throw new Error(t('invalidFormat'));
    DB.save(data);renderLibrary();
    if(data.length)loadFromDB(data[0]);
    closeModal();
    document.getElementById('modal-msg').textContent=t('importSuccess')(data.length);
  }catch(e){document.getElementById('modal-msg').textContent=t('importError')+e.message;}
}

/* â”€â”€â”€ Save As / Open JSON file â”€â”€â”€ */
function saveAsJSON(){
  readNoteInputsIntoCFG();
  const rec=snapshotToDB();
  const name=(rec.nom||'accordeon').replace(/[^a-zA-Z0-9_\-]/g,'_');
  triggerDownload(JSON.stringify(rec,null,2),name+'.json','application/json');
}
function downloadAllJSON(){
  const list=DB.all();
  triggerDownload(JSON.stringify(list,null,2),'accordeons_export.json','application/json');
}
function loadFromFile(evt){
  const file=evt.target.files&&evt.target.files[0];
  if(!file)return;
  evt.target.value=''; // reset so same file can be re-loaded
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      let data=JSON.parse(e.target.result);
      // Accept both a single object and an array
      if(!Array.isArray(data))data=[data];
      data.forEach((rec,i)=>{if(!rec.id)rec.id=Date.now().toString(36)+'_'+i+'_'+Math.random().toString(36).slice(2);});
      const existing=DB.load();
      // Merge: skip duplicates by id, add new ones at top
      const ids=new Set(existing.map(r=>r.id));
      const fresh=data.filter(r=>!ids.has(r.id));
      DB.save([...fresh,...existing]);
      renderLibrary();
      if(data.length)loadFromDB(data[0]);
      alert(t('loadedFrom')(data.length));
    }catch(err){alert(t('importError')+err.message);}
  };
  reader.readAsText(file);
}
function triggerDownload(content,filename,mime){
  const blob=new Blob([content],{type:mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();
  setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);},100);
}

/* â”€â”€â”€ utils â”€â”€â”€ */
function val(id){const el=document.getElementById(id);return el?el.value.trim():'';}
</script>
</body>
</html>
