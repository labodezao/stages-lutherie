<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clavier AccordÃ©on Diatonique â€” Outil de Conception</title>
  <style>
    :root {
      --vert:       #2d5a27;
      --vert-med:   #3d7a35;
      --vert-clair: #e8f5e3;
      --or:         #c8a96e;
      --or-clair:   #fff8e6;
      --gris:       #6c757d;
      --fond:       #f4f6f4;
      --blanc:      #ffffff;
      --texte:      #222;
      --rouge:      #c0392b;
      --bleu:       #1565c0;
      --border:     #d0d7d0;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, Arial, sans-serif; background: var(--fond); color: var(--texte); line-height: 1.5; font-size: 15px; }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--vert);
      color: #fff;
      padding: 16px 28px;
      display: flex; align-items: center; gap: 14px;
    }
    header .icon { font-size: 2rem; }
    header h1 { font-size: 1.35rem; font-weight: 700; }
    header p  { font-size: 0.85rem; opacity: 0.85; margin-top: 3px; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container { max-width: 1300px; margin: 0 auto; padding: 20px 18px; }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card { background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.09); margin-bottom: 20px; overflow: hidden; }
    .card-head {
      background: var(--vert); color: #fff;
      padding: 11px 20px;
      display: flex; align-items: center; gap: 10px;
    }
    .card-head h2 { font-size: 0.97rem; font-weight: 700; }
    .step-badge {
      background: rgba(255,255,255,.22); border-radius: 50%;
      width: 26px; height: 26px; display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; flex-shrink: 0;
    }
    .card-body { padding: 20px; }

    /* â”€â”€ Form elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group label { font-size: 0.78rem; font-weight: 700; color: var(--gris); text-transform: uppercase; letter-spacing: .05em; }
    input[type="text"], input[type="date"], select {
      padding: 8px 11px; border: 1.5px solid var(--border); border-radius: 6px;
      font-size: 0.88rem; font-family: inherit; background: #fff; color: var(--texte);
      transition: border-color .18s;
    }
    input[type="text"]:focus, select:focus, input[type="date"]:focus {
      border-color: var(--vert); outline: none;
      box-shadow: 0 0 0 3px rgba(45,90,39,.12);
    }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      padding: 9px 18px; border: none; border-radius: 6px;
      font-family: inherit; font-size: 0.88rem; font-weight: 700;
      cursor: pointer; display: inline-flex; align-items: center; gap: 7px;
      transition: filter .15s, transform .1s;
    }
    .btn:hover { filter: brightness(1.1); }
    .btn:active { transform: scale(.97); }
    .btn-primary  { background: var(--vert);  color: #fff; }
    .btn-or       { background: var(--or);    color: #fff; }
    .btn-outline  { background: transparent; color: var(--vert); border: 2px solid var(--vert); }
    .btn-outline:hover { background: var(--vert-clair); filter: none; }
    .btn-bleu     { background: var(--bleu);  color: #fff; }
    .btn-rouge    { background: var(--rouge); color: #fff; }
    .btn-group    { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }

    /* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend { display: flex; gap: 18px; margin-bottom: 14px; flex-wrap: wrap; align-items: center; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.83rem; }
    .legend-swatch {
      width: 34px; height: 16px; border-radius: 3px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.68rem; font-weight: 700;
    }

    /* â”€â”€ Note grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .note-section { margin-bottom: 22px; }
    .note-section-title {
      font-size: 0.9rem; font-weight: 700; color: var(--vert);
      border-bottom: 2px solid var(--vert-clair); padding-bottom: 5px; margin-bottom: 10px;
    }
    .row-wrap { margin-bottom: 14px; }
    .row-name-input {
      font-size: 0.82rem; font-weight: 700; color: var(--vert);
      border: 1px dashed var(--border); border-radius: 4px; padding: 3px 7px;
      margin-bottom: 6px; width: 220px; background: var(--vert-clair);
    }
    .btn-grid { display: flex; flex-wrap: wrap; gap: 5px; }
    .btn-cell { display: flex; flex-direction: column; align-items: center; gap: 2px; }
    .btn-num  { font-size: 0.68rem; color: var(--gris); font-weight: 700; }
    .note-input {
      width: 66px; padding: 4px 5px; text-align: center;
      font-size: 0.78rem; border-radius: 5px;
      border: 1.5px solid var(--border);
    }
    .note-input.pousse { border-color: var(--vert); background: var(--vert-clair); }
    .note-input.tire   { border-color: var(--or);   background: var(--or-clair);  }
    .note-input:focus  { outline: none; }
    .note-input.pousse:focus { border-color: #1a4417; box-shadow: 0 0 0 2px rgba(45,90,39,.15); }
    .note-input.tire:focus   { border-color: #9a7030; box-shadow: 0 0 0 2px rgba(200,169,110,.2); }

    /* â”€â”€ Info note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .info-box {
      background: #eaf2fb; border-left: 4px solid var(--bleu);
      padding: 11px 14px; border-radius: 0 6px 6px 0; font-size: 0.83rem; margin-bottom: 16px;
    }
    .mono { font-family: monospace; background: #f0f0f0; padding: 1px 5px; border-radius: 3px; }

    /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 16px; }
    .tab-btn {
      padding: 8px 20px; border: none; background: none;
      font-family: inherit; font-size: 0.88rem; font-weight: 700; color: var(--gris);
      cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px;
    }
    .tab-btn.active { color: var(--vert); border-bottom-color: var(--vert); }

    /* â”€â”€ SVG visual output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #visual-output { overflow-x: auto; }
    #visual-output svg { display: block; margin: 0 auto; max-width: 100%; }

    /* â”€â”€ Manufacturer table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mfr-table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
    .mfr-table th, .mfr-table td { border: 1px solid #ddd; padding: 7px 11px; text-align: center; }
    .mfr-table th { background: var(--vert); color: #fff; font-size: 0.78rem; font-weight: 700; }
    .mfr-table tr:nth-child(even) td { background: #f6f9f5; }
    .mfr-table td.note-p { color: #1a5c1a; font-weight: 700; }
    .mfr-table td.note-t { color: #8b6914; font-weight: 700; }
    .mfr-table td.row-hd { background: #edf4ec; font-weight: 700; color: var(--vert); }
    .mfr-section-head td { background: #d8ecda !important; font-weight: 700; color: var(--vert); text-align: left; padding-left: 14px; }
    .mfr-sub { color: var(--gris); font-style: italic; font-size: 0.8rem; margin-bottom: 16px; }

    /* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    hr.divider { border: none; border-top: 1.5px solid var(--vert-clair); margin: 18px 0; }

    /* â”€â”€ Print â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
      .card { box-shadow: none; border: 1px solid #ddd; }
      .card-head, .mfr-table th {
        background: #2d5a27 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    /* â”€â”€ Row config grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .rangees-grid { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .rangee-cfg {
      display: flex; flex-direction: column; gap: 4px;
      background: var(--vert-clair); border: 1.5px solid var(--border);
      border-radius: 6px; padding: 8px 10px; min-width: 150px;
    }
    .rangee-cfg label { font-size: 0.75rem; font-weight: 700; color: var(--vert); }

    @media (max-width: 700px) {
      header { flex-direction: column; text-align: center; }
      .form-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<header>
  <div class="icon">ğŸª—</div>
  <div>
    <h1>Outil Clavier AccordÃ©on Diatonique</h1>
    <p>CrÃ©ez le plan de clavier et le bon de commande anches pour vos accordÃ©ons diatoniques bisonores</p>
  </div>
</header>

<div class="container">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Ã‰TAPE 1 : Configuration                                -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="card no-print">
    <div class="card-head">
      <div class="step-badge">1</div>
      <h2>Configuration de l'accordÃ©on</h2>
    </div>
    <div class="card-body">

      <div class="form-grid">
        <div class="form-group">
          <label>RÃ©fÃ©rence instrument</label>
          <input type="text" id="nom-instrument" placeholder="Ex : Sol/Do #001, RÃ©/Sol Breizhâ€¦">
        </div>
        <div class="form-group">
          <label>Nom du client</label>
          <input type="text" id="nom-joueur" placeholder="Ex : Jean Dupont">
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="date-creation">
        </div>
        <div class="form-group">
          <label>Luthier</label>
          <input type="text" id="nom-luthier" value="Ewen d'Aviau">
        </div>
      </div>

      <hr class="divider">

      <div class="form-grid">
        <div class="form-group">
          <label>ModÃ¨le prÃ©dÃ©fini</label>
          <select id="preset-select" onchange="loadPreset(this.value)">
            <option value="">â€” Choisir un modÃ¨le â€”</option>
            <option value="GC21">Sol/Do â€” 21 boutons (2 rangÃ©es)</option>
            <option value="DG21">RÃ©/Sol â€” 21 boutons (2 rangÃ©es)</option>
            <option value="CF21">Do/Fa â€” 21 boutons (2 rangÃ©es)</option>
            <option value="GCD33">Sol/Do/RÃ© â€” 33 boutons (3 rangÃ©es)</option>
            <option value="BbFC33">Sib/Fa/Do â€” 33 boutons (3 rangÃ©es)</option>
            <option value="custom">PersonnalisÃ©â€¦</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nombre de rangÃ©es (main droite)</label>
          <select id="nb-rangees" onchange="onRangeesChange()">
            <option value="2">2 rangÃ©es</option>
            <option value="3" selected>3 rangÃ©es</option>
            <option value="4">4 rangÃ©es</option>
          </select>
        </div>
        <div class="form-group">
          <label>Configuration main gauche</label>
          <select id="config-gauche" onchange="generateInputGrid()">
            <option value="8">8 basses (4 basses + 4 accords)</option>
            <option value="12" selected>12 basses (6 basses + 6 accords)</option>
            <option value="18">18 basses (6+6 basses/accords + 6 terzetto)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nombre de voix (anches)</label>
          <select id="nb-voix">
            <option value="1">1 voix</option>
            <option value="2" selected>2 voix (octave LM ou MH)</option>
            <option value="3">3 voix (LMH)</option>
          </select>
        </div>
      </div>

      <!-- Per-row button count configuration -->
      <div id="rangees-cfg-wrap">
        <div style="font-size:0.82rem;font-weight:700;color:var(--gris);text-transform:uppercase;letter-spacing:.05em;margin-top:14px;margin-bottom:6px;">
          Configuration des rangÃ©es (nom &amp; nombre de boutons)
        </div>
        <div class="rangees-grid" id="rangees-cfg"></div>
      </div>

    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Ã‰TAPE 2 : Saisie des notes                             -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="card no-print">
    <div class="card-head">
      <div class="step-badge">2</div>
      <h2>Saisie des notes</h2>
    </div>
    <div class="card-body">

      <div class="info-box">
        <strong>Format :</strong> SolfÃ¨ge + octave &mdash;
        <span class="mono">Do4</span>, <span class="mono">Sol#3</span>, <span class="mono">RÃ©b4</span>, <span class="mono">Sib2</span>, <span class="mono">Fa#5</span><br>
        Accords (main gauche) : <span class="mono">Do Maj</span>, <span class="mono">Sol Min</span>, <span class="mono">RÃ© 7</span> &mdash;
        Octaves : 2 = grave Â· 3 = mÃ©dium grave Â· 4 = mÃ©dium Â· 5 = aigu Â· 6 = trÃ¨s aigu
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-swatch" style="background:var(--vert-clair);border:1.5px solid var(--vert);color:#1a5c1a;">â†“</div>
          <span><strong>PoussÃ©</strong> (soufflet poussÃ©)</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch" style="background:var(--or-clair);border:1.5px solid var(--or);color:#8b6914;">â†‘</div>
          <span><strong>TirÃ©</strong> (soufflet tirÃ©)</span>
        </div>
      </div>

      <div id="note-grid"></div>

      <div class="btn-group">
        <button class="btn btn-rouge" onclick="clearNotes()">ğŸ—‘ï¸ Effacer toutes les notes</button>
      </div>

    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Ã‰TAPE 3 : GÃ©nÃ©rer                                      -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="card no-print">
    <div class="card-head">
      <div class="step-badge">3</div>
      <h2>GÃ©nÃ©rer les documents</h2>
    </div>
    <div class="card-body">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="generateAll()">ğŸ¹ GÃ©nÃ©rer le visuel + tableau</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- Ã‰TAPE 4 : RÃ©sultats                                    -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="card" id="output-card" style="display:none;">
    <div class="card-head">
      <div class="step-badge">4</div>
      <h2>Documents gÃ©nÃ©rÃ©s</h2>
    </div>
    <div class="card-body">

      <div class="tabs no-print">
        <button class="tab-btn active" onclick="showTab('visual',this)">ğŸ¹ Visuel clavier (client)</button>
        <button class="tab-btn" onclick="showTab('fabricant',this)">ğŸ“‹ Bon de commande fabricant</button>
      </div>

      <!-- Tab: Visual -->
      <div id="tab-visual">
        <div class="btn-group no-print" style="margin-bottom:16px;">
          <button class="btn btn-bleu" onclick="printSection('visual')">ğŸ–¨ï¸ Imprimer / Enregistrer PDF client</button>
        </div>
        <div id="visual-output"></div>
      </div>

      <!-- Tab: Fabricant -->
      <div id="tab-fabricant" style="display:none;">
        <div class="btn-group no-print" style="margin-bottom:16px;">
          <button class="btn btn-bleu" onclick="printSection('fabricant')">ğŸ–¨ï¸ Imprimer / Enregistrer PDF fabricant</button>
        </div>
        <div id="table-output"></div>
      </div>

    </div>
  </div>

</div><!-- /container -->

<script>
/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Ã‰TAT GLOBAL                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let CFG = {
  nbRangees: 3,
  rangees: [
    { nom: 'RangÃ©e Sol (intÃ©rieure)', nb: 11 },
    { nom: 'RangÃ©e Do (mÃ©diane)',     nb: 11 },
    { nom: 'RangÃ©e RÃ© (extÃ©rieure)', nb: 11 },
  ],
  configGauche: 12,
  notes: { droite: [], basses: [], accords: [], terzetto: [] }
};

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  PRÃ‰RÃ‰GLAGES                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PRESETS = {
  GC21: {
    nbRangees: 2,
    rangees: [
      { nom: 'RangÃ©e Sol (intÃ©rieure)', nb: 10 },
      { nom: 'RangÃ©e Do (extÃ©rieure)',  nb: 11 },
    ],
    notes: {
      droite: [
        [ // Sol â€” 10 boutons
          {p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},
          {p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},
          {p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'}
        ],
        [ // Do â€” 11 boutons
          {p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},
          {p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},
          {p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}
        ]
      ],
      basses: [
        {p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},
        {p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}
      ],
      accords: [
        {p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},
        {p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}
      ],
      terzetto: []
    }
  },
  DG21: {
    nbRangees: 2,
    rangees: [
      { nom: 'RangÃ©e RÃ© (intÃ©rieure)', nb: 10 },
      { nom: 'RangÃ©e Sol (extÃ©rieure)', nb: 11 },
    ],
    notes: {
      droite: [
        [ // RÃ© â€” 10 boutons
          {p:'RÃ©3',t:'Mi3'},{p:'Fa#3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'RÃ©4',t:'Do#4'},
          {p:'Fa#4',t:'Mi4'},{p:'La4',t:'Sol4'},{p:'RÃ©5',t:'Si4'},{p:'Fa#5',t:'Do#5'},
          {p:'La5',t:'Mi5'},{p:'RÃ©6',t:'Sol5'}
        ],
        [ // Sol â€” 11 boutons
          {p:'Sol2',t:'La2'},{p:'Si2',t:'Do3'},{p:'RÃ©3',t:'Mi3'},{p:'Sol3',t:'Fa#3'},
          {p:'Si3',t:'La3'},{p:'RÃ©4',t:'Do4'},{p:'Sol4',t:'Mi4'},{p:'Si4',t:'Fa#4'},
          {p:'RÃ©5',t:'La4'},{p:'Sol5',t:'Do5'},{p:'Si5',t:'Mi5'}
        ]
      ],
      basses: [
        {p:'RÃ©3',t:'La2'},{p:'Sol2',t:'RÃ©2'},{p:'La3',t:'Mi3'},
        {p:'Do3',t:'Sol2'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}
      ],
      accords: [
        {p:'RÃ© Maj',t:'La Min'},{p:'Sol Maj',t:'RÃ© Min'},{p:'La Maj',t:'Mi Min'},
        {p:'Do Maj',t:'Sol Maj'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}
      ],
      terzetto: []
    }
  },
  CF21: {
    nbRangees: 2,
    rangees: [
      { nom: 'RangÃ©e Do (intÃ©rieure)', nb: 10 },
      { nom: 'RangÃ©e Fa (extÃ©rieure)', nb: 11 },
    ],
    notes: {
      droite: [
        [
          {p:'Do3',t:'RÃ©3'},{p:'Mi3',t:'Fa3'},{p:'Sol3',t:'La3'},{p:'Do4',t:'Si3'},
          {p:'Mi4',t:'RÃ©4'},{p:'Sol4',t:'Fa4'},{p:'Do5',t:'La4'},{p:'Mi5',t:'Si4'},
          {p:'Sol5',t:'RÃ©5'},{p:'Do6',t:'Fa5'}
        ],
        [
          {p:'Fa3',t:'Mi3'},{p:'La3',t:'Sol3'},{p:'Do4',t:'Sib3'},{p:'Fa4',t:'RÃ©4'},
          {p:'La4',t:'Mib4'},{p:'Do5',t:'Sol4'},{p:'Fa5',t:'La4'},{p:'La5',t:'Sib4'},
          {p:'Do6',t:'RÃ©5'},{p:'Fa6',t:'Mi5'},{p:'La6',t:'Sol5'}
        ]
      ],
      basses: [
        {p:'Do3',t:'Sol2'},{p:'Fa3',t:'Do3'},{p:'Sol2',t:'RÃ©2'},
        {p:'RÃ©3',t:'La2'},{p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'}
      ],
      accords: [
        {p:'Do Maj',t:'Sol Maj'},{p:'Fa Maj',t:'Do Maj'},{p:'Sol Maj',t:'RÃ© Min'},
        {p:'RÃ© Maj',t:'La Min'},{p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'}
      ],
      terzetto: []
    }
  },
  GCD33: {
    nbRangees: 3,
    rangees: [
      { nom: 'RangÃ©e Sol (intÃ©rieure)', nb: 11 },
      { nom: 'RangÃ©e Do (mÃ©diane)',     nb: 11 },
      { nom: 'RangÃ©e RÃ© (extÃ©rieure)', nb: 11 },
    ],
    notes: {
      droite: [
        [ // Sol
          {p:'Sol3',t:'La3'},{p:'Si3',t:'Do4'},{p:'RÃ©4',t:'Mi4'},{p:'Sol4',t:'Fa#4'},
          {p:'Si4',t:'La4'},{p:'RÃ©5',t:'Do5'},{p:'Sol5',t:'Mi5'},{p:'Si5',t:'Fa#5'},
          {p:'RÃ©6',t:'La5'},{p:'Sol6',t:'Do6'},{p:'Si6',t:'Mi6'}
        ],
        [ // Do
          {p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},
          {p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},
          {p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}
        ],
        [ // RÃ©
          {p:'RÃ©3',t:'Mi3'},{p:'Fa#3',t:'Sol3'},{p:'La3',t:'Si3'},{p:'RÃ©4',t:'Do#4'},
          {p:'Fa#4',t:'Mi4'},{p:'La4',t:'Sol4'},{p:'RÃ©5',t:'Si4'},{p:'Fa#5',t:'Do#5'},
          {p:'La5',t:'Mi5'},{p:'RÃ©6',t:'Sol5'},{p:'Fa#6',t:'La5'}
        ]
      ],
      basses: [
        {p:'Sol2',t:'RÃ©2'},{p:'Do3',t:'Sol2'},{p:'RÃ©3',t:'La2'},
        {p:'La3',t:'Mi3'},{p:'Mi3',t:'Si2'},{p:'Si2',t:'Fa#2'}
      ],
      accords: [
        {p:'Sol Maj',t:'RÃ© Min'},{p:'Do Maj',t:'Sol Maj'},{p:'RÃ© Maj',t:'La Min'},
        {p:'La Maj',t:'Mi Min'},{p:'Mi Maj',t:'Si Min'},{p:'Si Maj',t:'Fa# Min'}
      ],
      terzetto: []
    }
  },
  BbFC33: {
    nbRangees: 3,
    rangees: [
      { nom: 'RangÃ©e Sib (intÃ©rieure)', nb: 11 },
      { nom: 'RangÃ©e Fa (mÃ©diane)',      nb: 11 },
      { nom: 'RangÃ©e Do (extÃ©rieure)',  nb: 11 },
    ],
    notes: {
      droite: [
        [ // Sib
          {p:'Sib3',t:'Do4'},{p:'RÃ©4',t:'Mib4'},{p:'Fa4',t:'Sol4'},{p:'Sib4',t:'La4'},
          {p:'RÃ©5',t:'Do5'},{p:'Fa5',t:'Mib5'},{p:'Sib5',t:'Sol5'},{p:'RÃ©6',t:'La5'},
          {p:'Fa6',t:'Do6'},{p:'Sib6',t:'Mib6'},{p:'RÃ©7',t:'Sol6'}
        ],
        [ // Fa
          {p:'Fa3',t:'Mib3'},{p:'La3',t:'Sol3'},{p:'Do4',t:'Sib3'},{p:'Fa4',t:'RÃ©4'},
          {p:'La4',t:'Mib4'},{p:'Do5',t:'Sol4'},{p:'Fa5',t:'La4'},{p:'La5',t:'Sib4'},
          {p:'Do6',t:'RÃ©5'},{p:'Fa6',t:'Mi5'},{p:'La6',t:'Sol5'}
        ],
        [ // Do
          {p:'Do3',t:'Si2'},{p:'Mi3',t:'RÃ©3'},{p:'Sol3',t:'Fa3'},{p:'Do4',t:'La3'},
          {p:'Mi4',t:'Sib3'},{p:'Sol4',t:'RÃ©4'},{p:'Do5',t:'Mi4'},{p:'Mi5',t:'Fa#4'},
          {p:'Sol5',t:'La4'},{p:'Do6',t:'Si4'},{p:'Mi6',t:'RÃ©5'}
        ]
      ],
      basses: [
        {p:'Sib2',t:'Fa2'},{p:'Mib3',t:'Sib2'},{p:'Fa3',t:'Do3'},
        {p:'Do3',t:'Sol2'},{p:'Sol3',t:'RÃ©3'},{p:'RÃ©3',t:'La2'}
      ],
      accords: [
        {p:'Sib Maj',t:'Fa Min'},{p:'Mib Maj',t:'Sib Maj'},{p:'Fa Maj',t:'Do Min'},
        {p:'Do Maj',t:'Sol Maj'},{p:'Sol Maj',t:'RÃ© Min'},{p:'RÃ© Maj',t:'La Min'}
      ],
      terzetto: []
    }
  }
};

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  INITIALISATION                                      â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('date-creation').value = new Date().toISOString().slice(0, 10);
  loadPreset('GCD33');
  document.getElementById('preset-select').value = 'GCD33';
});

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  CHARGEMENT PRESET                                   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadPreset(key) {
  if (!key || key === 'custom') {
    renderRangeesCfg();
    generateInputGrid();
    return;
  }
  const p = PRESETS[key];
  if (!p) return;
  CFG.nbRangees = p.nbRangees;
  CFG.rangees   = p.rangees.map(r => ({ nom: r.nom, nb: r.nb }));
  CFG.notes     = JSON.parse(JSON.stringify(p.notes)); // deep copy
  document.getElementById('nb-rangees').value = p.nbRangees;
  renderRangeesCfg();
  generateInputGrid();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  CHANGEMENT NB RANGÃ‰ES                               â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onRangeesChange() {
  const nb = parseInt(document.getElementById('nb-rangees').value);
  CFG.nbRangees = nb;
  // Extend or trim rangees array
  while (CFG.rangees.length < nb) {
    CFG.rangees.push({ nom: `RangÃ©e ${CFG.rangees.length + 1}`, nb: 11 });
  }
  CFG.rangees = CFG.rangees.slice(0, nb);
  // Extend or trim notes
  while (CFG.notes.droite.length < nb) CFG.notes.droite.push([]);
  CFG.notes.droite = CFG.notes.droite.slice(0, nb);
  renderRangeesCfg();
  generateInputGrid();
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  RENDU CONFIG RANGÃ‰ES                                â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderRangeesCfg() {
  const wrap = document.getElementById('rangees-cfg');
  let html = '';
  for (let r = 0; r < CFG.nbRangees; r++) {
    const rCfg = CFG.rangees[r] || { nom: `RangÃ©e ${r+1}`, nb: 11 };
    html += `
    <div class="rangee-cfg">
      <label>RangÃ©e ${r+1} â€” Nom</label>
      <input type="text" id="rnom-${r}" value="${esc(rCfg.nom)}" style="font-size:.8rem;padding:4px 7px;"
        onchange="CFG.rangees[${r}].nom=this.value">
      <label style="margin-top:4px;">Nombre de boutons</label>
      <input type="text" id="rnb-${r}" value="${rCfg.nb}" style="font-size:.8rem;padding:4px 7px;width:70px;"
        onchange="CFG.rangees[${r}].nb=parseInt(this.value)||11; generateInputGrid()">
    </div>`;
  }
  wrap.innerHTML = html;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  GÃ‰NÃ‰RATION DES INPUTS                               â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generateInputGrid() {
  const configGauche = parseInt(document.getElementById('config-gauche').value);
  CFG.configGauche = configGauche;
  const nbBass = configGauche === 8 ? 4 : 6;
  let html = '';

  /* â”€â”€ Main Droite â”€â”€ */
  html += `<div class="note-section">
    <div class="note-section-title">ğŸµ Main Droite</div>`;

  for (let r = 0; r < CFG.nbRangees; r++) {
    const rCfg = CFG.rangees[r] || { nom: `RangÃ©e ${r+1}`, nb: 11 };
    const nb   = rCfg.nb;
    const notesR = CFG.notes.droite[r] || [];

    html += `<div class="row-wrap">`;
    html += `<div class="btn-grid">`;

    for (let b = 0; b < nb; b++) {
      const n = notesR[b] || { p:'', t:'' };
      html += `
      <div class="btn-cell">
        <div class="btn-num">${rCfg.nom.split(' ')[1] || `R${r+1}`} ${b+1}</div>
        <input class="note-input pousse" id="d-${r}-${b}-p" value="${esc(n.p)}" placeholder="â†“ PoussÃ©" title="Note poussÃ©e">
        <input class="note-input tire"   id="d-${r}-${b}-t" value="${esc(n.t)}" placeholder="â†‘ TirÃ©"   title="Note tirÃ©e">
      </div>`;
    }
    html += `</div></div>`;
  }
  html += `</div>`;

  /* â”€â”€ Main Gauche â”€â”€ */
  html += `<div class="note-section">
    <div class="note-section-title">ğŸ¹ Main Gauche</div>`;

  const gauche_sections = [
    { key: 'basses',   label: 'Basses',   count: nbBass },
    { key: 'accords',  label: 'Accords',  count: nbBass },
  ];
  if (configGauche === 18) {
    gauche_sections.push({ key: 'terzetto', label: 'Terzetto', count: 6 });
  }

  gauche_sections.forEach(({ key, label, count }) => {
    const arr = CFG.notes[key] || [];
    html += `<div class="row-wrap">
      <div style="font-size:.82rem;font-weight:700;color:var(--vert);margin-bottom:5px;">${label}</div>
      <div class="btn-grid">`;
    for (let b = 0; b < count; b++) {
      const n = arr[b] || { p:'', t:'' };
      html += `
      <div class="btn-cell">
        <div class="btn-num">${label[0]}${b+1}</div>
        <input class="note-input pousse" id="g-${key}-${b}-p" value="${esc(n.p)}" placeholder="â†“ PoussÃ©" title="Note poussÃ©e">
        <input class="note-input tire"   id="g-${key}-${b}-t" value="${esc(n.t)}" placeholder="â†‘ TirÃ©"   title="Note tirÃ©e">
      </div>`;
    }
    html += `</div></div>`;
  });

  html += `</div>`;
  document.getElementById('note-grid').innerHTML = html;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  LECTURE DES INPUTS                                  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function readInputs() {
  const configGauche = parseInt(document.getElementById('config-gauche').value);
  const nbBass = configGauche === 8 ? 4 : 6;
  const droite = [];

  for (let r = 0; r < CFG.nbRangees; r++) {
    const rCfg = CFG.rangees[r] || { nom: `RangÃ©e ${r+1}`, nb: 11 };
    const boutons = [];
    for (let b = 0; b < rCfg.nb; b++) {
      boutons.push({
        p: val(`d-${r}-${b}-p`),
        t: val(`d-${r}-${b}-t`)
      });
    }
    droite.push({ nom: rCfg.nom, boutons });
  }

  const readRow = (key, count) => {
    const arr = [];
    for (let b = 0; b < count; b++) {
      arr.push({ p: val(`g-${key}-${b}-p`), t: val(`g-${key}-${b}-t`) });
    }
    return arr;
  };

  const basses   = readRow('basses',  nbBass);
  const accords  = readRow('accords', nbBass);
  const terzetto = configGauche === 18 ? readRow('terzetto', 6) : [];

  return {
    nomInstrument: val('nom-instrument') || 'AccordÃ©on Diatonique',
    nomJoueur:     val('nom-joueur'),
    nomLuthier:    val('nom-luthier') || "Ewen d'Aviau",
    date:          val('date-creation'),
    nbVoix:        parseInt(document.getElementById('nb-voix').value),
    configGauche,
    droite, basses, accords, terzetto
  };
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG â€” MAIN DROITE                                   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSVG_Droite(data) {
  const R      = 26;         // button radius
  const HGAP   = 62;         // horizontal spacing (center to center)
  const VGAP   = 74;         // vertical spacing between rows
  const LPAD   = 172;        // left padding for row labels
  const MARG   = 18;
  const HEAD   = 72;
  const FOOT   = 30;

  const maxBtns = Math.max(...data.droite.map(r => r.boutons.length));
  const W = LPAD + maxBtns * HGAP + MARG;
  const H = MARG + HEAD + data.droite.length * VGAP + FOOT;

  let s = svg_open(W, H);

  // Title
  s += tx(W/2, MARG+16, escSVG(data.nomInstrument), 15, '#2d5a27', 'bold', 'middle');
  if (data.nomJoueur) s += tx(W/2, MARG+32, `Client : ${escSVG(data.nomJoueur)}`, 10, '#555', 'normal', 'middle');
  s += tx(W/2, MARG+46, `Luthier : ${escSVG(data.nomLuthier)}  Â·  ${fmtDate(data.date)}`, 9, '#888', 'normal', 'middle');

  // Legend
  const lx = LPAD;
  const ly = MARG + 58;
  s += `<rect x="${lx}" y="${ly-11}" width="14" height="11" rx="2" fill="#e8f5e3" stroke="#2d5a27" stroke-width="1.2"/>`;
  s += tx(lx+18, ly, 'â†“ PoussÃ©', 9, '#333', 'normal', 'start');
  s += `<rect x="${lx+80}" y="${ly-11}" width="14" height="11" rx="2" fill="#fff8e6" stroke="#c8a96e" stroke-width="1.2"/>`;
  s += tx(lx+98, ly, 'â†‘ TirÃ©', 9, '#333', 'normal', 'start');

  // Rows
  data.droite.forEach((row, ri) => {
    const cy   = MARG + HEAD + ri * VGAP + VGAP/2;
    const stagger = (ri % 2 === 1) ? HGAP/2 : 0;
    // Faint band
    s += `<rect x="${LPAD-4}" y="${cy-R-6}" width="${row.boutons.length*HGAP+stagger+8}" height="${(R+6)*2}" rx="4" fill="${ri%2===0?'#fafafa':'#f3f7f3'}" opacity=".7"/>`;
    // Row label
    s += tx(LPAD-8, cy+4, escSVG(row.nom), 10, '#2d5a27', 'bold', 'end');

    row.boutons.forEach((btn, bi) => {
      const cx = LPAD + stagger + bi * HGAP;
      // Split circle
      s += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="white" stroke="#bbb" stroke-width="1.2"/>`;
      s += `<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="#e8f5e3"/>`;
      s += `<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="#fff8e6"/>`;
      s += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#2d5a27" stroke-width="1.4"/>`;
      s += `<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="#2d5a27" stroke-width=".5" opacity=".4"/>`;
      // Number
      s += tx(cx, cy+3.5, bi+1, 8, 'rgba(0,0,0,.25)', 'normal', 'middle');
      // Push note
      if (btn.p) {
        const fs = btn.p.length > 5 ? 7.5 : 8.5;
        s += tx(cx, cy-9, escSVG(btn.p), fs, '#1a5c1a', 'bold', 'middle');
      }
      // Pull note
      if (btn.t) {
        const fs = btn.t.length > 5 ? 7.5 : 8.5;
        s += tx(cx, cy+19, escSVG(btn.t), fs, '#8b6914', 'bold', 'middle');
      }
    });
  });

  // Footer
  const fy = MARG + HEAD + data.droite.length * VGAP + 12;
  s += `<line x1="${LPAD}" y1="${fy}" x2="${W-MARG}" y2="${fy}" stroke="#eee" stroke-width="1"/>`;
  s += tx(LPAD, fy+14, `${escSVG(data.nomLuthier)} â€” ewendaviau.com`, 8, '#bbb', 'normal', 'start');

  s += '</svg>';
  return s;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  SVG â€” MAIN GAUCHE                                   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSVG_Gauche(data) {
  const R    = 26;
  const HGAP = 65;
  const VGAP = 72;
  const LPAD = 120;
  const MARG = 14;
  const HEAD = 36;
  const FOOT = 22;

  const sections = [
    { nom: 'Basses',   items: data.basses },
    { nom: 'Accords',  items: data.accords },
  ];
  if (data.terzetto && data.terzetto.length > 0) {
    sections.push({ nom: 'Terzetto', items: data.terzetto });
  }

  const maxItems = Math.max(...sections.map(s => s.items.length));
  const W = LPAD + maxItems * HGAP + MARG;
  const H = MARG + HEAD + sections.length * VGAP + FOOT;

  let s = svg_open(W, H);

  s += tx(W/2, MARG+16, `Main Gauche â€” ${escSVG(data.nomInstrument)}`, 12, '#2d5a27', 'bold', 'middle');

  sections.forEach((sec, si) => {
    const cy = MARG + HEAD + si * VGAP + VGAP/2;
    const stagger = (si % 2 === 1) ? HGAP/2 : 0;
    s += `<rect x="${LPAD-4}" y="${cy-R-6}" width="${sec.items.length*HGAP+stagger+8}" height="${(R+6)*2}" rx="4" fill="${si%2===0?'#fafafa':'#f3f7f3'}" opacity=".7"/>`;
    s += tx(LPAD-7, cy+4, escSVG(sec.nom), 10, '#2d5a27', 'bold', 'end');

    sec.items.forEach((btn, bi) => {
      const cx = LPAD + stagger + bi * HGAP;
      s += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="white" stroke="#bbb" stroke-width="1.2"/>`;
      s += `<path d="M${cx-R},${cy} A${R},${R} 0 0,1 ${cx+R},${cy}" fill="#e8f5e3"/>`;
      s += `<path d="M${cx-R},${cy} A${R},${R} 0 0,0 ${cx+R},${cy}" fill="#fff8e6"/>`;
      s += `<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#2d5a27" stroke-width="1.4"/>`;
      s += `<line x1="${cx-R}" y1="${cy}" x2="${cx+R}" y2="${cy}" stroke="#2d5a27" stroke-width=".5" opacity=".4"/>`;
      s += tx(cx, cy+3.5, bi+1, 8, 'rgba(0,0,0,.25)', 'normal', 'middle');
      if (btn.p) {
        const fs = btn.p.length > 7 ? 7 : (btn.p.length > 4 ? 7.5 : 8.5);
        s += tx(cx, cy-9, escSVG(btn.p), fs, '#1a5c1a', 'bold', 'middle');
      }
      if (btn.t) {
        const fs = btn.t.length > 7 ? 7 : (btn.t.length > 4 ? 7.5 : 8.5);
        s += tx(cx, cy+19, escSVG(btn.t), fs, '#8b6914', 'bold', 'middle');
      }
    });
  });

  s += '</svg>';
  return s;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  TABLEAU FABRICANT                                   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildManufacturerTable(data) {
  const date = fmtDate(data.date);

  let h = `
  <p class="mfr-sub">Instrument : <strong>${escHTML(data.nomInstrument)}</strong> &nbsp;|&nbsp;
     Client : <strong>${escHTML(data.nomJoueur) || 'â€”'}</strong> &nbsp;|&nbsp;
     Luthier : <strong>${escHTML(data.nomLuthier)}</strong> &nbsp;|&nbsp;
     Date : <strong>${date}</strong> &nbsp;|&nbsp;
     Voix : <strong>${data.nbVoix}</strong>
  </p>`;

  /* â”€â”€ Main droite â”€â”€ */
  h += `<h4 style="color:var(--vert);border-bottom:2px solid var(--vert-clair);padding-bottom:6px;margin:0 0 10px;font-size:.93rem;">
    MAIN DROITE â€” Plaque anches mÃ©lodie (bisonore)
  </h4>`;
  h += `<table class="mfr-table"><thead><tr>
    <th>RangÃ©e</th><th>NÂ°</th>
    <th>Note PoussÃ©e â†“<br><small style="font-weight:400;opacity:.85">(soufflet poussÃ©)</small></th>
    <th>Note TirÃ©e â†‘<br><small style="font-weight:400;opacity:.85">(soufflet tirÃ©)</small></th>
  </tr></thead><tbody>`;

  data.droite.forEach(row => {
    row.boutons.forEach((btn, bi) => {
      h += `<tr>`;
      if (bi === 0) h += `<td class="row-hd" rowspan="${row.boutons.length}">${escHTML(row.nom)}</td>`;
      h += `<td>${bi+1}</td>`;
      h += `<td class="note-p">${escHTML(btn.p) || 'â€”'}</td>`;
      h += `<td class="note-t">${escHTML(btn.t) || 'â€”'}</td>`;
      h += `</tr>`;
    });
  });
  h += `</tbody></table>`;

  /* â”€â”€ Main gauche â”€â”€ */
  h += `<h4 style="color:var(--vert);border-bottom:2px solid var(--vert-clair);padding-bottom:6px;margin:22px 0 10px;font-size:.93rem;">
    MAIN GAUCHE â€” Plaques basses, accords${data.terzetto.length ? ' &amp; terzetto' : ''}
  </h4>`;
  h += `<table class="mfr-table"><thead><tr>
    <th>Type</th><th>NÂ°</th>
    <th>Note/Accord PoussÃ© â†“</th>
    <th>Note/Accord TirÃ© â†‘</th>
  </tr></thead><tbody>`;

  const gSections = [
    { nom: 'Basses',  arr: data.basses  },
    { nom: 'Accords', arr: data.accords },
  ];
  if (data.terzetto.length > 0) gSections.push({ nom: 'Terzetto', arr: data.terzetto });

  gSections.forEach(({ nom, arr }) => {
    arr.forEach((btn, bi) => {
      h += `<tr>`;
      if (bi === 0) h += `<td class="row-hd" rowspan="${arr.length}">${nom}</td>`;
      h += `<td>${bi+1}</td>`;
      h += `<td class="note-p">${escHTML(btn.p) || 'â€”'}</td>`;
      h += `<td class="note-t">${escHTML(btn.t) || 'â€”'}</td>`;
      h += `</tr>`;
    });
  });
  h += `</tbody></table>`;

  /* â”€â”€ SpÃ©cifications â”€â”€ */
  h += `
  <div style="margin-top:22px;background:#f6f9f5;border:1.5px solid var(--vert-clair);border-radius:6px;padding:14px 16px;font-size:.82rem;">
    <strong>SpÃ©cifications / Specifications :</strong><br>
    &bull; AccordÃ©on bisonore â€” soufflet poussÃ© / tirÃ© (bisonoric â€” push / pull)<br>
    &bull; Nombre de voix (reeds per note) : <strong>${data.nbVoix}</strong><br>
    &bull; Notation solfÃ¨ge : Do=C Â· RÃ©=D Â· Mi=E Â· Fa=F Â· Sol=G Â· La=A Â· Si=B<br>
    &bull; DiÃ¨se = # Â· BÃ©mol = b &nbsp;&nbsp;|&nbsp;&nbsp; Octaves : 2 = basse Â· 3 = mÃ©dium grave Â· 4 = mÃ©dium Â· 5 = aigu Â· 6 = trÃ¨s aigu<br>
    <br>
    <em>Document gÃ©nÃ©rÃ© le ${date} â€” ${escHTML(data.nomLuthier)} â€” ewendaviau.com</em>
  </div>`;

  return h;
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  GÃ‰NÃ‰RER TOUT                                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function generateAll() {
  const data = readInputs();

  // Visual
  const svgD = buildSVG_Droite(data);
  const svgG = buildSVG_Gauche(data);
  document.getElementById('visual-output').innerHTML =
    `<h3 style="color:var(--vert);font-size:.95rem;margin-bottom:12px;">Main Droite</h3>${svgD}
     <h3 style="color:var(--vert);font-size:.95rem;margin:22px 0 12px;">Main Gauche</h3>${svgG}`;

  // Table
  document.getElementById('table-output').innerHTML = buildManufacturerTable(data);

  // Show output
  document.getElementById('output-card').style.display = 'block';
  document.getElementById('output-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  ONGLETS                                             â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showTab(name, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-visual').style.display    = name === 'visual'    ? '' : 'none';
  document.getElementById('tab-fabricant').style.display = name === 'fabricant' ? '' : 'none';
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  IMPRESSION / PDF                                    â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function printSection(which) {
  const data   = readInputs();
  const title  = which === 'visual'
    ? `Plan clavier â€” ${data.nomInstrument}`
    : `Bon de commande anches â€” ${data.nomInstrument}`;

  let body = '';
  if (which === 'visual') {
    body = `
      <h2 style="color:#2d5a27;font-size:13pt;margin-bottom:4mm;">${escHTML(data.nomInstrument)} â€” Plan de clavier</h2>
      <p style="font-size:9pt;color:#666;margin-bottom:4mm;">Client : <b>${escHTML(data.nomJoueur)||'â€”'}</b> Â· Luthier : <b>${escHTML(data.nomLuthier)}</b> Â· ${fmtDate(data.date)}</p>
      <div style="margin-bottom:6mm;">
        <div style="display:flex;gap:12mm;margin-bottom:3mm;">
          <span style="font-size:8pt;"><span style="display:inline-block;width:10mm;height:5mm;background:#e8f5e3;border:1px solid #2d5a27;border-radius:2px;vertical-align:middle;margin-right:2mm;"></span>â†“ PoussÃ©</span>
          <span style="font-size:8pt;"><span style="display:inline-block;width:10mm;height:5mm;background:#fff8e6;border:1px solid #c8a96e;border-radius:2px;vertical-align:middle;margin-right:2mm;"></span>â†‘ TirÃ©</span>
        </div>
        <h3 style="font-size:10pt;color:#2d5a27;margin:3mm 0 2mm;">Main Droite</h3>
        ${buildSVG_Droite(data)}
        <h3 style="font-size:10pt;color:#2d5a27;margin:6mm 0 2mm;">Main Gauche</h3>
        ${buildSVG_Gauche(data)}
      </div>
      <p style="font-size:7pt;color:#bbb;text-align:center;margin-top:8mm;">Plan rÃ©alisÃ© par ${escHTML(data.nomLuthier)} â€” ewendaviau.com</p>`;
  } else {
    body = buildManufacturerTable(data);
  }

  const win = window.open('', '_blank', 'width=900,height=700');
  if (!win) { alert('Veuillez autoriser les popups pour imprimer.'); return; }
  win.document.write(`<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <title>${escHTML(title)}</title>
    <style>
      body { font-family:Arial,sans-serif; margin:12mm 14mm; color:#222; }
      h4   { color:#2d5a27; border-bottom:1px solid #c8e0c5; padding-bottom:4px; margin:5mm 0 3mm; font-size:10pt; }
      table { width:100%; border-collapse:collapse; font-size:8.5pt; margin-bottom:4mm; }
      th,td { border:1px solid #ddd; padding:4px 9px; text-align:center; }
      th    { background:#2d5a27; color:#fff; font-size:8pt; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      tr:nth-child(even) td { background:#f6f9f5; }
      td.row-hd   { background:#edf4ec; font-weight:700; color:#2d5a27; }
      td.note-p   { color:#1a5c1a; font-weight:700; }
      td.note-t   { color:#8b6914; font-weight:700; }
      .mfr-sub    { font-size:8pt; color:#666; margin-bottom:4mm; }
      p { margin-bottom:2mm; font-size:9pt; }
      @media print { body { margin: 8mm 10mm; } }
    </style>
  </head><body>${body}</body></html>`);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 600);
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  EFFACER                                             â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clearNotes() {
  if (!confirm('Effacer toutes les notes ?')) return;
  document.querySelectorAll('#note-grid input').forEach(el => { el.value = ''; });
}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  UTILITAIRES                                         â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function val(id) {
  const el = document.getElementById(id);
  return el ? el.value.trim() : '';
}
function esc(s)     { if (!s) return ''; return String(s).replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escSVG(s)  { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escHTML(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.appendChild(document.createTextNode(String(s)));
  return d.innerHTML;
}
function fmtDate(d) {
  if (!d) return new Date().toLocaleDateString('fr-FR');
  try { return new Date(d).toLocaleDateString('fr-FR'); } catch(e) { return d; }
}
function svg_open(w, h) {
  return `<svg width="${w}" height="${h}" xmlns="http://www.w3.org/2000/svg" font-family="Arial,Helvetica,sans-serif"><rect width="${w}" height="${h}" fill="white"/>`;
}
function tx(x, y, text, size, fill, weight, anchor) {
  return `<text x="${x}" y="${y}" font-size="${size}" fill="${fill}" font-weight="${weight||'normal'}" text-anchor="${anchor||'start'}">${text}</text>`;
}
</script>
</body>
</html>
